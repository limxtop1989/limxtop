{
    "version": "https://jsonfeed.org/version/1",
    "title": "若批评不自由，则赞美无意义",
    "subtitle": "程序员&文艺青年的后花园",
    "icon": "https://limxtop1989.github.io/limxtop/images/favicon.ico",
    "description": "",
    "home_page_url": "https://limxtop1989.github.io/limxtop",
    "items": [
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/01/08/sunset/",
            "url": "https://limxtop1989.github.io/limxtop/2023/01/08/sunset/",
            "title": "晚霞",
            "date_published": "2023-01-08T04:01:26.000Z",
            "content_html": "<p><img data-src=\"https://tva1.sinaimg.cn/large/008vxvgGgy1h9w3xxbyokj30hs0lhacr.jpg\" alt=\"\" /></p>\n<p>作者：火山<br />\n公众号：火山与木星<br />\n原文链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvYUlNYnFxSGRNbUpsM3FsbWdwTUYzQQ==\">https://mp.weixin.qq.com/s/aIMbqqHdMmJl3qlmgpMF3A</span></p>\n<p>这天晚上，天空出现了美丽的颜色，从高架桥间望到的那一片天，其色彩让人赞叹。走下过街天桥的楼梯，拥挤破旧的出租房屋渐渐逼近我的鼻尖，我突然想起一个汉字：霞。那片美丽的颜色是霞光或彩霞。同时我想起我久未见面的妹妹，她的名字就叫明霞。</p>\n<p>晚上，我枕着双臂躺在燠热的凉席上，隔壁房间里麻将搓动的声音袭入我租的这个房间里。我很想再看一次那美妙的颜色，我很想用相机把它捕捉下来。此刻外边的天空早已漆黑一片，那光泽早已消逝，这将是一个平凡而乏味的黑夜。</p>\n<p>星期日我不用上班，上了往南边岛屿去的地铁。一个人，我走到了江边，对岸仍是拥挤的出租屋，轮船在江面驶过。我在堤岸上坐了下来，手侧放着向朋友借来的相机。我想如果它在这个黄昏出现，在如此广阔的天空下与它邂逅会是一件多么壮观的事。我要捕捉到它二千米长的光泽与神奇。</p>\n<p>那一日是惨淡收场。它没有出现。八点时候，我收拾水壶和相机，离开堤岸，重新向大陆走去。</p>\n<p>天色昏暗，我有些认不出回去的路。我踏上一条碎石砌就的小径，它的另一头向树林深处延伸。风令树林哗啦作响。我凝视陡起的消失在树林里的路的尽头，恍然觉得有人正从那边走过来。我有一个预感，来人我十分熟悉。我抵抗住这一强烈的幻觉，扭过头横越这条小径向远处的柏油马路走去。</p>\n<p>我的工作是外贸公司里的跟单。外国客户在我们公司下单以后，我们负责寻找工厂，监管质量，直至产品顺利上柜离岸，和客户交付提单。</p>\n<p>公司里的人脾气都很坏，因为工作繁忙而沉重。我算是比较温和的，所以说话没人想听。我的老板对我说必须要变得强硬，对工厂不能心软，这些厂家都是些贪婪和弄虚作假的人，没有什么值得同情。</p>\n<p>办公室里和我关系友好的一个女孩子坐在我的对面。上个礼拜日我和她坐在茶餐厅里，她告诉我她担心出不了手头上那批货会被老板责骂。我默默听着，把那碗椰汁西米露一勺一勺吃完。</p>\n<p>我知道在那条小径上向我走近的是谁。那只能是我的妹妹。我很后悔自己做过的一些事，比如十几岁时和她一起用汤水喂弃猫，她更小的时候，我领着她到处游荡等等。</p>\n<p>有一件事我很不情愿想起。大约在初三的时候，我早上和她一起出门去上学，她从楼梯上滑倒，坐在地上哇哇大哭。在充满痛苦和自卑的十六岁的那个清晨，我没有像以往一样赶紧去抱起我的妹妹，我只是站在楼梯的高处，对她冷酷说出 —— 你自己爬起来。</p>\n<p>从此以后，我的妹妹和我疏离起来。而我念完大学，并到另一个城市谋生以后，几乎把她忘记了。每次过年回家，我都会在客厅里见到一个平凡的女孩子，和远方归来的父亲兄弟闲聊几句以后就戴着耳机躲进房间里。那个房间里满是言情小说、长毛熊、韩国明星的贴纸。</p>\n<p>天气预报能告诉我的只是何时有雨、多云，阴天或起风。它不能告诉我何时天空会出现彩霞。城市里没有人关注这个。</p>\n<p>每天下班后一走出办公室，我都抬头搜寻天空，期待在被楼房和高架桥分割的间隙里，能找到它的踪影。</p>\n<p>某一日，我坐在公共汽车上。车厢里减肥茶的广告声震耳欲聋，一个中年妇女在尖声说话。我看着窗外，车驶上高架桥，楼房阳台布满积尘，窗户紧闭，我不能想象怎么有人可以睡在和马路只隔一层窗户的地方，他们怎么可以入眠。他们会否连发梦也是梦到自己在马路上或公共汽车上呢？对于我，我是无法在这样的楼房中入睡的，我不能忍受汽车引擎持续震动所引起的那种晕眩感。</p>\n<p>突然，在楼房的间隙里，它出现了！公共汽车恰好在这时候到站！门一打开，我就手提相机，一跃而出……</p>\n<p>我被后边的车子撞到了。天旋地转，某些人对我的围观议论声中，我想起自己在十四岁，读初一的时候，有一段时间每天傍晚都骑自行车载妹妹去西边的小学操场。那里有一片广阔的田野，有不被房屋阻隔的天空，那里几乎每晚都会有让我们翘首以待的晚霞。</p>\n<p>妹妹喜欢我载她去看日落，除了天空美丽，也许还因为我如果有两角钱，总会为她买一条雪条。她会说：“你吃上面的一截，下面的一截是我的。”</p>\n",
            "tags": [
                "晚霞"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/01/08/azhen/",
            "url": "https://limxtop1989.github.io/limxtop/2023/01/08/azhen/",
            "title": "阿珍",
            "date_published": "2023-01-08T03:53:54.000Z",
            "content_html": "<p><img data-src=\"https://tva1.sinaimg.cn/large/008vxvgGgy1h9w3uouvijj30hs0h7dg5.jpg\" alt=\"\" /></p>\n<p>作者：火山<br />\n公众号：火山与木星<br />\n原文链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvVmdmTGdnbEF2aTJVWWNMNnczNkpldw==\">https://mp.weixin.qq.com/s/VgfLgglAvi2UYcL6w36Jew</span></p>\n<p>没有任何的变化，疲惫的他依旧回到了单间，关上门，他坐下来。而女友告诉他：她怀孕了，孩子不是他的。</p>\n<p>他往楼下跑去，手里提着滴血的水果刀，他穿过人群和乏睡的车厢，跑过清新的田野，躲到了老家房子的农具房里，锄头和泥墙保护他睡去。儿时喜欢过的穿着红色袜子的小女孩在梦里宣布他无罪。</p>\n<p>被杀死的女人在出租屋里复活，不是因为信仰和魔法，仅仅是因为她要躲开明日早上过来收房租的房东。</p>\n<p>这个烫着头发的丰腴女人名叫阿珍，肚子里有了一个孩子。她拿些卫生纸把胸口的窟窿捂住，提起行李包，穿着拖鞋离开了她和狗屎强过了两年的房间。绿色铁门很新很光滑，锁舌扣合的声音很清脆。</p>\n<p>她拖着血迹，到菜市场买了羊肉和萝卜，打电话给阿猫，说她今晚过去煮饭给他吃。阿猫说今晚不方便，他正在外地出差。她说她现在无家可归了，现在她只剩下他了，他不能不要她。</p>\n<p>阿猫说他的确是在外地，劝她先去朋友那里住几天。她蹲在墙根，说她想见他，眼泪引得路人侧目。阿猫说他没办法。</p>\n<p>几天以后，她过去找阿猫。没有人应门。打电话过去，他说他搬了。她说：你怎么没有和我说起过？阿猫说他忘记了。她问他现在在哪里，他说在家。她问：你的家在哪里？我过去找你。阿猫沉默了一阵，说：你不用来找我，还是去医院堕胎吧……</p>\n<p>不久，人们看到一个蓬头垢面的女人，穿着睡裙，卧在杨箕地铁站 C 出口边上，这一次她终于死了，污黑的右手攥着一个胶袋，里边是一斤已经发臭的羊肉，萝卜上有几个牙印，而左手放在肚皮上，这只手那么干净、那么温柔。</p>\n",
            "tags": [
                "阿珍"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/12/23/next-pole/",
            "url": "https://limxtop1989.github.io/limxtop/2022/12/23/next-pole/",
            "title": "下一棒",
            "date_published": "2022-12-23T14:24:25.000Z",
            "content_html": "<p>Author: 叨址 (沈超）<br />\nWechatID: abelkid</p>\n<p>爹：国家守护了我们三年，尽力了，现在每个人都是自己健康的第一责任人，剩下的日子要靠自己了。我通过医院的熟人屯了一批药，随时有症状了也不怕没床位。<br />\n我：做好日常防护，奥密克戎不可怕。正常备药就行，不要屯药。<br />\n爹：年轻人就是没有生活经验。<br />\n我：以前屯板蓝根、屯白醋、屯盐，这些反面经验我们也没有学到什么教训。<br />\n爹：傻瓜，别人都在屯药你不屯，到时候你就买不到药。<br />\n我：所以明知道是一部分人的行为导致另一部分人买不到药。<br />\n不屯药才能让大家都有药。<br />\n爹：孩子，这个社会就是人与人的竞争，资源是有限的，你有了我就没有。<br />\n我：我们让渡出部分权益组成社会，是因为社会能够让其中的每个人都得到超出个人部分的权益和帮助，这是一份公共契约。<br />\n成为利己主义者只攫取好处而损害其他的人利益，会破坏这份契约。因为只追求竞争就不需要组成社会，森林法则就够了。<br />\n更何况竞争应该是竞争把社会蛋糕做大的能力，而不是抢夺蛋糕的能力。我们发展生产到今天，不是那个物资匮乏的社会了。</p>\n<p>爹：错，即使资源不匮乏，也依然是掌握在部分人的手里。你看那么多的空房子，都是资本的炒作，资本家才是坏透了。<br />\n我：你觉得是他们抬高了房价？<br />\n爹：他们抬高了房价，他们造成了失业，他们导致了腐败，他们的科技与狠活伤害人们的身体，他们甚至敢核酸造假祸国殃民。<br />\n我：你有没有想过这些是国家的问题？土地政策抬高了房价，行业打压造成了失业，监管不善导致了环境和食品安全问题，权力寻租和媒体失能导致了腐败和造假？<br />\n爹：我们是发展中国家，现阶段是会有一些问题，但不能把所有问题都归结到国家。我们终究会解决这些问题，别的国家同样有问题。<br />\n我：但别的国家有好的纠错机制，民主、法制、言论，我们一个都没有，如何解决问题？<br />\n爹：我们有强有力的党的领导。<br />\n我：封控和放开都是靠党的领导。现在有效的疫苗、重点人群的接种率、增扩医疗资源、防挤兑预案、科学的宣导与社会心理建设一项都没做到，就靠一句 “每个人都是自己健康的第一责任人”？我们把太多的力气花在了全民核酸这种折腾大众的错误方向上，还怕苍蝇不来叮？<br />\n爹：从封控到放开，就说明我们也有自我纠错能力。<br />\n我：放开是因为各地爆发的抗议活动，是勇敢的大学生和团结的民众为我们争取来的，不是因为良心发现。<br />\n爹：做核酸是政府出钱，现在自测抗原需要花自己的钱，大家肯定更愿意免费做核酸。<br />\n我：这就是没有公民意识啊。<br />\n政府出的也是纳税人的钱，纳税就是我们让渡出去的权益的一部分。每个人让渡出的私权组成了公权力，政府、警察等公权力是用来保护私权而不是侵蚀私权的，所以公权力必须受到监督。<br />\n你有纳税的义务也有监督财政的权利，财政不受监督就会导致腐败。你兜里的钱是你自己的，你纳出去的税也是你的，这个国家也是你的。</p>\n<p>爹：我不管别人是什么样的，我们过好自己的就好了。<br />\n我：你催买房催婚催生的时候可不是这么说的，你说的是别人都在做为什么你不做。<br />\n爹：所以别人都在屯药，你也应该屯。<br />\n我：你刚才可不是这么说的，你批判资本家的时候说他们占用了别人的资源。<br />\n爹：怎么跟爸爸说话呢这是？读书读傻了你。<br />\n我：可是我在厦门已经买不到药了。你屯了药让有的人买不到药，别人屯药让我也买不到药。也就是说，你们屯的药最终导致了你们的下一代没有药。<br />\n爹：不对，正是因为我屯了药，我才能帮你这个买不到药的下一代兜底。</p>\n<p>爹：张雪峰说我的女儿不用考研，我给我女儿已经赚够了一生的钱，她不会为钱发愁，她不用为了生计去做她不想做的事情。<br />\n能够兜底的父母都会为下一代提供更好的环境。<br />\n我：更好的环境是指现在的环境并不好，至少张雪峰认为现在的考研并不是奔着好去的。<br />\n爹：是的，如果好，就不存在为了生计做不想做的事情。<br />\n我：张雪峰为了自己的下一代跳出这个环境，而让这个互害的法则继续侵害别人的下一代。我不能苟同。<br />\n爹：他改变不了什么，只能自求多福了。<br />\n我：那你觉得这是一个好的社会环境吗？<br />\n爹：不算。<br />\n我：你愿意你的后代像你一样挣扎在这样一个沉疴制度导致的自利互害的社会吗？<br />\n爹：不愿意，但又能怎么办呢？<br />\n我：你认为这不是个好的社会，也不愿意后代生活在这样的社会中，又认为你无法改变社会进程，那为什么要繁衍下一代来重复承受你的困境呢？<br />\n柏拉图讲爱情，黑格尔讲婚姻，似乎没有哲学家讲繁衍。如果人类还有一点自由意志的话，那么我认为是想要选择生活。第一步是想要，第二步是选择。罗曼・罗兰的 “热爱生活” 不能被理解为鸡汤式的自我麻醉，热爱生活的形式是依然想要、依然选择，而不是看清生活真相后的无奈妥协与苟且。<br />\n我们称颂乔布斯，称颂哥伦布，称颂一切改变世界的英雄，但源于希腊的个人英雄主义叙事的遗害是成功学，我们称颂的并不是 “想要” 改变世界的精神，而是 “成功” 改变世界的结果。如果说在漫长的人类历史中注定要掩埋那些未竟的努力和失败，那么缩短到一年之内的接力便可让我们看见清晰的脉络：四通桥上的孤勇者的标语响遍全国，A4 运动导致灵车飘移式的转向，推动这一切的是参与其中的每一个人，是自下而上的选择意愿，而不是某一个人的金牌令箭。<br />\n或许我们的 “想要” 并不像这短短几个月内的奇效，而这一次的事件也只是接力赛中的其中一棒，其中的关键在于每个人都放弃关于伟大的幻想，放弃一蹴而就的救世者叙事，承认聚沙成塔的公民之力，承认我们想要选择的生活。即使我们不是最后冲线的那一棒，也承认每一棒的功绩与不朽，跑好自己的一棒并交给下一代接棒人，最终才有可能让他们的下一代，生活在你所愿景的更美好的社会中。<br />\n为每代下一代推动更美好的社会，这才是繁衍的真义。</p>\n<p>以上仿苏格拉底对话录是虚构的，但以下对话是真实的，来自反派影评《响指之后，何去何从？》。</p>\n<p>杨超：特别听不得有一句话，&quot; 我也改变不了什么”。这句话首先是一个绝对的废话，包含着极大的狂妄和极大的自卑。废话，你当然改变不了什么，你一个人怎么可能改变什么，但是很多人这么说的时候，其实为后面放弃做准备的。反正我也干不了什么，我就这样了，以一种非常低调谦逊的状态，说一句非常狂妄，但是又抛弃责任的话。先是狂到上帝那去，然后再低到魔鬼那，把自己的所有责任全都放弃掉。</p>\n<p>波米：我们今天谈的你也改变不了行业，你改变不了世界。其实改变世界的过程是一个非常非常漫长的接力赛跑，而每一个人或者每一代人都以为自己跑的是最后一棒，都以为到自己那一棒的时候应该出成绩。</p>\n<p>但是有一个时期你会意识到，真正改变了世界的过程都不是 4 棒的问题，它可能是 40 棒、400 棒的问题，而你其实只是跑的第 20 棒、第 2 棒，但是在这样一个情况下，我们怎么做？</p>\n<p>还记不记得《银翼杀手 2049》，就是高司令，他开始其实就是这样的。他原以为自己是救世者，到中间他发现每个人都是这么想的，原来我是非常普通的一个，但是他因此干脆拿起枪来把自己崩了，或者说这事跟我没关系？他不是。他最后还是把自己的使命完成，所以最后一幕落在那，他把哈里森福特带到真正的天选之子那里，他自己躺在了外面。在那一刻，我觉得这是最牛逼的英雄成长。因为他完成了最大的觉醒，觉醒之处在于，他认识到了自己不是跑最后一棒的人，但与此同时我也要完成好我自己这一棒。</p>\n<p>改变世界的事在你这完不成，那你要做的事情是你把这种信念，你把刚才说的所有，你要坚持常识，坚持保持判断是非的能力，传给下一棒跑步的人，别掉棒，继续跑。</p>\n<p>杨超：而且我们的下一代人会不会有可能就是最后一棒，其实取决于我们跑的怎么样，说不定你要跑得非常好，下一代人成最后一棒。</p>\n<p>波米：你要把棒扔了，那肯定就没有下一棒，永远是一个未竟事业。</p>\n",
            "tags": []
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/12/03/it-is-my-duty/",
            "url": "https://limxtop1989.github.io/limxtop/2022/12/03/it-is-my-duty/",
            "title": "IT'S MY DUTY",
            "date_published": "2022-12-03T15:21:39.000Z",
            "content_html": "<p>author: 佚名</p>\n<p>我们是广场上的遗孤</p>\n<p>我们是野火后的新芽</p>\n<p>我们沉入长江底</p>\n<p>我们在动车下</p>\n<p>我们在贵州的大巴上別有用心</p>\n<p>我们在乌鲁木齐的大火里破坏稳定</p>\n<p>我们是在盛世中流浪的低端人口</p>\n<p>我们是在黑屋里呐喊的境外势力</p>\n<p>我们是失去家园的香港人</p>\n<p>我们是失去自由的维吾尔人……</p>\n<p>我们是刘晓波 我们是伊力哈木</p>\n<p>我们是刘贤斌 我们是陈卫</p>\n<p>我们是曹顺利 我们是李旺阳</p>\n<p>我们是孙志刚 我们是雷洋</p>\n<p>我们是杨佳 我们是吴淦</p>\n<p>我们是郭玉闪 我们是许志永</p>\n<p>我们是艾晓明 我们是寇延丁</p>\n<p>我们是卢宇 我们是叶海燕</p>\n<p>我们是高智晟 我们是余文生</p>\n<p>我们是夏霖 我们是王宇</p>\n<p>我们是李和平我们是王峭岭</p>\n<p>我们是张展 我们是黄思敏</p>\n<p>我们是李明哲 我们是桂敏海</p>\n<p>我们是高耀洁 我们是蒋彦永</p>\n<p>我们是李文亮 我们是彭载舟………</p>\n<p>我们在方舱里自救</p>\n<p>我们在铁链下自由</p>\n<p>我们是被删掉的声音</p>\n<p>我们是被开除的良心</p>\n<p>我们是最后一代软肋</p>\n<p>我们是非必要的未来</p>\n<p>“不能”</p>\n<p>“不明白”</p>\n<p>“不同意”</p>\n<p>我们曾经站到坦克前</p>\n<p>我们也曾站在四通桥上</p>\n<p>今天我们依旧站在这里</p>\n<p>我们明天还要站到你们面前 因为</p>\n<p>It's my duty!(这是我的责任)</p>\n<p>It's our duty!(这是我们的责任)</p>\n",
            "tags": [
                "it's my duty"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/11/28/fight-for-freedom/",
            "url": "https://limxtop1989.github.io/limxtop/2022/11/28/fight-for-freedom/",
            "title": "柳德米拉·乌利茨卡娅",
            "date_published": "2022-11-28T14:52:20.000Z",
            "content_html": "<p><img data-src=\"https://tva1.sinaimg.cn/large/008vxvgGgy1h8l8exckf3j30ka0f70uw.jpg\" alt=\"\" /></p>\n<p>我们有雪亮的眼睛，<br />\n你有军警宪特。</p>\n<p>你有雄兵百万，<br />\n我们有人的尊严。</p>\n<p>我们是百姓和草根，<br />\n你是克格勃官员和权贵豪门。</p>\n<p>你有强大的盾牌壮胆，<br />\n我们全都赤手空拳。</p>\n<p>除非你是婴孩，<br />\n否则周身何须护具覆盖？</p>\n<p>我们并非来打架，只想表达，<br />\n你不需逢人就抓，</p>\n<p>不需要挥舞拳头和棍棒，<br />\n将无辜者扔进牢房，</p>\n<p>人们被分化<br />\n成普通民众和警察。</p>\n<p>我们是百姓和草根，<br />\n你是克格勃官员和权贵豪门......</p>\n<p>对我们来说，俄罗斯如此博大，<br />\n对你来说，它如同火山即将喷发</p>\n",
            "tags": []
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/10/19/how-to-make-money/",
            "url": "https://limxtop1989.github.io/limxtop/2022/10/19/how-to-make-money/",
            "title": "如何赚大钱",
            "date_published": "2022-10-19T14:53:22.000Z",
            "content_html": "<h1 id=\"\"><a class=\"anchor\" href=\"#\">#</a> </h1>\n<p>创造财富是致富的一种直接的方式（Creating wealth is a way to get rich.）</p>\n<h1 id=\"途径\"><a class=\"anchor\" href=\"#途径\">#</a> 途径</h1>\n<p>如果想变得富有，最好的方式是创立或者加盟初创科技公司，特别是攻克技术难题的公司。这是一种几百年来，屡试不爽可靠的致富方式。</p>\n<h1 id=\"观点\"><a class=\"anchor\" href=\"#观点\">#</a> 观点</h1>\n<p>经济上来看，初创公司相当于将全部的职业生涯压缩为短短的几年时间完成，而不是低强度的四十年，在这几年的时间里，你尽可能努力地工作。这可以通过让自己加倍努力工作达成，加班是一种方式，但不是唯一和优雅的方式。每天在办公室会有诸多工作事项，但并非他们都可以转化为同等的价值。</p>\n<ol>\n<li>有些工作并不能创造价值，或者收获甚微，比如因为公司的规则，不得不和同事做毫无意义的争论，或者撰写冗长的工作日报。特别是对那些日报没有洋洋洒洒上千字会被认为没有营养和内容的公司，请敬而远之。由此当我们考虑工作时间的时候，应该衡量的是有效工作时间，并将其最大化，而不是简单的考量工作时长。</li>\n<li>不同的工作，创造的价值不一样，花一年的时间搬砖砌墙，和花三年五载的漫长岁月，构思图灵机模型为世界从工业革命走向信息革命奠定基础，完全不能相提并论。</li>\n</ol>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>财富</mtext><mo>=</mo><mtext>有效工作时长</mtext><mo>∗</mo><mtext>单位时间创造的财富</mtext></mrow><annotation encoding=\"application/x-tex\">财富 = 有效工作时长 * 单位时间创造的财富\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord cjk_fallback\">财</span><span class=\"mord cjk_fallback\">富</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord cjk_fallback\">有</span><span class=\"mord cjk_fallback\">效</span><span class=\"mord cjk_fallback\">工</span><span class=\"mord cjk_fallback\">作</span><span class=\"mord cjk_fallback\">时</span><span class=\"mord cjk_fallback\">长</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord cjk_fallback\">单</span><span class=\"mord cjk_fallback\">位</span><span class=\"mord cjk_fallback\">时</span><span class=\"mord cjk_fallback\">间</span><span class=\"mord cjk_fallback\">创</span><span class=\"mord cjk_fallback\">造</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">财</span><span class=\"mord cjk_fallback\">富</span></span></span></span></span></p>\n<p>综上，当我们提高任何一个变量，都可以让财富增长。</p>\n<h1 id=\"供需理论\"><a class=\"anchor\" href=\"#供需理论\">#</a> 供需理论</h1>\n<p>如若要获得更高的个人劳动报酬，可以掌握少数人掌握的技能，或者市场大量需要的技能，不管哪一种，都可以促成供给少于需求的局面，让自己变得稀缺，从而自然而然获得更高的报酬。如果可以兼而有之，则更好。</p>\n<p>需求指的是人们有能力购买，并愿意购买某个具体财货的欲望。显示的是其它因素不变的情况下（ceteris paribus），随着价格升降，某个体在每段时间内所愿意购买某财货的数量。</p>\n<p>在某一价格下，消费者愿意购买的某一货物总数量称为 “需求量”(quantity demanded)。在不同价格下，需求量会不同。需求也就是说价格与需求量的关系。若以图像表示，便称为 “需求曲线”。</p>\n<p>供给，指特定市场上在一定时期内，与每一销售价格相对应，生产者愿意且能供应的财货数量。但供给并不完全代表生产，它属于生产的一部分，但供给量并不即是生产者在计算一系列成本所愿意生产的数量。生产量依据利润最大化条件决定，它在短期往往是固定，但供给量则可以随时变动。也就是说生产量是虚拟的、是人们算出来的，而供给量是现实的、真实发生的量。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><img data-src=\"https://tva1.sinaimg.cn/large/008vxvgGgy1h8uzfh5sptj30go0go3z5.jpg\" alt=\"\" /></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><em>标准的供给和需求模型：正斜率的是供给曲线，代表生产者愿意在某一价格水平下出售的物品数量；负斜率的是需求曲线，代表消费者愿意在某一价格水准下购买的数量。透过模型的分析，可发现两条曲线相交之处（均衡点）就是均衡价格和均衡产量。</em></td>\n</tr>\n</tbody>\n</table>\n<p>供求关系决定市场价格。</p>\n<ul>\n<li>供给稀缺不能满足有效需求，需求方不愿意得不到商品，愿支付更高的价格。</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><img data-src=\"https://tva1.sinaimg.cn/large/008vxvgGgy1h8uzhmzne5j308c08ct8u.jpg\" alt=\"\" /></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><em>供给是蓝线 S，需求是红线 D，当需求由 D1 变动为 D2 时，成交的价格和数量也随之变动。</em></td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>供给充裕超过有效需求，商品不能全部出售，势必导致供给方降低价格增加有效需求。</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><img data-src=\"https://tva1.sinaimg.cn/large/008vxvgGgy1h8uzk1ixhaj308c08c3yn.jpg\" alt=\"\" /></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><em>供给是蓝线 S，需求是红线 D，当供给由 S1 变动为 S2 时，成交的价格和数量也随之变动。</em></td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"金钱不是财富\"><a class=\"anchor\" href=\"#金钱不是财富\">#</a> 金钱不是财富</h1>\n<p>如果想要创造财富，理解什么是财富将大有裨益。财富并非和金钱等同，财富伴随着人类历史，金钱或者货币是相对近期的发明。财富才是根本的，是可以满足人类需求的物品：食物，衣服，房子，汽车…… 你可以没有金钱货币，便拥有财富。财富才是我们需要的，金钱不是。但如果财富是如此重要，为什么我们经常谈论提及的是赚钱？这不过是一种简化：金钱是一种交换财富的介质，在实践中，财富并不总是方便直接交换。</p>\n<p>往往身上的财富并不能满足自己和家庭所需，你可以用现有的财富和别人的财富做交换。只是交换时，彼此并不能恰好拥有彼此所需可交换的财富，比如我有多余的汽车需要房子，但对方是需要汽车但没有房子，对方可以支付我房子等额的金钱货币，然后我再用这些金钱找第三者买房子。或者因为财富不好分割，但金钱很适合。金钱货币才因此应运而生。所以，对于我们而言，重要的是财富本身，而不是金钱，金钱只是一种一般等价物，方便我们进行财富转移交换的媒介。财富和金钱的关系应该是这样的图景。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><img data-src=\"https://tva1.sinaimg.cn/large/008vxvgGgy1h8vmzxdfzdj30ht0cr75a.jpg\" alt=\"\" /></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><em>物物交换存在很多弊端，比如猫有鱼想和农民换稻米，农民是有稻米但他想用稻米和猎人换活鸡，猎人是有活鸡，但他只想吃鱼。所以交易无法进行。如果有一般等价物，比如货币，猫就可以用鱼和猎人的货币交换，然后用收入的货币和农民交换稻米。其他角色也如此，于是大家都换到自己心仪的商品。</em></td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"蛋糕谬论\"><a class=\"anchor\" href=\"#蛋糕谬论\">#</a> 蛋糕谬论</h1>\n<p>会有人误以为，世界上的财富总量是恒定的，在这样的上下文里，我们总是将财富称作为 “蛋糕”，但其实，财富的创造并非是零和游戏，不是我赚点，就注定有人要吃亏。<strong>蛋糕是可以做大的</strong>。比如，今年的夏天，与其在屋子里干坐着碌碌无为，我把自家后院的荒地开垦，种了草莓，这就是在创造财富，水果成熟时，可以采摘拿到市场售卖换金钱。这个过程中，我变得富有了，但并没有人因此变得更加贫穷。伴随人类历史，财富总是不停地被创造和毁灭，但总体上，创造多于毁灭。</p>\n<h1 id=\"法治\"><a class=\"anchor\" href=\"#法治\">#</a> 法治</h1>\n<p>在一个法治国家，每个人都可以自由地追逐财富，并自由使用，国家财富会逐步增加，蛋糕可以越做越大。不用担心窃取财富。毕竟，如果知道积累财富的最终结果是被他人夺取和打击，我们自然就不会去创造那么多的财富。从以前的打土豪劣绅，到最近马斯克的提问 “马云去哪里了？…… 我只是好奇，随口问一下”。</p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<ul>\n<li>[1] <span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC5tLndpa2lwZWRpYS5vcmcvemgtaGFucy8lRTklOUMlODAlRTYlQjElODIlRTglODglODclRTQlQkUlOUIlRTclQjUlQTY=\"> 供需曲线 </span></li>\n<li>[2] [ How to make wealth in hackers and painters ]</li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/10/06/tear-down-the-wall/",
            "url": "https://limxtop1989.github.io/limxtop/2022/10/06/tear-down-the-wall/",
            "title": "tear down the wall",
            "date_published": "2022-10-06T02:21:11.000Z",
            "content_html": "<h1 id=\"引言\"><a class=\"anchor\" href=\"#引言\">#</a> 引言</h1>\n<p>世界上有许多人确实不懂，或者说他们不明白什么是自由世界和共产主义世界的根本分歧。让他们来柏林吧。有些人说，共产主义是未来的潮流。让他们来柏林吧。有些人说，我们能在欧洲或其他地方与共产党人合作。让他们来柏林吧。甚至有那么几个人说，共产主义确是一种邪恶的制度，但它可以使我们取得经济发展。“Lasst sie nach Berlin kommen.”［“让他们到柏林看看”］</p>\n<h1 id=\"马歇尔计划\"><a class=\"anchor\" href=\"#马歇尔计划\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC5tLndpa2lwZWRpYS5vcmcvemgtY24vJUU5JUE5JUFDJUU2JUFEJTg3JUU1JUIwJTk0JUU4JUFFJUExJUU1JTg4JTky\">马歇尔计划</span></h1>\n<p>马歇尔计划（英语：The Marshall Plan），官方名称为欧洲复兴计划（英语：European Recovery Program），是二战后美国对战争破坏后的西欧各国进行经济援助、协助重建的计划，对欧洲国家的发展和世界政治格局产生了深远的影响。另外除了欧洲，同期类似的经济援助在朝鲜战争后也在亚洲第一岛链与其他第三世界国家实施，受援范围大部分是今日美国的盟邦，但并未有称为马歇尔计划。</p>\n<figure>\n    <img data-src=\"https://tva1.sinaimg.cn/large/006y8mN6ly1h6vet5m9zej30ua0u0gnw.jpg\"\n         alt=\"Albuquerque, New Mexico\">\n    <figcaption>这幅冷战时期的欧洲地图上标注了接受马歇尔计划援助的国家。蓝色圆柱代表了各国各自接受的援助相对数量。</figcaption>\n</figure>\n<h1 id=\"我是柏林人演讲者肯尼迪\"><a class=\"anchor\" href=\"#我是柏林人演讲者肯尼迪\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC5tLndpa2lwZWRpYS5vcmcvemgtbXkvJUU2JTg4JTkxJUU2JTk4JUFGJUU2JTlGJThGJUU2JTlFJTk3JUU0JUJBJUJB\">我是柏林人 (演讲者：肯尼迪)</span></h1>\n<p><img data-src=\"https://baike.baidu.com/pic/%E6%88%91%E6%98%AF%E6%9F%8F%E6%9E%97%E4%BA%BA/2557942/1/960a304e251f95cafbfd23c6c3177f3e670952b1?fr=lemma&amp;fromModule=lemma_top-image&amp;ct=single#aid=1&amp;pic=960a304e251f95cafbfd23c6c3177f3e670952b1\" alt=\"\" /></p>\n<h2 id=\"背景\"><a class=\"anchor\" href=\"#背景\">#</a> 背景</h2>\n<p>苏军在第二次世界大战时攻占柏对德国首都严加控制。起初柏林分为四区，分别由法国、英国、美国和苏联管治 苏军封锁柏林时，美军以空运的方式为柏林居民提供粮食。</p>\n<p>后来，由法英美控制的三区俨然成为西德的外飞地，被东德完全包围。（正式来说，西柏林不属于西德；柏林全市在两德统一前都受盟军军法统治。）1952 年起，东西之间的边境关闭，只有柏林分界仍然开放。成千上万的东德人经西柏林转投西方，流失的劳动力足以使东德经济崩溃。</p>\n<p>1961 年，瓦尔特・乌布利希领导的东德政府在西柏林周围树立了一堵布满尖刺的围墙。东德政府称之为 “反法西斯防卫墙”，声称围墙用于防止西德 “法西斯政权” 的间谍和特工进入东方。这就是柏林墙，全世界绝大部分意见都认为这是用于防止东德市民逃亡。数个月后，围墙改以混凝土建造，“死亡地带” 的建筑物被拆毁，由东德守卫持机枪驻守。柏林墙建立后，柏林从原本东欧移民到西欧最简单的地方变成了最难的地方。1962 年，彼得・费查因尝试越过围墙，成为第一个死在围墙前的东德人。</p>\n<p>包括美国在内的西方阵营被指责没有致力阻止围墙树立。1961 年 7 月 25 日，即美军 4 月猪湾入侵古巴失败后不久，肯尼迪发表总统演说，重申美国拥有 “四国权利”，会坚决防卫西柏林，但同时表示无法阻止苏军继续占领东德。<br />\n<img data-src=\"https://tva1.sinaimg.cn/large/006y8mN6ly1h6vcuhoyz7j31360u0whh.jpg\" alt=\"\" /></p>\n<h2 id=\"译文\"><a class=\"anchor\" href=\"#译文\">#</a> 译文</h2>\n<p>二千年以前，最自豪的夸耀是 “Civis Romanus sum”［“我是罗马公民”］，今天，自由世界最自豪的夸耀是 “Ich bin ein Berliner”［“我是柏林人”］。</p>\n<p><strong>世界上有许多人确实不懂，或者说他们不明白什么是自由世界和共产主义世界的根本分歧。让他们来柏林吧。有些人说，共产主义是未来的潮流。让他们来柏林吧。有些人说，我们能在欧洲或其他地方与共产党人合作。让他们来柏林吧。甚至有那么几个人说，共产主义确是一种邪恶的制度，但它可以使我们取得经济发展。“Lasst sie nach Berlin kommen.”［“让他们到柏林看看”］</strong></p>\n<p><strong>自由有许多困难，民主亦非完美，然而我们从未建造一堵墙把我们的人民关在里面，不准他们离开我们</strong>。我愿意我的同胞们 —— 他们与你们远隔千里住在大西洋彼岸 —— 说，他们为能在远方与你们共有过去十八年的经历感到莫大的骄傲。我不知道还有哪一个城镇或都市被围困十八年仍葆有西柏林的这种生机、力量、希望和决心。全世界都看到，柏林墙最生动最明显地表现出一种失败。但我们对此并不感到称心如意，因为柏林墙既是对历史也是对人性的冒犯，它拆散家庭，造成妻离子散骨肉分离，把希冀统一的一个民族分成两半。</p>\n<p>这个城市的事实也用于整个德国 —— 只要四个德国人中有一个被剥夺了自由人的基本权利，即自由选择的权利，那么欧洲真正持久的和平便绝无可能实现。经过保持和平与善意的十八年，这一代德国人终于赢得自由的权利，包括在持久和平中善所有的人民，实现家庭团聚和民族统一的权利。你们住在受到保护的一座自由之岛上，但你们的生活是大海的一部分。因此让我在结束讲话时请求你们抬起目光，超越今日的危险看到明天的希望；超越这道墙看到正义的生平来临的一天；超越你们自己和我们自己看到全人类。自由是不可分割的，只要一人被奴役，所有的人都不自由。当所有的人都自由了，那时我们便能期待这一天的到来：在和平与希望的光辉中这座城市获得统一，这个国家获得统一，欧洲大陆获得统一。当这一天最终来临 --- 它必将来临 --- 时，西柏林人民将能对这一点感到欣慰：几乎二十年时间里他们站在第一线。</p>\n<p>一切自由人，不论他们住在何方，皆是柏林市民，所以作为一个自由人，我为 “Ich bin ein Berliner” 这句话感到自豪。</p>\n<h2 id=\"原文\"><a class=\"anchor\" href=\"#原文\">#</a> 原文</h2>\n<p>Two thousand years ago the proudest boast － was &quot;Civitas Romanus sum.&quot; Today, in the world of freedom, the proudest boast is &quot;Ich bin ein Berliner.&quot;</p>\n<p>There are many people in the world who really don't understand, or say they don't, what is the great issue between the free world and the Communist world. Let them come to Berlin. There are some who say that Communism is the wave of the future. Let them come to Berlin. And there are some who say in Europe and elsewhere we can work with the Communists. Let them come to Berlin. And there are even a few who say that it is true that Communism is an evil system, but it permits us to make economic progress. &quot;Lasst sie nach Berlin kommen.&quot;</p>\n<p>Freedom has many difficulties and democracy is not perfect, but we have never had to put a wall up to keep our people in, to prevent them from leaving us. I want to say, on behalf of my countrymen, who live many miles away on the other side of the Atlantic, who are far distant from you, that they take the greatest pride that they have been able to share with you, even from a distance, the story of the last eighteen years. I know of no town, no city, that has been besieged for eighteen years that still lives with the vitality and the force, and the hope and the determination of the city of West Berlin. While the wall is the most obvious and vivid demonstration of the failures of the Communist system. for all the world to see, we take no satisfaction in it, for it is an offense not only against history but an offense against humanity, separating families, dividing husbands and wives and brothers and sisters, and dividing a people who wish to be joined together.</p>\n<p>What is true of this city is true of Germany － real, lasting peace in Europe can never be assured as long as one German out of four is denied the elementary right of free men, and that is to make a free choice. In eighteen years of peace and good faith, this generation of Germans has earned the right to be free, including the right to unite their families and their nation in lasting peace with good will to all people. You live in a defended island of freedom, but your life is part of the main. So let me ask you, as I close, to lift your eyes beyond the dangers of today to the hopes of tomorrow, beyond the freedom merely of this city of Berlin, or your country of Germany, to the advance of freedom everywhere, beyond the wall to the day of peace with justice, beyond ourselves and ourselves to all mankind. Freedom is indivisible, and when one man is enslaved, all are not free. When all are free, then we can look forward to that day when this city will be joined as one－ and this country, and this great continent of Europe－ in a peaceful and hopeful glow. When that day finally comes, as it will, the people of West Berlin can take sober satisfaction in the fact that they were in the front lines for almost two decades.</p>\n<p>All free men, wherever they may live, are citizens of Berlin, and, therefore, as a free man, I take pride in the words &quot;Ich bin ein Berliner.&quot;</p>\n<h1 id=\"推倒这堵墙演讲者里根\"><a class=\"anchor\" href=\"#推倒这堵墙演讲者里根\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3poLXNnLyVFNiU4RSVBOCVFNSU4MCU5MiVFOSU4MCU5OSVFNSVBMCVCNSVFNyU4OSU4NiVFRiVCQyU4MQ==\">推倒这堵墙！(演讲者：里根)</span></h1>\n<h2 id=\"背景-2\"><a class=\"anchor\" href=\"#背景-2\">#</a> 背景</h2>\n<p>1961 年，受苏联支持的东德为防止东德人迁往西方，开始建造柏林墙，成为冷战的重要象征 [3]。其后，美国总统约翰・肯尼迪 1963 年在 “我是柏林人” 演说中，表达美国对西德的支持 [4]。</p>\n<p>1980 年代，美国在欧洲布置了短程导弹，军力为和平时期空前之强大，使当时东西方关系极度紧张 [5]。1987 年，里根出席在意大利威尼斯举办的七国峰会后，应邀短暂到访柏林 [6] 。这是他五年来第二次到访柏林。</p>\n<p>选择勃兰登堡门，用意是突显里根的言论：西方民主是打开柏林墙的最佳希望 [2]。演说的重点是以一连串的政治运动达成这个目标；“推倒这堵墙” 用作总结里根提出的各项建议。起草演讲辞时，这句子引起幕僚中相当大的争议。一些高级官员和总统助手提出删去这句子，以免东西方紧张关系加剧，或者使友好的戈尔巴乔夫感到不安。西德的美国官员和总统演辞写手却不表认同；其中，演辞写手彼得・罗宾逊在西德视察演讲场地时，感到大部分西柏林人都反对围墙。虽然没有证据证明里根的确要把围墙拆除，但罗宾逊还是在演讲辞中加入了这句话。5 月 18 日，里根看过演讲辞后，赞赏它写得很好。白宫幕僚长霍华德・贝克不同意，指出它内容 “极端”，不是总统应该说的；国家安全顾问克林・鲍威尔同意贝克的意见。然而，里根很喜欢这段演讲辞，决定保留 [7]。</p>\n<h2 id=\"演说\"><a class=\"anchor\" href=\"#演说\">#</a> 演说</h2>\n<p>1987 年 6 月 12 日，里根和夫人抵达柏林后去到国会大厦，从阳台观看围墙 [8]。当天下午 2 时 20 分，里根受两块防弹玻璃保护，免受东柏林的狙击手袭击，在勃兰登堡门发表演说 [2]。有 45,000 名观众在场观看，包括西德总统里夏德・冯・魏茨泽克、总理赫尔穆特・科尔和西柏林市长埃贝哈德・迪普根 [8]。 演说中最著名的一段是：</p>\n<p>“我们乐见改变和开放；因为我们相信自由与安全并行，人类自由的进步令我们更努力追求世界和平。苏联可以做一件很明显的事，一件大幅促进自由与和平的事。戈尔巴乔夫总书记，如果你要寻求和平，如果你要为苏联和东欧寻求繁荣，如果你要寻求自由：就到这扇门来吧！戈尔巴乔夫先生，打开这扇门！戈尔巴乔夫先生，推倒这堵墙！[8]\t”<br />\n 里根在演说中的尾声说道：“不久之前，我从国会大厦──德国统一的体现──观望，看见围墙上以喷漆粗糙写的字──也许是一位年轻的柏林人写的，‘这堵墙会倒下。信念可成真。’对，这堵墙会在欧洲倒下；因为它抵挡不了信心，它抵挡不了真理，这堵墙抵挡不了自由。”[8]</p>\n<p>演说中的另一个焦点，是里根明确提及 SS-20 核子武器的威胁，呼吁苏联停止军备竞赛，并提出 “不仅是控制军备增长，而是史无前例地移除地球上所有核子武器。”[2]</p>\n<h2 id=\"译文-2\"><a class=\"anchor\" href=\"#译文-2\">#</a> 译文</h2>\n<p>非常感谢。</p>\n<p>科尔总理、迪普根市长、女士们、先生们：</p>\n<p>二十四年前，约翰・F・肯尼迪总统访问了柏林，在市政厅里面对这个城市以及全世界的人民发表了讲话。在那之后，有两位总统访问了柏林。今天，我自己，也第二次来到了你们的城市。</p>\n<p>我们这些美国总统来到柏林，是因为我们有责任在这里为自由呼吁。但是我也必须承认，我们之所以来到这里，还有其他的原因：这个城市历史悠久，比我的国家还要年长 500 岁；格吕讷瓦尔德（Grunewald）和蒂尔加滕（Tiergarten）优美瑰丽，引人入胜；而最主要的原因是，我被你们的勇气和决心所打动。作曲家保罗・林克，也许同我们这些美国总统有着共鸣。你们瞧，就像我之前的许多总统，我今天来到这里，是因为我无论走到哪里，无论我干什么：Ich hab noch einen Koffer in Berlin（我还有个箱子在柏林）。</p>\n<p>我们今天这个集会，正在面向整个西欧和北美进行广播。我知道，在东面，人们也在看着、听着。对那些东欧的倾听者，我有一言相赠：我虽然没有和你们站在一起，但我也在对你们讲话，正如我是在对我面前的这些人们讲话一样。我同你们、你们在西面的同胞一样，都有一个坚定的、不可变更的信念：Es gibt nur ein Berlin（只有一个柏林）。</p>\n<p>在我身后，耸立着一道墙，这堵墙环绕着这个城市的自由之地，它本身也只是分裂了整个欧洲大陆的庞大壁垒的一部分。从波罗的海向南，这个壁垒横裂德国，处处扎满铁丝网，浇筑混凝土，军犬巡逻不休，警戒塔密布。再向南，那里可能没有看得见的墙，但是那里仍然有着武装警卫和检查站 —— 仍然限制着人们的出行自由，仍然把极权主义国家的意志强加于每一个普通男女之上。</p>\n<p>然而，在这里，在柏林，这堵墙把这一点凸显的最为明显。正是在这里，新闻图片和电视屏幕都在全世界人们的心上烙刻着这道横贯你们的城市、分裂整个大陆的伤痕。每一个站在勃兰登堡门前的人都是德国人，同自己的骨肉同胞分离。每一个人都是柏林人，被迫俯视一道伤痕。</p>\n<p>冯・魏茨泽克总统曾经说过：“只要勃兰登堡门还关闭着，德国问题就将存在。” 今天我要说：只要这道门还关闭着，只要这堵墙带来的疤痕仍然被允许存在，那么长存的就不仅仅只是德国问题，还有整个人类的自由问题。我到这里来不是为了哀悼，因为我在柏林找到了一个希望，即使在这堵墙的阴影之下，仍然有着胜利的消息。</p>\n<p>在 1945 年春季，当柏林人民步出隐蔽所的时候，他们发现的是一片狼藉。数千英里之外，美国人民伸出了援手。在 1947 年，正如你们知道的那样，美国国务卿乔治・马歇尔宣布了那个将来会称之为马歇尔计划的援助方案。在四十年前的今天，他说：“我们的政策不针对任何国家、任何主义，我们针对的是饥饿、贫穷、绝望和混乱。”</p>\n<p>稍前时候，在德国国会大厦，我参观了一个纪念马歇尔计划四十周年的展览，在一个曾被熔毁的、正在得到重建的建筑物上，我看到了一个标语，这个标语深深的打动了我。我知道，我这一代的柏林人都还记得，在西柏林，曾经遍布着这样的标语。这个标语是：“为加强自由世界，马歇尔计划在这里伸出援手。” 一个强大的、自由的西方世界，这个梦想变成了现实。日本从废墟中崛起成为一个经济巨人，意大利、法兰西、比利时，几乎每一个西欧国家都见证了政治上和经济上的复兴，欧共体也得以诞生。</p>\n<p>在西德，在柏林，发生了经济奇迹，the Wirtschaftswunder（德国奇迹）。<strong>阿登纳、艾哈德、鲁伊特等领导人深知自由在实践上的重要意义，只有当新闻记者被赋予言论自由之时真相才会浮现，只有农民和商人能够享受到经济自由的时候，繁荣才会到来。德国领导人削减关税，扩大自由贸易，降低税率。仅仅在 1950 年到 1960 年十年间，西德和柏林的生活水准就成倍翻升</strong>。</p>\n<p>在西柏林，四十年前还是一片废墟的地方，现在是德国产出最大的工业区，到处是繁忙的办公区、优良的住宅和公寓、热闹的大街，和不断蔓延的公园草坪。在当年似乎是文化荒漠的地方，现在有两所最好的大学、乐团和一家歌剧院，无数的剧场和博物馆。在过去是匮乏，在现在是极大丰富 —— 食物、衣物、汽车 —— 在库达姆大街上应有尽有。在废墟上，从毁灭处，你们这些柏林人在自由中重建了地球上最伟大的城市之一。苏联人或许有其他的计划，但是我的朋友们，有些东西是苏联人永远指望不上的，那就是柏林人的心灵、柏林人的幽默，和柏林人的刚毛浓眉（Schnauze）。</p>\n<p>在 20 世纪 50 年代，<strong>赫鲁晓夫曾预言：“我们将埋葬你们”。但是在今天的西方，我们看到的是一片前所未有的繁荣和安宁。而在共产主义世界，我们看见了失败，看见了技术上的落后，看见了健康的倒退，看见了即使连最起码的东西 —— 食品 —— 都极度匮乏的情形！即使到了今天，苏联人仍然不能喂饱自己。在四十年之后的今天，在整个世界面前，耸立着一个伟大和必然的结论：自由导致繁荣，自由用礼让和宽容代替了各国之间古老的仇恨。自由是胜利者</strong>！</p>\n<p>现在苏联人自己，可能在某种程度上，也明白了自由的重要性。我们经常从莫斯科听到一些消息，一项改革和开放的新政策已经出台，一些政治犯已经得到释放，某些外国新闻广播不再被屏蔽，一些经济企业已经被允许拥有更多的自主权。</p>\n<p>这些举动是苏联发生巨大转变的开始吗？或者他们仅仅是做出姿态，想要在西方掀起错误的希望，又或者仅仅是企图在不更改苏联体制的前提下修修补补？我们欢迎变化和开放 ，因为我们相信自由和安全相伴，人类自由的进步只会加强世界的和平。这里有一件事是苏联人可以做出来而不至于遭到误解的，这件事将里程碑式的促进人类的自由和和平事业。</p>\n<p>戈尔巴乔夫总书记，如果你真的在寻求和平，如果你真的在寻求苏联和东欧的繁荣昌盛，如果你真的在寻求自由化，那么，到这扇门前来吧。戈尔巴乔夫先生，把这扇门打开！戈尔巴乔夫先生，把这堵墙拆掉！</p>\n<p>我理解战争的恐惧、分离的痛苦折磨着这片大陆，我向你们保证，我的国家会帮助克服这些障碍，为了万无一失，我们自由世界必须抵抗苏联的扩张，因此我们必须保持牢不可破的防御力量。然而我们也在寻求和平，因此我们也必须做出努力来削减双方的军备。</p>\n<p>从十年之前开始，苏联人带来了一种新的致命威胁，挑战着西方联盟，他们部署了数百枚更新式、更致命的 SS-20 核导弹，足以摧毁欧洲每一个都市。西方联盟则以相应的部署以牙还牙，除非苏联人同意进行谈判找到一个更好的解决方式，也就是双方都共同消除这样的武器，否则局面就只好这么僵持下来。</p>\n<p>这么多日子以来，那些苏联人一直拒绝进行诚实的谈判。在我们一方，随着联盟准备进行相应部署，也出现了一些困难的时光，比方说我在 1982 年访问这座城市的时候有许多人起来抗议，比方说苏联人稍后离开了谈判桌。</p>\n<p>但尽管有这些困难，我们的联盟仍然坚持住了，我邀请那时抗议的那些人，<strong>我邀请今天抗议的这些人，来注意到这样一个事实，那就是，因为我们的强硬，苏联人最后又回到了谈判桌上。因为我们的强硬，今天我们能做到的，不仅仅只是期望限制军备的增长，而且还包括这样一种可能，那就是将一整类核武器彻底的从地球上废除掉</strong>。</p>\n<p>当我讲话时，北约的部长们正在冰岛会晤，对这一建议的进展状况进行讨论。在日内瓦会谈中，我们也提出了要对进攻性战略武器进行大的削减。西方联盟已经提出了许多内容深广的提议，来减少发生常规战争的危险，以及彻底禁绝化学武器。</p>\n<p>当我们裁减这些军备的时候，我也向你们保证，我们将保持能力，以阻止苏联在任何层次上发动侵略。我们正在同许多盟友合作对 “战略防御构想” 计划进行研究，不是将威慑构基于威胁报复之上，而是着眼于真正的进行防御。简言之，这套防御体系将不瞄准平民，而是保护他们。通过这种方式，欧洲和全世界的安全将得以增强。</p>\n<p>但是我们必须牢记一个至关重要的事实：东方和西方彼此确信对方，是因为我们手里都有武装，我们有武装，又是因为我们彼此不信任。使东西方意见不同的不是武器本身，而是对自由的不同理解。在肯尼迪总统 24 年前在市政厅演讲时，自由被包围，柏林在围困中。然而今天，尽管敌人对这个城市施加了那么多压力，柏林仍然安全的沐立在自由之光下，自由本身也在改变着整个世界。</p>\n<p>在菲律宾、在南美和中美洲，民主已经获得重生。在整个太平洋地区，<strong>自由市场正在制造一个又一个经济增长的奇迹</strong>。在工业化国家，一次技术革命正在发生，这次技术革命的标志是计算机和电信方面的迅速发展。</p>\n<p>在欧洲，<strong>只有一个国家和它控制的那些卫星国拒绝加入自由阵营</strong>，然而在这个经济成倍增长的时代中，在这个信息与革新的时代中，苏联面临着一个选择：它必须进行根本的改变，否则它将变得过时。</p>\n<p>因此，今天就代表着希望。我们西方准备好与东方进行合作，促进真正的开放，打破分离人们的藩篱，建立一个安全和自由的世界。我想，没有哪个地方比柏林，这个连接东西方人民的地方，更适合作为一个起点。</p>\n<p>柏林的自由人民们，美国今天会像过去一样，坚定的遵守并执行 1971 年的四大国协议。让我们借这个机会，本市的 750 周年纪念日，迎接一个新的时代，建设一个更加充实、更加富裕的柏林。让我们维护并发展联邦德国与西柏林之间的联系，这是 1971 年协议所允许的。</p>\n<p>并且我将邀请戈尔巴乔夫先生：让我们一起为东西柏林的人们多做点工作吧，使它们靠的更紧一点，以便整个柏林的全部居民都能享受到生活在这个世界上最伟大的都市之一所带的来的乐趣。</p>\n<p>要进一步向整个欧洲、东方和西方开放柏林，我们就要扩展进入这个城市的重要空中通道，使通向柏林的商业航空服务更便利、更舒适，也更经济。我们期待着有一天西柏林可以成为整个中欧地区的主要航空枢纽之一。</p>\n<p>同我们的法国和英国同伴一起，美国准备在柏林召开各种国际会议。对柏林这个城市来说，召开联合国会议，或者有关人权、军备控制等等需要国际合作的议题的国际会议，是再合适也不过。</p>\n<p>要为将来带来希望，没有比点亮青年心灵更好的方法。我们将极为荣幸的赞助（东西柏林的）夏季青年交流、各类文化活动，以及为东柏林青年举办的其他活动。我们法国和英国的朋友，我敢肯定，也将这样做。我也希望东柏林当局能够赞助西柏林青年的访问活动。</p>\n<p>我心中最后一个建议是：运动是快乐与高贵之源，您可能会注意到，南韩已经允许 1988 年夏季奥运会的某些赛事在北方举行。各种国际体育比赛也可以在这个城市的两个部分举行。假如在将来的某一年，奥林匹克运动会能够在柏林 —— 东柏林与西柏林 —— 举行，那么还有什么更好的方式，比这，更能向世界展示柏林这个城市的开放呢？</p>\n<p>在这 40 年中，正如我所说，你们柏林人建立了一个伟大的城市。尽管存在着许多威胁 —— 苏联所强加的关口和封锁，你们还是做到了。尽管有这堵墙所隐喻着的挑战，这个城市仍然蓬勃发展。是什么使你们坚持下来？当然有许多原因，比方说你们的毅力，你们抵抗的勇气。但是我相信有些原因更加深邃，涉及到的是柏林整体的观感和生活方式，而不仅仅只是情操。</p>\n<p>没有人能够在柏林生活长久还能满心幻想的，他们看到了柏林生活的困难，但选择接受之，尽管被囚禁着人类活力和希望的极权主义制度所包围，他们仍然继续建设着这个美好的、令人自豪的城市。那是一种强有力的声音，这种声音对这座城市，对未来，对自由大声说 “是”。简言之，我会把这种东西称之为 “爱”—— 深刻而持久的爱。</p>\n<p>也许这就是问题的根源，这就是东西方之间最根本的区别。极权主义的世界生产落后，因为它侵犯这种精神，阻碍了人类去创造、去享受、去感悟的冲动。极权主义的世界，甚至觉得爱和宗教的符号是一种侮辱。</p>\n<p>几年前，当东德开始重建自己的教堂之前，他们建设了一个世俗建筑物：亚历山大广场电视塔。自那以后，东德当局一直在努力纠正（在他们眼中）该塔的一个重大缺陷，往其顶部的玻璃球上倾倒各种涂料和化学物品。然而，只到今天，每当阳光照射到这些玻璃上，阳光还是照射出一个十字架的摸样。在这里，在柏林，爱的符号，礼拜的符号，不会受到压制。</p>\n<p>当我之前从国会大厦 —— 这个德国统一的化身 —— 往外望的时候，我发现了一串喷漆在柏林墙上的话，这可能是一个年轻的柏林人写下来的，“这堵墙终将倒下，梦想终将成为现实。” 是的，整个欧洲，这堵墙终将倒下，因为，它经不起良知的考验，它经不起真理的追问，它经不起自由的期望！</p>\n<p>我想，在结束发言前，还说一句话。我已经知道 —— 我也被问过了 —— 我来到这里的时候，有人举行了一些示威活动。我想对那些示威者说一件事，我不知道他们是否想到，如果他们确实有了他们所希望建立的那种政府，就没有人能够做他们现在在做的那些事情了。</p>\n<p>谢谢大家，上帝保佑你们。</p>\n<h2 id=\"后续\"><a class=\"anchor\" href=\"#后续\">#</a> 后续</h2>\n<p>29 个月后，因应东德的激烈抗议，戈尔巴乔夫允许柏林市民拆卸围墙，苏联不久后也解体了；拆掉围墙成为东欧剧变的重要因素。1990 年 9 月，已卸任美国总统的罗纳德・里根再度去到柏林，亲自举起锤子，象征式敲击柏林墙的遗迹。</p>\n<p>两德统一后首任总统赫尔穆特科尔表示，他永远不会忘记里根站在他身旁，呼吁戈尔巴乔夫推倒柏林墙。科尔说：“他是世界之福，特别是欧洲之福。” 虽然有一些意见认为里根之言对柏林墙坍塌没有帮助，但这篇演说已成为冷战时期的重要一刻。</p>\n<h2 id=\"原文-2\"><a class=\"anchor\" href=\"#原文-2\">#</a> 原文</h2>\n<p>Remarks at the Brandenburg Gate<br />\nWest Berlin, Germany<br />\nJune 12, 1987<br />\nPresident Ronald Reagon:</p>\n<p>Thank you. Thank you, very much.</p>\n<p>Chancellor Kohl, Governing Mayor Diepgen, ladies and gentlemen: Twenty four years ago, President John F. Kennedy visited Berlin, and speaking to the people of this city and the world at the city hall. Well since then two other presidents have come, each in his turn to Berlin. And today, I, myself, make my second visit to your city.</p>\n<p>We come to Berlin, we American Presidents, because it’s our duty to speak in this place of freedom. But I must confess, we’re drawn here by other things as well; by the feeling of history in this city — more than 500 years older than our own nation; by the beauty of the Grunewald and the Tiergarten; most of all, by your courage and determination. Perhaps the composer, Paul Linke, understood something about American Presidents. You see, like so many Presidents before me, I come here today because wherever I go, whatever I do: “Ich hab noch einen Koffer in Berlin” [I still have a suitcase in Berlin.]</p>\n<p>Our gathering today is being broadcast throughout Western Europe and North America. I understand that it is being seen and heard as well in the East. To those listening throughout Eastern Europe, I extend my warmest greetings and the good will of the American people. To those listening in East Berlin, a special word: Although I cannot be with you, I address my remarks to you just as surely as to those standing here before me. For I join you, as I join your fellow countrymen in the West, in this firm, this unalterable belief: Es gibt nur ein Berlin. [There is only one Berlin.]</p>\n<p>Behind me stands a wall that encircles the free sectors of this city, part of a vast system of barriers that divides the entire continent of Europe. From the Baltic South, those barriers cut across Germany in a gash of barbed wire, concrete, dog runs, and guard towers. Farther south, there may be no visible, no obvious wall. But there remain armed guards and checkpoints all the same — still a restriction on the right to travel, still an instrument to impose upon ordinary men and women the will of a totalitarian state.</p>\n<p>Yet, it is here in Berlin where the wall emerges most clearly; here, cutting across your city, where the news photo and the television screen have imprinted this brutal division of a continent upon the mind of the world.</p>\n<p>Standing before the Brandenburg Gate, every man is a German separated from his fellow men.</p>\n<p>Every man is a Berliner, forced to look upon a scar.</p>\n<p>President Von Weizsäcker has said, “The German question is open as long as the Brandenburg Gate is closed.” Well today — today I say: As long as this gate is closed, as long as this scar of a wall is permitted to stand, it is not the German question alone that remains open, but the question of freedom for all mankind.</p>\n<p>Yet, I do not come here to lament. For I find in Berlin a message of hope, even in the shadow of this wall, a message of triumph.</p>\n<p>In this season of spring in 1945, the people of Berlin emerged from their air-raid shelters to find devastation. Thousands of miles away, the people of the United States reached out to help. And in 1947 Secretary of State — as you’ve been told — George Marshall announced the creation of what would become known as the Marshall Plan. Speaking precisely 40 years ago this month, he said: “Our policy is directed not against any country or doctrine, but against hunger, poverty, desperation, and chaos.”</p>\n<p>In the Reichstag a few moments ago, I saw a display commemorating this 40th anniversary of the Marshall Plan. I was struck by a sign — the sign on a burnt-out, gutted structure that was being rebuilt. I understand that Berliners of my own generation can remember seeing signs like it dotted throughout the western sectors of the city. The sign read simply: “The Marshall Plan is helping here to strengthen the free world.” A strong, free world in the West — that dream became real. Japan rose from ruin to become an economic giant. Italy, France, Belgium — virtually every nation in Western Europe saw political and economic rebirth; the European Community was founded.</p>\n<p>In West Germany and here in Berlin, there took place an economic miracle, the Wirtschaftswunder. Adenauer, Erhard, Reuter, and other leaders understood the practical importance of liberty — that just as truth can flourish only when the journalist is given freedom of speech, so prosperity can come about only when the farmer and businessman enjoy economic freedom. The German leaders — the German leaders reduced tariffs, expanded free trade, lowered taxes. From 1950 to 1960 alone, the standard of living in West Germany and Berlin doubled.</p>\n<p>Where four decades ago there was rubble, today in West Berlin there is the greatest industrial output of any city in Germany: busy office blocks, fine homes and apartments, proud avenues, and the spreading lawns of parkland. Where a city’s culture seemed to have been destroyed, today there are two great universities, orchestras and an opera, countless theaters, and museums. Where there was want, today there’s abundance — food, clothing, automobiles — the wonderful goods of the Kudamm.¹ From devastation, from utter ruin, you Berliners have, in freedom, rebuilt a city that once again ranks as one of the greatest on earth. Now the Soviets may have had other plans. But my friends, there were a few things the Soviets didn’t count on: Berliner Herz, Berliner Humor, ja, und Berliner Schnauze. [Berliner heart, Berliner humor, yes, and a Berliner Schnauze.²]</p>\n<p>In the 1950s — In the 1950s Khrushchev predicted: “We will bury you.”</p>\n<p>But in the West today, we see a free world that has achieved a level of prosperity and well-being unprecedented in all human history. In the Communist world, we see failure, technological backwardness, declining standards of health, even want of the most basic kind — too little food. Even today, the Soviet Union still cannot feed itself. After these four decades, then, there stands before the entire world one great and inescapable conclusion: Freedom leads to prosperity. Freedom replaces the ancient hatreds among the nations with comity and peace. Freedom is the victor.</p>\n<p>And now — now the Soviets themselves may, in a limited way, be coming to understand the importance of freedom. We hear much from Moscow about a new policy of reform and openness. Some political prisoners have been released. Certain foreign news broadcasts are no longer being jammed. Some economic enterprises have been permitted to operate with greater freedom from state control.</p>\n<p>Are these the beginnings of profound changes in the Soviet state? Or are they token gestures intended to raise false hopes in the West, or to strengthen the Soviet system without changing it? We welcome change and openness; for we believe that freedom and security go together, that the advance of human liberty — the advance of human liberty can only strengthen the cause of world peace.</p>\n<p>There is one sign the Soviets can make that would be unmistakable, that would advance dramatically the cause of freedom and peace.</p>\n<p>General Secretary Gorbachev, if you seek peace, if you seek prosperity for the Soviet Union and Eastern Europe, if you seek liberalization: Come here to this gate.</p>\n<p>Mr. Gorbachev, open this gate.</p>\n<p>Mr. Gorbachev — Mr. Gorbachev, tear down this wall!</p>\n<p>I understand the fear of war and the pain of division that afflict this continent, and I pledge to you my country’s efforts to help overcome these burdens. To be sure, we in the West must resist Soviet expansion. So, we must maintain defenses of unassailable strength. Yet we seek peace; so we must strive to reduce arms on both sides.</p>\n<p>Beginning 10 years ago, the Soviets challenged the Western alliance with a grave new threat, hundreds of new and more deadly SS-20 nuclear missiles capable of striking every capital in Europe. The Western alliance responded by committing itself to a counter-deployment (unless the Soviets agreed to negotiate a better solution) — namely, the elimination of such weapons on both sides. For many months, the Soviets refused to bargain in earnestness. As the alliance, in turn, prepared to go forward with its counter-deployment, there were difficult days, days of protests like those during my 1982 visit to this city; and the Soviets later walked away from the table.</p>\n<p>But through it all, the alliance held firm. And I invite those who protested then — I invite those who protest today — to mark this fact: Because we remained strong, the Soviets came back to the table. Because we remained strong, today we have within reach the possibility, not merely of limiting the growth of arms, but of eliminating, for the first time, an entire class of nuclear weapons from the face of the earth.</p>\n<p>As I speak, NATO ministers are meeting in Iceland to review the progress of our proposals for eliminating these weapons. At the talks in Geneva, we have also proposed deep cuts in strategic offensive weapons. And the Western allies have likewise made far-reaching proposals to reduce the danger of conventional war and to place a total ban on chemical weapons.</p>\n<p>While we pursue these arms reductions, I pledge to you that we will maintain the capacity to deter Soviet aggression at any level at which it might occur. And in cooperation with many of our allies, the United States is pursuing the Strategic Defense Initiative — research to base deterrence not on the threat of offensive retaliation, but on defenses that truly defend; on systems, in short, that will not target populations, but shield them. By these means we seek to increase the safety of Europe and all the world. But we must remember a crucial fact: East and West do not mistrust each other because we are armed; we are armed because we mistrust each other. And our differences are not about weapons but about liberty. When President Kennedy spoke at the City Hall those 24 years ago, freedom was encircled; Berlin was under siege. And today, despite all the pressures upon this city, Berlin stands secure in its liberty. And freedom itself is transforming the globe.</p>\n<p>In the Philippines, in South and Central America, democracy has been given a rebirth. Throughout the Pacific, free markets are working miracle after miracle of economic growth. In the industrialized nations, a technological revolution is taking place, a revolution marked by rapid, dramatic advances in computers and telecommunications.</p>\n<p>In Europe, only one nation and those it controls refuse to join the community of freedom. Yet in this age of redoubled economic growth, of information and innovation, the Soviet Union faces a choice: It must make fundamental changes, or it will become obsolete.</p>\n<p>Today, thus, represents a moment of hope. We in the West stand ready to cooperate with the East to promote true openness, to break down barriers that separate people, to create a safer, freer world. And surely there is no better place than Berlin, the meeting place of East and West, to make a start.</p>\n<p>Free people of Berlin: Today, as in the past, the United States stands for the strict observance and full implementation of all parts of the Four Power Agreement of 1971. Let us use this occasion, the 750th anniversary of this city, to usher in a new era, to seek a still fuller, richer life for the Berlin of the future. Together, let us maintain and develop the ties between the Federal Republic and the Western sectors of Berlin, which is permitted by the 1971 agreement.</p>\n<p>And I invite Mr. Gorbachev: Let us work to bring the Eastern and Western parts of the city closer together, so that all the inhabitants of all Berlin can enjoy the benefits that come with life in one of the great cities of the world.</p>\n<p>To open Berlin still further to all Europe, East and West, let us expand the vital air access to this city, finding ways of making commercial air service to Berlin more convenient, more comfortable, and more economical. We look to the day when West Berlin can become one of the chief aviation hubs in all central Europe.</p>\n<p>With — With our French — With our French and British partners, the United States is prepared to help bring international meetings to Berlin. It would be only fitting for Berlin to serve as the site of United Nations meetings, or world conferences on human rights and arms control, or other issues that call for international cooperation.</p>\n<p>There is no better way to establish hope for the future than to enlighten young minds, and we would be honored to sponsor summer youth exchanges, cultural events, and other programs for young Berliners from the East. Our French and British friends, I’m certain, will do the same. And it’s my hope that an authority can be found in East Berlin to sponsor visits from young people of the Western sectors.</p>\n<p>One final proposal, one close to my heart: Sport represents a source of enjoyment and ennoblement, and you may have noted that the Republic of Korea — South Korea — has offered to permit certain events of the 1988 Olympics to take place in the North. International sports competitions of all kinds could take place in both parts of this city. And what better way to demonstrate to the world the openness of this city than to offer in some future year to hold the Olympic games here in Berlin, East and West.</p>\n<p>In these four decades, as I have said, you Berliners have built a great city. You’ve done so in spite of threats — the Soviet attempts to impose the East-mark, the blockade. Today the city thrives in spite of the challenges implicit in the very presence of this wall. What keeps you here? Certainly there’s a great deal to be said for your fortitude, for your defiant courage. But I believe there’s something deeper, something that involves Berlin’s whole look and feel and way of life — not mere sentiment. No one could live long in Berlin without being completely disabused of illusions. Something, instead, that has seen the difficulties of life in Berlin but chose to accept them, that continues to build this good and proud city in contrast to a surrounding totalitarian presence, that refuses to release human energies or aspirations, something that speaks with a powerful voice of affirmation, that says “yes” to this city, yes to the future, yes to freedom. In a word, I would submit that what keeps you in Berlin — is “love.”</p>\n<p>Love both profound and abiding.</p>\n<p>Perhaps this gets to the root of the matter, to the most fundamental distinction of all between East and West. The totalitarian world produces backwardness because it does such violence to the spirit, thwarting the human impulse to create, to enjoy, to worship. The totalitarian world finds even symbols of love and of worship an affront.</p>\n<p>Years ago, before the East Germans began rebuilding their churches, they erected a secular structure: the television tower at Alexander Platz. Virtually ever since, the authorities have been working to correct what they view as the tower’s one major flaw: treating the glass sphere at the top with paints and chemicals of every kind. Yet even today when the sun strikes that sphere, that sphere that towers over all Berlin, the light makes the sign of the cross. There in Berlin, like the city itself, symbols of love, symbols of worship, cannot be suppressed.</p>\n<p>As I looked out a moment ago from the Reichstag, that embodiment of German unity, I noticed words crudely spray-painted upon the wall, perhaps by a young Berliner (quote):</p>\n<p>“This wall will fall. Beliefs become reality.”</p>\n<p>Yes, across Europe, this wall will fall, for it cannot withstand faith; it cannot withstand truth. The wall cannot withstand freedom.</p>\n<p>And I would like, before I close, to say one word. I have read, and I have been questioned since I’ve been here about certain demonstrations against my coming. And I would like to say just one thing, and to those who demonstrate so. I wonder if they have ever asked themselves that if they should have the kind of government they apparently seek, no one would ever be able to do what they’re doing again.</p>\n<p>Thank you and God bless you all. Thank you.</p>\n",
            "tags": []
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/09/10/when-I-was-young/",
            "url": "https://limxtop1989.github.io/limxtop/2022/09/10/when-I-was-young/",
            "title": "钱很重要么？",
            "date_published": "2022-09-10T11:41:17.000Z",
            "content_html": "<p>年轻的时候，总以为钱很重要。<br />\n长大以后，才发觉，那时还是太年轻。<br />\n生活不仅有眼前的苟且，还有诗和远方。<br />\n但也需要一路的盘缠。</p>\n",
            "tags": [
                "钱，年轻"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/09/10/Java-IO/",
            "url": "https://limxtop1989.github.io/limxtop/2022/09/10/Java-IO/",
            "title": "Java IO",
            "date_published": "2022-09-10T02:18:36.000Z",
            "content_html": "<h1 id=\"inputstream\"><a class=\"anchor\" href=\"#inputstream\">#</a> InputStream</h1>\n<p>InputStream: 输入流的抽象，提供应用程从内存读取任意字节数（read 指针向后偏移），跳过，标记流位置（标记一个索引位置，reset 后，read 指针会重置为 mark 的值），流剩余字节数的 API。<br />\n<img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h61dub1vbaj20pq08o3z5.jpg\" alt=\"data_structure\" /></p>\n<p><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h63mdvxjnlj20n30degng.jpg\" alt=\"input_stream_class_diagram\" /></p>\n<ol>\n<li>FilterInputStream: 算是装饰者，包装或者聚合了 <code>InputStream</code> ，使用它作为基本的数据源。覆盖 <code>InputStream</code>  所有方法，简单的把方法调用转发给 <code>InputStream</code> 。</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>a   </span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">InputStream</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Closeable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">volatile</span> <span class=\"token class-name\">InputStream</span> in<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     * Creates a &lt;code>FilterInputStream&lt;/code></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     * by assigning the  argument &lt;code>in&lt;/code></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     * to the field &lt;code>this.in&lt;/code> so as</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     * to remember it for later use.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     * @param   in   the underlying input stream, or &lt;code>null&lt;/code> if</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     *          this instance is to be created without an underlying stream.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token class-name\">FilterInputStream</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">InputStream</span> in<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>in <span class=\"token operator\">=</span> in<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>ByteArrayInputStream: 内部使用字节数组  <code>byte buf[]</code>  作为直接流数据源，每一次 read，都从 buf 读取数据。</li>\n<li>BufferedInputStream: 内部也使用字节数组  <code>byte buf[]</code> ，不过它是代理的角色， 实际的数据流是类的聚合字段 <code>InputStream in</code> ，每一次 read 都是从 buf 读取数据，buf 数据读完，会从 <code>in</code>  预读取一块数据填充  <code>buf</code> 。<br />\n一般而言，当我们使用 File 作为数据源的时候，需要配合 <code>BufferedInputStream</code>  使用 <code>new BufferedInputStream(new BufferedInputStream())</code> ，一次读取文件系统的一大块数据（涉及磁盘旋转等耗时物理操作），然后应用程序可以一次一次读取小块数据，提高性能。</li>\n<li>FileInputStream: 使用文件系统的文件作为流数据源，读取其原始的字节数据，如果要读取字符流，考虑使用 <code>FileReader</code></li>\n</ol>\n<blockquote>\n<p>A FileInputStream obtains input bytes from a file in a file system. FileInputStream is meant for reading streams of raw bytes such as image data. For reading streams of characters, consider using FileReader.</p>\n</blockquote>\n<ol start=\"5\">\n<li>ObjectInputStream: An ObjectInputStream deserializes primitive data and objects previously written using an ObjectOutputStream.</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ObjectStreamDemo</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token class-name\">FileOutputStream</span> fos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"t.tmp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token class-name\">ObjectOutputStream</span> oos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectOutputStream</span><span class=\"token punctuation\">(</span>fos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">writeInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">12345</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Today\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token class-name\">FileInputStream</span> fis <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileInputStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"t.tmp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token class-name\">ObjectInputStream</span> ois <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectInputStream</span><span class=\"token punctuation\">(</span>fis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> ois<span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">String</span> today <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> ois<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token class-name\">Date</span> date <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Date</span><span class=\"token punctuation\">)</span> ois<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        ois<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>SequenceInputStream: 代表多个 <code>InputStream</code>  的逻辑拼接 <code>Enumeration&lt;? extends InputStream&gt; e</code> 。程序开始时读取数组第一个 <code>InputStream</code>  元素，读完流数据，继续读第二个元素，如此反复。</li>\n</ol>\n<blockquote>\n<p>A SequenceInputStream represents the logical concatenation of other input streams. It starts out with an ordered collection of input streams and reads from the first one until end of file is reached, whereupon it reads from the second one, and so on, until end of file is reached on the last of the contained input streams.</p>\n</blockquote>\n<ol start=\"7\">\n<li>PushbackInputStream: 在 <code>read</code>  的基础上，支持 <code>unread</code> ，程序可以提前读取后续的字节，看看是什么数据，然后 <code>unread</code>  回到原来的状态，决定如何 <code>read</code> 。类似 <code>mark &amp; reset</code> ，不同之处是 unread 额外提供数据（可能是上一次 read 的，也可能是别的）， 覆盖 reset 区域。</li>\n<li>PipedInputStream: 管道输入流必须和管道输出流连接，一般是一个线程从管道输入流读取数据，这些数据是另一个线程往管道输入流写入。单一线程使用管道输入输出流是不推荐的。PipedInputStream 构造时，传入管道输出流，并和它建立连接。</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PipedInputStream</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">InputStream</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">PipedInputStream</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PipedOutputStream</span> src<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> pipeSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>         <span class=\"token function\">initPipe</span><span class=\"token punctuation\">(</span>pipeSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>         <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PipedOutputStream</span> src<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        src<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PipedOutputStream</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">OutputStream</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PipedInputStream</span> snk<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>snk <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sink <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> snk<span class=\"token punctuation\">.</span>connected<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Already connected\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        sink <span class=\"token operator\">=</span> snk<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        snk<span class=\"token punctuation\">.</span>in <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        snk<span class=\"token punctuation\">.</span>out <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        snk<span class=\"token punctuation\">.</span>connected <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>管道输出流写入数据时，向管道输入流发送接收的消息。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PipedOutputStream</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">OutputStream</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> b<span class=\"token punctuation\">)</span>  <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sink <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Pipe not connected\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        sink<span class=\"token punctuation\">.</span><span class=\"token function\">receive</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>管道输入流接收管道输出流的数据，保存在  <code>buffer[in++]</code></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PipedInputStream</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">InputStream</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">receive</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> b<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token function\">checkStateForReceive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        writeSide <span class=\"token operator\">=</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>in <span class=\"token operator\">==</span> out<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token function\">awaitSpace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>in <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            in <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            out <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        buffer<span class=\"token punctuation\">[</span>in<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>b <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>in <span class=\"token operator\">>=</span> buffer<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            in <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     * The index of the position in the circular buffer at which the</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     * next byte of data will be stored when received from the connected</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     * piped output stream. &lt;code>in&amp;lt;0&lt;/code> implies the buffer is empty,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     * &lt;code>in==out&lt;/code> implies the buffer is full</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>     * @since   JDK1.1</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">int</span> in <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>     * The index of the position in the circular buffer at which the next</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     * byte of data will be read by this piped input stream.</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     * @since   JDK1.1</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">int</span> out <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h61jgeoakgj20m207e3yy.jpg\" alt=\"\" /><br />\n管道输入流维护写入，读出的下标索引，应用程序 <code>read</code> ，就从 buffer 读取数据 <code>int ret = buffer[out++] &amp; 0xFF;</code></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PipedInputStream</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">InputStream</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">int</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>connected<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Pipe not connected\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>closedByReader<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Pipe closed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>writeSide <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>writeSide<span class=\"token punctuation\">.</span><span class=\"token function\">isAlive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                   <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>closedByWriter <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>in <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Write end dead\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        readSide <span class=\"token operator\">=</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">int</span> trials <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>in <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>closedByWriter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token comment\">/* closed by writer, return EOF */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>writeSide <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>writeSide<span class=\"token punctuation\">.</span><span class=\"token function\">isAlive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">--</span>trials <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Pipe broken\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token comment\">/* might be a writer waiting */</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token function\">notifyAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>InterruptedIOException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">int</span> ret <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">[</span>out<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>out <span class=\"token operator\">>=</span> buffer<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            out <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>in <span class=\"token operator\">==</span> out<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token comment\">/* now empty */</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            in <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"9\">\n<li>LineNumberInputStream: 读取字节如果是 A carriage-return character or a carriage return followed by a newline character 则 lineNumber 递增计数。应用程序可以通过 <code>java.io.LineNumberInputStream#getLineNumber</code>  获取行号记录。</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LineNumberInputStream</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">FilterInputStream</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> pushBack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            pushBack <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            c <span class=\"token operator\">=</span> in<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          <span class=\"token keyword\">case</span> <span class=\"token string\">'\\r'</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            pushBack <span class=\"token operator\">=</span> in<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pushBack <span class=\"token operator\">==</span> <span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                pushBack <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          <span class=\"token keyword\">case</span> <span class=\"token string\">'\\n'</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            lineNumber<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token string\">'\\n'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">return</span> c<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"10\">\n<li>DataInputStream: 和 ObjectInputStream 类似，区别在于它只支持读取基本数据类型。</li>\n</ol>\n<blockquote>\n<p>A data input stream lets an application read primitive Java data types from an underlying input stream in a machine-independent way. An application uses a data output stream to write data that can later be read by a data input stream.</p>\n</blockquote>\n<ol start=\"11\">\n<li>SocketInputStream: socket 通信时，系统分配一个 fd 给接收端，用于接收数据。应用程序通过系统读文件的系统调用，就可以读取 fd 的数据了。</li>\n</ol>\n<blockquote>\n<p>This stream extends FileInputStream to implement a SocketInputStream. Note that this class should NOT be public.</p>\n</blockquote>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">SocketInputStream</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">FileInputStream</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">int</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span> b<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> off<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> length<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> timeout<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">int</span> n<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// EOF already encountered</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>eof<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// ignore</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// acquire file descriptor and do the read</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token class-name\">FileDescriptor</span> fd <span class=\"token operator\">=</span> impl<span class=\"token punctuation\">.</span><span class=\"token function\">acquireFD</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            n <span class=\"token operator\">=</span> <span class=\"token function\">socketRead</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> off<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">,</span> timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token keyword\">return</span> n<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ConnectionResetException</span> rstExc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            gotReset <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            impl<span class=\"token punctuation\">.</span><span class=\"token function\">releaseFD</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\">// ignore</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        eof <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"13\">\n<li>CheckedInputStream: 维护一个读取数据的校验和功能，可以验证输入数据的完整性。</li>\n</ol>\n<blockquote>\n<p>An input stream that also maintains a checksum of the data being read. The checksum can then be used to verify the integrity of the input data.</p>\n</blockquote>\n<h1 id=\"outputstream\"><a class=\"anchor\" href=\"#outputstream\">#</a> OutputStream</h1>\n<p><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h63mf0qgkqj20la0dw3zx.jpg\" alt=\"output_stream_class_diagram\" /><br />\n 输出流总体上和输入流类似，只是方向相反。比如 <code>BufferedOutputStream</code>  有字节缓冲区 <code>byte buf[]</code> ，接收应用程序的写入，当缓冲区写满了，就调用装饰的输出流 <code>OutputStream out</code> 。 <code>PrintStream</code>  比较特殊，涉及到 <code>Writer</code> ，我们放到 <code>Writer</code>  部分展开。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">BufferedOutputStream</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">FilterOutputStream</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     * Writes the specified byte to this buffered output stream.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     * @param      b   the byte to be written.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     * @exception  IOException  if an I/O error occurs.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> b<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>count <span class=\"token operator\">>=</span> buf<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token function\">flushBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        buf<span class=\"token punctuation\">[</span>count<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span>b<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"reader\"><a class=\"anchor\" href=\"#reader\">#</a> Reader</h1>\n<p><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h63mgxpb3oj20nd0c875q.jpg\" alt=\"reader_class_diagram\" /><br />\n 一次读取 <code>InputStream</code>  的两个字节，并使用指定的字符集解析成对应字符。Java 中一个 <code>char</code>  占用 2 <code>byte</code> ，但对于 UTF-8 字符集，它的编码长度是可变的，用 1`byte・来编码常见字符。</p>\n<blockquote>\n<p>A char represents a character in Java (*). It is 2 bytes large (or 16 bits).<br />\nThat doesn't necessarily mean that every representation of a character is 2 bytes long. In fact many character encodings only reserve 1 byte for every character (or use 1 byte for the most common characters).</p>\n</blockquote>\n<ol>\n<li>InputStreamReader:  作为字节流到字符流的桥接，读取一个或者多个字节，使用字符集解码成对应的字符。使用装饰者模式实现，解码工作由 <code>StreamDecoder</code>  完成。</li>\n</ol>\n<blockquote>\n<p>An InputStreamReader is a bridge from byte streams to character streams: It reads bytes and decodes them into characters using a specified charset. The charset that it uses may be specified by name or may be given explicitly, or the platform's default charset may be accepted.<br />\nEach invocation of one of an InputStreamReader's read() methods may cause one or more bytes to be read from the underlying byte-input stream. To enable the efficient conversion of bytes to characters, more bytes may be read ahead from the underlying stream than are necessary to satisfy the current read operation.<br />\nFor top efficiency, consider wrapping an InputStreamReader within a BufferedReader. For example:<br />\n <code>BufferedReader in = new BufferedReader(new InputStreamReader(System.in));</code></p>\n</blockquote>\n<ol start=\"2\">\n<li>FileReader: 实现很言简意赅和巧妙的令人叹为观止。提供 <code>FileInputStream</code>  给 <code>InputStreamReader</code>  作字节流数据源，就完事了，整个类才三个重载的构造器。</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FileReader</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">InputStreamReader</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    * Creates a new &lt;tt>FileReader&lt;/tt>, given the name of the</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    * file to read from.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    * @param fileName the name of the file to read from</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    * @exception  FileNotFoundException  if the named file does not exist,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    *                   is a directory rather than a regular file,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    *                   or for some other reason cannot be opened for</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    *                   reading.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> fileName<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">FileNotFoundException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">FileInputStream</span><span class=\"token punctuation\">(</span>fileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>BufferedReader: 也是使用装饰者模式。内部定义一个缓冲区，一次性读取源字符流一大块字符，以此对外提供字符流。</li>\n<li>FilterReader: 同样是装饰者模式。里面啥也没做，所有的消息都转发给被装饰者，即内部的 <code>Reader</code> .</li>\n<li>PushbackReader: 撤销读的实现很巧妙，使用 <code>char[] buf;</code>  并且索引 <code>pos</code>  初始为 size，unread 的字符写在这里，后续的读优先从这里读，里面如果没有数据，再从被装饰的 <code>Reader</code>  读。</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PushbackReader</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">FilterReader</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">/** Pushback buffer */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">char</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> buf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">/** Current position in buffer */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> pos<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     * Creates a new pushback reader with a pushback buffer of the given size.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     * @param   in   The reader from which characters will be read</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     * @param   size The size of the pushback buffer</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     * @exception IllegalArgumentException if &#123;@code size &lt;= 0&#125;</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">PushbackReader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Reader</span> in<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"size &lt;= 0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>buf <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">char</span><span class=\"token punctuation\">[</span>size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pos <span class=\"token operator\">=</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>StringReader: 使用字符串作为字符流的数据源。</li>\n<li>CharArrayReader: 使用字符数组作为字符流的数据源，里面的实现就全都是数组操作了。</li>\n<li>PipedWriter: 与 <code>PipedInputStream</code>  类似，只是 API 接口参数从 <code>byte</code>  换成了  <code>char</code> 。</li>\n<li>LineNumberReader: 增加字符流里的行号识别功能。</li>\n</ol>\n<h1 id=\"writer\"><a class=\"anchor\" href=\"#writer\">#</a> Writer</h1>\n<p>与 <code>Reader</code>  方向相反，和 <code>OutputStream</code>  类似，不再赘述。<br />\n<img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h63mhs54j9j20in0gbq4c.jpg\" alt=\"write_class_diagram\" /></p>\n<h1 id=\"randomaccessfile\"><a class=\"anchor\" href=\"#randomaccessfile\">#</a> RandomAccessFile</h1>\n<p>把文件当成一个 <code>byte[]</code> ，支持同时读写操作，读写指针做相应偏移。<br />\n<img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h63mlwea47j20oi09sq3m.jpg\" alt=\"\" /></p>\n<p><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h63mjpax45j206p05e3yk.jpg\" alt=\"random_class_diagram\" /></p>\n",
            "tags": [
                "Java, IO, 源码"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/08/19/android-touch-event/",
            "url": "https://limxtop1989.github.io/limxtop/2022/08/19/android-touch-event/",
            "title": "Android Touch Event Dispatch",
            "date_published": "2022-08-19T14:42:18.000Z",
            "content_html": "<h1 id=\"return-true-at-ontouchevent-of-the-child-view-during-action-down\"><a class=\"anchor\" href=\"#return-true-at-ontouchevent-of-the-child-view-during-action-down\">#</a> Return true at onTouchEvent of the child view during action down</h1>\n<p><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h5cgobq43vj20u40u0n18.jpg\" alt=\"touch down\" /><br />\nThe subsequent move and up actions will be dispatched to the child view directly, but the parent views still have a chance to intercept the actions.<br />\n<img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h5ch3isl8pj20u00uwdk6.jpg\" alt=\"\" /></p>\n<p>Once the parent views intercept the touch event during move action by return true at  <code>onInterceptToucheEvent</code></p>\n<p><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h5chap23ivj20vs0u042q.jpg\" alt=\"\" /><br />\na cancel event is generated and dispatched to the intercepted child view, in the mean while, the subsequent move and up actions will be dispatched to parent view directly rather than the child view.<br />\n<img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h5ch8wfx5cj20u00uctcw.jpg\" alt=\"\" /></p>\n<h1 id=\"return-false-at-ontouchevent-the-child-view-during-action-down\"><a class=\"anchor\" href=\"#return-false-at-ontouchevent-the-child-view-during-action-down\">#</a> Return false at onTouchEvent the child view during action down</h1>\n<p><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h5ch5h9serj20wl0u0jvn.jpg\" alt=\"\" /><br />\nThe subsequent move and up actions will not be dispatched to the child view any more.<br />\n<img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h5ch6if7mdj20u00uyq73.jpg\" alt=\"\" /></p>\n",
            "tags": [
                "Android, Touch Event Dispatch, 触摸事件派发"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/07/24/Android-animation-principles/",
            "url": "https://limxtop1989.github.io/limxtop/2022/07/24/Android-animation-principles/",
            "title": "Android 动画原理",
            "date_published": "2022-07-24T14:42:18.000Z",
            "content_html": "<h1 id=\"动画原理\"><a class=\"anchor\" href=\"#动画原理\">#</a> 动画原理</h1>\n<p>动画的本质是，物体随着时间，从初始值到最终值的连续变化。所以，定义一个动画有三个要素，动画时间即 duration，动画初始和最终值。最基础原始的关系是动画时间和动画值成正比例。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mfrac><mi>t</mi><mrow><mi>d</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>A</mi><mi>n</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow><mrow><mi>e</mi><mi>n</mi><mi>d</mi><mo>−</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mfrac></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(1)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\frac{t}{duration} = \\frac{AnimateValue}{end - start} \\tag{1}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.9780799999999998em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.29208em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.14077em;vertical-align:-0.7693300000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.37144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">t</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7693300000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span><span class=\"tag\"><span class=\"strut\" style=\"height:2.14077em;vertical-align:-0.7693300000000001em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h4iysbvgfbj20ja07emxg.jpg\" alt=\"\" /></p>\n<h1 id=\"keyframe扩展\"><a class=\"anchor\" href=\"#keyframe扩展\">#</a> KeyFrame 扩展</h1>\n<p>在 Android 内部实现上，会将初始值到最终值切分成诸多在动画时间轴均匀分布的关键帧 KeyFrame，这个类有两个重要成员变量：</p>\n<ol>\n<li>mFraction：当前关键帧对应动画时间与 duration 的比值。</li>\n<li>mValue：在当前动画时间比时，物体的状态值，它由下一个关键帧值 - 上一个关键帧值，按 mFraction / 时间差的比值计算得出。</li>\n</ol>\n<p>抽象来看，公式<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 中，start &amp; end 对应起始关键帧：KF (0, start) 和结束关键帧: KF (1, end)。但如果只有这两个关键帧，物体就只能介于这两个关键帧的动画值之间线性变化，为了支持动画值可以挣脱这个局限，动画框架提供了关键帧的 API，指定某关键帧（mFraction, mValue），其中 mValue 可以在 [start, end] 之外。也可以提供关键帧计算函数，实现曲线运动轨迹而非线段。为此动画时间轴上 t 时，对应的动画值 V 计算方法扩展为：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mfrac><mrow><mfrac><mi>t</mi><mrow><mi>d</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow></mfrac><mo>−</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>m</mi><mi>F</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mrow><mi>n</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>m</mi><mi>F</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>−</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>v</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>m</mi><mi>F</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>A</mi><mi>n</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow><mrow><mi>n</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>−</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>v</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow></mfrac></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(2)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\frac{\\frac{t}{duration} - preKF.mFraction}{nextKF.mFraction - prevKF.mFraction} = \\frac{AnimateValue}{nextKF.value - prevKF.value} \\tag{2}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.4399960000000003em;vertical-align:-0.8804400000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.5595560000000002em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.7350000000000003em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.824556em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8804400000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.25188em;vertical-align:-0.8804400000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.37144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8804400000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span><span class=\"tag\"><span class=\"strut\" style=\"height:2.4399960000000003em;vertical-align:-0.8804400000000001em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">2</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p>它根据<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mi>t</mi><mrow><mi>d</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\frac{t}{duration}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.169556em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.824556em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span> 和 KeyFrame.mFraction 相比较大小，计算位于哪两个 KeyFrame 区间，应用公式<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>。随着动画时间流逝，就可以在所有的 KeyFrame 应用公式<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 了。</p>\n<table>\n<thead>\n<tr>\n<th>KeyFrame.mFraction &amp; mValue 均匀线性分布</th>\n<th>KeyFrame.mFraction 线性，mValue 曲线分布</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h4iysdp4pyj20eu09s0t2.jpg\" style=\"zoom:50%;\" /></td>\n<td><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h4iysgpbj1j20es09qweu.jpg\" style=\"zoom:50%;\" /></td>\n</tr>\n</tbody>\n</table>\n<p>注：右侧第四个红点挪到 end 右侧，动画轨迹就可以越出 end 的范围了。</p>\n<h1 id=\"变速扩展\"><a class=\"anchor\" href=\"#变速扩展\">#</a> 变速扩展</h1>\n<p>为支持非匀速动画，使用 Interpolator 将 t 篡改， <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mrow><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow><mrow><mi>d</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\frac{Interpolator(t)}{duration}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.355em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.01em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.485em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，转换成别的比例。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mfrac><mrow><mfrac><mrow><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow><mrow><mi>d</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow></mfrac><mo>−</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>m</mi><mi>F</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mrow><mi>n</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>m</mi><mi>F</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>−</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>v</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>m</mi><mi>F</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>A</mi><mi>n</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow><mrow><mi>n</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>−</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>v</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow></mfrac></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(3)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\frac{\\frac{Interpolator(t)}{duration} - preKF.mFraction}{nextKF.mFraction - prevKF.mFraction} = \\frac{AnimateValue}{nextKF.value - prevKF.value} \\tag{3}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.62544em;vertical-align:-0.8804400000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.745em;\"><span style=\"top:-2.324em;\"><span class=\"pstrut\" style=\"height:3.01em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span></span></span><span style=\"top:-3.2399999999999998em;\"><span class=\"pstrut\" style=\"height:3.01em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.745em;\"><span class=\"pstrut\" style=\"height:3.01em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.01em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.485em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8804400000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.25188em;vertical-align:-0.8804400000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.37144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8804400000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span><span class=\"tag\"><span class=\"strut\" style=\"height:2.62544em;vertical-align:-0.8804400000000001em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">3</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo><mtext> where </mtext><mi>t</mi><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">Interpolator(t)\\text{ where } t\\in[0, 1]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mord text\"><span class=\"mord\"> where </span></span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">]</span></span></span></span> 其实就是一个函数，输入原始时间 t，输出篡改后的时间，约束是 Interpolator (0) = 0 &amp;&amp; Interpolator (1) = 1。由于 AnimateValue 是 t 的函数，变速动画成为可能，且容易实现。比如未引入 Interpolator 概念的公式，AnimateValue 和 t 是等比关系，只能是匀速动画，是 Interpolator (t) = t 这一特例，但它可以做的更多，比如匀加速，匀减速…… 具体是怎么变速，AnimateValue 对 t 一阶求导可以得到速度，二阶求导可以得到加速度，这样描述应该可以更容易理解。</p>\n<table>\n<thead>\n<tr>\n<th>匀速运动 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">Interpolator(t) = t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span></th>\n<th>匀加速<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><msup><mi>t</mi><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">Interpolator(t) = t^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></th>\n<th>匀减速<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mn>1</mn><mo>−</mo><mo stretchy=\"false\">(</mo><mi>t</mi><mo>−</mo><mn>1</mn><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">Interpolator(t) = 1 - ( t - 1 ) ^ 2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h4xgm0wy7kj20fm0fiaap.jpg\" style=\"zoom:50%;\" /></td>\n<td><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h4xgqhibukj20iy0fmq3t.jpg\" style=\"zoom:50%;\" /></td>\n<td><img data-src=\"https://tva1.sinaimg.cn/large/e6c9d24egy1h4xgqwcxudj20j00fmdgl.jpg\" style=\"zoom:50%;\" /></td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"向量扩展\"><a class=\"anchor\" href=\"#向量扩展\">#</a> 向量扩展</h1>\n<p>对于有些动画值，并非标量，不能简单的如：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi><mi>f</mi><mn>2.</mn><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>−</mo><mi>k</mi><mi>f</mi><mn>1.</mn><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi></mrow><annotation encoding=\"application/x-tex\">kf2.value - kf1.value</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\">2</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\">1</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span></span></span></span> 直接相减，因此引入 Evaluator，从其方法签名 <code>evaluate(float fraction, Object startValue, Object endValue)</code> ，fraction 参数值为<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn></mrow><annotation encoding=\"application/x-tex\">3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">3</span></span></span></span> 的左值，可以看出其职责为，计算出 startValue 和 endValue 之间，fraction 所对应的动画值。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mi>A</mi><mi>n</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>=</mo><mi>e</mi><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>a</mi><mi>t</mi><mi>e</mi><mo stretchy=\"false\">(</mo><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo separator=\"true\">,</mo><mtext> </mtext><mi>p</mi><mi>r</mi><mi>e</mi><mi>v</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo separator=\"true\">,</mo><mtext> </mtext><mi>n</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>K</mi><mi>F</mi><mi mathvariant=\"normal\">.</mi><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo stretchy=\"false\">)</mo></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(4)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">AnimateValue = evaluate(fraction, \\ prevKF.value, \\ nextKF.value) \\tag{4}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mpunct\">,</span><span class=\"mspace\"> </span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mpunct\">,</span><span class=\"mspace\"> </span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mclose\">)</span></span><span class=\"tag\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">4</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p>以颜色值为例</p>\n<pre><code class=\"language-javaj\">public Object evaluate(float fraction, Object startValue, Object endValue) &#123;\n    int startInt = (Integer) startValue;\n    int startA = (startInt &gt;&gt; 24) &amp; 0xff;\n    int startR = (startInt &gt;&gt; 16) &amp; 0xff;\n    int startG = (startInt &gt;&gt; 8) &amp; 0xff;\n    int startB = startInt &amp; 0xff;\n\n    int endInt = (Integer) endValue;\n    int endA = (endInt &gt;&gt; 24) &amp; 0xff;\n    int endR = (endInt &gt;&gt; 16) &amp; 0xff;\n    int endG = (endInt &gt;&gt; 8) &amp; 0xff;\n    int endB = endInt &amp; 0xff;\n\n    return (int)((startA + (int)(fraction * (endA - startA))) &lt;&lt; 24) |\n        (int)((startR + (int)(fraction * (endR - startR))) &lt;&lt; 16) |\n        (int)((startG + (int)(fraction * (endG - startG))) &lt;&lt; 8) |\n        (int)((startB + (int)(fraction * (endB - startB))));\n  &#125;\n</code></pre>\n<h1 id=\"多属性动画\"><a class=\"anchor\" href=\"#多属性动画\">#</a> 多属性动画</h1>\n<p>诸多关键帧只能描述单一对象的动画轨迹，将属性和其对应的关键帧封装为 PropertyValuesHolder，使得能够支持多个动画对象的多个属性同时动画。</p>\n<h1 id=\"动画引擎\"><a class=\"anchor\" href=\"#动画引擎\">#</a> 动画引擎</h1>\n<p>动画的内部实现使用 Choreographer 提供定时引擎，周期性回调执行上述动画值的计算，实现动画对象从上一个关键帧到下一个关键帧的动画渐变效果。</p>\n",
            "tags": [
                "Android, Animation, Animator"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/02/24/Android-view-canvas-%E5%9D%90%E6%A0%87%E7%B3%BB/",
            "url": "https://limxtop1989.github.io/limxtop/2022/02/24/Android-view-canvas-%E5%9D%90%E6%A0%87%E7%B3%BB/",
            "title": "Android view & canvas 坐标系",
            "date_published": "2022-02-24T11:22:26.000Z",
            "content_html": "<p>View 坐标系原点在 parent view 左上角，left, top, right, bottom 是 child view 左上角和右下角相对坐标轴的距离。</p>\n<img data-src=\"https://s3.bmp.ovh/imgs/2022/02/268be9e97fb1f9e7.png\" style=\"zoom:50%\" />\n<img data-src=\"https://s3.bmp.ovh/imgs/2022/02/0172ac6697998ed7.png\" style=\"zoom:50%;\" />\n",
            "tags": [
                "Android, view coordinate, canvas coordinate, 坐标系"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2022/02/14/LifeCycle-LiveData%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/",
            "url": "https://limxtop1989.github.io/limxtop/2022/02/14/LifeCycle-LiveData%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/",
            "title": "LifeCycle & LiveData源码剖析",
            "date_published": "2022-02-14T12:33:46.000Z",
            "content_html": "<p><img data-src=\"https://s3.bmp.ovh/imgs/2022/02/c5d4136edbfe0f20.png\" alt=\"类图\" /></p>\n<h1 id=\"生命周期回调方法映射为事件并派发给lifecycle\"><a class=\"anchor\" href=\"#生命周期回调方法映射为事件并派发给lifecycle\">#</a> 生命周期回调方法映射为事件，并派发给 LifeCycle</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentActivity</span>#onStart</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// ……</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// NOTE: HC onStart goes here.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    mFragmentLifecycleRegistry<span class=\"token punctuation\">.</span><span class=\"token function\">handleLifecycleEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span><span class=\"token punctuation\">.</span>ON_START<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    mFragments<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>LifecycleRegistry</span>#handleLifecycleEvent</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * Sets the current state and notifies the observers.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> * Note that if the &#123;@code currentState&#125; is the same state as the last call to this method,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> * calling this method has no effect.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * @param event The event that was received</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleLifecycleEvent</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token class-name\">State</span> next <span class=\"token operator\">=</span> <span class=\"token function\">getStateAfter</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span>next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">State</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mState <span class=\"token operator\">==</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    mState <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mHandlingEvent <span class=\"token operator\">||</span> mAddingObserverCounter <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        mNewEventOccurred <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token comment\">// we will figure out what to do on upper level.</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    mHandlingEvent <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token function\">sync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    mHandlingEvent <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\">// happens only on the top of stack (never in reentrance),</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">// so it doesn't have to take in account parents</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token class-name\">LifecycleOwner</span> lifecycleOwner <span class=\"token operator\">=</span> mLifecycleOwner<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lifecycleOwner <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LifecycleOwner of this LifecycleRegistry is already\"</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token operator\">+</span> <span class=\"token string\">\"garbage collected. It is too late to change lifecycle state.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isSynced</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        mNewEventOccurred <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token comment\">// no need to check eldest for nullability, because isSynced does it for us.</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\">// State descends, such as RESUMED to STARTED</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mState<span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span>mObserverMap<span class=\"token punctuation\">.</span><span class=\"token function\">eldest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>mState<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token function\">backwardPass</span><span class=\"token punctuation\">(</span>lifecycleOwner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\">// State ascends, such at STARTED TO RESUMED</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LifecycleObserver</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">></span></span> newest <span class=\"token operator\">=</span> mObserverMap<span class=\"token punctuation\">.</span><span class=\"token function\">newest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mNewEventOccurred <span class=\"token operator\">&amp;&amp;</span> newest <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                <span class=\"token operator\">&amp;&amp;</span> mState<span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span>newest<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>mState<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            <span class=\"token function\">forwardPass</span><span class=\"token punctuation\">(</span>lifecycleOwner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    mNewEventOccurred <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://s3.bmp.ovh/imgs/2022/02/a70384d33bf36163.png\" alt=\"状态图\" /></p>\n<p>如果是状态降级，从尾部向头部遍历监听队列，如果是状态升级，从头部向尾部遍历监听队列。之所以如此区分是因为要保证 FastSafeIterableMap 的 Invariant，但为什么要维持这个不变量呢？原则上，LifeCycleOwner 从 ON_CREATED 到 ON_RESUMED，再到 ON_CREATED 是一种状态回退，监听回调顺序也要从向前到向后回退。FastSafeIterableMap 是一个 map，同时每个 Entry 是一个双向链表，新加入元素插入尾部。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>LifecycleRegistry</span>#mObserverMap</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Custom list that keeps observers and can handle removals / additions during traversal.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * Invariant: at any moment of time for observer1 &amp; observer2:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * if addition_order(observer1) &lt; addition_order(observer2), then</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * state(observer1) >= state(observer2),</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token class-name\">FastSafeIterableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LifecycleObserver</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">></span></span> mObserverMap <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">new</span> <span class=\"token class-name\">FastSafeIterableMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>LifecycleRegistry</span>#backwardPass</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">backwardPass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> lifecycleOwner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LifecycleObserver</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> descendingIterator <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            mObserverMap<span class=\"token punctuation\">.</span><span class=\"token function\">descendingIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>descendingIterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>mNewEventOccurred<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token class-name\">Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LifecycleObserver</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">></span></span> entry <span class=\"token operator\">=</span> descendingIterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">ObserverWithState</span> observer <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">.</span>mState<span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span>mState<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>mNewEventOccurred</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token operator\">&amp;&amp;</span> mObserverMap<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token class-name\">Event</span> event <span class=\"token operator\">=</span> <span class=\"token function\">downEvent</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">.</span>mState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token function\">pushParentState</span><span class=\"token punctuation\">(</span><span class=\"token function\">getStateAfter</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            observer<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchEvent</span><span class=\"token punctuation\">(</span>lifecycleOwner<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token function\">popParentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>LifecycleRegistry<span class=\"token punctuation\">.</span>ObserverWithState</span>#dispatchEvent</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">dispatchEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">State</span> newState <span class=\"token operator\">=</span> <span class=\"token function\">getStateAfter</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    mState <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>mState<span class=\"token punctuation\">,</span> newState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    mLifecycleObserver<span class=\"token punctuation\">.</span><span class=\"token function\">onStateChanged</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    mState <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Class that can receive any lifecycle change and dispatch it to the receiver.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * If a class implements both this interface and</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * &#123;@link androidx.lifecycle.DefaultLifecycleObserver&#125;, then</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * methods of &#123;@code DefaultLifecycleObserver&#125; will be called first, and then followed by the call</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * of &#123;@link LifecycleEventObserver#onStateChanged(LifecycleOwner, Lifecycle.Event)&#125;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * If a class implements this interface and in the same time uses &#123;@link OnLifecycleEvent&#125;, then</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * annotations will be ignored.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">LifecycleEventObserver</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">LifecycleObserver</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     * Called when a state transition event happens.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>     * @param source The source of the event</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>     * @param event The event</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">onStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> source<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>LiveData 包 androidx.lifecycle.LiveData.LifecycleBoundObserver 实现了这个接口，接下来看如何实现和使用</p>\n<h1 id=\"监听注册\"><a class=\"anchor\" href=\"#监听注册\">#</a> 监听注册</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>LiveData</span>#observe</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * Adds the given observer to the observers list within the lifespan of the given</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * owner. The events are dispatched on the main thread. If LiveData already has data</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * set, it will be delivered to the observer.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * The observer will only receive events if the owner is in &#123;@link Lifecycle.State#STARTED&#125;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * or &#123;@link Lifecycle.State#RESUMED&#125; state (active).</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * If the owner moves to the &#123;@link Lifecycle.State#DESTROYED&#125; state, the observer will</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> * automatically be removed.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * When data changes while the &#123;@code owner&#125; is not active, it will not receive any updates.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> * If it becomes active again, it will receive the last available data automatically.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> * LiveData keeps a strong reference to the observer and the owner as long as the</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * given LifecycleOwner is not destroyed. When it is destroyed, LiveData removes references to</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * the observer &amp;amp; the owner.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> * If the given owner is already in &#123;@link Lifecycle.State#DESTROYED&#125; state, LiveData</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> * ignores the call.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> * If the given owner, observer tuple is already in the list, the call is ignored.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> * If the observer is already in the list with another owner, LiveData throws an</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> * &#123;@link IllegalArgumentException&#125;.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"27\"></td><td><pre> * @param owner    The LifecycleOwner which controls the observer</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> * @param observer The observer that will receive the events</pre></td></tr><tr><td data-num=\"29\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token annotation punctuation\">@MainThread</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token function\">assertMainThread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"observe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> DESTROYED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token comment\">// ignore</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token class-name\">LifecycleBoundObserver</span> wrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LifecycleBoundObserver</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token class-name\">ObserverWrapper</span> existing <span class=\"token operator\">=</span> mObservers<span class=\"token punctuation\">.</span><span class=\"token function\">putIfAbsent</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">,</span> wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>existing<span class=\"token punctuation\">.</span><span class=\"token function\">isAttachedTo</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot add the same observer\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token operator\">+</span> <span class=\"token string\">\" with different lifecycles\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>observer 被封装为 LifecycleBoundObserver，并注册到 Lifecycle 的监听队列里，当生命周期方法调用，并派发事件，最终 androidx.lifecycle.LiveData.LifecycleBoundObserver#onStateChanged 被调用，对于 LiveData 而言，它只关注两个方面：</p>\n<ol>\n<li>如果是 Lifecycle 已经 destroy，那么自动移除双向监听（对 LiveData，和对 Lifecycle 的监听）；</li>\n<li>判断 active &amp; inActive 状态变更方向，如果是 inactive →  active，说明 Lifecycle 重新回到前台，则将 LiveData 的 value 派发给监听者，提供数据刷新 UI。</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">LifecycleBoundObserver</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ObserverWrapper</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">GenericLifecycleObserver</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token annotation punctuation\">@NonNull</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token class-name\">LifecycleOwner</span> mOwner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">LifecycleBoundObserver</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Observer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        mOwner <span class=\"token operator\">=</span> owner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleOwner</span> source<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mOwner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> DESTROYED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">// Remove double direction observers.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token function\">removeObserver</span><span class=\"token punctuation\">(</span>mObserver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// Dispatch value if state changes from inactive to active.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token function\">shouldBeActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>LifecycleBoundObserver 注册观察 Lifecycle 时，需要处理注册时，错失的生命周期方法派发，将当前 LifecycleBoundObserver 的状态推送至 Lifecycle 一致。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>LifecycleRegistry</span>#addObserver</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleObserver</span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">State</span> initialState <span class=\"token operator\">=</span> mState <span class=\"token operator\">==</span> DESTROYED <span class=\"token operator\">?</span> DESTROYED <span class=\"token operator\">:</span> INITIALIZED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">ObserverWithState</span> statefulObserver <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObserverWithState</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">,</span> initialState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">ObserverWithState</span> previous <span class=\"token operator\">=</span> mObserverMap<span class=\"token punctuation\">.</span><span class=\"token function\">putIfAbsent</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">,</span> statefulObserver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>previous <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token class-name\">LifecycleOwner</span> lifecycleOwner <span class=\"token operator\">=</span> mLifecycleOwner<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lifecycleOwner <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// it is null we should be destroyed. Fallback quickly</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">boolean</span> isReentrance <span class=\"token operator\">=</span> mAddingObserverCounter <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> mHandlingEvent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token class-name\">State</span> targetState <span class=\"token operator\">=</span> <span class=\"token function\">calculateTargetState</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mAddingObserverCounter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>statefulObserver<span class=\"token punctuation\">.</span>mState<span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span>targetState<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token operator\">&amp;&amp;</span> mObserverMap<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token function\">pushParentState</span><span class=\"token punctuation\">(</span>statefulObserver<span class=\"token punctuation\">.</span>mState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        statefulObserver<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchEvent</span><span class=\"token punctuation\">(</span>lifecycleOwner<span class=\"token punctuation\">,</span> <span class=\"token function\">upEvent</span><span class=\"token punctuation\">(</span>statefulObserver<span class=\"token punctuation\">.</span>mState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token function\">popParentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">// mState / subling may have been changed recalculate</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        targetState <span class=\"token operator\">=</span> <span class=\"token function\">calculateTargetState</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isReentrance<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token comment\">// we do sync only on the top level.</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token function\">sync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    mAddingObserverCounter<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"数据变更\"><a class=\"anchor\" href=\"#数据变更\">#</a> 数据变更</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>LiveData</span>#setValue</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * Sets the value. If there are active observers, the value will be dispatched to them.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * This method must be called from the main thread. If you need set a value from a background</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * thread, you can use &#123;@link #postValue(Object)&#125;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @param value The new value</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token annotation punctuation\">@MainThread</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">assertMainThread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"setValue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    mVersion<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    mData <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>LiveData</span>#dispatchingValue</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WeakerAccess\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">/* synthetic access */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">dispatchingValue</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">ObserverWrapper</span> initiator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mDispatchingValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        mDispatchInvalidated <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    mDispatchingValue <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        mDispatchInvalidated <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initiator <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// Maxim: Lifecycle changes from inactive to active, but the data keeps still,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// notify the corresponding observer in the lifecycle owner only.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span>initiator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            initiator <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">//Maxim:  The data source has changed, notify all observers.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Observer</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObserverWrapper</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    mObservers<span class=\"token punctuation\">.</span><span class=\"token function\">iteratorWithAdditions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span>iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mDispatchInvalidated<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>mDispatchInvalidated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    mDispatchingValue <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">considerNotify</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ObserverWrapper</span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>observer<span class=\"token punctuation\">.</span>mActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// we still first check observer.active to keep it as the entrance for events. So even if</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// the observer moved to an active state, if we've not received that event, we better not</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// notify for a more predictable notification order.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token comment\">// Maxim: Don't notify if the observer is not active, for lifecycle, it should</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token comment\">// at leat be started or above(resumed).</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>observer<span class=\"token punctuation\">.</span><span class=\"token function\">shouldBeActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        observer<span class=\"token punctuation\">.</span><span class=\"token function\">activeStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">.</span>mLastVersion <span class=\"token operator\">>=</span> mVersion<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    observer<span class=\"token punctuation\">.</span>mLastVersion <span class=\"token operator\">=</span> mVersion<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">//noinspection unchecked</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    observer<span class=\"token punctuation\">.</span>mObserver<span class=\"token punctuation\">.</span><span class=\"token function\">onChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> mData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"更多资料\"><a class=\"anchor\" href=\"#更多资料\">#</a> 更多资料</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9nb29nbGUtZGV2ZWxvcGVyLXRyYWluaW5nLmdpdGh1Yi5pby9hbmRyb2lkLWRldmVsb3Blci1hZHZhbmNlZC1jb3Vyc2UtcHJhY3RpY2Fscy91bml0LTYtd29ya2luZy13aXRoLWFyY2hpdGVjdHVyZS1jb21wb25lbnRzL2xlc3Nvbi0xNC1yb29tLC1saXZlZGF0YSwtdmlld21vZGVsLzE0LTEtYS1yb29tLWxpdmVkYXRhLXZpZXdtb2RlbC8xNC0xLWEtcm9vbS1saXZlZGF0YS12aWV3bW9kZWwuaHRtbA==\">https://google-developer-training.github.io/android-developer-advanced-course-practicals/unit-6-working-with-architecture-components/lesson-14-room,-livedata,-viewmodel/14-1-a-room-livedata-viewmodel/14-1-a-room-livedata-viewmodel.html</span></p>\n",
            "tags": [
                "LifeCycle, LiveData"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/",
            "url": "https://limxtop1989.github.io/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/",
            "title": "FragmentManager源码剖析二",
            "date_published": "2021-10-18T13:27:09.000Z",
            "content_html": "<h1 id=\"remove-detach-fragment差别\"><a class=\"anchor\" href=\"#remove-detach-fragment差别\">#</a> remove &amp; detach Fragment 差别</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">removeFragment</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"remove: \"</span> <span class=\"token operator\">+</span> fragment <span class=\"token operator\">+</span> <span class=\"token string\">\" nesting=\"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">.</span>mBackStackNesting<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> inactive <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span><span class=\"token function\">isInBackStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mDetached <span class=\"token operator\">||</span> inactive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isMenuAvailable</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mRemoving <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">detachFragment</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"detach: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mDetached<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mDetached <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token comment\">// We are not already in back stack, so need to remove the fragment.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"remove from detach: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isMenuAvailable</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            fragment<span class=\"token punctuation\">.</span>mAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>都是移出 mAdded 集合，并将 mAdded 置为 false，区别在更新的标记不同 mRemoving &amp; mDetached。在 FragmentManager 同步状态调用时，有对 remove &amp; detach 的状态同步。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Changes the state of the fragment manager to &#123;@code newState&#125;. If the fragment manager</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * changes state or &#123;@code always&#125; is &#123;@code true&#125;, any fragments within it have their</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * states updated as well.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param newState The new state for the fragment manager</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param always If &#123;@code true&#125;, all fragments update their state, even</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *               if &#123;@code newState&#125; matches the current fragment manager's state.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> newState<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> always<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mHost <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> newState <span class=\"token operator\">!=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>INITIALIZING<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No activity\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>always <span class=\"token operator\">&amp;&amp;</span> newState <span class=\"token operator\">==</span> mCurState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mCurState <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mActive <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\">// Must add them in the proper order. mActive fragments may be out of order</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// Fragment add &amp; attach 后的状态同步</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> numAdded <span class=\"token operator\">=</span> mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> numAdded<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">=</span> mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token function\">moveFragmentToExpectedState</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token comment\">// Now iterate through all active fragments. These will include those that are removed</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token comment\">// and detached.</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> numActive <span class=\"token operator\">=</span> mActive<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> numActive<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">=</span> mActive<span class=\"token punctuation\">.</span><span class=\"token function\">valueAt</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">// Fragment 激活后执行 remove 或者 detach，同步状态。</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>mRemoving <span class=\"token operator\">||</span> f<span class=\"token punctuation\">.</span>mDetached<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>f<span class=\"token punctuation\">.</span>mIsNewlyAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token function\">moveFragmentToExpectedState</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token function\">startPendingDeferredFragments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mNeedMenuInvalidate <span class=\"token operator\">&amp;&amp;</span> mHost <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> mCurState <span class=\"token operator\">==</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>RESUMED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            mHost<span class=\"token punctuation\">.</span><span class=\"token function\">onSupportInvalidateOptionsMenu</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Moves a fragment to its expected final state or the fragment manager's state, depending</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * on whether the fragment manager's state is raised properly.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param f The fragment to change.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">moveFragmentToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> f<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mActive<span class=\"token punctuation\">.</span><span class=\"token function\">containsKey</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>mWho<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Ignoring moving \"</span> <span class=\"token operator\">+</span> f <span class=\"token operator\">+</span> <span class=\"token string\">\" to state \"</span> <span class=\"token operator\">+</span> mCurState</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token operator\">+</span> <span class=\"token string\">\"since it is not added to \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">int</span> nextState <span class=\"token operator\">=</span> mCurState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>mRemoving<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">isInBackStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            nextState <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            nextState <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>INITIALIZING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> nextState<span class=\"token punctuation\">,</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">getNextTransition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">getNextTransitionStyle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>对于 Remove 如果 nextState 是 CREATED，Fragment 只会 <code>f.performDestroyView()</code> ，但如果是 INITIALIZING，分两种情况：</p>\n<ol>\n<li>不在回退栈，执行 <code>f.performDestroy()</code> ;</li>\n<li>在回退栈，执行 <code>f.performDetach()</code> ; 并 <code>makeInactive(f);</code></li>\n</ol>\n<p>对于 detach，nextState 是 CREATED，也即只执行 <code>f.performDestroyView()</code></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ReferenceEquality\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> f<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> newState<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> transit<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> transitionStyle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">boolean</span> keepActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// Fragments that are not currently added will sit in the onCreate() state.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>f<span class=\"token punctuation\">.</span>mAdded <span class=\"token operator\">||</span> f<span class=\"token punctuation\">.</span>mDetached<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> newState <span class=\"token operator\">></span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        newState <span class=\"token operator\">=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"add-attach-fragment区别\"><a class=\"anchor\" href=\"#add-attach-fragment区别\">#</a> add &amp; attach Fragment 区别</h1>\n<p>由于 addFragment 有 activate 调用，fragment 已经在 mActive 映射里，允许状态同步，但 attach 没有 activate 调用，于是状态不同步。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Moves a fragment to its expected final state or the fragment manager's state, depending</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * on whether the fragment manager's state is raised properly.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param f The fragment to change.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">moveFragmentToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> f<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mActive<span class=\"token punctuation\">.</span><span class=\"token function\">containsKey</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>mWho<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Ignoring moving \"</span> <span class=\"token operator\">+</span> f <span class=\"token operator\">+</span> <span class=\"token string\">\" to state \"</span> <span class=\"token operator\">+</span> mCurState</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token operator\">+</span> <span class=\"token string\">\"since it is not added to \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">int</span> nextState <span class=\"token operator\">=</span> mCurState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>mRemoving<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">isInBackStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            nextState <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            nextState <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>INITIALIZING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> nextState<span class=\"token punctuation\">,</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">getNextTransition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">getNextTransitionStyle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addFragment</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> moveToStateNow<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"add: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token function\">makeActive</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 这是主要区别 **</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mDetached<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Fragment already added: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mRemoving <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mView <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            fragment<span class=\"token punctuation\">.</span>mHiddenChanged <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isMenuAvailable</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>moveToStateNow<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">attachFragment</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"attach: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mDetached<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mDetached <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Fragment already added: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"add from attach: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            fragment<span class=\"token punctuation\">.</span>mAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isMenuAvailable</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"show和hide-fragment区别\"><a class=\"anchor\" href=\"#show和hide-fragment区别\">#</a> Show 和 hide Fragment 区别</h1>\n<p>首先，更新 mHidden 标记。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Marks a fragment as hidden to be later animated in with</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * &#123;@link #completeShowHideFragment(Fragment)&#125;.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param fragment The fragment to be shown.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">hideFragment</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"hide: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mHidden<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mHidden <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// it doesn't go through the animation.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mHiddenChanged <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mHiddenChanged<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * Marks a fragment as shown to be later animated in with</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * &#123;@link #completeShowHideFragment(Fragment)&#125;.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> * @param fragment The fragment to be shown.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">showFragment</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"show: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mHidden<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mHidden <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token comment\">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// it doesn't go through the animation.</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mHiddenChanged <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mHiddenChanged<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>故事并没有就此结束，看下这个标记如何使用。</p>\n<p>首先，hidden 后，Fragment 下的 View 为 Gone，不贡献视图。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentStateManager</span>#moveToExpectedState</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span>USE_STATE_MANAGER <span class=\"token operator\">&amp;&amp;</span> mFragment<span class=\"token punctuation\">.</span>mHiddenChanged<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mView <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> mFragment<span class=\"token punctuation\">.</span>mContainer <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// Get the controller and enqueue the show/hide</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token class-name\">SpecialEffectsController</span> controller <span class=\"token operator\">=</span> <span class=\"token class-name\">SpecialEffectsController</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">getOrCreateController</span><span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mContainer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                        mFragment<span class=\"token punctuation\">.</span><span class=\"token function\">getParentFragmentManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mHidden<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            controller<span class=\"token punctuation\">.</span><span class=\"token function\">enqueueHide</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            controller<span class=\"token punctuation\">.</span><span class=\"token function\">enqueueShow</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mFragmentManager <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        mFragment<span class=\"token punctuation\">.</span>mFragmentManager<span class=\"token punctuation\">.</span><span class=\"token function\">invalidateMenuForFragment</span><span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    mFragment<span class=\"token punctuation\">.</span>mHiddenChanged <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    mFragment<span class=\"token punctuation\">.</span><span class=\"token function\">onHiddenChanged</span><span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mHidden<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其次，hidden 后，Fragment 不再贡献菜单项</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#dispatchPrepareOptionsMenu</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">boolean</span> <span class=\"token function\">dispatchPrepareOptionsMenu</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Menu</span> menu<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mCurState <span class=\"token operator\">&lt;</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">boolean</span> show <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">:</span> mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">getFragments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isParentMenuVisible</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">performPrepareOptionsMenu</span><span class=\"token punctuation\">(</span>menu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                show <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> show<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>Fragment</span>#performPrepareOptionsMenu</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">boolean</span> <span class=\"token function\">performPrepareOptionsMenu</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Menu</span> menu<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">boolean</span> show <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mHidden<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mHasMenu <span class=\"token operator\">&amp;&amp;</span> mMenuVisible<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            show <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token function\">onPrepareOptionsMenu</span><span class=\"token punctuation\">(</span>menu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        show <span class=\"token operator\">|=</span> mChildFragmentManager<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchPrepareOptionsMenu</span><span class=\"token punctuation\">(</span>menu<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">return</span> show<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>显隐切换完成后，androidx.fragment.app.Fragment#onHiddenChanged 会得到通知调用。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#completeShowHideFragment</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentStateManager</span>#moveToExpectedState</pre></td></tr></table></figure><h1 id=\"fragmentmanager-派发生命周期方法\"><a class=\"anchor\" href=\"#fragmentmanager-派发生命周期方法\">#</a> FragmentManager 派发生命周期方法</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FragmentActivity</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ComponentActivity</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token class-name\">FragmentController</span> mFragments <span class=\"token operator\">=</span> <span class=\"token class-name\">FragmentController</span><span class=\"token punctuation\">.</span><span class=\"token function\">createController</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t\t\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">HostCallbacks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>mFragments 负责 Activity 生命周期方法，派发给 FragmentManager，再遍历逐个派发给旗下的 Fragment。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Perform initialization of all fragments.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"deprecation\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Bundle</span> savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    mFragments<span class=\"token punctuation\">.</span><span class=\"token function\">attachHost</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token comment\">/*parent*/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>savedInstanceState <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token class-name\">Parcelable</span> p <span class=\"token operator\">=</span> savedInstanceState<span class=\"token punctuation\">.</span><span class=\"token function\">getParcelable</span><span class=\"token punctuation\">(</span>FRAGMENTS_TAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        mFragments<span class=\"token punctuation\">.</span><span class=\"token function\">restoreSaveState</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    mFragmentLifecycleRegistry<span class=\"token punctuation\">.</span><span class=\"token function\">handleLifecycleEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span><span class=\"token punctuation\">.</span>ON_CREATE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    mFragments<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Moves all Fragments managed by the controller's FragmentManager</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * into the create state.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * &lt;p>Call when Fragments should be created.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @see Fragment#onCreate(Bundle)</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">dispatchCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    mHost<span class=\"token punctuation\">.</span>mFragmentManager<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>dispatchCreate 终导致 FragmentManagerImpl 的当前状态 <code>mCurState</code>  变更。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#dispatchCreate</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">dispatchCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    mStateSaved <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    mStopped <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    mNonConfig<span class=\"token punctuation\">.</span><span class=\"token function\">setIsStateSaved</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">dispatchStateChange</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#dispatchStateChange</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">dispatchStateChange</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> nextState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        mExecutingActions <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchStateChange</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>USE_STATE_MANAGER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SpecialEffectsController</span><span class=\"token punctuation\">></span></span> controllers <span class=\"token operator\">=</span> <span class=\"token function\">collectAllSpecialEffectsController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SpecialEffectsController</span> controller <span class=\"token operator\">:</span> controllers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                controller<span class=\"token punctuation\">.</span><span class=\"token function\">forceCompleteAllOperations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        mExecutingActions <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token function\">execPendingActions</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">// 同步生命周期状态给 mActive 内 fragment 集合</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">dispatchStateChange</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> state<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentStateManager</span> fragmentStateManager <span class=\"token operator\">:</span> mActive<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragmentStateManager <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">setFragmentManagerState</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#<span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * Changes the state of the fragment manager to &#123;@code newState&#125;. If the fragment manager</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * changes state or &#123;@code always&#125; is &#123;@code true&#125;, any fragments within it have their</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * states updated as well.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param newState The new state for the fragment manager</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @param always If &#123;@code true&#125;, all fragments update their state, even</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *               if &#123;@code newState&#125; matches the current fragment manager's state.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> newState<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> always<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mHost <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> newState <span class=\"token operator\">!=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>INITIALIZING<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No activity\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>always <span class=\"token operator\">&amp;&amp;</span> newState <span class=\"token operator\">==</span> mCurState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    mCurState <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>USE_STATE_MANAGER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">// Must add them in the proper order. mActive fragments may be out of order</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">:</span> mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">getFragments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token function\">moveFragmentToExpectedState</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token comment\">// Now iterate through all active fragments. These will include those that are removed</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token comment\">// and detached.</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentStateManager</span> fragmentStateManager <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">getActiveFragmentStateManagers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">=</span> fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">getFragment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>f<span class=\"token punctuation\">.</span>mIsNewlyAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token function\">moveFragmentToExpectedState</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token keyword\">boolean</span> beingRemoved <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>mRemoving <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">isInBackStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>beingRemoved<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">makeInactive</span><span class=\"token punctuation\">(</span>fragmentStateManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token function\">startPendingDeferredFragments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mNeedMenuInvalidate <span class=\"token operator\">&amp;&amp;</span> mHost <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> mCurState <span class=\"token operator\">==</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>RESUMED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        mHost<span class=\"token punctuation\">.</span><span class=\"token function\">onSupportInvalidateOptionsMenu</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#moveFragmentToExpectedState</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// Must add them in the proper order. mActive fragments may be out of order</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">:</span> mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token class-name\">FragmentStateManager</span> fragmentStateManager <span class=\"token operator\">=</span> mActive<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>mWho<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragmentStateManager <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// Now iterate through all active fragments. These will include those that are removed</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// and detached.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentStateManager</span> fragmentStateManager <span class=\"token operator\">:</span> mActive<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragmentStateManager <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">=</span> fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">getFragment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">boolean</span> beingRemoved <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>mRemoving <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">isInBackStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>beingRemoved<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token function\">makeInactive</span><span class=\"token punctuation\">(</span>fragmentStateManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>注意只有在 mActive 集合的 Fragment 才可以 <code>moveToExpectedState</code>  ，attach 阶段的 Fragment 并未进入此集合，add 之后才进入，此后 Fragment 接收生命周期方法派发。</p>\n<h1 id=\"backstack\"><a class=\"anchor\" href=\"#backstack\">#</a> BackStack</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Implementation of &#123;@link FragmentManagerImpl.OpGenerator&#125;.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * This operation is added to the list of pending actions during &#123;@link #commit()&#125;, and</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * will be executed on the UI thread to run this FragmentTransaction.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param records Modified to add this BackStackRecord</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param isRecordPop Modified to add a false (this isn't a pop)</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @return true always because the records and isRecordPop will always be changed</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">generateOps</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">></span></span> records<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">></span></span> isRecordPop<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentManagerImpl</span><span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Run: \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    records<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mAddToBackStack<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        mManager<span class=\"token punctuation\">.</span><span class=\"token function\">addBackStackState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">addBackStackState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BackStackRecord</span> state<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mBackStack <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        mBackStack <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    mBackStack<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>把当前 backStackRecord 即事务加入 mBackStack 集合。此处可以猜想：当接收 back 事件时，activity 先派发 back 事件给 FragmentManager，如果 mBackStack 存在元素，则将列表末尾的事务 revert，并移出集合，指针向左偏移一位，并直接返回。如果 FragmentManager 不回应 back event，那么由 Activity 继续回应。我们看下具体实现是否这样。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span></span>ComponentActivity</span>#onBackPressed</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * Called when the activity has detected the user's press of the back</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * key. The &#123;@link #getOnBackPressedDispatcher() OnBackPressedDispatcher&#125; will be given a</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * chance to handle the back button before the default behavior of</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * &#123;@link android.app.Activity#onBackPressed()&#125; is invoked.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @see #getOnBackPressedDispatcher()</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token annotation punctuation\">@MainThread</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onBackPressed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    mOnBackPressedDispatcher<span class=\"token punctuation\">.</span><span class=\"token function\">onBackPressed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OnBackPressedDispatcher</span> mOnBackPressedDispatcher <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token keyword\">new</span> <span class=\"token class-name\">OnBackPressedDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>              <span class=\"token class-name\">ComponentActivity</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onBackPressed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span></span>OnBackPressedDispatcher</span>#onBackPressed</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> * Trigger a call to the currently added &#123;@link OnBackPressedCallback callbacks&#125; in reverse</pre></td></tr><tr><td data-num=\"27\"></td><td><pre> * order in which they were added. Only if the most recently added callback is not</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> * &#123;@link OnBackPressedCallback#isEnabled() enabled&#125;</pre></td></tr><tr><td data-num=\"29\"></td><td><pre> * will any previously added callback be called.</pre></td></tr><tr><td data-num=\"30\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"31\"></td><td><pre> * It is strongly recommended to call &#123;@link #hasEnabledCallbacks()&#125; prior to calling</pre></td></tr><tr><td data-num=\"32\"></td><td><pre> * this method to determine if there are any enabled callbacks that will be triggered</pre></td></tr><tr><td data-num=\"33\"></td><td><pre> * by this method as calling this method.</pre></td></tr><tr><td data-num=\"34\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token annotation punctuation\">@MainThread</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onBackPressed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OnBackPressedCallback</span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            mOnBackPressedCallbacks<span class=\"token punctuation\">.</span><span class=\"token function\">descendingIterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token class-name\">OnBackPressedCallback</span> callback <span class=\"token operator\">=</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">.</span><span class=\"token function\">isEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">// 如果回调回应 back 事件，则返回</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            callback<span class=\"token punctuation\">.</span><span class=\"token function\">handleOnBackPressed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token comment\">// FragmentManager 没回应，则继续走这里</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFallbackOnBackPressed <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 为 OnBackPressedDispatcher 初始化时，传入的回调方法，其实现是</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 调用 Activity 的 onBackPressed ()</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        mFallbackOnBackPressed<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>FragmentManager 如何注册 callback</p>\n<p>→androidx.fragment.app.FragmentActivity#init</p>\n<p>→androidx.fragment.app.FragmentController#attachHost</p>\n<p>→androidx.fragment.app.FragmentManager#attachController</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"deprecation\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressLint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SyntheticAccessor\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">attachController</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">FragmentHostCallback</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> host<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">FragmentContainer</span> container<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Fragment</span> parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mHost <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Already attached\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    mHost <span class=\"token operator\">=</span> host<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    mContainer <span class=\"token operator\">=</span> container<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    mParent <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// Add a FragmentOnAttachListener to the parent fragment / host to support</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// backward compatibility with the deprecated onAttachFragment() APIs</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mParent <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">addFragmentOnAttachListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">FragmentOnAttachListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"deprecation\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onAttachFragment</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">FragmentManager</span> fragmentManager<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                parent<span class=\"token punctuation\">.</span><span class=\"token function\">onAttachFragment</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>host <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">FragmentOnAttachListener</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token function\">addFragmentOnAttachListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentOnAttachListener</span><span class=\"token punctuation\">)</span> host<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mParent <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">// Since the callback depends on us being the primary navigation fragment,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token comment\">// update our callback now that we have a parent so that we have the correct</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// state by default</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token function\">updateOnBackPressedCallbackEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// Set up the OnBackPressedCallback</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>host <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">OnBackPressedDispatcherOwner</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token class-name\">OnBackPressedDispatcherOwner</span> dispatcherOwner <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OnBackPressedDispatcherOwner</span><span class=\"token punctuation\">)</span> host<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        mOnBackPressedDispatcher <span class=\"token operator\">=</span> dispatcherOwner<span class=\"token punctuation\">.</span><span class=\"token function\">getOnBackPressedDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token class-name\">LifecycleOwner</span> owner <span class=\"token operator\">=</span> parent <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> parent <span class=\"token operator\">:</span> dispatcherOwner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        mOnBackPressedDispatcher<span class=\"token punctuation\">.</span><span class=\"token function\">addCallback</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> mOnBackPressedCallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token comment\">// 代码省略</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OnBackPressedCallback</span> mOnBackPressedCallback <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">new</span> <span class=\"token class-name\">OnBackPressedCallback</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleOnBackPressed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleOnBackPressed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#handleOnBackPressed</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WeakerAccess\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">/* synthetic access */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">handleOnBackPressed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// First, execute any pending actions to make sure we're in an</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// up to date view of the world just in case anyone is queuing</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// up transactions that change the back stack then immediately</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// calling onBackPressed()</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token function\">execPendingActions</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mOnBackPressedCallback<span class=\"token punctuation\">.</span><span class=\"token function\">isEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// We still have a back stack, so we can pop</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token function\">popBackStackImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// Sigh. Due to FragmentManager's asynchronicity, we can</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// get into cases where we *think* we can handle the back</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// button but because of frame perfect dispatch, we fell</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// on our face. Since our callback is disabled, we can</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// re-trigger the onBackPressed() to dispatch to the next</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token comment\">// enabled callback</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        mOnBackPressedDispatcher<span class=\"token punctuation\">.</span><span class=\"token function\">onBackPressed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>看 fragmentManager.popBackStackImmediate ()</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">popBackStackImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">checkStateLoss</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">popBackStackImmediate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Used by all public popBackStackImmediate methods, this executes pending transactions and</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * returns true if the pop action did anything, regardless of what other pending</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * transactions did.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @return true if the pop operation did anything or false otherwise.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">popBackStackImmediate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">execPendingActions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">ensureExecReady</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mPrimaryNav <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token comment\">// We have a primary nav fragment</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token operator\">&amp;&amp;</span> id <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token comment\">// No valid id (since they're local)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token operator\">&amp;&amp;</span> name <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// no name to pop to (since they're local)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">FragmentManager</span> childManager <span class=\"token operator\">=</span> mPrimaryNav<span class=\"token punctuation\">.</span><span class=\"token function\">getChildFragmentManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>childManager<span class=\"token punctuation\">.</span><span class=\"token function\">popBackStackImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token comment\">// We did something, just not to this specific FragmentManager. Return true.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">boolean</span> executePop <span class=\"token operator\">=</span> <span class=\"token function\">popBackStackState</span><span class=\"token punctuation\">(</span>mTmpRecords<span class=\"token punctuation\">,</span> mTmpIsPop<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>executePop<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        mExecutingActions <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token function\">removeRedundantOperationsAndExecute</span><span class=\"token punctuation\">(</span>mTmpRecords<span class=\"token punctuation\">,</span> mTmpIsPop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token function\">cleanupExec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token function\">updateOnBackPressedCallbackEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">doPendingDeferredStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token function\">burpActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">return</span> executePop<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>popBackStackState 获取回退事务集合，交由 removeRedundantOperationsAndExecute 执行事务回退。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">boolean</span> <span class=\"token function\">popBackStackState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">></span></span> records<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">></span></span> isRecordPop<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                              <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mBackStack <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token comment\">// 无参数回退，只回退一个事务</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> id <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>flags <span class=\"token operator\">&amp;</span> POP_BACK_STACK_INCLUSIVE<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">int</span> last <span class=\"token operator\">=</span> mBackStack<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>last <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        records<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>mBackStack<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>last<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 指定 id 或者 backStack name 回退，可以一次回退多个事务。</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">int</span> index <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> id <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token comment\">// If a name or ID is specified, look for that place in</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token comment\">// the stack.</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            index <span class=\"token operator\">=</span> mBackStack<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token class-name\">BackStackRecord</span> bss <span class=\"token operator\">=</span> mBackStack<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>bss<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>id <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> id <span class=\"token operator\">==</span> bss<span class=\"token punctuation\">.</span>mIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                index<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>flags<span class=\"token operator\">&amp;</span>POP_BACK_STACK_INCLUSIVE<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                index<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token comment\">// Consume all following entries that match.</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                    <span class=\"token class-name\">BackStackRecord</span> bss <span class=\"token operator\">=</span> mBackStack<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>bss<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                            <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>id <span class=\"token operator\">>=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> id <span class=\"token operator\">==</span> bss<span class=\"token punctuation\">.</span>mIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                        index<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">==</span> mBackStack<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> mBackStack<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">></span> index<span class=\"token punctuation\">;</span> i<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            records<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>mBackStack<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>事务从 mBackStack 回退栈管理集合移出，并加入 records 用于执行事务，对应的 isRecordPop 元素设置为 true，标记位回退事务，最后执行逆向操作，实现回退。</p>\n<p>→androidx.fragment.app.FragmentManagerImpl#removeRedundantOperationsAndExecute</p>\n<p>→androidx.fragment.app.FragmentManagerImpl#executeOpsTogether</p>\n<p>→androidx.fragment.app.FragmentManager#executeOps</p>\n<p>→androidx.fragment.app.BackStackRecord#executePopOps</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#executeOps</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * Run the operations in the BackStackRecords, either to push or pop.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param records The list of records whose operations should be run.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param isRecordPop The direction that these records are being run.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param startIndex The index of the first entry in records to run.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @param endIndex One past the index of the final entry in records to run.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">executeOps</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">></span></span> records<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">></span></span> isRecordPop<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> startIndex<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> endIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> startIndex<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> endIndex<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">BackStackRecord</span> <span class=\"token keyword\">record</span> <span class=\"token operator\">=</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> isPop <span class=\"token operator\">=</span> isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isPop<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">bumpBackStackNesting</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token comment\">// Only execute the add operations at the end of</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token comment\">// all transactions.</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">boolean</span> moveToState <span class=\"token operator\">=</span> i <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>endIndex <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">executePopOps</span><span class=\"token punctuation\">(</span>moveToState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">bumpBackStackNesting</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeOps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>BackStackRecord</span>#executePopOps</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"30\"></td><td><pre> * Reverses the execution of the operations within this transaction. The Fragment states will</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> * only be modified if reordering is not allowed.</pre></td></tr><tr><td data-num=\"32\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"33\"></td><td><pre> * @param moveToState &#123;@code true&#125; if added fragments should be moved to their final state</pre></td></tr><tr><td data-num=\"34\"></td><td><pre> *                    in ordered transactions</pre></td></tr><tr><td data-num=\"35\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">executePopOps</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> moveToState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> opNum <span class=\"token operator\">=</span> mOps<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> opNum <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> opNum<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Op</span> op <span class=\"token operator\">=</span> mOps<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>opNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">=</span> op<span class=\"token punctuation\">.</span>mFragment<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            f<span class=\"token punctuation\">.</span><span class=\"token function\">setPopDirection</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            f<span class=\"token punctuation\">.</span><span class=\"token function\">setAnimations</span><span class=\"token punctuation\">(</span>op<span class=\"token punctuation\">.</span>mEnterAnim<span class=\"token punctuation\">,</span> op<span class=\"token punctuation\">.</span>mExitAnim<span class=\"token punctuation\">,</span> op<span class=\"token punctuation\">.</span>mPopEnterAnim<span class=\"token punctuation\">,</span> op<span class=\"token punctuation\">.</span>mPopExitAnim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            f<span class=\"token punctuation\">.</span><span class=\"token function\">setNextTransition</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">reverseTransit</span><span class=\"token punctuation\">(</span>mTransition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token comment\">// Reverse the target and source names for pop operations</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            f<span class=\"token punctuation\">.</span><span class=\"token function\">setSharedElementNames</span><span class=\"token punctuation\">(</span>mSharedElementTargetNames<span class=\"token punctuation\">,</span> mSharedElementSourceNames<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>op<span class=\"token punctuation\">.</span>mCmd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_ADD<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setExitAnimationOrder</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">removeFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_REMOVE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">addFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_HIDE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">showFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_SHOW<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setExitAnimationOrder</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">hideFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_DETACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">attachFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_ATTACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setExitAnimationOrder</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">detachFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_SET_PRIMARY_NAV<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setPrimaryNavigationFragment</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_UNSET_PRIMARY_NAV<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setPrimaryNavigationFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_SET_MAX_LIFECYCLE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setMaxLifecycle</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> op<span class=\"token punctuation\">.</span>mOldMaxState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unknown cmd: \"</span> <span class=\"token operator\">+</span> op<span class=\"token punctuation\">.</span>mCmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mReorderingAllowed <span class=\"token operator\">&amp;&amp;</span> op<span class=\"token punctuation\">.</span>mCmd <span class=\"token operator\">!=</span> OP_REMOVE <span class=\"token operator\">&amp;&amp;</span> f <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span>USE_STATE_MANAGER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">moveFragmentToExpectedState</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mReorderingAllowed <span class=\"token operator\">&amp;&amp;</span> moveToState <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span>USE_STATE_MANAGER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        mManager<span class=\"token punctuation\">.</span><span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span>mManager<span class=\"token punctuation\">.</span>mCurState<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"backpressedcallback注册和反注册\"><a class=\"anchor\" href=\"#backpressedcallback注册和反注册\">#</a> BackPressedCallback 注册和反注册</h1>\n<p>注册和反注册有些值得揣摩，它和以往的模式略有不同。一般而言，注册和反注册都是提供一对 API，add &amp; remove 或者 register &amp; unregister。但这里 mOnBackPressedDispatcher 只提供 addCallback，反注册是 mOnBackPressedCallback 自己调用 cancel 方法实现。</p>\n<h2 id=\"注册\"><a class=\"anchor\" href=\"#注册\">#</a> 注册</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#attachController</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressLint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SyntheticAccessor\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">attachController</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">FragmentHostCallback</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> host<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">FragmentContainer</span> container<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Fragment</span> parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mHost <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Already attached\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    mHost <span class=\"token operator\">=</span> host<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    mContainer <span class=\"token operator\">=</span> container<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    mParent <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// Set up the OnBackPressedCallback</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>host <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">OnBackPressedDispatcherOwner</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token class-name\">OnBackPressedDispatcherOwner</span> dispatcherOwner <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OnBackPressedDispatcherOwner</span><span class=\"token punctuation\">)</span> host<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        mOnBackPressedDispatcher <span class=\"token operator\">=</span> dispatcherOwner<span class=\"token punctuation\">.</span><span class=\"token function\">getOnBackPressedDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token class-name\">LifecycleOwner</span> owner <span class=\"token operator\">=</span> parent <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> parent <span class=\"token operator\">:</span> dispatcherOwner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 注册</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        mOnBackPressedDispatcher<span class=\"token punctuation\">.</span><span class=\"token function\">addCallback</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">,</span> mOnBackPressedCallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"反注册\"><a class=\"anchor\" href=\"#反注册\">#</a> 反注册</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">dispatchDestroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    mDestroyed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">execPendingActions</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">endAnimatingAwayFragments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">dispatchStateChange</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>INITIALIZING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    mHost <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    mContainer <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    mParent <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mOnBackPressedDispatcher <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// mOnBackPressedDispatcher can hold a reference to the host</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// so we need to null it out to prevent memory leaks</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 反注册</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        mOnBackPressedCallback<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        mOnBackPressedDispatcher <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>注册实现</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span></span>OnBackPressedDispatcher</span>#<span class=\"token function\">addCallback</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>LifecycleOwner</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span></span>OnBackPressedCallback</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * Receive callbacks to a new &#123;@link OnBackPressedCallback&#125; when the given</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * &#123;@link LifecycleOwner&#125; is at least &#123;@link Lifecycle.State#STARTED started&#125;.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * This will automatically call &#123;@link #addCallback(OnBackPressedCallback)&#125; and</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * remove the callback as the lifecycle state changes.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * As a corollary, if your lifecycle is already at least</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * &#123;@link Lifecycle.State#STARTED started&#125;, calling this method will result in an immediate</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * call to &#123;@link #addCallback(OnBackPressedCallback)&#125;.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * When the &#123;@link LifecycleOwner&#125; is &#123;@link Lifecycle.State#DESTROYED destroyed&#125;, it will</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * automatically be removed from the list of callbacks. The only time you would need to</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> * manually call &#123;@link OnBackPressedCallback#remove()&#125; is if</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> * you'd like to remove the callback prior to destruction of the associated lifecycle.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * If the Lifecycle is already &#123;@link Lifecycle.State#DESTROYED destroyed&#125;</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * when this method is called, the callback will not be added.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> * @param owner The LifecycleOwner which controls when the callback should be invoked</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> * @param onBackPressedCallback The callback to add</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> * @see #onBackPressed()</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressLint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LambdaLast\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token annotation punctuation\">@MainThread</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addCallback</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> owner<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">OnBackPressedCallback</span> onBackPressedCallback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token class-name\">Lifecycle</span> lifecycle <span class=\"token operator\">=</span> owner<span class=\"token punctuation\">.</span><span class=\"token function\">getLifecycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lifecycle<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>State</span><span class=\"token punctuation\">.</span>DESTROYED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token comment\">// 注册 action2</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    onBackPressedCallback<span class=\"token punctuation\">.</span><span class=\"token function\">addCancellable</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token keyword\">new</span> <span class=\"token class-name\">LifecycleOnBackPressedCancellable</span><span class=\"token punctuation\">(</span>lifecycle<span class=\"token punctuation\">,</span> onBackPressedCallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>onBackPressedCallback 的注册委托给 LifecycleOnBackPressedCancellable，同时，持有 LifecycleOnBackPressedCancellable 的实例引用，但反注册时，onBackPressedCallback 调用 cancel 方法，通知 LifecycleOnBackPressedCancellable 实例反注册。也就是 A 向 C 注册，其实是委托给 B 实现注册，反注册通过 A 持有 B 的引用，也由 B 负责完成。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LifecycleOnBackPressedCancellable</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">LifecycleEventObserver</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token class-name\">Cancellable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Lifecycle</span> mLifecycle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OnBackPressedCallback</span> mOnBackPressedCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@Nullable</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Cancellable</span> mCurrentCancellable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">LifecycleOnBackPressedCancellable</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Lifecycle</span> lifecycle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">OnBackPressedCallback</span> onBackPressedCallback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        mLifecycle <span class=\"token operator\">=</span> lifecycle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        mOnBackPressedCallback <span class=\"token operator\">=</span> onBackPressedCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 注册 action1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        lifecycle<span class=\"token punctuation\">.</span><span class=\"token function\">addObserver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">LifecycleOwner</span> source<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">==</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span><span class=\"token punctuation\">.</span>ON_START<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">// 实际注册</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            mCurrentCancellable <span class=\"token operator\">=</span> <span class=\"token function\">addCancellableCallback</span><span class=\"token punctuation\">(</span>mOnBackPressedCallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">==</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span><span class=\"token punctuation\">.</span>ON_STOP<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token comment\">// Should always be non-null</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mCurrentCancellable <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                mCurrentCancellable<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">==</span> <span class=\"token class-name\">Lifecycle<span class=\"token punctuation\">.</span>Event</span><span class=\"token punctuation\">.</span>ON_DESTROY<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 反注册 action1</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        mLifecycle<span class=\"token punctuation\">.</span><span class=\"token function\">removeObserver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 反注册 action2</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        mOnBackPressedCallback<span class=\"token punctuation\">.</span><span class=\"token function\">removeCancellable</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mCurrentCancellable <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">// 实际反注册</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            mCurrentCancellable<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            mCurrentCancellable <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span></span>OnBackPressedDispatcher</span>#addCancellableCallback</pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"49\"></td><td><pre> * Internal implementation of &#123;@link #addCallback(OnBackPressedCallback)&#125; that gives</pre></td></tr><tr><td data-num=\"50\"></td><td><pre> * access to the &#123;@link Cancellable&#125; that specifically removes this callback from</pre></td></tr><tr><td data-num=\"51\"></td><td><pre> * the dispatcher without relying on &#123;@link OnBackPressedCallback#remove()&#125; which</pre></td></tr><tr><td data-num=\"52\"></td><td><pre> * is what external developers should be using.</pre></td></tr><tr><td data-num=\"53\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"54\"></td><td><pre> * @param onBackPressedCallback The callback to add</pre></td></tr><tr><td data-num=\"55\"></td><td><pre> * @return a &#123;@link Cancellable&#125; which can be used to &#123;@link Cancellable#cancel() cancel&#125;</pre></td></tr><tr><td data-num=\"56\"></td><td><pre> * the callback and remove it from the set of OnBackPressedCallbacks.</pre></td></tr><tr><td data-num=\"57\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WeakerAccess\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">/* synthetic access */</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token annotation punctuation\">@MainThread</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token annotation punctuation\">@NonNull</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token class-name\">Cancellable</span> <span class=\"token function\">addCancellableCallback</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">OnBackPressedCallback</span> onBackPressedCallback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token comment\">//start 后，实际注册进 callback 列表</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\tmOnBackPressedCallbacks<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>onBackPressedCallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token comment\">// 建立 OnBackPressedCancellable 实例 与 onBackPressedCallback 的双向引用并返回</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token class-name\">OnBackPressedCancellable</span> cancellable <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OnBackPressedCancellable</span><span class=\"token punctuation\">(</span>onBackPressedCallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    onBackPressedCallback<span class=\"token punctuation\">.</span><span class=\"token function\">addCancellable</span><span class=\"token punctuation\">(</span>cancellable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token keyword\">return</span> cancellable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OnBackPressedCancellable</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Cancellable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OnBackPressedCallback</span> mOnBackPressedCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token class-name\">OnBackPressedCancellable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OnBackPressedCallback</span> onBackPressedCallback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        mOnBackPressedCallback <span class=\"token operator\">=</span> onBackPressedCallback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t\t<span class=\"token comment\">//stop 后，实际反注册</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        mOnBackPressedCallbacks<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>mOnBackPressedCallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 断开引用</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        mOnBackPressedCallback<span class=\"token punctuation\">.</span><span class=\"token function\">removeCancellable</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": []
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/",
            "url": "https://limxtop1989.github.io/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/",
            "title": "FragmentManager源码剖析一",
            "date_published": "2021-10-18T13:23:33.000Z",
            "content_html": "<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<ol>\n<li>使用 Fragment 的 Activity 需要继承 <code>FragmentActivity</code>  这里有派发生命周期方法给 FragmentManager，再派发给旗下 Fragment。</li>\n<li>加入 Fragment 时，需要判断 <code>savedInstanceState == null</code>  ，避免重复创建实例。</li>\n<li>add Fragment，初始时，其 Fragment 生命周期方法会被升级到 onStart 状态，随后与 FragmentManager 的状态同步，如果宿主 Activity 是 Resume 状态，则同步至 onResume 状态。</li>\n<li>detach fragment，其生命周期方法会被降级到 onDestroyView。</li>\n<li>remove fragment，其生命周期方法会被降级到 onDestroyView 或者 onDestroy。</li>\n<li>show or hide fragment，生命周期方法不会回调，只是切换 fragment 根 view 的可见性。</li>\n</ol>\n<h1 id=\"sample-codes\"><a class=\"anchor\" href=\"#sample-codes\">#</a> Sample codes</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ExampleActivity</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AppCompatActivity</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ExampleActivity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">.</span>layout<span class=\"token punctuation\">.</span>example_activity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bundle</span> savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>savedInstanceState <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token function\">getSupportFragmentManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">beginTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">setReorderingAllowed</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">.</span>fragment_container_view<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ExampleFragment</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t\t\t\t\t<span class=\"token comment\">// name can be null</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\t\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">addToBackStack</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Note: the fragment transaction is only created when savedInstanceState is null. This is to ensure that the fragment is added only once, when the activity is first created. When a configuration change occurs and the activity is recreated, savedInstanceState is no longer null, and the fragment does not need to be added a second time, as the fragment is automatically restored from the savedInstanceState.</p>\n<p>Note: You should always use setReorderingAllowed(true) when performing a FragmentTransaction. For more information on reordered transactions, see Fragment transactions.</p>\n<h2 id=\"begintransaction\"><a class=\"anchor\" href=\"#begintransaction\">#</a> beginTransaction</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@NonNull</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">FragmentTransaction</span> <span class=\"token function\">beginTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"setreorderingallowed\"><a class=\"anchor\" href=\"#setreorderingallowed\">#</a> setReorderingAllowed</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Sets whether or not to allow optimizing operations within and across</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * transactions. This will remove redundant operations, eliminating</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * operations that cancel. For example, if two transactions are executed</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * together, one that adds a fragment A and the next replaces it with fragment B,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * the operations will cancel and only fragment B will be added. That means that</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * fragment A may not go through the creation/destruction lifecycle.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * The side effect of removing redundant operations is that fragments may have state changes</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * out of the expected order. For example, one transaction adds fragment A,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> * a second adds fragment B, then a third removes fragment A. Without removing the redundant</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * operations, fragment B could expect that while it is being created, fragment A will also</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * exist because fragment A will be removed after fragment B was added.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> * With removing redundant operations, fragment B cannot expect fragment A to exist when</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> * it has been created because fragment A's add/remove will be optimized out.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * It can also reorder the state changes of Fragments to allow for better Transitions.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * Added Fragments may have &#123;@link Fragment#onCreate(Bundle)&#125; called before replaced</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * Fragments have &#123;@link Fragment#onDestroy()&#125; called.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> * &#123;@link Fragment#postponeEnterTransition()&#125; requires &#123;@code setReorderingAllowed(true)&#125;.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"23\"></td><td><pre> * The default is &#123;@code false&#125;.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> * @param reorderingAllowed &#123;@code true&#125; to enable optimizing out redundant operations</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> *                          or &#123;@code false&#125; to disable optimizing out redundant</pre></td></tr><tr><td data-num=\"27\"></td><td><pre> *                          operations on this transaction.</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token annotation punctuation\">@NonNull</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">FragmentTransaction</span> <span class=\"token function\">setReorderingAllowed</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> reorderingAllowed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    mReorderingAllowed <span class=\"token operator\">=</span> reorderingAllowed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"add\"><a class=\"anchor\" href=\"#add\">#</a> add</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Calls &#123;@link #add(int, Fragment, String)&#125; with a 0 containerViewId.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token annotation punctuation\">@NonNull</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">FragmentTransaction</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">String</span> tag<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">doAddOp</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> fragment<span class=\"token punctuation\">,</span> tag<span class=\"token punctuation\">,</span> OP_ADD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">doAddOp</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> containerViewId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">String</span> tag<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> opcmd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> fragmentClass <span class=\"token operator\">=</span> fragment<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> modifiers <span class=\"token operator\">=</span> fragmentClass<span class=\"token punctuation\">.</span><span class=\"token function\">getModifiers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragmentClass<span class=\"token punctuation\">.</span><span class=\"token function\">isAnonymousClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token class-name\">Modifier</span><span class=\"token punctuation\">.</span><span class=\"token function\">isPublic</span><span class=\"token punctuation\">(</span>modifiers<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>fragmentClass<span class=\"token punctuation\">.</span><span class=\"token function\">isMemberClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token class-name\">Modifier</span><span class=\"token punctuation\">.</span><span class=\"token function\">isStatic</span><span class=\"token punctuation\">(</span>modifiers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Fragment \"</span> <span class=\"token operator\">+</span> fragmentClass<span class=\"token punctuation\">.</span><span class=\"token function\">getCanonicalName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token operator\">+</span> <span class=\"token string\">\" must be a public static class to be  properly recreated from\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token operator\">+</span> <span class=\"token string\">\" instance state.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tag <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mTag <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>tag<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Can't change tag of fragment \"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token operator\">+</span> fragment <span class=\"token operator\">+</span> <span class=\"token string\">\": was \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">.</span>mTag</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token operator\">+</span> <span class=\"token string\">\" now \"</span> <span class=\"token operator\">+</span> tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mTag <span class=\"token operator\">=</span> tag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>containerViewId <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>containerViewId <span class=\"token operator\">==</span> <span class=\"token class-name\">View</span><span class=\"token punctuation\">.</span>NO_ID<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Can't add fragment \"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                    <span class=\"token operator\">+</span> fragment <span class=\"token operator\">+</span> <span class=\"token string\">\" with tag \"</span> <span class=\"token operator\">+</span> tag <span class=\"token operator\">+</span> <span class=\"token string\">\" to container view with no id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mFragmentId <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> fragment<span class=\"token punctuation\">.</span>mFragmentId <span class=\"token operator\">!=</span> containerViewId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Can't change container ID of fragment \"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    <span class=\"token operator\">+</span> fragment <span class=\"token operator\">+</span> <span class=\"token string\">\": was \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">.</span>mFragmentId</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    <span class=\"token operator\">+</span> <span class=\"token string\">\" now \"</span> <span class=\"token operator\">+</span> containerViewId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mContainerId <span class=\"token operator\">=</span> fragment<span class=\"token punctuation\">.</span>mFragmentId <span class=\"token operator\">=</span> containerViewId<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">addOp</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Op</span><span class=\"token punctuation\">(</span>opcmd<span class=\"token punctuation\">,</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">addOp</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Op</span> op<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    mOps<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>op<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    op<span class=\"token punctuation\">.</span>mEnterAnim <span class=\"token operator\">=</span> mEnterAnim<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    op<span class=\"token punctuation\">.</span>mExitAnim <span class=\"token operator\">=</span> mExitAnim<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    op<span class=\"token punctuation\">.</span>mPopEnterAnim <span class=\"token operator\">=</span> mPopEnterAnim<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    op<span class=\"token punctuation\">.</span>mPopExitAnim <span class=\"token operator\">=</span> mPopExitAnim<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>传入 fragment 实例，将对 fragment 的增删换，显示隐藏等操作封装成 op，并加入 op 列表集合，作为一个操作事物。</p>\n<h2 id=\"addtobackstack\"><a class=\"anchor\" href=\"#addtobackstack\">#</a> addToBackStack</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Add this transaction to the back stack.  This means that the transaction</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * will be remembered after it is committed, and will reverse its operation</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * when later popped off the stack.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * &#123;@link #setReorderingAllowed(boolean)&#125; must be set to &lt;code>true&lt;/code></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * in the same transaction as addToBackStack() to allow the pop of that</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * transaction to be reordered.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * @param name An optional name for this back stack state, or null.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token annotation punctuation\">@NonNull</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">FragmentTransaction</span> <span class=\"token function\">addToBackStack</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mAllowAddToBackStack<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token string\">\"This FragmentTransaction is not allowed to be added to the back stack.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    mAddToBackStack <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mName <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>addToBackStack 更新 mAddToBackStack 标记位，并保存 backStack 名字，作为未来回退到此 backStack 的标示。</p>\n<h2 id=\"commit\"><a class=\"anchor\" href=\"#commit\">#</a> commit</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>BackStackRecord</span>#commitInternal</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">commitInternal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> allowStateLoss<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mCommitted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"commit already called\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    mCommitted <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mAddToBackStack<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        mIndex <span class=\"token operator\">=</span> mManager<span class=\"token punctuation\">.</span><span class=\"token function\">allocBackStackIndex</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        mIndex <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    mManager<span class=\"token punctuation\">.</span><span class=\"token function\">enqueueAction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> allowStateLoss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> mIndex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>如果加入 backStack，则分配一个在 backStack 的索引，然后将此事务加入提交队列，等待主线程调度提交。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#enqueueAction</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Adds an action to the queue of pending actions.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param action the action to add</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param allowStateLoss whether to allow loss of state information</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @throws IllegalStateException if the activity has been destroyed</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">enqueueAction</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OpGenerator</span> action<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> allowStateLoss<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>allowStateLoss<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token function\">checkStateLoss</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mDestroyed <span class=\"token operator\">||</span> mHost <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>allowStateLoss<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token comment\">// This FragmentManager isn't attached, so drop the entire transaction.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Activity has been destroyed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mPendingActions <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            mPendingActions <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        mPendingActions<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token function\">scheduleCommit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"opgenerator\"><a class=\"anchor\" href=\"#opgenerator\">#</a> OpGenerator</h2>\n<p>BackStackRecord 实现 OpGenerator 接口，先看下方法实现内容：将本次事务加入事务集合。并且判断如果要支持回退栈，则加入回退栈集合。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>BackStackRecord</span>#generateOps</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Implementation of &#123;@link FragmentManagerImpl.OpGenerator&#125;.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * This operation is added to the list of pending actions during &#123;@link #commit()&#125;, and</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * will be executed on the UI thread to run this FragmentTransaction.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @param records Modified to add this BackStackRecord</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * @param isRecordPop Modified to add a false (this isn't a pop)</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * @return true always because the records and isRecordPop will always be changed</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">generateOps</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">></span></span> records<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">></span></span> isRecordPop<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentManagerImpl</span><span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Run: \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    records<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mAddToBackStack<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        mManager<span class=\"token punctuation\">.</span><span class=\"token function\">addBackStackState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#addBackStackState</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">addBackStackState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BackStackRecord</span> state<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mBackStack <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        mBackStack <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    mBackStack<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"schedulecommit\"><a class=\"anchor\" href=\"#schedulecommit\">#</a> scheduleCommit</h1>\n<h2 id=\"ensureexecready\"><a class=\"anchor\" href=\"#ensureexecready\">#</a> ensureExecReady</h2>\n<p>条件检查，并实例化 mTmpRecords &amp; mTmpIsPop。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#execPendingActions</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Only call from main thread!</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">execPendingActions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">ensureExecReady</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 1. Init mTmpRecords &amp; mTmpIsPop</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">boolean</span> didSomething <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// 2. Copy BackStackRecord  in mPendingActions into mTmpRecords， so does mTmpIsPop </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">generateOpsForPendingActions</span><span class=\"token punctuation\">(</span>mTmpRecords<span class=\"token punctuation\">,</span> mTmpIsPop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        mExecutingActions <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">// 3. </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token function\">removeRedundantOperationsAndExecute</span><span class=\"token punctuation\">(</span>mTmpRecords<span class=\"token punctuation\">,</span> mTmpIsPop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token function\">cleanupExec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        didSomething <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token function\">updateOnBackPressedCallbackEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token function\">doPendingDeferredStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token function\">burpActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">return</span> didSomething<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"generateopsforpendingactions\"><a class=\"anchor\" href=\"#generateopsforpendingactions\">#</a> generateOpsForPendingActions</h2>\n<p>将 mPendingActions 的 BackStackRecord，即我们提交的事务集合，复制到 records（即成员变量 mTmpRecords，mTmpIsPop 同理）</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#generateOpsForPendingActions</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Adds all records in the pending actions to records and whether they are add or pop</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * operations to isPop. After executing, the pending actions will be empty.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param records All pending actions will generate BackStackRecords added to this.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *                This contains the transactions, in order, to execute.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * @param isPop All pending actions will generate booleans to add to this. This contains</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *              an entry for each entry in records to indicate whether or not it is a</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *              pop action.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">generateOpsForPendingActions</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">></span></span> records<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                                             <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">></span></span> isPop<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">boolean</span> didSomething <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mPendingActions <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> mPendingActions<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> numActions <span class=\"token operator\">=</span> mPendingActions<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> numActions<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            didSomething <span class=\"token operator\">|=</span> mPendingActions<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">generateOps</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">,</span> isPop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        mPendingActions<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        mHost<span class=\"token punctuation\">.</span><span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">removeCallbacks</span><span class=\"token punctuation\">(</span>mExecCommit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">return</span> didSomething<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"removeredundantoperationsandexecute\"><a class=\"anchor\" href=\"#removeredundantoperationsandexecute\">#</a> removeRedundantOperationsAndExecute</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#removeRedundantOperationsAndExecute</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Remove redundant BackStackRecord operations and executes them. This method merges operations</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * of proximate records that allow reordering. See</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * &#123;@link FragmentTransaction#setReorderingAllowed(boolean)&#125;.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * For example, a transaction that adds to the back stack and then another that pops that</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * back stack record will be optimized to remove the unnecessary operation.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> * Likewise, two transactions committed that are executed at the same time will be optimized</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * to remove the redundant operations as well as two pop operations executed together.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> * @param records The records pending execution</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> * @param isRecordPop The direction that these records are being run.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">removeRedundantOperationsAndExecute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">></span></span> records<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                                                 <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">></span></span> isRecordPop<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>records <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isRecordPop <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Internal error with the back stack records\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// Force start of any postponed transactions that interact with scheduled transactions:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token function\">executePostponedTransaction</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">,</span> isRecordPop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> numRecords <span class=\"token operator\">=</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">int</span> startIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> recordNum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> recordNum <span class=\"token operator\">&lt;</span> numRecords<span class=\"token punctuation\">;</span> recordNum<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> canReorder <span class=\"token operator\">=</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>recordNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>mReorderingAllowed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>canReorder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token comment\">// execute all previous transactions</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>startIndex <span class=\"token operator\">!=</span> recordNum<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token function\">executeOpsTogether</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">,</span> isRecordPop<span class=\"token punctuation\">,</span> startIndex<span class=\"token punctuation\">,</span> recordNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token comment\">// execute all pop operations that don't allow reordering together or</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token comment\">// one add operation</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token keyword\">int</span> reorderingEnd <span class=\"token operator\">=</span> recordNum <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>recordNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>reorderingEnd <span class=\"token operator\">&lt;</span> numRecords</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                        <span class=\"token operator\">&amp;&amp;</span> isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>reorderingEnd<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                        <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>records<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>reorderingEnd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>mReorderingAllowed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                    reorderingEnd<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token function\">executeOpsTogether</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">,</span> isRecordPop<span class=\"token punctuation\">,</span> recordNum<span class=\"token punctuation\">,</span> reorderingEnd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            startIndex <span class=\"token operator\">=</span> reorderingEnd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            recordNum <span class=\"token operator\">=</span> reorderingEnd <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token comment\">// Reorder is true as example code. Pay attention here.</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>startIndex <span class=\"token operator\">!=</span> numRecords<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t\t<span class=\"token comment\">//startIndex 为 0， numRecords 为批处理的事务个数。</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token function\">executeOpsTogether</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">,</span> isRecordPop<span class=\"token punctuation\">,</span> startIndex<span class=\"token punctuation\">,</span> numRecords<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"executeopstogether\"><a class=\"anchor\" href=\"#executeopstogether\">#</a> executeOpsTogether</h2>\n<p>一般推荐允许重排序，看最后一行方法调用 executeOpsTogether。从 API 描述看，它执行事务集合的子集，子集里事务要么是允许重排序，要么不允许。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#executeOpsTogether</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Executes a subset of a list of BackStackRecords, all of which either allow reordering or</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * do not allow ordering.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param records A list of BackStackRecords that are to be executed</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param isRecordPop The direction that these records are being run.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @param startIndex The index of the first record in &lt;code>records&lt;/code> to be executed</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * @param endIndex One more than the final record index in &lt;code>records&lt;/code> to executed.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">executeOpsTogether</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">></span></span> records<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">></span></span> isRecordPop<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> startIndex<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> endIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> allowReordering <span class=\"token operator\">=</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>startIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>mReorderingAllowed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">boolean</span> addToBackStack <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mTmpAddedFragments <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        mTmpAddedFragments <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        mTmpAddedFragments<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token comment\">// 执行 transaction.add (fragment)，事务完成后，fragment 会加入 mAdded 集合内，</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token comment\">//activity 生命周期方法派发给 FragmentManager，继而派发给 mAdded 集合内的 Fragment</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token comment\">// 此处复制已添加 Fragment 集合到临时变量，</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    mTmpAddedFragments<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">getFragments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token class-name\">Fragment</span> oldPrimaryNav <span class=\"token operator\">=</span> <span class=\"token function\">getPrimaryNavigationFragment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> recordNum <span class=\"token operator\">=</span> startIndex<span class=\"token punctuation\">;</span> recordNum <span class=\"token operator\">&lt;</span> endIndex<span class=\"token punctuation\">;</span> recordNum<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">BackStackRecord</span> <span class=\"token keyword\">record</span> <span class=\"token operator\">=</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>recordNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> isPop <span class=\"token operator\">=</span> isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>recordNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isPop<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">// 这里将 op 替换为更原子的操作，如 replace 拆解为 remove &amp; add，并将 ops 内的 fragment</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t\t\t\t<span class=\"token comment\">// 依照 op 的 cmd 命令，从 mTmpAddedFragments add 或 remove op 里的 fragment，</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            oldPrimaryNav <span class=\"token operator\">=</span> <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">expandOps</span><span class=\"token punctuation\">(</span>mTmpAddedFragments<span class=\"token punctuation\">,</span> oldPrimaryNav<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            oldPrimaryNav <span class=\"token operator\">=</span> <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">trackAddedFragmentsInPop</span><span class=\"token punctuation\">(</span>mTmpAddedFragments<span class=\"token punctuation\">,</span> oldPrimaryNav<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        addToBackStack <span class=\"token operator\">=</span> addToBackStack <span class=\"token operator\">||</span> <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span>mAddToBackStack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    mTmpAddedFragments<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>allowReordering <span class=\"token operator\">&amp;&amp;</span> mCurState <span class=\"token operator\">>=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token comment\">// 一般推荐重排序，此处代码省略</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token comment\">// 1. 遍历 BackStackRecord 集合，逐个执行事务：将 Fragment 发送给 FragmentManager 管理，并更新 Fragment 标记。</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token function\">executeOps</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">,</span> isRecordPop<span class=\"token punctuation\">,</span> startIndex<span class=\"token punctuation\">,</span> endIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>USE_STATE_MANAGER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token comment\">// The last operation determines the overall direction, this ensures that operations</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token comment\">// such as push, push, pop, push are correctly considered a push</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token keyword\">boolean</span> isPop <span class=\"token operator\">=</span> isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>endIndex <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token comment\">// Ensure that Fragments directly affected by operations</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token comment\">// are moved to their expected state in operation order</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> index <span class=\"token operator\">=</span> startIndex<span class=\"token punctuation\">;</span> index <span class=\"token operator\">&lt;</span> endIndex<span class=\"token punctuation\">;</span> index<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token class-name\">BackStackRecord</span> <span class=\"token keyword\">record</span> <span class=\"token operator\">=</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isPop<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token comment\">// Pop operations get applied in reverse order</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> opIndex <span class=\"token operator\">=</span> <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span>mOps<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> opIndex <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> opIndex<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    <span class=\"token class-name\">FragmentTransaction<span class=\"token punctuation\">.</span>Op</span> op <span class=\"token operator\">=</span> <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span>mOps<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>opIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                    <span class=\"token class-name\">Fragment</span> fragment <span class=\"token operator\">=</span> op<span class=\"token punctuation\">.</span>mFragment<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                        <span class=\"token class-name\">FragmentStateManager</span> fragmentStateManager <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                                <span class=\"token function\">createOrGetFragmentStateManager</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                        fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentTransaction<span class=\"token punctuation\">.</span>Op</span> op <span class=\"token operator\">:</span> <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span>mOps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                    <span class=\"token class-name\">Fragment</span> fragment <span class=\"token operator\">=</span> op<span class=\"token punctuation\">.</span>mFragment<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                        <span class=\"token class-name\">FragmentStateManager</span> fragmentStateManager <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                                <span class=\"token function\">createOrGetFragmentStateManager</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"token comment\">// 2. 事务内的 Fragment 推送至默认状态</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                        fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token comment\">// And only then do we move all other fragments to the current state</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 3. 将 Fragment 全部推送到当前 FragmentManager 的状态。</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span>mCurState<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SpecialEffectsController</span><span class=\"token punctuation\">></span></span> changedControllers <span class=\"token operator\">=</span> <span class=\"token function\">collectChangedControllers</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                records<span class=\"token punctuation\">,</span> startIndex<span class=\"token punctuation\">,</span> endIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SpecialEffectsController</span> controller <span class=\"token operator\">:</span> changedControllers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            controller<span class=\"token punctuation\">.</span><span class=\"token function\">updateOperationDirection</span><span class=\"token punctuation\">(</span>isPop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            controller<span class=\"token punctuation\">.</span><span class=\"token function\">markPostponedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>            controller<span class=\"token punctuation\">.</span><span class=\"token function\">executePendingOperations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token comment\">// USE_STATE_MANAGER 默认为 true，此处代码省略</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t<span class=\"token comment\">// 调用每个事务的提交监听回掉</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> recordNum <span class=\"token operator\">=</span> startIndex<span class=\"token punctuation\">;</span> recordNum <span class=\"token operator\">&lt;</span> endIndex<span class=\"token punctuation\">;</span> recordNum<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">BackStackRecord</span> <span class=\"token keyword\">record</span> <span class=\"token operator\">=</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>recordNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> isPop <span class=\"token operator\">=</span> isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>recordNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isPop <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span>mIndex <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>            <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span>mIndex <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">runOnCommitRunnables</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t<span class=\"token comment\">//// 通知 backStack 变更的监听回掉</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>addToBackStack<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token function\">reportBackStackChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"executeops\"><a class=\"anchor\" href=\"#executeops\">#</a> executeOps</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#executeOps</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Run the operations in the BackStackRecords, either to push or pop.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param records The list of records whose operations should be run.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param isRecordPop The direction that these records are being run.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @param startIndex The index of the first entry in records to run.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * @param endIndex One past the index of the final entry in records to run.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">executeOps</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BackStackRecord</span><span class=\"token punctuation\">></span></span> records<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                               <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">></span></span> isRecordPop<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> startIndex<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> endIndex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> startIndex<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> endIndex<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">BackStackRecord</span> <span class=\"token keyword\">record</span> <span class=\"token operator\">=</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> isPop <span class=\"token operator\">=</span> isRecordPop<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isPop<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">bumpBackStackNesting</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token comment\">// Only execute the add operations at the end of</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token comment\">// all transactions.</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">boolean</span> moveToState <span class=\"token operator\">=</span> i <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>endIndex <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">executePopOps</span><span class=\"token punctuation\">(</span>moveToState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">bumpBackStackNesting</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">record</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeOps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>遍历事务 Op 集合，逐个执行事务里的 Op</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>BackStackRecord</span>#executeOps</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * Executes the operations contained within this transaction. The Fragment states will only</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * be modified if optimizations are not allowed.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">executeOps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> numOps <span class=\"token operator\">=</span> mOps<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> opNum <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> opNum <span class=\"token operator\">&lt;</span> numOps<span class=\"token punctuation\">;</span> opNum<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Op</span> op <span class=\"token operator\">=</span> mOps<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>opNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">=</span> op<span class=\"token punctuation\">.</span>mFragment<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            f<span class=\"token punctuation\">.</span><span class=\"token function\">setPopDirection</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            f<span class=\"token punctuation\">.</span><span class=\"token function\">setAnimations</span><span class=\"token punctuation\">(</span>op<span class=\"token punctuation\">.</span>mEnterAnim<span class=\"token punctuation\">,</span> op<span class=\"token punctuation\">.</span>mExitAnim<span class=\"token punctuation\">,</span> op<span class=\"token punctuation\">.</span>mPopEnterAnim<span class=\"token punctuation\">,</span> op<span class=\"token punctuation\">.</span>mPopExitAnim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            f<span class=\"token punctuation\">.</span><span class=\"token function\">setNextTransition</span><span class=\"token punctuation\">(</span>mTransition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            f<span class=\"token punctuation\">.</span><span class=\"token function\">setSharedElementNames</span><span class=\"token punctuation\">(</span>mSharedElementSourceNames<span class=\"token punctuation\">,</span> mSharedElementTargetNames<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>op<span class=\"token punctuation\">.</span>mCmd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_ADD<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setExitAnimationOrder</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">addFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_REMOVE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">removeFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_HIDE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">hideFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_SHOW<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setExitAnimationOrder</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">showFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_DETACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">detachFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_ATTACH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setExitAnimationOrder</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">attachFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_SET_PRIMARY_NAV<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setPrimaryNavigationFragment</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_UNSET_PRIMARY_NAV<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setPrimaryNavigationFragment</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token keyword\">case</span> OP_SET_MAX_LIFECYCLE<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">setMaxLifecycle</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> op<span class=\"token punctuation\">.</span>mCurrentMaxState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unknown cmd: \"</span> <span class=\"token operator\">+</span> op<span class=\"token punctuation\">.</span>mCmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 允许排序，以下代码不执行</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mReorderingAllowed <span class=\"token operator\">&amp;&amp;</span> op<span class=\"token punctuation\">.</span>mCmd <span class=\"token operator\">!=</span> OP_ADD <span class=\"token operator\">&amp;&amp;</span> f <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span>USE_STATE_MANAGER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                mManager<span class=\"token punctuation\">.</span><span class=\"token function\">moveFragmentToExpectedState</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mReorderingAllowed <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span>USE_STATE_MANAGER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token comment\">// Added fragments are added at the end to comply with prior behavior.</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        mManager<span class=\"token punctuation\">.</span><span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span>mManager<span class=\"token punctuation\">.</span>mCurState<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>addFragment &amp; removeFragment 主要是操作 mAdded fragment 集合并更新 fragment.mRemoving &amp; fragment.mAdded 标记</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#removeFragment</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">removeFragment</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>VERBOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"remove: \"</span> <span class=\"token operator\">+</span> fragment <span class=\"token operator\">+</span> <span class=\"token string\">\" nesting=\"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">.</span>mBackStackNesting<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> inactive <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span><span class=\"token function\">isInBackStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mDetached <span class=\"token operator\">||</span> inactive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">removeFragment</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isMenuAvailable</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mRemoving <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">setVisibleRemovingFragment</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#addFragment</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token class-name\">FragmentStateManager</span> <span class=\"token function\">addFragment</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>VERBOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"add: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token class-name\">FragmentStateManager</span> fragmentStateManager <span class=\"token operator\">=</span> <span class=\"token function\">createOrGetFragmentStateManager</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    fragment<span class=\"token punctuation\">.</span>mFragmentManager <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">makeActive</span><span class=\"token punctuation\">(</span>fragmentStateManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mDetached<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">addFragment</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mRemoving <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mView <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            fragment<span class=\"token punctuation\">.</span>mHiddenChanged <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isMenuAvailable</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">return</span> fragmentStateManager<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>attachFragment 与 addFragment 的差异：</p>\n<ol>\n<li>无 makeActive (fragment)，这个差异导致两者的 Fragment 默认升级到 started 状态后，只有 add fragment 会继续与 FragmentManager 状态同步，接收 FragmentManager 生命周期方法的派发，attach fragment 则到此戛然而止。也没有 moveToState (fragment) 操作（addFragment 下，此方法不调用，传入 moveToStateNow 参数值为 false）</li>\n<li>只有之前 detach 操作过，attach 才有效果。</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#attachFragment</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">attachFragment</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>VERBOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"attach: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mDetached<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 初始化时，mDetached 为 false，只有 detachFragment 才置为 true。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mDetached <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">addFragment</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>VERBOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"add from attach: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isMenuAvailable</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentStore</span>#addFragment</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">addFragment</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Fragment already added: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    fragment<span class=\"token punctuation\">.</span>mAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>remove &amp; detachFragment 都将 fragment 从 mAdded 集合移除 fragment，不同的是分别标记 mRemoving &amp; mDetached 为 true。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">removeFragment</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>VERBOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"remove: \"</span> <span class=\"token operator\">+</span> fragment <span class=\"token operator\">+</span> <span class=\"token string\">\" nesting=\"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">.</span>mBackStackNesting<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> inactive <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span><span class=\"token function\">isInBackStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mDetached <span class=\"token operator\">||</span> inactive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">removeFragment</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isMenuAvailable</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mRemoving <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token function\">setVisibleRemovingFragment</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">removeFragment</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        mAdded<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    fragment<span class=\"token punctuation\">.</span>mAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">detachFragment</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>VERBOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"detach: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mDetached<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mDetached <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token comment\">// We are not already in back stack, so need to remove the fragment.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>VERBOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"remove from detach: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">removeFragment</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isMenuAvailable</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token function\">setVisibleRemovingFragment</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>showFrament &amp; hideFragment 主要更新 mHidden 标记</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Marks a fragment as hidden to be later animated in with</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * &#123;@link #completeShowHideFragment(Fragment)&#125;.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param fragment The fragment to be shown.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">hideFragment</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>VERBOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"hide: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mHidden<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mHidden <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// it doesn't go through the animation.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mHiddenChanged <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mHiddenChanged<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token function\">setVisibleRemovingFragment</span><span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * Marks a fragment as shown to be later animated in with</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> * &#123;@link #completeShowHideFragment(Fragment)&#125;.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> * @param fragment The fragment to be shown.</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">showFragment</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Fragment</span> fragment<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>VERBOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"show: \"</span> <span class=\"token operator\">+</span> fragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragment<span class=\"token punctuation\">.</span>mHidden<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mHidden <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token comment\">// it doesn't go through the animation.</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        fragment<span class=\"token punctuation\">.</span>mHiddenChanged <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>fragment<span class=\"token punctuation\">.</span>mHiddenChanged<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Fragment 主要标记</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// True if the fragment is in the list of added fragments.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">boolean</span> mAdded<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// If set this fragment is being removed from its activity.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">boolean</span> mRemoving<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// Set to true when the app has requested that this fragment be hidden</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// from the user.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">boolean</span> mHidden<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// Set to true when the app has requested that this fragment be deactivated.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">boolean</span> mDetached<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"movetoexpectedstate\"><a class=\"anchor\" href=\"#movetoexpectedstate\">#</a> moveToExpectedState</h3>\n<p>遍历事务集合，将事务内每个 op 对应的 Fragment 推送到合适的状态，具体状态值在 computeExpectedState 计算。默认是当前 FragmentManager 的状态。但会根据 Fragment 标记重算。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Assume the Fragment can go as high as the FragmentManager's state</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">int</span> maxState <span class=\"token operator\">=</span> mFragmentManagerState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// Fragments that are not currently added will sit in the CREATED state.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//detach &amp; remove 操作的 fragment，目标状态是 CREATED</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mFragment<span class=\"token punctuation\">.</span>mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    maxState <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>maxState<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mRemoving<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span><span class=\"token function\">isInBackStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// Fragments on the back stack shouldn't go higher than CREATED</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        maxState <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>maxState<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// While removing a fragment, we always move to INITIALIZING</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t\t<span class=\"token comment\">//remove 操作的 Fragment，如果不在回退栈，目标状态是 INITIALIZING</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        maxState <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>maxState<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>INITIALIZING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mMovingToState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>VERBOSE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">v</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Ignoring re-entrant call to \"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                        <span class=\"token operator\">+</span> <span class=\"token string\">\"moveToExpectedState() for \"</span> <span class=\"token operator\">+</span> <span class=\"token function\">getFragment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            mMovingToState <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">int</span> newState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>newState <span class=\"token operator\">=</span> <span class=\"token function\">computeExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> mFragment<span class=\"token punctuation\">.</span>mState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newState <span class=\"token operator\">></span> mFragment<span class=\"token punctuation\">.</span>mState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token comment\">// Moving upward</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                    <span class=\"token keyword\">int</span> nextStep <span class=\"token operator\">=</span> mFragment<span class=\"token punctuation\">.</span>mState <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>nextStep<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>ATTACHED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                            <span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                            <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>VIEW_CREATED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                            <span class=\"token function\">ensureInflatedView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                            <span class=\"token function\">createView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>AWAITING_EXIT_EFFECTS<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                            <span class=\"token function\">activityCreated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>ACTIVITY_CREATED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mView <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> mFragment<span class=\"token punctuation\">.</span>mContainer <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                                <span class=\"token class-name\">SpecialEffectsController</span> controller <span class=\"token operator\">=</span> <span class=\"token class-name\">SpecialEffectsController</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                                        <span class=\"token punctuation\">.</span><span class=\"token function\">getOrCreateController</span><span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mContainer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                                                mFragment<span class=\"token punctuation\">.</span><span class=\"token function\">getParentFragmentManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                                <span class=\"token keyword\">int</span> visibility <span class=\"token operator\">=</span> mFragment<span class=\"token punctuation\">.</span>mView<span class=\"token punctuation\">.</span><span class=\"token function\">getVisibility</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                                <span class=\"token class-name\">SpecialEffectsController<span class=\"token punctuation\">.</span>Operation<span class=\"token punctuation\">.</span>State</span> finalState <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                                        <span class=\"token class-name\">SpecialEffectsController<span class=\"token punctuation\">.</span>Operation<span class=\"token punctuation\">.</span>State</span><span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>visibility<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                                controller<span class=\"token punctuation\">.</span><span class=\"token function\">enqueueAdd</span><span class=\"token punctuation\">(</span>finalState<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                            mFragment<span class=\"token punctuation\">.</span>mState <span class=\"token operator\">=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>ACTIVITY_CREATED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>STARTED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                            <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>AWAITING_ENTER_EFFECTS<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                            mFragment<span class=\"token punctuation\">.</span>mState <span class=\"token operator\">=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>AWAITING_ENTER_EFFECTS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>RESUMED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                            <span class=\"token function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                    <span class=\"token comment\">// Moving downward</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                    <span class=\"token keyword\">int</span> nextStep <span class=\"token operator\">=</span> mFragment<span class=\"token punctuation\">.</span>mState <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>nextStep<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>AWAITING_ENTER_EFFECTS<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                            <span class=\"token function\">pause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>STARTED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                            mFragment<span class=\"token punctuation\">.</span>mState <span class=\"token operator\">=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>STARTED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>ACTIVITY_CREATED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                            <span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>AWAITING_EXIT_EFFECTS<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">isLoggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                                <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">d</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"movefrom ACTIVITY_CREATED: \"</span> <span class=\"token operator\">+</span> mFragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mView <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                                <span class=\"token comment\">// Need to save the current view state if not done already</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                                <span class=\"token comment\">// by saveInstanceState()</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mSavedViewState <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                                    <span class=\"token function\">saveViewState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mView <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> mFragment<span class=\"token punctuation\">.</span>mContainer <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                                <span class=\"token class-name\">SpecialEffectsController</span> controller <span class=\"token operator\">=</span> <span class=\"token class-name\">SpecialEffectsController</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                                        <span class=\"token punctuation\">.</span><span class=\"token function\">getOrCreateController</span><span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mContainer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                                                mFragment<span class=\"token punctuation\">.</span><span class=\"token function\">getParentFragmentManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                                controller<span class=\"token punctuation\">.</span><span class=\"token function\">enqueueRemove</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                            mFragment<span class=\"token punctuation\">.</span>mState <span class=\"token operator\">=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>AWAITING_EXIT_EFFECTS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>VIEW_CREATED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                            mFragment<span class=\"token punctuation\">.</span>mInLayout <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                            mFragment<span class=\"token punctuation\">.</span>mState <span class=\"token operator\">=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>VIEW_CREATED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                            <span class=\"token function\">destroyFragmentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                            mFragment<span class=\"token punctuation\">.</span>mState <span class=\"token operator\">=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>CREATED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>ATTACHED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                            <span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                        <span class=\"token keyword\">case</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>INITIALIZING<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                            <span class=\"token function\">detach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentManager</span><span class=\"token punctuation\">.</span>USE_STATE_MANAGER <span class=\"token operator\">&amp;&amp;</span> mFragment<span class=\"token punctuation\">.</span>mHiddenChanged<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mView <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> mFragment<span class=\"token punctuation\">.</span>mContainer <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                    <span class=\"token comment\">// Get the controller and enqueue the show/hide</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                    <span class=\"token class-name\">SpecialEffectsController</span> controller <span class=\"token operator\">=</span> <span class=\"token class-name\">SpecialEffectsController</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>                            <span class=\"token punctuation\">.</span><span class=\"token function\">getOrCreateController</span><span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mContainer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                                    mFragment<span class=\"token punctuation\">.</span><span class=\"token function\">getParentFragmentManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mHidden<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>                        controller<span class=\"token punctuation\">.</span><span class=\"token function\">enqueueHide</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>                        controller<span class=\"token punctuation\">.</span><span class=\"token function\">enqueueShow</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mFragmentManager <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                    mFragment<span class=\"token punctuation\">.</span>mFragmentManager<span class=\"token punctuation\">.</span><span class=\"token function\">invalidateMenuForFragment</span><span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                mFragment<span class=\"token punctuation\">.</span>mHiddenChanged <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>                mFragment<span class=\"token punctuation\">.</span><span class=\"token function\">onHiddenChanged</span><span class=\"token punctuation\">(</span>mFragment<span class=\"token punctuation\">.</span>mHidden<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>            mMovingToState <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentManager</span>#<span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * Changes the state of the fragment manager to &#123;@code newState&#125;. If the fragment manager</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * changes state or &#123;@code always&#125; is &#123;@code true&#125;, any fragments within it have their</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * states updated as well.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @param newState The new state for the fragment manager</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * @param always If &#123;@code true&#125;, all fragments update their state, even</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *               if &#123;@code newState&#125; matches the current fragment manager's state.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">moveToState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> newState<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> always<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mHost <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> newState <span class=\"token operator\">!=</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>INITIALIZING<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalStateException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No activity\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>always <span class=\"token operator\">&amp;&amp;</span> newState <span class=\"token operator\">==</span> mCurState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    mCurState <span class=\"token operator\">=</span> newState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>USE_STATE_MANAGER<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">// Must add them in the proper order. mActive fragments may be out of order</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">:</span> mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">getFragments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token function\">moveFragmentToExpectedState</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token comment\">// Now iterate through all active fragments. These will include those that are removed</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token comment\">// and detached.</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentStateManager</span> fragmentStateManager <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">getActiveFragmentStateManagers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">=</span> fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">getFragment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>f<span class=\"token punctuation\">.</span>mIsNewlyAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token function\">moveFragmentToExpectedState</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token keyword\">boolean</span> beingRemoved <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>mRemoving <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">isInBackStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>beingRemoved<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                mFragmentStore<span class=\"token punctuation\">.</span><span class=\"token function\">makeInactive</span><span class=\"token punctuation\">(</span>fragmentStateManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token function\">startPendingDeferredFragments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mNeedMenuInvalidate <span class=\"token operator\">&amp;&amp;</span> mHost <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> mCurState <span class=\"token operator\">==</span> <span class=\"token class-name\">Fragment</span><span class=\"token punctuation\">.</span>RESUMED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        mHost<span class=\"token punctuation\">.</span><span class=\"token function\">onSupportInvalidateOptionsMenu</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        mNeedMenuInvalidate <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>同步 FragmentManager 的状态到 mActive 集合里的 Fragments，mAdded 集合的不同步。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>fragment<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>FragmentStore</span>#moveToExpectedState</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// Must add them in the proper order. mActive fragments may be out of order</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">:</span> mAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token class-name\">FragmentStateManager</span> fragmentStateManager <span class=\"token operator\">=</span> mActive<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>mWho<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragmentStateManager <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// Now iterate through all active fragments. These will include those that are removed</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// and detached.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">FragmentStateManager</span> fragmentStateManager <span class=\"token operator\">:</span> mActive<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fragmentStateManager <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">moveToExpectedState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token class-name\">Fragment</span> f <span class=\"token operator\">=</span> fragmentStateManager<span class=\"token punctuation\">.</span><span class=\"token function\">getFragment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">boolean</span> beingRemoved <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>mRemoving <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>f<span class=\"token punctuation\">.</span><span class=\"token function\">isInBackStack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>beingRemoved<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token function\">makeInactive</span><span class=\"token punctuation\">(</span>fragmentStateManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>将当前 Fragment 的状态沿着下方箭头方向升级（curState &lt;newState），或降级 (curState&gt; newState) 至 newState，（想象状态值是一个等腰三角形，resumed 在上方顶点，created &amp; destroyed 位于下方两端。从左顶点到上顶点是升级，上顶点到右顶点是降级）状态值如下，RESUMED 状态值最大。当前 newState 参数值为 STARTED。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> INITIALIZING <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// Not yet created.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> CREATED <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Created.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> ACTIVITY_CREATED <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Fully created, not started.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> STARTED <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Created and started, not resumed.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> RESUMED <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// Created started and resumed.</span></pre></td></tr></table></figure><p><img data-src=\"https://developer.android.com/images/guide/fragments/fragment-view-lifecycle.png\" alt=\"https://developer.android.com/images/guide/fragments/fragment-view-lifecycle.png\" /></p>\n<p>由上可见，Fragment 添加后，首先推送升级到 STARTED 状态。</p>\n",
            "tags": []
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2021/09/19/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/",
            "url": "https://limxtop1989.github.io/limxtop/2021/09/19/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/",
            "title": "ViewModel源码剖析",
            "date_published": "2021-09-19T10:44:37.000Z",
            "content_html": "<h1 id=\"viewmodel-源码剖析\"><a class=\"anchor\" href=\"#viewmodel-源码剖析\">#</a> ViewModel 源码剖析</h1>\n<h1 id=\"示例代码\"><a class=\"anchor\" href=\"#示例代码\">#</a> 示例代码</h1>\n<p>ViewModel 负责数据存储，借助 LiveData，实现异步获取数据，完成后，通知 UI 观察者，更新 UI</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyViewModel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ViewModel</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MutableLiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> users<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">LiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getUsers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>users <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            users <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MutableLiveData</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token function\">loadUsers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">return</span> users<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loadUsers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// Do an asynchronous operation to fetch users.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\t<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> requestResult <span class=\"token operator\">=</span> <span class=\"token function\">requestUsers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// Once value changes, observer will be notified.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t\tusers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>requestResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>UI 层注册数据变更监听。注意 ViewModelProvider 构造器参数是哪个 Activity，Fragment 实例，ViewModel 实例化后，其引用寄存在该实例内。他们都实现 ViewModelStoreOwner 接口。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyActivity</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AppCompatActivity</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bundle</span> savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token comment\">// Create a ViewModel the first time the system calls an activity's onCreate() method.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// Re-created activities receive the same MyViewModel instance created by the first activity.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// 1. ViewModel 实例挂载在 this 实例里，有点相当于是 this 实例的成员变量</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token class-name\">MyViewModel</span> model <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ViewModelProvider</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MyViewModel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\">// 2. 这里的 this 参数，决定观察者的生命周期。注意，如果此参数是 activity 实例，而当前类是 fragment，则 fragment 实例内存泄漏</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        model<span class=\"token punctuation\">.</span><span class=\"token function\">getUsers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> users <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token comment\">// update UI</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>注意，observe 这里第一个参数，决定观察者的生命周期。所以，如下示例代码，此参数是 activity 实例，而当前类是 fragment，则 fragment 实例内存泄漏，因为监听实例生命周期和 Activity 一致，而它持有 Fragment 实例引用，导致 Fragment 在 Activity 生命周期内无法被回收。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyFragment</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Fragment</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bundle</span> savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token comment\">// Create a ViewModel the first time the system calls an activity's onCreate() method.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// Re-created activities receive the same MyViewModel instance created by the first activity.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token class-name\">MyViewModel</span> model <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ViewModelProvider</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MyViewModel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        model<span class=\"token punctuation\">.</span><span class=\"token function\">getUsers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token function\">requireActivity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> users <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token comment\">// update UI</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"源码剖析\"><a class=\"anchor\" href=\"#源码剖析\">#</a> 源码剖析</h1>\n<p>先从 ViewModel 实例化开始，首先要解决 ViewModel 如何实例化，并存放实例，便后续获取实例。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>ViewModelProvider</span><span class=\"token punctuation\">.</span>java</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * Creates &#123;@code ViewModelProvider&#125;. This will create &#123;@code ViewModels&#125;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * and retain them in a store of the given &#123;@code ViewModelStoreOwner&#125;.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * &lt;p></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * This method will use the</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * &#123;@link HasDefaultViewModelProviderFactory#getDefaultViewModelProviderFactory() default factory&#125;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * if the owner implements &#123;@link HasDefaultViewModelProviderFactory&#125;. Otherwise, a</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * &#123;@link NewInstanceFactory&#125; will be used.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">ViewModelProvider</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">ViewModelStoreOwner</span> owner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">.</span><span class=\"token function\">getViewModelStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> owner <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">HasDefaultViewModelProviderFactory</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HasDefaultViewModelProviderFactory</span><span class=\"token punctuation\">)</span> owner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDefaultViewModelProviderFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token operator\">:</span> <span class=\"token class-name\">NewInstanceFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * Creates &#123;@code ViewModelProvider&#125;, which will create &#123;@code ViewModels&#125; via the given</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * &#123;@code Factory&#125; and retain them in a store of the given &#123;@code ViewModelStoreOwner&#125;.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> * @param owner   a &#123;@code ViewModelStoreOwner&#125; whose &#123;@link ViewModelStore&#125; will be used to</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> *                retain &#123;@code ViewModels&#125;</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> * @param factory a &#123;@code Factory&#125; which will be used to instantiate</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> *                new &#123;@code ViewModels&#125;</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">ViewModelProvider</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">ViewModelStoreOwner</span> owner<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Factory</span> factory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>owner<span class=\"token punctuation\">.</span><span class=\"token function\">getViewModelStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> * Creates &#123;@code ViewModelProvider&#125;, which will create &#123;@code ViewModels&#125; via the given</pre></td></tr><tr><td data-num=\"32\"></td><td><pre> * &#123;@code Factory&#125; and retain them in the given &#123;@code store&#125;.</pre></td></tr><tr><td data-num=\"33\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"34\"></td><td><pre> * @param store   &#123;@code ViewModelStore&#125; where ViewModels will be stored.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre> * @param factory factory a &#123;@code Factory&#125; which will be used to instantiate</pre></td></tr><tr><td data-num=\"36\"></td><td><pre> *                new &#123;@code ViewModels&#125;</pre></td></tr><tr><td data-num=\"37\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">ViewModelProvider</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">ViewModelStore</span> store<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Factory</span> factory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    mFactory <span class=\"token operator\">=</span> factory<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    mViewModelStore <span class=\"token operator\">=</span> store<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Activity，Fragment 实例，他们都实现 ViewModelStoreOwner 接口，看这名字，顾名思义，就是提供存放 ViewModel 实例的地方。同时，ViewModelStoreOwner 可能自带 ViewModel 构造工厂，没有的话，就使用 ViewModelProvider 内的 NewInstanceFactory 实例。</p>\n<p>ViewModelStoreOwner 返回 ViewModelStore，内部就是一个 Map，key 是 <code>ViewModelProvider(this).get(MyViewModel.class);</code> get 方法传入 ViewModel class 的 canonicalName，value 就是对应的 ViewModel 实例啦。Activity 或者 Fragment 持有 ViewModelStore 引用。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>ViewModelProvider</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ViewModel</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">T</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> modelClass<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">String</span> canonicalName <span class=\"token operator\">=</span> modelClass<span class=\"token punctuation\">.</span><span class=\"token function\">getCanonicalName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>canonicalName <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Local and anonymous classes can not be ViewModels\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>DEFAULT_KEY <span class=\"token operator\">+</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> canonicalName<span class=\"token punctuation\">,</span> modelClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ViewModel</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">T</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">String</span> key<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> modelClass<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token class-name\">ViewModel</span> viewModel <span class=\"token operator\">=</span> mViewModelStore<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>modelClass<span class=\"token punctuation\">.</span><span class=\"token function\">isInstance</span><span class=\"token punctuation\">(</span>viewModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFactory <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">OnRequeryFactory</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OnRequeryFactory</span><span class=\"token punctuation\">)</span> mFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">onRequery</span><span class=\"token punctuation\">(</span>viewModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> viewModel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">//noinspection StatementWithEmptyBody</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>viewModel <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token comment\">// TODO: log a warning.</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFactory <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">KeyedFactory</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        viewModel <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KeyedFactory</span><span class=\"token punctuation\">)</span> mFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> modelClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        viewModel <span class=\"token operator\">=</span> mFactory<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>modelClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    mViewModelStore<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> viewModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> viewModel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>总结下，ViewModelStoreOwner 提供负责存储 ViewModel 的类：ViewModelStore，ViewModel 由 Factory 创建，然后放在 ViewModelStore 实例内，下次直接从 ViewModelStore 通过 get 方法获取，单例。</p>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2021/09/8a107bebc30102c8.png\" alt=\"ViewModel\" /></p>\n<h1 id=\"androidviewmodel-viewmodel\"><a class=\"anchor\" href=\"#androidviewmodel-viewmodel\">#</a> AndroidViewModel &amp; ViewModel</h1>\n<p>ViewModel 不可以强引用 Context，如果确实需要，则使用 AndroidViewModel，它持有 Application 的引用。解决需要的同时，避免 Activity 泄漏。</p>\n<p><code>ViewModelProvider</code>  默认实例化的 ViewModel 由 NewInstanceFactory 创建。AndroidViewModel 由 AndroidViewModelFactory 通过作为实例化 <code>ViewModelProvider</code>  构造器的 Factory 参数创建。</p>\n<p>Activity &amp; Fragment 也同时实现 <code>HasDefaultViewModelProviderFactory</code>  接口。看下 <code>SavedStateViewModelFactory</code>  ，区分是实例化 ViewModel 还是 AndroidViewModel，并增加保存状态的处理。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>SavedStateViewModelFactory</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@NonNull</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ViewModel</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">T</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">String</span> key<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> modelClass<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">boolean</span> isAndroidViewModel <span class=\"token operator\">=</span> <span class=\"token class-name\">AndroidViewModel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">isAssignableFrom</span><span class=\"token punctuation\">(</span>modelClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">Constructor</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> constructor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isAndroidViewModel <span class=\"token operator\">&amp;&amp;</span> mApplication <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        constructor <span class=\"token operator\">=</span> <span class=\"token function\">findMatchingConstructor</span><span class=\"token punctuation\">(</span>modelClass<span class=\"token punctuation\">,</span> ANDROID_VIEWMODEL_SIGNATURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        constructor <span class=\"token operator\">=</span> <span class=\"token function\">findMatchingConstructor</span><span class=\"token punctuation\">(</span>modelClass<span class=\"token punctuation\">,</span> VIEWMODEL_SIGNATURE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// doesn't need SavedStateHandle</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>constructor <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">return</span> mFactory<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>modelClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token class-name\">SavedStateHandleController</span> controller <span class=\"token operator\">=</span> <span class=\"token class-name\">SavedStateHandleController</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            mSavedStateRegistry<span class=\"token punctuation\">,</span> mLifecycle<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> mDefaultArgs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token class-name\">T</span> viewmodel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isAndroidViewModel <span class=\"token operator\">&amp;&amp;</span> mApplication <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            viewmodel <span class=\"token operator\">=</span> constructor<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span>mApplication<span class=\"token punctuation\">,</span> controller<span class=\"token punctuation\">.</span><span class=\"token function\">getHandle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            viewmodel <span class=\"token operator\">=</span> constructor<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span>controller<span class=\"token punctuation\">.</span><span class=\"token function\">getHandle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        viewmodel<span class=\"token punctuation\">.</span><span class=\"token function\">setTagIfAbsent</span><span class=\"token punctuation\">(</span>TAG_SAVED_STATE_HANDLE_CONTROLLER<span class=\"token punctuation\">,</span> controller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">return</span> viewmodel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IllegalAccessException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to access \"</span> <span class=\"token operator\">+</span> modelClass<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InstantiationException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A \"</span> <span class=\"token operator\">+</span> modelClass <span class=\"token operator\">+</span> <span class=\"token string\">\" cannot be instantiated.\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InvocationTargetException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"An exception happened in constructor of \"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token operator\">+</span> modelClass<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getCause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ViewModel 就是一个壳，与 ViewModelStoreOwner 共存亡。但 Activity 因 onConfigurationChanged 重建后，会获取上一个 Activity ViewModelStore，恢复上一个 ViewModel。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>activity<span class=\"token punctuation\">.</span></span>ComponentActivity</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">ensureViewModelStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mViewModelStore <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token class-name\">NonConfigurationInstances</span> nc <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token punctuation\">(</span><span class=\"token class-name\">NonConfigurationInstances</span><span class=\"token punctuation\">)</span> <span class=\"token function\">getLastNonConfigurationInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nc <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token comment\">// Restore the ViewModelStore from NonConfigurationInstances</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            mViewModelStore <span class=\"token operator\">=</span> nc<span class=\"token punctuation\">.</span>viewModelStore<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mViewModelStore <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            mViewModelStore <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ViewModelStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"onrequeryfactory-接口\"><a class=\"anchor\" href=\"#onrequeryfactory-接口\">#</a> OnRequeryFactory 接口</h1>\n<p>用途：提供从 ViewModelProvider get 返回 ViewModel 实例前的回调，可以在返回前对 ViewModel 做些预处理。SavedStateViewModelFactory 实现此接口。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>SavedStateViewModelFactory</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">onRequery</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">ViewModel</span> viewModel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">attachHandleIfNeeded</span><span class=\"token punctuation\">(</span>viewModel<span class=\"token punctuation\">,</span> mSavedStateRegistry<span class=\"token punctuation\">,</span> mLifecycle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>lifecycle<span class=\"token punctuation\">.</span></span>ViewModelProvider</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ViewModel</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">T</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">String</span> key<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> modelClass<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">ViewModel</span> viewModel <span class=\"token operator\">=</span> mViewModelStore<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>modelClass<span class=\"token punctuation\">.</span><span class=\"token function\">isInstance</span><span class=\"token punctuation\">(</span>viewModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// ViewModel 返回前处理</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFactory <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">OnRequeryFactory</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OnRequeryFactory</span><span class=\"token punctuation\">)</span> mFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">onRequery</span><span class=\"token punctuation\">(</span>viewModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> viewModel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">//noinspection StatementWithEmptyBody</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>viewModel <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token comment\">// TODO: log a warning.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mFactory <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">KeyedFactory</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        viewModel <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KeyedFactory</span><span class=\"token punctuation\">)</span> mFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> modelClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        viewModel <span class=\"token operator\">=</span> mFactory<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>modelClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    mViewModelStore<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> viewModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> viewModel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "ViewModel源码剖析, Android, ViewModel"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2021/08/18/English-introduction/",
            "url": "https://limxtop1989.github.io/limxtop/2021/08/18/English-introduction/",
            "title": "英语自学指南",
            "date_published": "2021-08-18T13:23:28.000Z",
            "content_html": "<h1 id=\"联系我\"><a class=\"anchor\" href=\"#联系我\">#</a> 联系我</h1>\n<p>Email:    <span class=\"exturl\" data-url=\"bWFpbHRvOmxpbXh0b3BAZ21haWwuY29t\">limxtop@gmail.com</span><br />\nWechat: limxtop<br />\nTwitter:  @limxtop</p>\n<h1 id=\"作者寄语\"><a class=\"anchor\" href=\"#作者寄语\">#</a> 作者寄语</h1>\n<p>作者个人经验，很多同学投入可观的时间和精力，学习英语，但最后大学毕业，连看英文文档的能力和勇气都没有，功败垂成，这很令人惋惜。本文对此展开深入的分析和解释，从而悟出学习掌握新语言读写听说能力的根本方法和策略，它们很简单，简单到如同每天清晨醒来刷牙洗漱，也不需要占用太多额外的时间。在此分享给大家，读懂原理，然后按部就班跟着做就好了，理论上可以帮助大家早日脱离苦海。</p>\n<h1 id=\"本文要点\"><a class=\"anchor\" href=\"#本文要点\">#</a> 本文要点</h1>\n<ol>\n<li>解释很多人十年英语刻苦学习，最后多以失败告终的根源。</li>\n<li>解释坚持和投入<strong>有效</strong>的训练是学习掌握任何一门语言和科学技术的必要条件。</li>\n<li>阐述成人学习掌握新语言的能力胜于孩童，只是缺乏训练环境。</li>\n<li>陈述如何搭建个人训练环境并展开有效训练。</li>\n<li>描述如何降低训练难度，使学习变得舒适自然，无需头悬梁，锥刺股。</li>\n<li>最后附上词典安装配置和语法书。</li>\n</ol>\n<h1 id=\"驳斥英语无用论\"><a class=\"anchor\" href=\"#驳斥英语无用论\">#</a> 驳斥英语无用论</h1>\n<p>有朋友曾经对我说：“我没有需要学英语，阅读英文效率太低，实际也用不到，何不如把有限的时间用在更感兴趣的地方。”</p>\n<p>我相信，持这样观点的人并不在少数。当然，我也能理解。但不难发现，之所以感觉英语对自己没用，是因为自己没有掌握英语，所以无法体会和理解，掌握英语就能打开另一扇知识的大门对神奇体验。道理就像一个农民，如果不会说普通话，这并不影响他种庄稼，但如果他会普通话，至少他可以进城务工会遇到更少的困难，人生有更多的选择。菜市场的大妈，不需要掌握微积分，这数学知识并不能帮助她卖菜收入更多，然而，如果她掌握的微积分的话，就应该不会在菜市场卖菜了。一个大学生，不懂英语，不会读写听说，并不怎么影响找工作。但如果会英语，不仅选项会更多，在信息爆炸，很多英文人文社科，理工科技术书籍，资讯并不会有人翻译为中文的当下，还能够更大程度，阅读吸收更好的学习资料。</p>\n<p>很多人因为无知和局限，大半辈子甚至一辈子生活在柏拉图的洞穴里，依照自己的陈旧的经验看待周遭的世界。可是，当一道光照耀进洞穴时，人可以得到启发和指引，人要有勇气和智慧，走出洞穴，追求光明和真理。对于英语只是入门。却可以运用类比等思维推理，预见和先知英语对自己至关重要，能够坚持不懈地学习并掌握的人。和只有掌握英语，才能领悟英语所带来的好处的人，他们的人生注定截然不同。</p>\n<h1 id=\"自学掌握语言的根本方法\"><a class=\"anchor\" href=\"#自学掌握语言的根本方法\">#</a> 自学掌握语言的根本方法</h1>\n<p><strong>天道酬勤！熟能生巧！</strong></p>\n<p>理论上，不仅是英语学科，其他大部分知识的学习，只要投入足够的时间和运用合理的技巧，大体上，总是可以学好的。 有些知识，比如无人驾驶，因为跨越很多学科，并建立在诸多基础知识之上，所以，门槛很高，学习周期漫长，过程自然也费劲许多。但就英语而言，虽然也有难度，但只要方法得当，持之以恒，也可以水到渠成，瓜熟蒂落。话虽如此，但我们的时间资源是有限的，不可能完全用在英语上。不过，解决方案也很简单，把自己平时阅读的资料切换为英文版，反正得阅读中文，那不如拿这些时间阅读英文版，还可以学英语，一举两得。刚开始会多花点时间，后面就不相上下了。英语只会每一天都进步，假以时日，英语必有所成。</p>\n<p>我认为意识到这点很重要，<strong>唯有当你坚信自己通过不懈的努力，有能力完成这个学习目标，掌握以前久攻不下的英语。你才有恒心和毅力，在学习过程中遇到诸多挫折之后，依然百折不挠地前进。</strong></p>\n<p><strong>但很遗憾，感觉很多人并没有意识到这点，甚至更加糟糕的是，还并不敢苟同这样的观念。于是，在进步到某个阶段的时候，就缴械投降，遂而前功尽弃了。</strong> 然后安慰自己，学海无涯，回头是岸，或者说英语学了也没用，自己不喜欢英语云云。为自己的退缩和放弃寻找到合理性，甚至深信不疑。</p>\n<p>有一种观点或者说法很流行：童年时代才是学习语言的最佳年纪，所以当我们长大以后，即使学习了很多年的英语，依然不能开口流利说英语。这样的观点之所以深受认可是因为我们小时候开始学习汉语长大后可以用汉语口若悬河地表达，但成年后即使学习英语时间看似并不比汉语少，很多人依然在英语表达上结巴的表面事实。不过，私以为，这样的观点并非正确，与之相反，我依然深信表面上童年确实是学习语言的最佳时机，但如果能够洞察这里的真相和原因，我们可以从中获得关于如何学习语言的启发，也有足够的的理由相信，语言的学习和掌握，和年纪没有多大关系，而且由于成年人具备更好的学习能力，学习语言可以更加的有效率。</p>\n<p><strong>那么为什么懵懂的孩童时代学习语言进步显著，而认知能力和学习能力已经今非昔比的成人学习语言却举步维艰？在我看来是因为前者在学习语言的时间和精力上投入比后者多出很多</strong>。我能预知到这并非是一句能够让人轻易信服的结论，毕竟以我个人经历而言，经过小学六年的学习实践，自己已经具备初步的汉语表达能力，著书立说尚且有待时日，但与人日常攀谈，向来得心应手。但从初中到大学学习了 10 年的英语，在你摩拳擦掌，准备开口说的时候，此刻他们却纷纷打地鼠一般给你玩捉迷藏，以至于你憋红了脸，也只能支支吾吾，拼凑出词不达意，漏洞百出的词句。养兵千日，期待着有朝一日可以用兵，却发现无计可施，还有什么比这个更令人沮丧？以至于让多少人，放弃了坚持。</p>\n<p>那么很多人都会疑问，我们学习汉语的时间怎么会比英语多呢？这里的玄机在于我们计算语言学习的时间有失偏颇，我们学习汉语并非只是在语文课上，我们上数学课也是用汉语，由于我们的生活环境，日常的交流也是用汉语，甚至到了中学我们的生物、物理、化学、地理、政治、历史课等除了英语课外所有的科目，还有我们所阅读的课外读物都是汉语，所以虽然只有六年的时间，但在这短短的时间里面因为我们所处的环境，使得我们有意无意地接收大量的的听说读写能力的训练和强化。而英语则并非如此。</p>\n<p><strong>所以，我们的英语能力不尽人意，根源在于我们投入的训练和实践远远不够。</strong></p>\n<p>使用工具是人类的天赋，而借助工具，或者外界力量用于辅助学习是一个很可取的选择。只是学习知识是一个将知识吸收内化的过程。当我们在学习的过程中，受挫，我们总是会感到沮丧，对自己失去信心。会有倾向求助于外界，期望有高人从天而降，对我们指点迷津，或者像神明一般施加法力，直接帮我们脱离苦海，比如我们会去报名参加培训，找老师，使用各种各样的 APP。但这并不现实。师傅只是领进门，修行还是靠个人。学习这个过程大部分的工作还需要我们自己去完成。如果寻求外界获得成功，取得进步的决定性因素，并非是他们，而是因为你深度参与其中实践。<strong>归根结底，他们都遵循，学习的本质是不断去亲身训练这一基本原则。所以，不管采取什么学习方法，有一点需要明白，万事求诸己。</strong></p>\n<h1 id=\"如何训练和实践\"><a class=\"anchor\" href=\"#如何训练和实践\">#</a> 如何训练和实践</h1>\n<p>不可否认，学习又是一件艰难漫长的过程。<strong>所以，坚持本身至关重要。而坚持，归根结底是坚持训练。</strong></p>\n<p><strong>具体如何坚持训练呢？想必不是起早贪黑，狂背单词，或者捧着英文教科书念念有词，那样太辛苦了。于我而言，把自己接触的资讯全都切换为英文的，就好啦。将自己的手机，电脑语言切换成英语，所阅读的专业、非专业书籍也几乎是英文，平时多阅读英文文档呀，刷刷推特。不用特地投入时间学英语，但却在日如一日的重复里，慢慢地就可以感觉到进步和蜕变了。</strong></p>\n<p>万事开头难，刚开始会感到不适，因为阅读一个段落，有些词汇不懂，有些句子每个单词都认识，就是不理解。这严重影响阅读速度不说，因为不能理解，让自己倍感沮丧。但其实不必太担心，逃离舒适区哪有那么舒服，只要不是过于难受，就坦然面对，不懂的单词，用电子词典查询，不懂的句子，查语法说。一点一滴的学习，随着日积月累，阅读速度和理解能力就与日俱增，付出学习和懵懂无知是一场此消彼长的对抗。</p>\n<p>练习听力，阅读文字只是输入式的训练，真正而更加有效的训练方式，应该是输出，也就是写作和口语表达。当我们在做输入式训练的时候，其实我们可以不怎么动脑的，甚至当时心不在焉。所以，只有输入式训练的话，进步的道路步履维艰，</p>\n<p>学习时间里，听说读写的训练，想必都不会有多大的问题。每个学习英语的成年中国人最大的问题在于，由于他们已经擅长汉语，在时间长出很多的非学习时间里，也就是日常生活中，他们习惯性地用汉语思考，因为用汉语可以很流畅，但用外语在屡屡碰壁，而语言是思考的载体，所以<strong>思考才是训练的核心</strong>。就像我们解题，阅读题目思考设计解答方案才是解题的核心，在纸上将答案表达出来不过是将思考输出。而这，就很好地解释了为什么小孩学习英语比较容易，因为当时他们的汉语与英语势均力敌，不像成年人，因为选择舒适的方式，不断地训练，强化了汉语，导致即使特别花时间精力对英语特别扶贫，也缩短不了他们的贫富差距。一方面我们做了大量的输入式训练，另一方面刻意规避输出式的训练，而这，正是，很多人学习英语，却收效甚微的根结所在。至于连输入式训练都没有的人，结果如何，自不必说。</p>\n<p><strong>我们可以尝试着用英语去描述自己的所见所闻和所思所想，不懂的记录下来查询辞典。比如站在十字街头，会想到 intersection，懂得词汇之后，可以尝试遣词造句，进一步地训练表达内容思想更加丰富的句子和短文，这些动作都是需要我们动脑思考的，是有效训练的很好实践。</strong></p>\n<h1 id=\"好的学习方法\"><a class=\"anchor\" href=\"#好的学习方法\">#</a> 好的学习方法</h1>\n<p><strong>Practice makes perfect。但很遗憾，坚持训练本身很多人没能坚持下来。因为抽象来看，学习过程就是运用自己心智，与学习本身自带的诸多困难对抗，如图 1。当屡屡受挫，你感知到的困难已经超越了自己的解决能力，放弃是一种明智和无奈的选择。</strong></p>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2021/08/487b6f7ecd3e3944.webp\" alt=\"\" /></p>\n<p><strong>学习过程会屡屡碰壁，好的学习方法，应该要能够降低这种困难，减少斜坡的倾角。我们应该寻找和掌握一种方法，让学习如丝般顺滑，而不是举步维艰。</strong> 说到坚持练习，比如经常阅读英文书籍，但很少能够寻找到为自己词汇水平的资料，一个短句好几个单词都不懂，阅读一整页下来，不知所云，长久以往，很少有人能够保持热情与耐心继续阅读下去，即使做到，感觉也没有多大意义，因为虽然你过目了，但你依然没有掌握认识它，顶多似曾相识。<strong>此时，身边有一本辞典，就显得尤为重要，它可以将这种困难降低到几乎为零的程度，遇到不懂的单词，即刻查询。通过自己所阅读的资料为主线，扩充自己的词汇量。</strong></p>\n<p>所谓工欲善其事，必先利其器。当遇到不懂的单词，比如 malicious，在有道或者 Google 翻译里面查询，能得到的只有其翻译，也许还会花点心思查看下对应的同义词、反义词、同根词。但这种学习方式不过是建立英文单词与汉语释义单一的映射，这是一种硬编码，记忆效率极其低下。可曾记得小学时候，我们为了记忆九九乘法表，花了一个星期的时间，天天背诵，终于烙印在脑里。</p>\n<p>自己在使用英文资料学习编程的过程中，时常在思索如何解决快速索引释义的问题，偶然而又幸运的是，意外发现了 GoldenDict 辞典软件，如图 2，它并本身并不提供任何辞典，但它支持种类繁多的辞典格式，与它们搭档，使得 GoldenDict 在众多辞典软件里所向披靡。我安装了好几部英英辞典，里面提供完整的释义，词组，相关的同义词和丰富的例句。我喜欢这种像神经网络一样，在与他物联系中记忆的方式，短时间内阅读辞典查询结果，可能不如狂背一百遍的记忆效果好，但我对自己的方法爱不释手，毕竟，单词并非独立的存在，它需要和其他单词组合拼凑成句子，才能构建表达完整的含义，也只有知道了组合后，我们才有可能学以致用。在丰富的组合连接之下，每个单词不再是一座孤岛，在记忆的深处都有迹可循，长期以往，这样可以有效地构建我们丰富的语言体系，和表达能力。毕竟，表达和思考，本质上无非就是向记忆索取词汇，但凡词汇索引建的好，这个过程就不会吃力。而单独记忆单词的结果是知道中文含义，但不知道如何使用，真的开口说话时，更是哑口无言，或者词不能大意。同时我很讨厌背诵，在时常检查背诵的初中时代，自己有过不幸被老师点名，在全班同学面前背诵文言文，却背不出一个完整的段落，申请背诵另外一篇，没想到依然差强人意。兴许是屡次三番摘得年级桂冠光芒的照耀，老师同学只是爆发出慈眉善目的笑声，险过一关。不过值得一提的是，时至今日，我依然记得初中课文里出现的几个句子 “天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣。人之为学有难易乎？学之，则难者亦易矣；不学，则易者亦难矣。” <sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup> “无他，但手熟尔”<sup class=\"footnote-ref\"><a href=\"#fn2\" id=\"fnref2\">[2]</a></sup>，“故不积跬步，无以至千里；不积小流，无以成江海。”<sup class=\"footnote-ref\"><a href=\"#fn3\" id=\"fnref3\">[3]</a></sup>，“世之奇伟、瑰怪、非常之观，常在险远，而人之所罕至焉，故非有志者不能至也。”<sup class=\"footnote-ref\"><a href=\"#fn4\" id=\"fnref4\">[4]</a></sup>。它们启发与激励着我，每每灰心丧气的时候，鼓舞自己，再坚持一下。<br />\n<img data-src=\"https://s3.bmp.ovh/imgs/2021/08/69bc4729f629349e.webp\" alt=\"\" /></p>\n<h1 id=\"关于记忆\"><a class=\"anchor\" href=\"#关于记忆\">#</a> 关于记忆</h1>\n<p>我当然认为记忆本身很重要，只是觉得应该追本溯源，记忆最原始，源头的部分，因为这些内容是朴素的，简洁的，内容少很容易记，其他的内容，可以通过记忆的内容通过推理、推到得出，是故没有必要滥用珍贵的记忆资源。</p>\n<p>举个例子:</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mi>cos</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>A</mi><mo>+</mo><mi>B</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>cos</mi><mo>⁡</mo><mi>A</mi><mtext>∗</mtext><mi>cos</mi><mo>⁡</mo><mi>B</mi><mtext>−</mtext><mi>sin</mi><mo>⁡</mo><mi>A</mi><mtext>∗</mtext><mi>sin</mi><mo>⁡</mo><mi>B</mi></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(1)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\cos(A + B) = \\cos A ∗ \\cos B −\\sin A ∗ \\sin B  \\tag{1}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mop\">cos</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mop\">cos</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">cos</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">sin</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">sin</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span><span class=\"tag\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mi>sin</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>A</mi><mo>+</mo><mi>B</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>sin</mi><mo>⁡</mo><mi>A</mi><mtext>∗</mtext><mi>cos</mi><mo>⁡</mo><mi>B</mi><mo>+</mo><mi>cos</mi><mo>⁡</mo><mi>A</mi><mtext>∗</mtext><mi>sin</mi><mo>⁡</mo><mi>B</mi></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(2)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\sin(A + B) = \\sin A ∗ \\cos B + \\cos A ∗ \\sin B  \\tag{2}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mop\">sin</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mop\">sin</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">cos</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mop\">cos</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">sin</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span><span class=\"tag\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">2</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mi>tan</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>A</mi><mo>+</mo><mi>B</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><mrow><mi>sin</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>A</mi><mo>+</mo><mi>B</mi><mo stretchy=\"false\">)</mo></mrow><mrow><mi>cos</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>A</mi><mo>+</mo><mi>B</mi><mo stretchy=\"false\">)</mo></mrow></mfrac><mo>=</mo><mfrac><mrow><mo stretchy=\"false\">(</mo><mi>tan</mi><mo>⁡</mo><mi>A</mi><mo>+</mo><mi>tan</mi><mo>⁡</mo><mi>B</mi><mo stretchy=\"false\">)</mo></mrow><mrow><mn>1</mn><mtext>−</mtext><mi>tan</mi><mo>⁡</mo><mi>A</mi><mtext>∗</mtext><mi>tan</mi><mo>⁡</mo><mi>B</mi><mo stretchy=\"false\">)</mo></mrow></mfrac></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(3)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\tan(A + B) = \\frac{\\sin(A + B)}{\\cos(A + B)} = \\frac{(\\tan A + \\tan B)}{1− \\tan A ∗ \\tan B)}  \\tag{3}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mop\">tan</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.363em;vertical-align:-0.936em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.427em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">cos</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mclose\">)</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\">sin</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.936em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.363em;vertical-align:-0.936em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.427em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">tan</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">tan</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mclose\">)</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mopen\">(</span><span class=\"mop\">tan</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop\">tan</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.936em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span><span class=\"tag\"><span class=\"strut\" style=\"height:2.363em;vertical-align:-0.936em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">3</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p>如上数学和差角公式还记得吧？当年的女数学老师只是用复杂的方法证明其正确，却没有教会我们如何推理记忆。那时，同学们只能靠大量的解题，在重复的训练中强化记忆，但只要训练中断时日，记忆可能就会出现偏差。</p>\n<p>但其实，只需要记得图 3 矩形框里的几何图形及其意义，上面一系列相关的公式可以一字不落地推理得出，简洁直观，一目了然。</p>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2021/08/0d1a20ecab37a4d3.webp\" alt=\"\" /></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mi>a</mi><mi>b</mi><mo>=</mo><mi>a</mi><mi>c</mi><mo>−</mo><mi>b</mi><mi>c</mi><mo>=</mo><mi>a</mi><mi>c</mi><mo>−</mo><mi>e</mi><mi>f</mi></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(4)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">ab = ac - bc = ac - ef  \\tag{4}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">b</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span><span class=\"tag\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">4</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p>由 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn></mrow><annotation encoding=\"application/x-tex\">4</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">4</span></span></span></span> 我们可得<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>5</mn></mrow><annotation encoding=\"application/x-tex\">5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">5</span></span></span></span>.</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mi>a</mi><mi>f</mi><mtext>∗</mtext><mi>cos</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>A</mi><mo>+</mo><mi>B</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>a</mi><mi>c</mi><mtext>−</mtext><mi>e</mi><mi>f</mi><mo>=</mo><mi>a</mi><mi>f</mi><mtext>∗</mtext><mi>cos</mi><mo>⁡</mo><mi>A</mi><mtext>∗</mtext><mi>cos</mi><mo>⁡</mo><mi>B</mi><mtext>−</mtext><mi>a</mi><mi>f</mi><mtext>∗</mtext><mi>sin</mi><mo>⁡</mo><mi>A</mi><mtext>∗</mtext><mi>sin</mi><mo>⁡</mo><mi>B</mi></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(5)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">af ∗ \\cos(A + B) = ac − ef = af ∗ \\cos A ∗ \\cos B − af ∗ \\sin A ∗ \\sin B \\tag{5}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">cos</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mord\">−</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">cos</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">cos</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord\">−</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">sin</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">sin</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span><span class=\"tag\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">5</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p>消除公因子 af，所以</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>cos</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>A</mi><mo>+</mo><mi>B</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>cos</mi><mo>⁡</mo><mi>A</mi><mtext>∗</mtext><mi>cos</mi><mo>⁡</mo><mi>B</mi><mtext>−</mtext><mi>sin</mi><mo>⁡</mo><mi>A</mi><mtext>∗</mtext><mi>sin</mi><mo>⁡</mo><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">\\cos(A+B) = \\cos A∗\\cos B −\\sin A∗ \\sin B\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mop\">cos</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mop\">cos</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">cos</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">sin</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">sin</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span></p>\n<p>证毕，其他同理。</p>\n<p>对于理工科而言，单纯的记忆结果除了提高解题速度，应付考试，是没有多大功用的，因为它很容易遗忘。重要的是理解简化推理论证的过程，或者最原始基本的定义，通过定义和推理关键步骤，整个知识版图都可以顺藤摸瓜探索出来。</p>\n<h1 id=\"如何记忆单词\"><a class=\"anchor\" href=\"#如何记忆单词\">#</a> 如何记忆单词</h1>\n<p>其实，感觉很多人都懂这些，但为了完整性，还是罗列一下，因为自己本身也不专业，一笔带过吧。</p>\n<h2 id=\"按音节记忆单词\"><a class=\"anchor\" href=\"#按音节记忆单词\">#</a> 按音节记忆单词</h2>\n<p>刚接触英语时，貌似是老师这么教我们 b-i-k-e bike，初学时无可厚非。在入门后，就应该按照音节来辅助记忆了，辅音一般不变，元音虽然时常有好几种发音，但多是相对固定，我记得初中英语教科书上有这样的汇总表格，但自己平时留意，也可以总结出常用的规律。比如 i 发 aɪ音，所以从拼写可以推断出发音，bike 念作 baɪk，从发音可以推断出拼写，baɪk 其拼写为 bike。</p>\n<h2 id=\"词根词缀\"><a class=\"anchor\" href=\"#词根词缀\">#</a> 词根词缀</h2>\n<p>mature 有成熟，完善之意，pre 有在前，前面之意，所以 premature 就表示早熟，或者引申为早产。具体可以搜索参考词根词缀记忆领域的书籍。</p>\n<h2 id=\"系统学习\"><a class=\"anchor\" href=\"#系统学习\">#</a> 系统学习</h2>\n<p>按照情景或者场景系统地学习词汇和用法，比如房子的物品名称，以及其相关的动词和对话表达，如图 4。</p>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2021/08/b8518865846f4d62.webp\" alt=\"\" /></p>\n<h2 id=\"高频词汇优先\"><a class=\"anchor\" href=\"#高频词汇优先\">#</a> 高频词汇优先</h2>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2023/01/11/bf447cc97d9d8a9b.png\" alt=\"\" /><sup class=\"footnote-ref\"><a href=\"#fn5\" id=\"fnref5\">[5]</a></sup><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cub3hmb3JkbGVhcm5lcnNkaWN0aW9uYXJpZXMuY29tL3dvcmRsaXN0cy9veGZvcmQzMDAwLTUwMDA=\">牛津按照 CEFR 英语水平等级分组词汇</span> 我的做法是将词汇表按等级分组，不懂的单词收集过滤，并拷贝词典的释义等详细内容，按照遗忘曲线记忆，将掌握词汇剔除，重复下一轮，如此反复，直到都掌握吃透。其他词汇书也是如此进行。<br />\n高频词汇平时用的多，自然比较容易记住，产出投入比比较高。学到的词汇要平时多用，听说读写最好雨露均沾。<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cub3hmb3Jkb25saW5lZW5nbGlzaC5jb20vZW5nbGlzaC1sZXZlbC10ZXN0L3ZvY2FidWxhcnk=\">词汇测试</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY29lLmludC9lbi93ZWIvY29tbW9uLWV1cm9wZWFuLWZyYW1ld29yay1yZWZlcmVuY2UtbGFuZ3VhZ2VzL3RhYmxlLTEtY2Vmci0zLjMtY29tbW9uLXJlZmVyZW5jZS1sZXZlbHMtZ2xvYmFsLXNjYWxl\">欧洲共同语言参考标准</span>，这里应该也会提供很多资源，有时间可以探究一下。</p>\n<h1 id=\"审慎对待任何学习方法\"><a class=\"anchor\" href=\"#审慎对待任何学习方法\">#</a> 审慎对待任何学习方法</h1>\n<p>中学时代，曾经在书籍上阅读过一段文字，某君总结自己的学习经验时，将自己英语听力的提高归功于自己平时听英文歌曲。于是自己也尝试着去听英文歌。但过了些时日，并没有感觉到听力明显的提升，但也许是自己练习不够，也许自己听的时候并没有全神贯注的听，当然，还有可能这种方法本身就不可能奏效。理论上，只要练习，总会有进步的，但私以为这样的方法收效甚微，毕竟，如果单词你本来就不懂，你是很难通过听来学习掌握的。首先，你得会识字，以此为前提，你可以听懂和表达。意识到这些，已经是多年以后了，以至于，在后来，又几乎重蹈覆辙。</p>\n<p>在书店发现一本书，书名叫《千万别学英语》，有些标新立异，就捧读起来。一本书的厚度，但里面的内容如果没记错的话，总结起来，大概是每天都听两遍磁带，每周固定休息一天。作者的观点是，我们大脑学习语言的部分，也需要休息整顿。并危言耸听道，如果不在休息日绝对不能接触英语，将前功尽弃。我仿佛在地摊上发现了练得一身上乘武功的武林秘籍，只要按部就班地模仿学习，在武林上雄霸一方指日可待，喜悦之前，溢于言表，开始憧憬创造奇迹的未来。后来的结果，如大家所料，并没有什么意外。依然收效甚微，在英语的学习上依旧艰难前进。如果没有记错，书里还提到一点，就是把听不懂的单词特别标注出来，使用最新的英英词典查询 (他批判长辈把辞典馈赠给子女用的行为，认为辞典日新月异，祖传的都已经不合时宜)。</p>\n<p>这里并没有否定他们学习方法的意思，我觉得每个人的学习方法都可以不同，都是在刻苦练习，殊途同归。也许他们的方法确实帮助他们掌握了英语，也许是他们实践中的某个环节起到了决定性的作用，只是他自己都没能意识到，于是总结自己经验时，出了偏差。分享自己成功学习经验的行为，我觉得这本身就很值得褒奖。只是，以我现在的处事原则来看，任何一种结论，言辞，都要思辨、审慎地对待，汲取合理有效的部分，不能盲从，包括此篇。</p>\n<p>李阳的疯狂英语，也在事实上影响了很多人，我没怎么接触过，也就不予置评了。但曾经在南方周末看过毛坦厂中学的报道，学生起早贪黑，在操场上捧着书，像疯子一样大声朗读。我想说，每个人都有自己的学习方法，爱怎么整都是自己的事情，只是，学习应该是一件轻松愉悦的事情，没必要头悬梁锥刺股，整的与自己为敌。同时也应该多比较他人的学习方法，师夷长技，博采众长，为自己所用，相信很多人都认同，闭门造车往往进度条滚动太慢。</p>\n<h1 id=\"宽容的环境\"><a class=\"anchor\" href=\"#宽容的环境\">#</a> 宽容的环境</h1>\n<p>很多人学了很多年的英语，终归不会开口流利地表达自己的想法和感受，归根结底在于我们过多的注重孤立的词汇和语法学习，没有系统地学习词汇，没有学习丰富的词组，更缺少平时的开口表达。</p>\n<p>在缺少表达的问题上，很多人简单的归因为身边没有外国朋友可以交流实践。但其实，这是一个伪命题。退一步说，假设真有一位外国友人如神兵天降于你身边，你也很少有机会可以开口实践，毕竟，人家也是人，实在无法做到和一位词不达意，说话结巴的人，和颜悦色地交流。也就是说，在你想和别人交流时，自身必须达到一定的表达能力，而在此之前，一切都靠自学，或者和自己水平相当的伙伴协同学习。试想那些咿呀学语的婴孩，也就只有父母家人才有耐心和热情陪同重复那些简单的词汇语句，以此教导他的语言能力。</p>\n<p>由于很多人掌握的词汇支离破碎，常常并不足以表达一个完整的句子，此时采用中英结合的方式，倒是不错的选择。但问题在于，有人很厌恶这样的举动，并公开地排斥。甚至，有人会厌恶那些在中国说着英语的中国人，他们认为，在中国就该讲中国话，是中国人就该讲中国话，爱国就应该讲国语。或者仅仅英语不合他们自己接收信息的习惯方式，就足以在内心产生抵触。暂且不深入展开他们的逻辑，但可以想象，有这样的现象存在，那些想实践英语的人，自然面对更多的困难和挑战。当然，我们可以选择忽视他们的意见，我们也需要有勇气直面他们的反对，并踽踽而行，毕竟，他们并非正确，真理也并非掌握在他们手上。不得不承认他们不过是在言论自由的框架之下表达自己的反对意见，对此我自然也不能有什么指摘，只是希望，这些人，特别是公众人物，在自由地表达自己的意见时，能够明白自己言行的后果，从而在情不自禁的随口一说时，更加审慎一些。</p>\n<h1 id=\"godendict-安装\"><a class=\"anchor\" href=\"#godendict-安装\">#</a> GodenDict 安装</h1>\n<p>下载链接: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMW9WNkF4UlVsWDFjN21wRTM1MmJ0OHc=\">https://pan.baidu.com/s/1oV6AxRUlX1c7mpE352bt8w</span> 提取码: uxtw</p>\n<h2 id=\"windows-mac\"><a class=\"anchor\" href=\"#windows-mac\">#</a> Windows &amp; Mac</h2>\n<ol>\n<li>下载 GodenDict 应用程序：\n<ol>\n<li>Mac： GoldenDict-1.5.0-RC2-209-gfe9312e(Qt_563)</li>\n<li>Windows： GoldenDict-1.0.1-Portable</li>\n</ol>\n</li>\n<li>下载词典文件并解压\n<ol>\n<li>En-En-Longman_Pronunciation3.zip</li>\n<li>En-En_OALD8.zip</li>\n<li>En-En_Merriam_Webster11</li>\n<li>En-zh_CN_OALD4</li>\n<li>En-En_Longman_DOCE5</li>\n</ol>\n</li>\n<li>GodenDic 安装完毕，打开 Dictionary 菜单，在如下界面点击 Add，将解压的词典目录逐个添加，完成后点击 Rescan now，程序建立索引。</li>\n</ol>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2021/08/305a1480dcfc9dbd.png\" alt=\"\" /></p>\n<p>Mac 上会有如下界面异常，</p>\n<img data-src=\"https://s3.bmp.ovh/imgs/2021/08/bad36e68350614d4.png\" style=\"zoom:100%;\" />\n<p>点击 Preference 菜单，如下截图勾选 “Expand optional parts”</p>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2021/08/f3565b6d9c3abefc.png\" alt=\"\" /></p>\n<p>最后，可以把这个选项勾选。</p>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2021/08/79f7c59f09d94491.png\" alt=\"\" /></p>\n<h2 id=\"android\"><a class=\"anchor\" href=\"#android\">#</a> Android</h2>\n<ol>\n<li>下载 Android APK 并安装：<span class=\"exturl\" data-url=\"aHR0cDovL2dvbGRlbmRpY3QubW9iaS9kb3dubG9hZHMvYW5kcm9pZC9mcmVlLw==\">下载链接</span></li>\n<li>下载词典文件：上一节百度云 Android 目录（此目录下的文件是从词典文件压缩包里面提取，去掉音频和图片，以减少手机存储占用）</li>\n<li>将下载的词典文件存放于手机根目录的：GoldenDict 文件夹（注意命名，大小写完全一致）</li>\n<li>手机上打开 GoldenDict，此时先建立索引，完毕就可以正常使用。</li>\n</ol>\n<h2 id=\"ios\"><a class=\"anchor\" href=\"#ios\">#</a> iOS：</h2>\n<p>尚未支持，可以考虑使用欧路词典或其他，并按照类似思路，安装词典即可。</p>\n<h1 id=\"写作\"><a class=\"anchor\" href=\"#写作\">#</a> 写作</h1>\n<h2 id=\"语法\"><a class=\"anchor\" href=\"#语法\">#</a> 语法</h2>\n<p>写作的基础是正确的语法，语法书我推荐</p>\n<ol>\n<li><span class=\"exturl\" data-url=\"aHR0cDovL2dyYW1tYXIuY29kZXl1LmNvbS8=\">旋元佑进阶文法</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yNTk3NDM3My8=\">赖氏经典英语语法</span></li>\n</ol>\n<h2 id=\"写作课程\"><a class=\"anchor\" href=\"#写作课程\">#</a> 写作课程</h2>\n<ol>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY291cnNlcmEub3JnL3NwZWNpYWxpemF0aW9ucy9hY2FkZW1pYy1lbmdsaXNo\">Academic English: Writing Specialization</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9vbmxpbmUuc3RhbmZvcmQuZWR1L2NvdXJzZXMvc29tLXkwMDEwLXdyaXRpbmctc2NpZW5jZXM=\">Writing in the Sciences</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93cml0aW5ncHJvamVjdC5mYXMuaGFydmFyZC5lZHUvcGFnZXMvd3JpdGluZy1ndWlkZXM=\">哈佛写作项目（The Harvard Writing Project）</span>提供的人文社科英文写作指南，旨在通过为学生提供实用的写作建议、指南和案例来鼓励他们更好地写作。四种主要类型：\n<ul>\n<li>跨学科项目的写作指南</li>\n<li>特定写作类型的写作指南</li>\n<li>特定课程的写作指南</li>\n<li>通识教育课程写作指南</li>\n</ul>\n</li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yNDc1MzAxMS8=\">葛传椝英语写作</span></li>\n</ol>\n<h2 id=\"写作助手\"><a class=\"anchor\" href=\"#写作助手\">#</a> 写作助手</h2>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2023/01/11/d58d4918f960dbca.png\" alt=\"\" /><br />\n请安装 Grammarly 浏览器扩展插件，或者安装应用程序。简单常见的语法错误可以自动为你高亮并提供修正建议。</p>\n<h1 id=\"听说\"><a class=\"anchor\" href=\"#听说\">#</a> 听说</h1>\n<p>使用 podcast 订阅 BBC learning English 等练习听力，YouTube 看英语视频。去参加英语角，平时和朋友聊天用英语说，都是不错的选择，不说也行，只要习惯用英语思考也可以。但，如果读写功底足够扎实，听说其实是水到渠成一般容易。</p>\n<h1 id=\"最后\"><a class=\"anchor\" href=\"#最后\">#</a> 最后</h1>\n<p>英语的重要性不言而喻，相信各位好奇心切可以阅读到这里，自是一清二楚，希望各位可以学有所成。<strong>如果本文令你受益匪浅，愿意慷慨解囊，可以点击 donate 红色按钮，然后扫描二维码，一分也是爱。分享推荐给身边的朋友，也是不胜感激</strong>。</p>\n<hr class=\"footnotes-sep\" />\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p>《为学》 <a href=\"#fnref1\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn2\" class=\"footnote-item\"><p>《卖油翁》 <a href=\"#fnref2\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn3\" class=\"footnote-item\"><p>《劝学》 <a href=\"#fnref3\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn4\" class=\"footnote-item\"><p>《游褒禅山记》 <a href=\"#fnref4\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn5\" class=\"footnote-item\"><p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2J5b3VuZ2QvRW5nbGlzaC1sZXZlbC11cC10aXBz\">An advanced guide to learn English</span> <a href=\"#fnref5\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n</ol>\n</section>\n",
            "tags": [
                "英语,自学,入门,指南,方法论,词典"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2021/07/17/activity-transfer-detection/",
            "url": "https://limxtop1989.github.io/limxtop/2021/07/17/activity-transfer-detection/",
            "title": "Android Activity 转移类型检测",
            "date_published": "2021-07-17T12:26:30.000Z",
            "content_html": "<p>Requirement:：</p>\n<p>应用内有些 Activity 数据敏感，需要区别对待，这里需要识别首次进入红色 Activity 集合内，在红色 Activity 集合内跳转，和跳出红色 Activity 集合三种情况。【当红色 Activity 集合是应用内的 Activity 集合时，就相当于首次进入应用，应用内界面跳转和退出应用的判定】</p>\n<p><a href=\"https://imgtu.com/i/W1aZWR\"><img data-src=\"https://z3.ax1x.com/2021/07/17/W1aZWR.png\" alt=\"W1aZWR.png\" /></a></p>\n<p>算法描述：</p>\n<ol>\n<li>\n<p>定义一个保存 Activity Simple Name 的集合。</p>\n</li>\n<li>\n<p>Activity onResume 时，将此 Activity Simple Name 加入集合。</p>\n</li>\n<li>\n<ol>\n<li>当集合元素个数等于<strong> 1</strong> 时，为首次进入该应用打开的第一个 Activity。</li>\n<li>当集合元素个数等于<strong> 2</strong> 时，表示打开应用内的其他 Activity。</li>\n</ol>\n</li>\n<li>\n<p>Activity onStop 时，将此 Activity Simple Name 移出集合。</p>\n</li>\n<li>\n<ol>\n<li>当集合元素个数为<strong> 1</strong> 时，表示在应用内跳转。</li>\n<li>当集合元素个数为<strong> 0</strong> 时，表示打开其他应用。</li>\n</ol>\n</li>\n</ol>\n<p>原理：</p>\n<p><a href=\"https://imgtu.com/i/W1aVY9\"><img data-src=\"https://z3.ax1x.com/2021/07/17/W1aVY9.png\" alt=\"W1aVY9.png\" /></a></p>\n<p>由上图可知，Activity A 启动 Activity B 时，执行顺序是 Activity A's onPause () -&gt; Activity B's onResume () -&gt; Activity A's onStop ()。应用内的 Activity 在执行 onResume () &amp; onStop () 时，我们规约将其 Activity Simple Name 加入 &amp; 移出集合，而启动应用外的 Activity 我们没有能力如此操作。</p>\n<ol>\n<li>首次进入 Activity 集合，应用内的 Activity onResume 被调用；</li>\n<li>在 Activity 集合间跳转，应用内的 Activity onResume &amp; onStop 被调用；</li>\n<li>跳出 Activity 集合，应用内的 Activity onStop 被调用；</li>\n</ol>\n<p>所以，启动应用内还是应用外的 Activity 在此产生差异，而差异让程序识别成为可能。</p>\n<ol>\n<li>\n<p>当 Activity B 是<strong>应用内 Activity</strong> 时，集合内元素个数变迁如下：</p>\n<p>Activity A's onPause() -&gt; Activity B's onResume() -&gt; Activity A's onStop()</p>\n<p><strong>1</strong>（Activity A）         <strong>2</strong>（Activity A&amp;B）        <strong>1</strong>（Activity B）</p>\n</li>\n<li>\n<p>当 Activity B 是<strong>应用外 Activity</strong> 时，集合内元素个数变迁如下：</p>\n<p>Activity A's onPause() -&gt; Activity B's onResume() -&gt; Activity A's onStop()</p>\n<p><strong>1</strong>（Activity A）         <strong>1</strong>（Activity A）              <strong>0</strong>（）</p>\n</li>\n</ol>\n",
            "tags": []
        }
    ]
}