{
    "version": "https://jsonfeed.org/version/1",
    "title": "若批评不自由，则赞美无意义",
    "subtitle": "有梦书架",
    "icon": "https://limxtop1989.github.io/limxtop/images/favicon.ico",
    "description": "",
    "home_page_url": "https://limxtop1989.github.io/limxtop",
    "items": [
        {
            "id": "https://limxtop1989.github.io/limxtop/2025/04/19/mirror-bitmap/",
            "url": "https://limxtop1989.github.io/limxtop/2025/04/19/mirror-bitmap/",
            "title": "镜像翻转Bitmap及其原理",
            "date_published": "2025-04-19T13:59:24.000Z",
            "content_html": "<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@NonNull</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token class-name\">ByteArrayOutputStream</span> <span class=\"token function\">flipImageHorizontally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">ByteBuffer</span> buffer <span class=\"token operator\">=</span> image<span class=\"token punctuation\">.</span><span class=\"token function\">getPlanes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> bytes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">remaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    buffer<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token class-name\">Bitmap</span> origin <span class=\"token operator\">=</span> <span class=\"token class-name\">BitmapFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">decodeByteArray</span><span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> bytes<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token class-name\">Matrix</span> matrix <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Matrix</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    matrix<span class=\"token punctuation\">.</span><span class=\"token function\">preScale</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token class-name\">Bitmap</span> hFlip <span class=\"token operator\">=</span> <span class=\"token class-name\">Bitmap</span><span class=\"token punctuation\">.</span><span class=\"token function\">createBitmap</span><span class=\"token punctuation\">(</span>origin<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> origin<span class=\"token punctuation\">.</span><span class=\"token function\">getWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> origin<span class=\"token punctuation\">.</span><span class=\"token function\">getHeight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> matrix<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> hFlip<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Returns a bitmap from subset of the source bitmap,</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * transformed by the optional matrix. The new bitmap may be the</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * same object as source, or a copy may have been made. It is</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * initialized with the same density and color space as the original</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * bitmap.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * If the source bitmap is immutable and the requested subset is the</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * same as the source bitmap itself, then the source bitmap is</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * returned and no new bitmap is created.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * The returned bitmap will always be mutable except in the following scenarios:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * (1) In situations where the source bitmap is returned and the source bitmap is immutable</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> * (2) The source bitmap is a hardware bitmap. That is &#123;@link #getConfig()&#125; is equivalent to</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> * &#123;@link Config#HARDWARE&#125;</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * @param source   The bitmap we are subsetting</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> * @param x        The x coordinate of the first pixel in source</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> * @param y        The y coordinate of the first pixel in source</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> * @param width    The number of pixels in each row</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> * @param height   The number of rows</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> * @param m        Optional matrix to be applied to the pixels</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> * @param filter   true if the source should be filtered.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> *                   Only applies if the matrix contains more than just</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> *                   translation.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre> * @return A bitmap that represents the specified subset of source</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> * @throws IllegalArgumentException if the x, y, width, height values are</pre></td></tr><tr><td data-num=\"29\"></td><td><pre> *         outside of the dimensions of the source bitmap, or width is &lt;= 0,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre> *         or height is &lt;= 0, or if the source bitmap has already been recycled</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Bitmap</span> <span class=\"token function\">createBitmap</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@NonNull</span> <span class=\"token class-name\">Bitmap</span> source<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> x<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> y<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> width<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> height<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token annotation punctuation\">@Nullable</span> <span class=\"token class-name\">Matrix</span> m<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> filter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">int</span> neww <span class=\"token operator\">=</span> width<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">int</span> newh <span class=\"token operator\">=</span> height<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token class-name\">Bitmap</span> bitmap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token class-name\">Paint</span> paint<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token class-name\">Rect</span> srcR <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Rect</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> width<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token class-name\">RectF</span> dstR <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RectF</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token class-name\">RectF</span> deviceR <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RectF</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">isIdentity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        bitmap <span class=\"token operator\">=</span> <span class=\"token function\">createBitmap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> neww<span class=\"token punctuation\">,</span> newh<span class=\"token punctuation\">,</span> newConfig<span class=\"token punctuation\">,</span> source<span class=\"token punctuation\">.</span><span class=\"token function\">hasAlpha</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        paint <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// not needed</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> transformed <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>m<span class=\"token punctuation\">.</span><span class=\"token function\">rectStaysRect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        m<span class=\"token punctuation\">.</span><span class=\"token function\">mapRect</span><span class=\"token punctuation\">(</span>deviceR<span class=\"token punctuation\">,</span> dstR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        neww <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>deviceR<span class=\"token punctuation\">.</span><span class=\"token function\">width</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        newh <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>deviceR<span class=\"token punctuation\">.</span><span class=\"token function\">height</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        bitmap <span class=\"token operator\">=</span> <span class=\"token function\">createBitmap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> neww<span class=\"token punctuation\">,</span> newh<span class=\"token punctuation\">,</span> transformedConfig<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                transformed <span class=\"token operator\">||</span> source<span class=\"token punctuation\">.</span><span class=\"token function\">hasAlpha</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        paint <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Paint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        paint<span class=\"token punctuation\">.</span><span class=\"token function\">setFilterBitmap</span><span class=\"token punctuation\">(</span>filter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>transformed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            paint<span class=\"token punctuation\">.</span><span class=\"token function\">setAntiAlias</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token comment\">// The new bitmap was created from a known bitmap source so assume that</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token comment\">// they use the same density</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    bitmap<span class=\"token punctuation\">.</span>mDensity <span class=\"token operator\">=</span> source<span class=\"token punctuation\">.</span>mDensity<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">setHasAlpha</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">.</span><span class=\"token function\">hasAlpha</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">setPremultiplied</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">.</span>mRequestPremultiplied<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token class-name\">Canvas</span> canvas <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Canvas</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    canvas<span class=\"token punctuation\">.</span><span class=\"token function\">translate</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>deviceR<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span>deviceR<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    canvas<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    canvas<span class=\"token punctuation\">.</span><span class=\"token function\">drawBitmap</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> srcR<span class=\"token punctuation\">,</span> dstR<span class=\"token punctuation\">,</span> paint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    canvas<span class=\"token punctuation\">.</span><span class=\"token function\">setBitmap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isHardware<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token keyword\">return</span> bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">copy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Config</span><span class=\"token punctuation\">.</span>HARDWARE<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">return</span> bitmap<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>canvas<span class=\"token punctuation\">.</span><span class=\"token function\">translate</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>deviceR<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span>deviceR<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    canvas<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>translate 是 preconcat the current matrix with the specified translation.<br />\nconcat 同理，是 Preconcat the current matrix with the specified matrix. If the specified matrix is null, this method does nothing.<br />\n 假设 canvas 目前的 matrix 是 I， 那么最后的矩阵 M` = I * translate * m</p>\n<p>为什么是这样的矩阵链，我们该如何理解？</p>\n<p>Canvas 底层的实现 是 Skia， 其有 device 和 local 坐标系。 device 坐标系由你要渲染到的 surface 定义，他们的范围从 surface 的左上角 (0, 0) 到右下角的 (w, h)。 local 坐标系是所有 geometry &amp; shader 应用到 SkCanvas 时的参考坐标系。开始时，两个坐标系原点重合。矩阵变换 操作的是 canvas 和 local 坐标系。</p>\n<blockquote>\n<p>Device coordinates are defined by the surface (or other device) that you’re rendering to. They range from (0, 0) in the upper-left corner of the surface, to (w, h) in the bottom-right corner - they are effectively measured in pixels.</p>\n</blockquote>\n<blockquote>\n<p>The local coordinate space is how all geometry and shaders are supplied to the SkCanvas. By default, the local and device coordinate systems are the same.</p>\n</blockquote>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Canvas</span> canvas <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Canvas</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>canvas<span class=\"token punctuation\">.</span><span class=\"token function\">translate</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>deviceR<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span>deviceR<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>canvas<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>canvas<span class=\"token punctuation\">.</span><span class=\"token function\">drawBitmap</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> srcR<span class=\"token punctuation\">,</span> dstR<span class=\"token punctuation\">,</span> paint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>drawBitmap 时，对 canvas 应用 matrix ，dstR 是相对 canvas 局部坐标系定义，也跟随 matrix 变换，因此 dstR 可能发生位移，此时 canvas 矩阵需要后乘这个逆位移，将矩阵变换后的 dstR 的左上角对齐 device 坐标系原点。 然后将 bitmap 的 srcR 区域像素，拷贝到 canvas 坐标系下的 dstR。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Matrix</span> matrix <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Matrix</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>matrix<span class=\"token punctuation\">.</span><span class=\"token function\">preScale</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">RectF</span> dstR <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RectF</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>dstR 应用镜像矩阵变换后变成 (-width, 0 - 0, height)，同时 canvas 也翻面，此时 srcR 里坐标（0， 0） 的像素映射绘制到 dstR 坐标里的 (0, 0)，srcR 里坐标（width， 0） 的像素映射绘制到 dstR 坐标里的 (-width, 0)。再 translate (left, top)，将画布和 local 坐标系原点偏移回 device 坐标系原点。 这里的 left &amp; top 为什么要取值 deviceR？ 因为在应用矩阵 m 时，可能存在缩放， dstR 可能大小变了，其对应的 (left, top)</p>\n<blockquote>\n<p>对于 local 坐标系的某一点 A (left, top)，如果要偏移到 device 坐标系的原点，则只需要  <code>canvas.translate(-left, -top)</code> <br />\n canvas 有自己的坐标系，其原点位于 View 的左上角，X 轴朝右， Y 轴朝下。在 drawBitmap 前的 translate，scale，rotate， concat 等矩阵操作其实都是在三维空间里对 Canvas 坐变换，</p>\n</blockquote>\n<ol>\n<li><code>canvas.concat(m);</code>  canvas 围绕着 Y 轴旋转 180 度，此时坐标系和 canvas 也跟着旋转， X 轴朝左，</li>\n<li><code>canvas.translate(-deviceR.left, -deviceR.top);</code>  canvas 向</li>\n</ol>\n",
            "tags": [
                "Android，镜像，bitmap"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2025/02/16/Android-command/",
            "url": "https://limxtop1989.github.io/limxtop/2025/02/16/Android-command/",
            "title": "Android 提升开发效率常用命令指南",
            "date_published": "2025-02-16T03:23:48.000Z",
            "content_html": "<h1 id=\"概述\"><a class=\"anchor\" href=\"#概述\">#</a> 概述</h1>\n<p>工欲善其事，必先利其器。在 Android 开发过程中，命令行工具的使用能极大提升开发效率。命令行不仅能帮助开发者快速调试、自动化流程，还能在开发过程中快速定位问题、进行批量操作等，本文将详细展开介绍。</p>\n<h1 id=\"log-过滤查询\"><a class=\"anchor\" href=\"#log-过滤查询\">#</a> Log 过滤查询</h1>\n<p>日志分析时，我们时常需要将包含某个关键字的日志过滤出来，如果只是在一个文件里，使用文本编辑器都可以实现目的。但如果需要高级的查询条件，特别是待分析的日志散落在多个目录下，或者需要实时过滤  <code>adb logcat -b all</code>  的输出时，命令行是最简洁高效。比如我们需要在多个日志文件里，将 “18:20: 任意多个字符 keyword1 &amp; 18:21: 任意多个字符 keyword1 &amp; keyword2” 的日志过滤高亮显示出来，如下命令即可。</p>\n<pre><code class=\"language-Bash\">egrep -irn --color '18:2[01]:.*keyword1|keyword2'\n</code></pre>\n<p>配合管道命令，就可以边操作，边实时过滤查看日志输出。代码怎么执行的，运行时逻辑大概一目了然。</p>\n<p><code>adb logcat -b all | egrep -in --color 'keyword1|keyword2'</code></p>\n<p>每个系统命令都可以在 terminal 通过  <code>man</code>  命令查询其 API，比如  <code>egrep</code>  输入  <code>man egrep</code>  获得其使用说明。</p>\n<p>当然，我们平时在写代码是，同一个类的日志需要使用相同的 TAG， 日志要带上所在的方法名，这样光看日志，就知道程序执行的方法路径和逻辑。方法内的日志需要带上入参和返回值，这些都是比较好的实践。程序运行时的状态更是一目了然了，这样过滤命令更能高效地发挥作用</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Foo</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> TAG <span class=\"token operator\">=</span> <span class=\"token string\">\"Foo\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> param1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">d</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"foo: param1=\"</span> <span class=\"token operator\">+</span> param1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><blockquote>\n<p>❤️ <span class=\"exturl\" data-url=\"aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUmVndWxhcl9leHByZXNzaW9u\">正则表达式</span><br />\n❤️ 做开发总是要学会英语，阅读英文资料的，如何一年半载掌握英语阅读能力，见<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iZXdhdGVycy5tZS8=\">英语自学指南</span></p>\n</blockquote>\n<h1 id=\"文本替换\"><a class=\"anchor\" href=\"#文本替换\">#</a> 文本替换</h1>\n<p>我们可以使用 sed 命令来替换所有 Log.d 为 Log.i：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">find</span> <span class=\"token builtin class-name\">.</span> -name <span class=\"token string\">\"*.java\"</span> -exec <span class=\"token function\">sed</span> -i <span class=\"token string\">'s/Log\\.d/Log\\.i/g'</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> +</pre></td></tr></table></figure><ul>\n<li>find . -name &quot;*.java&quot;：查找所有 .java 文件。</li>\n<li>-exec：对找到的文件执行后面的命令。</li>\n<li>sed -i's/Log.d/Log.i/g'：在文件中替换 Log.d 为 Log.i，-i 表示直接修改文件。</li>\n</ul>\n<h1 id=\"查看当前-resume-的-activity\"><a class=\"anchor\" href=\"#查看当前-resume-的-activity\">#</a> 查看当前 resume 的 Activity</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb shell dumpsys activity activities <span class=\"token operator\">|</span> <span class=\"token function\">egrep</span> -in --color <span class=\"token string\">'dumpsys activity activities'</span> -A <span class=\"token number\">100</span></pre></td></tr></table></figure><p>日志输出如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>:ACTIVITY MANAGER ACTIVITIES <span class=\"token punctuation\">(</span>dumpsys activity activities<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2</span>-Display <span class=\"token comment\">#0 (activities from top to bottom):</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">3</span>-  * Task<span class=\"token punctuation\">&#123;</span>9cb2e7c <span class=\"token comment\">#7568 type=standard A=10265:com.tencent.mm U=0 visible=true visibleRequested=true mode=fullscreen translucent=false sz=3&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">4</span>-    mLastPausedActivity: ActivityRecord<span class=\"token punctuation\">&#123;</span>8d3b19b u0 com.tencent.mm/.plugin.offline.ui.WalletOfflineEntranceUI t-1 f<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">5</span>-    <span class=\"token assign-left variable\">mLastNonFullscreenBounds</span><span class=\"token operator\">=</span>Rect<span class=\"token punctuation\">(</span><span class=\"token number\">276</span>, <span class=\"token number\">696</span> - <span class=\"token number\">805</span>, <span class=\"token number\">1776</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">6</span>-    <span class=\"token assign-left variable\">isSleeping</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">7</span>-    <span class=\"token assign-left variable\">topResumedActivity</span><span class=\"token operator\">=</span>ActivityRecord<span class=\"token punctuation\">&#123;</span>3d295a u0 com.tencent.mm/.framework.app.UIPageFragmentActivity t7568<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">8</span>-    * Hist  <span class=\"token comment\">#2: ActivityRecord&#123;3d295a u0 com.tencent.mm/.framework.app.UIPageFragmentActivity t7568&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">9</span>-      <span class=\"token assign-left variable\">packageName</span><span class=\"token operator\">=</span>com.tencent.mm <span class=\"token assign-left variable\">processName</span><span class=\"token operator\">=</span>com.tencent.mm</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">10</span>-      <span class=\"token assign-left variable\">launchedFromUid</span><span class=\"token operator\">=</span><span class=\"token number\">10265</span> <span class=\"token assign-left variable\">launchedFromPackage</span><span class=\"token operator\">=</span>com.tencent.mm <span class=\"token assign-left variable\">launchedFromFeature</span><span class=\"token operator\">=</span>null <span class=\"token assign-left variable\">userId</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">11</span>-      <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>ProcessRecord<span class=\"token punctuation\">&#123;</span>94fb2cb <span class=\"token number\">29639</span>:com.tencent.mm/u0a265<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">12</span>-      Intent <span class=\"token punctuation\">&#123;</span> <span class=\"token assign-left variable\">cmp</span><span class=\"token operator\">=</span>com.tencent.mm/.framework.app.UIPageFragmentActivity <span class=\"token punctuation\">(</span>has extras<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">13</span>-      <span class=\"token assign-left variable\">rootOfTask</span><span class=\"token operator\">=</span>false <span class=\"token assign-left variable\">task</span><span class=\"token operator\">=</span>Task<span class=\"token punctuation\">&#123;</span>9cb2e7c <span class=\"token comment\">#7568 type=standard A=10265:com.tencent.mm&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">14</span>-      <span class=\"token assign-left variable\">taskAffinity</span><span class=\"token operator\">=</span><span class=\"token number\">10265</span>:com.tencent.mm</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">15</span>-      <span class=\"token assign-left variable\">mActivityComponent</span><span class=\"token operator\">=</span>com.tencent.mm/.framework.app.UIPageFragmentActivity</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token number\">53</span>-    * Hist  <span class=\"token comment\">#1: ActivityRecord&#123;c7145cd u0 com.tencent.mm/.plugin.mall.ui.MallIndexUIv2 t7568&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token number\">54</span>-      <span class=\"token assign-left variable\">packageName</span><span class=\"token operator\">=</span>com.tencent.mm <span class=\"token assign-left variable\">processName</span><span class=\"token operator\">=</span>com.tencent.mm</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">55</span>-      <span class=\"token assign-left variable\">launchedFromUid</span><span class=\"token operator\">=</span><span class=\"token number\">10265</span> <span class=\"token assign-left variable\">launchedFromPackage</span><span class=\"token operator\">=</span>com.tencent.mm <span class=\"token assign-left variable\">launchedFromFeature</span><span class=\"token operator\">=</span>null <span class=\"token assign-left variable\">userId</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token number\">56</span>-      <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>ProcessRecord<span class=\"token punctuation\">&#123;</span>94fb2cb <span class=\"token number\">29639</span>:com.tencent.mm/u0a265<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token number\">57</span>-      Intent <span class=\"token punctuation\">&#123;</span> <span class=\"token assign-left variable\">flg</span><span class=\"token operator\">=</span>0x20000000 <span class=\"token assign-left variable\">cmp</span><span class=\"token operator\">=</span>com.tencent.mm/.plugin.mall.ui.MallIndexUIv2 <span class=\"token punctuation\">(</span>has extras<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token number\">58</span>-      <span class=\"token assign-left variable\">rootOfTask</span><span class=\"token operator\">=</span>false <span class=\"token assign-left variable\">task</span><span class=\"token operator\">=</span>Task<span class=\"token punctuation\">&#123;</span>9cb2e7c <span class=\"token comment\">#7568 type=standard A=10265:com.tencent.mm&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token number\">59</span>-      <span class=\"token assign-left variable\">taskAffinity</span><span class=\"token operator\">=</span><span class=\"token number\">10265</span>:com.tencent.mm</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token number\">60</span>-      <span class=\"token assign-left variable\">mActivityComponent</span><span class=\"token operator\">=</span>com.tencent.mm/.plugin.mall.ui.MallIndexUIv2</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token number\">98</span>-    * Hist  <span class=\"token comment\">#0: ActivityRecord&#123;f0316e7 u0 com.tencent.mm/.ui.LauncherUI t7568&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token number\">99</span>-      <span class=\"token assign-left variable\">packageName</span><span class=\"token operator\">=</span>com.tencent.mm <span class=\"token assign-left variable\">processName</span><span class=\"token operator\">=</span>com.tencent.mm</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token number\">100</span>-      <span class=\"token assign-left variable\">launchedFromUid</span><span class=\"token operator\">=</span><span class=\"token number\">10265</span> <span class=\"token assign-left variable\">launchedFromPackage</span><span class=\"token operator\">=</span>com.tencent.mm <span class=\"token assign-left variable\">launchedFromFeature</span><span class=\"token operator\">=</span>null <span class=\"token assign-left variable\">userId</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token number\">101</span>-      <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>ProcessRecord<span class=\"token punctuation\">&#123;</span>94fb2cb <span class=\"token number\">29639</span>:com.tencent.mm/u0a265<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"查看当前-resume-的-fragment\"><a class=\"anchor\" href=\"#查看当前-resume-的-fragment\">#</a> 查看当前 resume 的 Fragment</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb shell dumpsys activity <span class=\"token function\">top</span></pre></td></tr></table></figure><p>更多 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vdG9vbHMvZHVtcHN5cw==\">dumpsys</span> 见链接和自行搜索。</p>\n<h1 id=\"查看-activity-启动调度流程\"><a class=\"anchor\" href=\"#查看-activity-启动调度流程\">#</a> 查看 Activity 启动调度流程</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb logcat -b all <span class=\"token operator\">|</span> <span class=\"token function\">egrep</span> -in --color <span class=\"token string\">'am_|wm_|activitytask|displayed'</span></pre></td></tr></table></figure><p>以桌面启动 wordcard 应用为例，日志输出：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">41911</span>:02-15 <span class=\"token number\">22</span>:11:28.678  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I wm_task_created: <span class=\"token number\">7584</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">41915</span>:02-15 <span class=\"token number\">22</span>:11:28.686  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I wm_task_moved: <span class=\"token punctuation\">[</span><span class=\"token number\">7584,7584</span>,0,1,9<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">41916</span>:02-15 <span class=\"token number\">22</span>:11:28.686  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I wm_task_to_front: <span class=\"token punctuation\">[</span><span class=\"token number\">0,7584</span>,0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">41917</span>:02-15 <span class=\"token number\">22</span>:11:28.687  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I wm_create_task: <span class=\"token punctuation\">[</span><span class=\"token number\">0,7584</span>,7584,0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">41918</span>:02-15 <span class=\"token number\">22</span>:11:28.687  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I wm_create_activity: <span class=\"token punctuation\">[</span><span class=\"token number\">0,107658451</span>,7584,com.maxim.wordcard.free/com.maxim.wordcard.MainActivity,android.intent.action.MAIN,NULL,NULL,270532608<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">41919</span>:02-15 <span class=\"token number\">22</span>:11:28.687  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I wm_task_moved: <span class=\"token punctuation\">[</span><span class=\"token number\">7584,7584</span>,0,1,9<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">41921</span>:02-15 <span class=\"token number\">22</span>:11:28.689  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I wm_pause_activity: <span class=\"token punctuation\">[</span><span class=\"token number\">0,62924082</span>,com.google.android.apps.nexuslauncher/.NexusLauncherActivity,userLeaving<span class=\"token operator\">=</span>true,pauseBackTasks<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">41923</span>:02-15 <span class=\"token number\">22</span>:11:28.691  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I ActivityTaskManager: START u0 <span class=\"token punctuation\">&#123;</span>act<span class=\"token operator\">=</span>android.intent.action.MAIN <span class=\"token assign-left variable\">cat</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>android.intent.category.LAUNCHER<span class=\"token punctuation\">]</span> <span class=\"token assign-left variable\">flg</span><span class=\"token operator\">=</span>0x10200000 <span class=\"token assign-left variable\">cmp</span><span class=\"token operator\">=</span>com.maxim.wordcard.free/com.maxim.wordcard.MainActivity <span class=\"token assign-left variable\">bnds</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token number\">787,671</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1034,986</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span> with LAUNCH_MULTIPLE from uid <span class=\"token number\">10232</span> <span class=\"token punctuation\">(</span>BAL_ALLOW_ALLOWLISTED_COMPONENT<span class=\"token punctuation\">)</span> result <span class=\"token assign-left variable\">code</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">41928</span>:02-15 <span class=\"token number\">22</span>:11:28.693  <span class=\"token number\">1622</span>  <span class=\"token number\">1782</span> I am_uid_running: <span class=\"token number\">10320</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">41929</span>:02-15 <span class=\"token number\">22</span>:11:28.693 <span class=\"token number\">27385</span> <span class=\"token number\">27385</span> I wm_on_top_resumed_lost_called: <span class=\"token punctuation\">[</span><span class=\"token number\">62924082</span>,com.google.android.apps.nexuslauncher.NexusLauncherActivity,topStateChangedWhenResumed<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">41937</span>:02-15 <span class=\"token number\">22</span>:11:28.694 <span class=\"token number\">27385</span> <span class=\"token number\">27385</span> I wm_on_paused_called: <span class=\"token punctuation\">[</span><span class=\"token number\">62924082</span>,com.google.android.apps.nexuslauncher.NexusLauncherActivity,performPause,0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">41938</span>:02-15 <span class=\"token number\">22</span>:11:28.695  <span class=\"token number\">1622</span>  <span class=\"token number\">4091</span> I wm_add_to_stopping: <span class=\"token punctuation\">[</span><span class=\"token number\">0,62924082</span>,com.google.android.apps.nexuslauncher/.NexusLauncherActivity,makeInvisible<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">41945</span>:02-15 <span class=\"token number\">22</span>:11:28.711  <span class=\"token number\">1622</span>  <span class=\"token number\">1809</span> I am_proc_start: <span class=\"token punctuation\">[</span><span class=\"token number\">0,2035</span>,10320,com.maxim.wordcard.free,next-top-activity,<span class=\"token punctuation\">&#123;</span>com.maxim.wordcard.free/com.maxim.wordcard.MainActivity<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">41948</span>:02-15 <span class=\"token number\">22</span>:11:28.720  <span class=\"token number\">1622</span>  <span class=\"token number\">1805</span> I am_pss  <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">27027,10155</span>,com.google.android.googlequicksearchbox:search,185773056,120262656,48736256,273444864,0,3,20<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">41971</span>:02-15 <span class=\"token number\">22</span>:11:28.732  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I am_proc_bound: <span class=\"token punctuation\">[</span><span class=\"token number\">0,2035</span>,com.maxim.wordcard.free<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token number\">41976</span>:02-15 <span class=\"token number\">22</span>:11:28.735  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I am_uid_active: <span class=\"token number\">10320</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token number\">42055</span>:02-15 <span class=\"token number\">22</span>:11:28.871  <span class=\"token number\">1622</span>  <span class=\"token number\">1965</span> I am_unfreeze: <span class=\"token punctuation\">[</span><span class=\"token number\">27271</span>,com.google.android.adservices.api,6<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">42056</span>:02-15 <span class=\"token number\">22</span>:11:28.871  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I am_uid_active: <span class=\"token number\">10257</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token number\">42081</span>:02-15 <span class=\"token number\">22</span>:11:28.935  <span class=\"token number\">1622</span>  <span class=\"token number\">1965</span> I am_unfreeze: <span class=\"token punctuation\">[</span><span class=\"token number\">23781</span>,com.android.vending,6<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token number\">42092</span>:02-15 <span class=\"token number\">22</span>:11:28.969  <span class=\"token number\">1622</span>  <span class=\"token number\">4091</span> I am_uid_active: <span class=\"token number\">10174</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token number\">42093</span>:02-15 <span class=\"token number\">22</span>:11:28.969  <span class=\"token number\">1622</span>  <span class=\"token number\">1965</span> I am_unfreeze: <span class=\"token punctuation\">[</span><span class=\"token number\">26122</span>,com.google.android.webview:webview_service,6<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token number\">42100</span>:02-15 <span class=\"token number\">22</span>:11:28.986  <span class=\"token number\">1622</span>  <span class=\"token number\">4091</span> I am_uid_running: <span class=\"token number\">99529</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token number\">42107</span>:02-15 <span class=\"token number\">22</span>:11:28.998  <span class=\"token number\">1622</span>  <span class=\"token number\">1809</span> I am_proc_start: <span class=\"token punctuation\">[</span><span class=\"token number\">0,2196</span>,99529,com.google.android.webview:sandboxed_process0:org.chromium.content.app.SandboxedProcessService0:0,,<span class=\"token punctuation\">&#123;</span>com.maxim.wordcard.free/org.chromium.content.app.SandboxedProcessService0:0<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token number\">42118</span>:02-15 <span class=\"token number\">22</span>:11:29.013  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I am_proc_bound: <span class=\"token punctuation\">[</span><span class=\"token number\">0,2196</span>,com.google.android.webview:sandboxed_process0:org.chromium.content.app.SandboxedProcessService0:0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token number\">42123</span>:02-15 <span class=\"token number\">22</span>:11:29.028  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I wm_restart_activity: <span class=\"token punctuation\">[</span><span class=\"token number\">0,107658451</span>,7584,com.maxim.wordcard.free/com.maxim.wordcard.MainActivity<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token number\">42124</span>:02-15 <span class=\"token number\">22</span>:11:29.029  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I wm_set_resumed_activity: <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>,com.maxim.wordcard.free/com.maxim.wordcard.MainActivity,minimalResumeActivityLocked - onActivityStateChanged<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token number\">42125</span>:02-15 <span class=\"token number\">22</span>:11:29.030  <span class=\"token number\">1622</span>  <span class=\"token number\">4086</span> I am_uid_active: <span class=\"token number\">99529</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token number\">42151</span>:02-15 <span class=\"token number\">22</span>:11:29.158  <span class=\"token number\">2035</span>  <span class=\"token number\">2035</span> I wm_on_create_called: <span class=\"token punctuation\">[</span><span class=\"token number\">107658451</span>,com.maxim.wordcard.MainActivity,performCreate,12<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token number\">42153</span>:02-15 <span class=\"token number\">22</span>:11:29.162  <span class=\"token number\">2035</span>  <span class=\"token number\">2035</span> I wm_on_start_called: <span class=\"token punctuation\">[</span><span class=\"token number\">107658451</span>,com.maxim.wordcard.MainActivity,handleStartActivity,4<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token number\">42176</span>:02-15 <span class=\"token number\">22</span>:11:29.229  <span class=\"token number\">2035</span>  <span class=\"token number\">2035</span> I wm_on_resume_called: <span class=\"token punctuation\">[</span><span class=\"token number\">107658451</span>,com.maxim.wordcard.MainActivity,RESUME_ACTIVITY,0<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token number\">42178</span>:02-15 <span class=\"token number\">22</span>:11:29.240  <span class=\"token number\">2035</span>  <span class=\"token number\">2035</span> I wm_on_top_resumed_gained_called: <span class=\"token punctuation\">[</span><span class=\"token number\">107658451</span>,com.maxim.wordcard.MainActivity,topStateChangedWhenResumed<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token number\">42206</span>:02-15 <span class=\"token number\">22</span>:11:29.268  <span class=\"token number\">1622</span>  <span class=\"token number\">1783</span> I wm_wallpaper_surface: <span class=\"token punctuation\">[</span><span class=\"token number\">0,0</span>,Window<span class=\"token punctuation\">&#123;</span>277b556 u0 com.google.android.apps.nexuslauncher/com.google.android.apps.nexuslauncher.NexusLauncherActivity<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token number\">42249</span>:02-15 <span class=\"token number\">22</span>:11:29.328  <span class=\"token number\">1622</span>  <span class=\"token number\">1779</span> I wm_activity_launch_time: <span class=\"token punctuation\">[</span><span class=\"token number\">0,107658451</span>,com.maxim.wordcard.free/com.maxim.wordcard.MainActivity,661<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token number\">42250</span>:02-15 <span class=\"token number\">22</span>:11:29.328  <span class=\"token number\">1622</span>  <span class=\"token number\">1779</span> I ActivityTaskManager: Displayed com.maxim.wordcard.free/com.maxim.wordcard.MainActivity <span class=\"token keyword\">for</span> user <span class=\"token number\">0</span>: +661ms</pre></td></tr></table></figure><ul>\n<li>wm_task_created ： 创建 WordCard 所在的 Task。</li>\n<li>wm_create_activity： WMS 创建好 WordCard 的 MainActivity。</li>\n<li>wm_on_create_called： Activity 执行 onCreate 完成后，通知 WMS 生命周期回调完成。</li>\n<li>Displayed： 启动 com.maxim.wordcard.free 耗时 661ms。</li>\n</ul>\n<h1 id=\"activity-启动耗时\"><a class=\"anchor\" href=\"#activity-启动耗时\">#</a> Activity 启动耗时</h1>\n<pre><code class=\"language-Bash\">ActivityTaskManager: Displayed com.google.android.dialer/.extensions.GoogleDialtactsActivity for user 0: +514ms\n</code></pre>\n<h1 id=\"安装-apk\"><a class=\"anchor\" href=\"#安装-apk\">#</a> 安装 apk</h1>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb <span class=\"token function\">install</span> -r fileName.apk</pre></td></tr></table></figure><ul>\n<li>-b : Back up any existing files before overwriting them by renaming them to file.old.  See -B for specifying a different backup suffix.</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb push fileName.apk remote</pre></td></tr></table></figure><h1 id=\"应用卸载\"><a class=\"anchor\" href=\"#应用卸载\">#</a> 应用卸载</h1>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb shell pm uninstall com.example.MyApp</pre></td></tr></table></figure><h1 id=\"adb启动activity\"><a class=\"anchor\" href=\"#adb启动activity\">#</a> adb 启动 activity</h1>\n<p>Call activity manager</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ adb shell am start -n ｛包<span class=\"token punctuation\">(</span>package<span class=\"token punctuation\">)</span>名｝/｛包名｝.<span class=\"token punctuation\">&#123;</span>活动<span class=\"token punctuation\">(</span>activity<span class=\"token punctuation\">)</span>名称<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>如：启动浏览器</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb shell am start -n com.android.systemui/com.android.browser.BrowserActivity --ei x <span class=\"token number\">1</span> --ei y <span class=\"token number\">2</span></pre></td></tr></table></figure><ul>\n<li>ei : Intent 携带整型参数 x = 1 &amp; y = 2.</li>\n</ul>\n<p>携带启动参数见：Specification for intent arguments 一节</p>\n<h1 id=\"adb启动service\"><a class=\"anchor\" href=\"#adb启动service\">#</a> adb 启动 service</h1>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ adb shell am start <span class=\"token function\">service</span> -n ｛包<span class=\"token punctuation\">(</span>package<span class=\"token punctuation\">)</span>名｝/｛包名｝.<span class=\"token punctuation\">&#123;</span>服务<span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">)</span>名称<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>如：启动自己应用中一个 service</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb shell am startservice -n com.android.traffic/com.android.traffic.maniservice</pre></td></tr></table></figure><p>携带启动参数见：Specification for intent arguments 一节</p>\n<h1 id=\"adb发送broadcast\"><a class=\"anchor\" href=\"#adb发送broadcast\">#</a> adb 发送 broadcast</h1>\n<p>$ adb shell $ am broadcast -a &lt;广播动作&gt; 如：发送一个网络变化的广播</p>\n<pre><code>adb shell am broadcast -a android.net.conn.CONNECTIVITY_CHANGE\n</code></pre>\n<p>携带启动参数见：Specification for intent arguments 一节</p>\n<h1 id=\"清空应用的文件包含数据库和-sharepreference\"><a class=\"anchor\" href=\"#清空应用的文件包含数据库和-sharepreference\">#</a> 清空应用的文件，包含数据库和 SharePreference</h1>\n<p>Call package manager</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb shell pm <span class=\"token function\">clear</span> package</pre></td></tr></table></figure><h1 id=\"copy-files-to-and-from-a-device\"><a class=\"anchor\" href=\"#copy-files-to-and-from-a-device\">#</a> Copy files to and from a device</h1>\n<p>To copy a file or directory and its sub-directories <em>from</em> the device, do the following:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb pull remote <span class=\"token builtin class-name\">local</span></pre></td></tr></table></figure><p>To copy a file or directory and its sub-directories <em>to</em> the device, do the following:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb push <span class=\"token builtin class-name\">local</span> remote</pre></td></tr></table></figure><p>Replace  <code>local</code>  and  <code>remote</code>  with the paths to the target files/directory on your development machine (local) and on the device (remote). For example:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb push myfile.txt /sdcard/myfile.txt</pre></td></tr></table></figure><p>示例：截屏</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb shell screencap -p /sdcard/screenshot.png</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>adb pull /sdcard/screenshot.png</pre></td></tr></table></figure><ul>\n<li>第一条命令在设备上截屏并保存到 /sdcard/screenshot.png。</li>\n<li>第二条命令将截屏文件从设备拉取到本地。</li>\n</ul>\n<h1 id=\"call-package-manager-pm\"><a class=\"anchor\" href=\"#call-package-manager-pm\">#</a> Call package manager (pm)</h1>\n<p>Within an adb shell, you can issue commands with the package manager (pm) tool to perform actions and queries on app packages installed on the device.</p>\n<p>While in a shell, the pm syntax is:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pm <span class=\"token builtin class-name\">command</span></pre></td></tr></table></figure><p>You can also issue a package manager command directly from adb without entering a remote shell. For example:</p>\n<table>\n<thead>\n<tr>\n<th>Command</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>install [options] path</td>\n<td>Install a package, specified by path, to the system.<br>Options:<br><br> <code>-r</code> : Reinstall an existing app, keeping its data.<br> <code>-t</code> : Allow test APKs to be installed. Gradle generates a test APK when you have only run or debugged your app or have used the Android Studio Build &gt; Build APK command. If the APK is built using a developer preview SDK, you must include the -t option with the install command if you are installing a test APK.<br> <code>-d</code> : Allow version code downgrade.</td>\n</tr>\n<tr>\n<td>uninstall [options] package</td>\n<td>Removes a package from the system.<br>Options:<br><br>-k: Keep the data and cache directories after package removal.</td>\n</tr>\n<tr>\n<td>clear package</td>\n<td>Delete all data associated with a package.</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"take-a-screenshot\"><a class=\"anchor\" href=\"#take-a-screenshot\">#</a> Take a screenshot</h1>\n<p>The screencap command is a shell utility for taking a screenshot of a device display.</p>\n<p>While in a shell, the screencap syntax is:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>screencap filename</pre></td></tr></table></figure><p>To use screencap from the command line, enter the following:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb shell screencap /sdcard/screen.png</pre></td></tr></table></figure><p>Here's an example screenshot session, using the adb shell to capture the screenshot and the pull command to download the file from the device:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ adb shell</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>shell@ $ screencap /sdcard/screen.png</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>shell@ $ <span class=\"token builtin class-name\">exit</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>$ adb pull /sdcard/screen.png</pre></td></tr></table></figure><h1 id=\"record-a-video\"><a class=\"anchor\" href=\"#record-a-video\">#</a> Record a video</h1>\n<p>The screenrecord command is a shell utility for recording the display of devices running Android 4.4 (API level 19) and higher. The utility records screen activity to an MPEG-4 file. You can use this file to create promotional or training videos or for debugging and testing.</p>\n<p>In a shell, use the following syntax:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>screenrecord <span class=\"token punctuation\">[</span>options<span class=\"token punctuation\">]</span> filename</pre></td></tr></table></figure><p>To use screenrecord from the command line, enter the following:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb shell screenrecord /sdcard/demo.mp4</pre></td></tr></table></figure><p>Stop the screen recording by pressing Control+C. Otherwise, the recording stops automatically at three minutes or the time limit set by --time-limit.</p>\n<p>To begin recording your device screen, run the screenrecord command to record the video. Then, run the pull command to download the video from the device to the host computer. Here's an example recording session:</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ adb shell</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>shell@ $ screenrecord --verbose /sdcard/demo.mp4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span>press Control + C to stop<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>shell@ $ <span class=\"token builtin class-name\">exit</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>$ adb pull /sdcard/demo.mp4</pre></td></tr></table></figure><p>The screenrecord utility can record at any supported resolution and bit rate you request, while retaining the aspect ratio of the device display. The utility records at the native display resolution and orientation by default, with a maximum length of three minutes.</p>\n<p>Limitations of the screenrecord utility:</p>\n<ul>\n<li>Audio is not recorded with the video file.</li>\n<li>Video recording is not available for devices running Wear OS.</li>\n<li>Some devices might not be able to record at their native display resolution. If you encounter problems with screen recording, try using a lower screen resolution.</li>\n<li>Rotation of the screen during recording is not supported. If the screen does rotate during recording, some of the screen is cut off in the recording.</li>\n</ul>\n<p>Table 4. screenrecord options</p>\n<table>\n<thead>\n<tr>\n<th>Options</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>--help</td>\n<td>Display command syntax and options</td>\n</tr>\n<tr>\n<td>--size widthxheight</td>\n<td>Set the video size: 1280x720. The default value is the device's native display resolution (if supported), 1280x720 if not. For best results, use a size supported by your device's Advanced Video Coding (AVC) encoder.</td>\n</tr>\n<tr>\n<td>--bit-rate rate</td>\n<td>Set the video bit rate for the video, in megabits per second. The default value is 20Mbps. You can increase the bit rate to improve video quality, but doing so results in larger movie files. The following example sets the recording bit rate to 6Mbps:<br> <code>screenrecord --bit-rate 6000000 /sdcard/demo.mp4</code></td>\n</tr>\n<tr>\n<td>--time-limit time</td>\n<td>Set the maximum recording time, in seconds. The default and maximum value is 180 (3 minutes).</td>\n</tr>\n<tr>\n<td>--rotate</td>\n<td>Rotate the output 90 degrees. This feature is experimental.</td>\n</tr>\n<tr>\n<td>--verbose</td>\n<td>Display log information on the command-line screen. If you do not set this option, the utility does not display any information while running.</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"specification-for-intent-arguments\"><a class=\"anchor\" href=\"#specification-for-intent-arguments\">#</a> Specification for intent arguments</h1>\n<p>For activity manager commands that take an  <code>intent</code>  argument, you can specify the intent with the following options:</p>\n<p><code>-a action</code></p>\n<p>Specify the intent action, such as  <code>android.intent.action.VIEW</code> . You can declare this only once.</p>\n<p><code>-d data_uri</code></p>\n<p>Specify the intent data URI, such as  <code>content://contacts/people/1</code> . You can declare this only once.</p>\n<p><code>-t mime_type</code></p>\n<p>Specify the intent MIME type, such as  <code>image/png</code> . You can declare this only once.</p>\n<p><code>-c category</code></p>\n<p>Specify an intent category, such as  <code>android.intent.category.APP_CONTACTS</code> .</p>\n<p><code>-n component</code></p>\n<p>Specify the component name with package name prefix to create an explicit intent, such as  <code>com.example.app/.ExampleActivity</code> .</p>\n<p><code>-f flags</code></p>\n<p>Add flags to the intent, as supported by  <code>[setFlags()](https://developer.android.com/reference/android/content/Intent#setFlags(int))</code> .</p>\n<p><code>--esn extra_key</code></p>\n<p>Add a null extra. This option is not supported for URI intents.</p>\n<p><code>-e | --es extra_key extra_string_value</code></p>\n<p>Add string data as a key-value pair.</p>\n<p><code>--ez extra_key extra_boolean_value</code></p>\n<p>Add boolean data as a key-value pair.</p>\n<p><code>--ei extra_key extra_int_value</code></p>\n<p>Add integer data as a key-value pair.</p>\n<p><code>--el extra_key extra_long_value</code></p>\n<p>Add long data as a key-value pair.</p>\n<p><code>--ef extra_key extra_float_value</code></p>\n<p>Add float data as a key-value pair.</p>\n<p><code>--eu extra_key extra_uri_value</code></p>\n<p>Add URI data as a key-value pair.</p>\n<p><code>--ecn extra_key extra_component_name_value</code></p>\n<p>Add a component name, which is converted and passed as a  <code>[ComponentName](https://developer.android.com/reference/android/content/ComponentName)</code>  object.</p>\n<p><code>--eia extra_key extra_int_value[,extra_int_value...]</code></p>\n<p>Add an array of integers.</p>\n<p><code>--ela extra_key extra_long_value[,extra_long_value...]</code></p>\n<p>Add an array of longs.</p>\n<p><code>--efa extra_key extra_float_value[,extra_float_value...]</code></p>\n<p>Add an array of floats.</p>\n<p><code>--grant-read-uri-permission</code></p>\n<p>Include the flag  <code>[FLAG_GRANT_READ_URI_PERMISSION](https://developer.android.com/reference/android/content/Intent#FLAG_GRANT_READ_URI_PERMISSION)</code> .</p>\n<p><code>--grant-write-uri-permission</code></p>\n<p>Include the flag  <code>[FLAG_GRANT_WRITE_URI_PERMISSION](https://developer.android.com/reference/android/content/Intent#FLAG_GRANT_WRITE_URI_PERMISSION)</code> .</p>\n<p><code>--debug-log-resolution</code></p>\n<p>Include the flag  <code>[FLAG_DEBUG_LOG_RESOLUTION](https://developer.android.com/reference/android/content/Intent#FLAG_DEBUG_LOG_RESOLUTION)</code> .</p>\n<p><code>--exclude-stopped-packages</code></p>\n<p>Include the flag  <code>[FLAG_EXCLUDE_STOPPED_PACKAGES](https://developer.android.com/reference/android/content/Intent#FLAG_EXCLUDE_STOPPED_PACKAGES)</code> .</p>\n<p><code>--include-stopped-packages</code></p>\n<p>Include the flag  <code>[FLAG_INCLUDE_STOPPED_PACKAGES](https://developer.android.com/reference/android/content/Intent#FLAG_INCLUDE_STOPPED_PACKAGES)</code> .</p>\n<p><code>--activity-brought-to-front</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_BROUGHT_TO_FRONT](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_BROUGHT_TO_FRONT)</code> .</p>\n<p><code>--activity-clear-top</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_CLEAR_TOP](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_TOP)</code> .</p>\n<p><code>--activity-clear-when-task-reset</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET)</code> .</p>\n<p><code>--activity-exclude-from-recents</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS)</code> .</p>\n<p><code>--activity-launched-from-history</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_LAUNCHED_FROM_HISTORY](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_LAUNCHED_FROM_HISTORY)</code> .</p>\n<p><code>--activity-multiple-task</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_MULTIPLE_TASK](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_MULTIPLE_TASK)</code> .</p>\n<p><code>--activity-no-animation</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_NO_ANIMATION](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_NO_ANIMATION)</code> .</p>\n<p><code>--activity-no-history</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_NO_HISTORY](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_NO_HISTORY)</code> .</p>\n<p><code>--activity-no-user-action</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_NO_USER_ACTION](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_NO_USER_ACTION)</code> .</p>\n<p><code>--activity-previous-is-top</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_PREVIOUS_IS_TOP](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_PREVIOUS_IS_TOP)</code> .</p>\n<p><code>--activity-reorder-to-front</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_REORDER_TO_FRONT](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_REORDER_TO_FRONT)</code> .</p>\n<p><code>--activity-reset-task-if-needed</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_RESET_TASK_IF_NEEDED](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_RESET_TASK_IF_NEEDED)</code> .</p>\n<p><code>--activity-single-top</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_SINGLE_TOP](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_SINGLE_TOP)</code> .</p>\n<p><code>--activity-clear-task</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_CLEAR_TASK](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_CLEAR_TASK)</code> .</p>\n<p><code>--activity-task-on-home</code></p>\n<p>Include the flag  <code>[FLAG_ACTIVITY_TASK_ON_HOME](https://developer.android.com/reference/android/content/Intent#FLAG_ACTIVITY_TASK_ON_HOME)</code> .</p>\n<p><code>--receiver-registered-only</code></p>\n<p>Include the flag  <code>[FLAG_RECEIVER_REGISTERED_ONLY](https://developer.android.com/reference/android/content/Intent#FLAG_RECEIVER_REGISTERED_ONLY)</code> .</p>\n<p><code>--receiver-replace-pending</code></p>\n<p>Include the flag  <code>[FLAG_RECEIVER_REPLACE_PENDING](https://developer.android.com/reference/android/content/Intent#FLAG_RECEIVER_REPLACE_PENDING)</code> .</p>\n<p><code>--selector</code></p>\n<p>Requires the use of  <code>-d</code>  and  <code>-t</code>  options to set the intent data and type.</p>\n",
            "tags": [
                "Android",
                "Android, adb, egrep, 正则表达式，"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2024/05/19/take-part-in/",
            "url": "https://limxtop1989.github.io/limxtop/2024/05/19/take-part-in/",
            "title": "置身事内读书笔记",
            "date_published": "2024-05-19T14:39:48.000Z",
            "content_html": "<h1 id=\"chapter-2-财税和政府行为\"><a class=\"anchor\" href=\"#chapter-2-财税和政府行为\">#</a> Chapter 2 财税和政府行为</h1>\n<h2 id=\"分税制\"><a class=\"anchor\" href=\"#分税制\">#</a> 分税制</h2>\n<p>在 1994 年财政改革以前，中国的财政体制采用 “包干制”，其中政府财政收入被分为三类：中央固定收入、地方固定收入和中央地方共享收入。地方财政每年仅向中央交纳定额的财政税收，部分地方采用减免企业税收的方式，截留经济发展成果，藏富于企。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlODglODYlRTclQTglOEUlRTUlODglQjYlRTYlOTQlQjklRTklOUQlQTkvNjU0NzA1NQ==\">分税制改革</span>主要目的是缓解自 1980 年代末以来中央财政入不敷出的情况。在全国财政收入快速增长的基础上，还实现了中央财政占总财政收入比重的快速上升，中央财政贫弱的局面得到改观，从制度层面保证了中央财政收入稳定增长、 增强中央宏观调控能力目标的实现。</p>\n<ol>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlQTIlOUUlRTUlODAlQkMlRTclQTglOEU=\">增值税</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTQlQkMlODElRTQlQjglOUElRTYlODklODAlRTUlQkUlOTclRTclQTglOEU=\">企业所得税</span> （鼓励地方企业成立：烟酒厂。弊端：地方保护主义，只买卖本地烟酒）</li>\n</ol>\n<h2 id=\"土地财政\"><a class=\"anchor\" href=\"#土地财政\">#</a> 土地财政</h2>\n<p>奏效原因：</p>\n<ol>\n<li>停止单位福利分房</li>\n<li>土地管理法颁布，规定农地转建设用地，须征地为国有土地。地方政府垄断住房土地供应</li>\n</ol>\n<p>地方政府压低工业用地价格。工业对经济发展提供动力，有长久的竞争优势和稳定的税收来源。<br />\n商住用地抬高用地价格，增加地方政府的收入。</p>\n<p>土地财政弊端。</p>\n<ol>\n<li>地方政府的债务问题：土地财政本质是把未来的收益抵押到今天去借钱，如果这些钱投资质量高，收益大于债务，则是良性的。否则是寅吃卯粮。</li>\n<li>资源使用率不高。地方有动力调配土地资源，平衡工业和商住用地供给和价格，但全国范围内，土地资源和建设用地分配却很难优化。地区间虽然搞竞争，但用地指标不能跨省流动到效率更高的地区。比如长三角和珠三角，没有足够的建设用地指标，工业和人口被人为限制，中西部却有大量闲置的产业园区。这些指标不可以分给经济更加发达的地区。如果竞争不能让资源转移到效率更高的地方，那这种竞争和市场竞争不同。</li>\n</ol>\n<h2 id=\"不平衡\"><a class=\"anchor\" href=\"#不平衡\">#</a> 不平衡</h2>\n<p>分税制改革后，中央拿走收入的大头，支出仍由地方负责，地方收支差距由中央转移支付来填补。</p>\n<h3 id=\"基层财政困难\"><a class=\"anchor\" href=\"#基层财政困难\">#</a> 基层财政困难</h3>\n<p>分税制后，中央和省分成，省和市县分成，上级权威高于下级，基层分到的钱少，但分到的任务多。导致基层乱收费，工程欠款。</p>\n<p>应对措施：</p>\n<ol>\n<li>农村税费改革：比如取消农业税，得益于加入 WTO，工商业发展，国家财政不需依赖农业税费。</li>\n<li>加大上级的统筹和转移支付力度。\n<ol>\n<li>农村公共服务开支由中叶和地方政府共同负担，（农村义务教育改革基金，新型农村合作医疗制度，新型农村社会养老保险制度）</li>\n<li>激励精简机构和人员的县乡政府。</li>\n</ol>\n</li>\n</ol>\n<h3 id=\"地区间不平等\"><a class=\"anchor\" href=\"#地区间不平等\">#</a> 地区间不平等</h3>\n<p>转移支付分为一般性转移支付和专项转移支付。后者会优先给具有先发优势和条件的地区。</p>\n<h1 id=\"chapter-3-政府投融资与债务\"><a class=\"anchor\" href=\"#chapter-3-政府投融资与债务\">#</a> Chapter 3 政府投融资与债务</h1>\n<h2 id=\"城投公司和土地金融\"><a class=\"anchor\" href=\"#城投公司和土地金融\">#</a> 城投公司和土地金融</h2>\n<p>城投特征</p>\n<ul>\n<li>持有土地使用权</li>\n<li>盈利状况依赖政府补贴</li>\n<li>政府隐性担保可以让其大量借款</li>\n</ul>\n<p>工业园区很难盈利，政府付费使用私营企业开发建设的基础设施（比如产业园区）变相和政府分享税收收益。</p>\n<h2 id=\"地方政府债务\"><a class=\"anchor\" href=\"#地方政府债务\">#</a> 地方政府债务</h2>\n<p>城投公司诞生来源</p>\n<ol>\n<li>政府不能从银行直接贷款</li>\n<li>城建开发项目繁复，有些赚钱，有些亏本，以赚钱项目带动不赚钱项目</li>\n<li>仅靠财政预算收入不够还债，需要把土地有关的收益用起来</li>\n</ol>\n<p>城投公司的融资方式</p>\n<ol>\n<li>银行贷款</li>\n<li>发行债券（城投债）</li>\n</ol>\n<p>地方债的治理和改革</p>\n<ol>\n<li>债务置换：用地方政府发行的公债，替换一部分融资平台公司的银行贷款和城投债。</li>\n<li>推动融资平台转型，剥离其为政府融资的功能，破除政府对其形成的 “隐性” 担保。</li>\n<li>约束银行和金融机构，避免大量资金流入城投公司。</li>\n<li>终身问责官员</li>\n</ol>\n<p>官员政绩和激励机制<br />\n地区生产总值和增长率作为考核评价政绩的主要指标<br />\n偏重投资的增长模式有不良后果：经济发展到一定阶段后，低风险高收益的工业投资项目减少，基础设施和城市建设投资的经济效益减弱。<br />\n出于政绩考虑，地方官员在基础设施投资偏重看得见的工程，比如道路，地铁，绿地，相对忽视 “看不见” 的工程，比如地下管网。<br />\n政绩和晋升无法激励绝大多数公务员，实际收入和工作福利为主要因素。这些和本地经济发展，地区财政紧密相关。有助于监督和制约其他部门破坏营商环境的举动。外在的激励需要可量化的工作业绩，并非总是可行，内在驱动和自我约束可以互为补充。</p>\n<p>腐败</p>\n<ol>\n<li>腐败和经济高速增长长期并存。</li>\n<li>腐败形式变化：80 年代的腐败案件，大多与价格双轨制的 “官倒” 和 “投机倒把”.90 年代的案件多与国企改革和国有资产流失有关。21 世纪，则与土地有关。</li>\n</ol>\n<p>腐败类型</p>\n<ol>\n<li>掠夺式：私营企业敲诈勒索，索贿，挪用公款。对经济极其有害。</li>\n<li>权力寻租，官商勾结共同发财。\n<ol>\n<li>资源不能最优配置，推升债务负担和风险</li>\n<li>扩大贫富差距，对经济发展不良影响。</li>\n<li>地方上形成利益集团，破坏市场自由竞争。</li>\n</ol>\n</li>\n</ol>\n<h1 id=\"chapter-5-城市化与不平衡\"><a class=\"anchor\" href=\"#chapter-5-城市化与不平衡\">#</a> Chapter 5 城市化与不平衡</h1>\n<h2 id=\"房价与居民债务\"><a class=\"anchor\" href=\"#房价与居民债务\">#</a> 房价与居民债务</h2>\n<p>东部城市用地指标少于新增人口，造成土地和住房供不应求，推升房价。</p>\n<h3 id=\"欧美经验和教训\"><a class=\"anchor\" href=\"#欧美经验和教训\">#</a> 欧美经验和教训</h3>\n<p>欧美自有住房上升有两个后果。</p>\n<ol>\n<li>房子价格上涨后，房产成了国民财富最重要的组成部分。</li>\n<li>房价增长，得益于房价上涨的人就越多，政府为了讨好这部分选民，不愿意房价下跌。无房者也期望买房上车，政府顺水推舟，降低买房的首付门槛和按揭利率。<br />\n房价下挫和收入下降会加大家庭负担，进而抑制消费，经济衰退。</li>\n</ol>\n<h3 id=\"我国的情况\"><a class=\"anchor\" href=\"#我国的情况\">#</a> 我国的情况</h3>\n<p>我过房价和居民债务的上涨，不大可能会突发美国式的房贷和金融危机。</p>\n<ol>\n<li>住房按揭首付比例 30%，除非房价暴跌超过首付比例，否则居民不会违约按揭，损失掉自己的首付。</li>\n<li>住房按揭形成的信贷资产，没有被层层嵌套金融衍生品，规模和风险没有被放大。</li>\n</ol>\n<h3 id=\"贫富差距\"><a class=\"anchor\" href=\"#贫富差距\">#</a> 贫富差距</h3>\n<p>原因</p>\n<ol>\n<li>低收入人口不可以自由流动到高收入地区工作。</li>\n<li>地方政府倚重投资，导致收入分配偏向资本，降低劳动收入占比。<br />\n方案：达到地区间的人均收入平等，为此需要让劳动力自由流动。在城市，低技能的人，生产率和收入也更高，比如早点摊，而在农村，早点都在家里吃，市场需求小，没有规模效应。</li>\n</ol>\n<h3 id=\"土地流转与户籍改革\"><a class=\"anchor\" href=\"#土地流转与户籍改革\">#</a> 土地流转与户籍改革</h3>\n<p>2019 年，《土地管理法》首次在法律上确认了集体经营性建设用地使用权可以直接向市场中的用地者出让，出租或者作价出资入股，不再需要先行征收为国有土地。打破城市政府对土地供应的垄断。<br />\n2019 年开始，放宽落户限制</p>\n<h1 id=\"chapter-6-债务与风险\"><a class=\"anchor\" href=\"#chapter-6-债务与风险\">#</a> Chapter 6 债务与风险</h1>\n<h2 id=\"债务与经济衰退\"><a class=\"anchor\" href=\"#债务与经济衰退\">#</a> 债务与经济衰退</h2>\n<p>房价不下跌，债务依然存在风险</p>\n<ol>\n<li>债务缺乏弹性，一般不会有大的变动。</li>\n<li>收入波动可以很大。</li>\n<li>家庭支出变动。</li>\n</ol>\n<p>负债高风险高，原因有二</p>\n<ol>\n<li>负债率高的经济中，资产价格下跌往往迅猛。因为债务太多，只能变卖资产，抛售的人多了，资产价格就会跳水。</li>\n<li>资产价格下跌会引起信贷收缩，导致资金链断裂。若抵押物价值跳水，债权人坏账就会飙升，不得不缩减新增信贷。导致债务人借不到钱，资金链断裂。（温州民间借贷危机中，一些人跑路逃债，信任危机发酵，所有人都捂紧钱包，信用良好的人也借不到钱）</li>\n</ol>\n<h2 id=\"债务为何高筑\"><a class=\"anchor\" href=\"#债务为何高筑\">#</a> 债务为何高筑</h2>\n<ol>\n<li>银行规模大，杠杆高，银行自有资本占资产规模大比重下降到 5%</li>\n<li>银行接进来的钱多是短期，当贷出去的却大多是长期，存在流动性和挤兑风险</li>\n<li>银行信贷大都和房地产有关，与土地和房地产价值一同起落。贷款需要抵押物，土地和房子就是最好的抵押物，不会消失和跑掉，价值稳定，用途广。</li>\n<li>银行风险会传导到其他金融部门，打包按揭贷款成一个证券组合，卖给其他金融公司，这种业务挫伤了银行分析信贷的积极性，不大在乎借钱人是否有能力还款，击鼓传花，有人接盘就行。</li>\n</ol>\n<p>全国棚户区改造从实物安置转变为货币化安置，带动房价进一步上涨。</p>\n<p>在购置土地环节，发达国家要求房企使用自有资本。而我国允许房企借钱 “买地”，这就刺激了房企竞相抬高地价和储备土地，储备的土地又可以作为抵押去撬动更多借贷资金。房企的现金流依赖房产预售款和个人按揭，销售出现问题，房企就面临资金链风险。</p>\n<p>银行风险<br />\n银行偏爱以土地和房产为抵押物的贷款。企业的贷款抵押物为设备，专用性太强，找人接盘并不容易，也大打折扣。但如果企业有政府担保，或者是国企，银行风险就小的多。</p>\n<p>“影子银行”，类似银行的信贷业务，但不在银行的资产负债表中，不受银行见鬼规则的约束。若房企想用 10% 的利息贷款，银行想借，但我过严格限制银行给房企的贷款量，银行可以卖给老百姓一个理财产品，利息 5%，再把筹来的钱委托给信托公司，让信托公司把钱借给房企。</p>\n<h2 id=\"化解债务风险\"><a class=\"anchor\" href=\"#化解债务风险\">#</a> 化解债务风险</h2>\n<p>偿还已有债务</p>\n<ol>\n<li>增发货币降低利率。金融危机前的主流做法</li>\n<li>量化宽松，即央行增发货币来买入各类资产。金融危机后发达国家的主流做法。资产抛售，价格大跌，连锁反应后果严重。央行出手买入这些资产，托住资产价格。</li>\n</ol>\n<p>遏制新增债务</p>\n<ol>\n<li>限制房价上涨，</li>\n<li>限制土地财政和土地金融</li>\n<li>限制政府担保和国有企业过度借贷</li>\n</ol>\n",
            "tags": [
                "置身事内"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2024/01/25/squat-down-to-pee/",
            "url": "https://limxtop1989.github.io/limxtop/2024/01/25/squat-down-to-pee/",
            "title": "姐妹们，家里的男人尿脏马桶，怎么办",
            "date_published": "2024-01-25T14:10:00.000Z",
            "content_html": "<p>姐妹们，真的很焦虑。我坚持了好多年霸王洗发水的努力，恐怕要功亏一篑了，最近头发掉的厉害。男朋友入住第一天，我那常年无需清洁的卫生间就像被围困的莫斯科一样，卫生保卫战的号角如同深夜里的防空警报嘹亮地吹响。好多次尿急，风驰电掣闪进厕所，看到马桶壁上残存的黄色尿渍，星星点点，一时尿意全无。我三番五次苦口婆心劝导他，“亲爱的，你大可不必这样，屋里就只有咱们两个，你不用像动物撒尿绕了一个圈，标记宣告这是你的地盘。这屋里的一切，都是我的，也是你的，但终归到底，都是我们的，这里没有外人。” 但几乎无济于事。好多情侣夫妻都在担心七年之痒，我倒觉得他们简直就是神仙眷侣，可以谐恩爱这么久远，像我就没有这样的忧愁，因为我们的爱情可能都坚持不到那个时候。</p>\n<h1 id=\"站着小便不卫生\"><a class=\"anchor\" href=\"#站着小便不卫生\">#</a> 站着小便不卫生</h1>\n<p>国外一家公司，为研究男人尿液溅出的情况，利用荧光液模拟尿液，做了一项实验。</p>\n<p><img data-src=\"https://s3.uuu.ovh/imgs/2024/01/26/395dcb1123d93fa0.jpg\" alt=\"\" /><br />\n实验中，如果液体对准马桶后侧（即靠近水箱一侧的马桶壁），肉眼看上去液体都滴落在马桶中，但紫外线灯一照，发现液体会溅射到马桶盖、马桶圈上。<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2024/01/26/9fbf48890c5fb0b4.jpeg\" alt=\"\" /></p>\n<p>如果液体对准马桶 “靶心”（即马桶的水里），尿液也会有自己的想法，还是溅得到处都是，毕竟很多男人终究是凡人，不会像跳水运动员一样，能够漂亮压水花。<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2024/01/26/06fcfd48cedf3077.jpeg\" alt=\"\" /></p>\n<p>而倘若液体对准马桶前侧（即靠近人体一侧的马桶壁），发现没太多液体能溅到外面，说明这种方式比前两种方式更干净。然而，研究显示，仅有 2% 的男人会用这种方式排尿。不过，尿到马桶前壁的分险大为增加。<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2024/01/26/18c6b3c3668a59b2.jpeg\" alt=\"\" /></p>\n<p>这个实验恐怕有夸大其词之嫌，但站着尿尿，不干净卫生是显而易见。</p>\n<h1 id=\"改良\"><a class=\"anchor\" href=\"#改良\">#</a> 改良</h1>\n<p>我尝试回收了空矿泉水瓶子，费尽心机，像远古的祖先砖木取火一般，给瓶盖钻了个洞，装满了水给家里的男人演示如何正确地撒尿。第一次演示，就取得圆满成功，水柱如同精确制导一般，准确无误地落入马桶前侧。男人点点头，算是学会了。我有点惊呼，困扰世界，引发无数家庭为什纠纷的难题，居然这样神奇地解决了。但好景不长，事与愿违，让男人实操，总是与演示效果相距甚远。</p>\n<p>随着深入研究，叹了一口气得出结论，站立着尿尿，落点要准的技术难度太大，理论上不存在。当男性选择了直立小便的时候，就决定了：无论如何巧妙地 “轻捻慢拢抹复挑” 都很难完美地 “大珠小珠落玉盘”。</p>\n<p>尿尿的运动轨迹是一道完美的抛物线，尿液的抛物线轨迹取决于身高，尿道口角度，尿液压力程度等变量。中间那一段 d 就是就是我们尿尿的辐射范围，而 d 是受两个关键指标影响的。<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2024/01/26/49b17a98772dfc76.jpg\" alt=\"\" /></p>\n<p>第一个是高度 h ，鲁迅曾经说过:</p>\n<blockquote>\n<p>“站得高，尿得远”</p>\n</blockquote>\n<p>就是这个道理，如果他老人家否认了，那就是我说过。这个 h 可以简单地等于裆部的高度，是相对固定的，所以对于长得越高的人来说，d 就越大，就越容易尿到马桶圈上，找个高男友是有代价的😭</p>\n<p>每一次撒尿，除了身高，其他都在变化，所以，过去所有的撒尿经验都无法复制，每一次都是全新的探索。上一次动作可以对准马桶靶心，同样的动作，这次就是流到马桶前侧。就单次尿尿过程，也并非恒定，就像香水有前调，中调和后调，尿尿也分为前奏，高潮和尾声，从刚开始的喷薄而出，中间涓涓细流，到最后残液欲出还羞。每个阶段，都对应不同的抛物线轨迹，所以呢，要尿得准，要全过程实时调整，其技术含量不亚于空中导弹拦截。这些还是小问题，最后的甩动，处理残余尿液，才是灭顶之宅，它就像抛出的鱼线，可近可远。别说远处的直立的马桶盖，近处的马桶前壁，男人狠起来，自己裤子都能沾上。</p>\n<p>所以，原谅他们吧，和有些劣迹斑斑如尿渍的男人相比，他们算好的了，好歹他们知道把马桶坐垫掀起来。碰上坐垫不掀，直接站着尿尿的男人，不是得七窍生烟，就得看破红尘。</p>\n<p>但如果没有办法改良站立式尿尿，那么我们何不破旧立新。</p>\n<h1 id=\"男人也可以坐着尿尿\"><a class=\"anchor\" href=\"#男人也可以坐着尿尿\">#</a> 男人也可以坐着尿尿</h1>\n<p>坐着小便，干净又卫生，但让家里的男人改成这样，又谈何容易。</p>\n<p>首先，顾名思义，站着方便真的方便，毕竟只需经历 “开闸 — 放水 — 关闸”3 个步骤，快速简单，直接缓解上厕所的焦躁心情。酣畅淋漓之感，如飞流直下三千尺，疑是银河落九天。如果每次都得解开裤腰带，纽扣，拉链，脱裤子，坐下结束了还得逆序重做一遍，不仅动作繁琐，费时费力，特别是在尿急尿崩之际，难解燃眉之急。</p>\n<p>其次，男人从盘古开天辟地人类起源起，就只有站着尿尿。从小开始，男孩就被教导尿尿的正确姿势，并且他们会模仿大人的尿尿行为。站着尿尿是一种传承，男人世世代代都习惯了站着尿尿，坐下来拉屎，预备动作彼此分开，多年来形成的神经反馈一时改不来，坐下来尿尿容易变成不小心也拉屎了。这种事情万一传出去，让村里人知道了，容易添油加醋变成，“啧啧啧，他们家男人大小便失禁，好可怜。” 最后连故乡，都回不去了。</p>\n<p>再者，有些时候，坐下来方便也不见得万无一失。共和国的男人，从小在红旗下长大，从不轻易低头，龟头也是头。在不期而遇的晨勃时如厕，尿道根本就无法自然垂落，稍有不慎，就全都尿到裤子上了。当然，这也不是什么大问题，男人又不是没手没脚，自己动手把它按下去，调整角度即可。</p>\n<p>最后，最棘手的当属思想观念，就像历史里的保守派，大清都亡国了，有人还依依不舍留着辫子。有些人实在不容易破旧立新，看着大千世界，坐着尿尿是娘们才干的事情，于是觉得自己坐下来不仅有损男子汉风骨，还离经叛道成为传统的异教徒。殊不知，男人也坐下来尿尿，已经是大势所趋。</p>\n<p>但如果，坐下来尿尿，可以换来干净卫生，上面罗列的种种阻碍，都不应该是问题。如果男人不能纠正历史错误，那就让他负责马桶卫生保洁。虽然这样，马桶的清洁度变成以清洁日为周期的梯度衰减曲线，但也好过于自己清洁，无辜承受。兴许经历这些付出后，男人能够切身明白，还是坐着小便好呀。</p>\n<h1 id=\"时尚是一场轮回\"><a class=\"anchor\" href=\"#时尚是一场轮回\">#</a> 时尚是一场轮回</h1>\n<p>在德国，男性站着尿尿被认为是一种不礼貌的行为。无论是在公共场所如咖啡馆、电影院里的洗手间，还是私人住宅厕所，经常能看见禁止男人站着小便的醒目标志，有的甚至还设置了语音提示装置。</p>\n<p><img data-src=\"https://s3.uuu.ovh/imgs/2024/01/26/4cbc81b682d29382.webp\" alt=\"\" /></p>\n<p>这似乎与广大男性的认知不同，站着嘘嘘不是天经地义的吗？怎么你们搞特殊呢？</p>\n<p>同样，国外一家卫浴制造商研究了日本男人上厕所的方式，结果显示，有 44% 的男士选择坐着上厕所，他们认为，这样做是因为不会弄脏马桶或其他地方，而且也方便打扫。</p>\n<p><img data-src=\"https://pic3.zhimg.com/80/v2-90b71e69350fa299033672accf914466_1440w.webp\" alt=\"\" /></p>\n<p>言归正传，站立尿尿本无可厚非，只是时代在进步，文明和道德的水位也在涨高，像过去司空见惯的随地吐痰，公共场所吸烟，现在已经是白纸黑字的不文明行文。只要家里的男人能坐下马桶撒尿，那都算献出一点爱，世界就会变成美好人间。我们应该开放思想，拥抱变化，各尽所能，让彼此生活更加干净舒心。</p>\n",
            "tags": [
                "男人坐下尿尿"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2024/01/10/volatile/",
            "url": "https://limxtop1989.github.io/limxtop/2024/01/10/volatile/",
            "title": "volatile",
            "date_published": "2024-01-10T08:22:39.000Z",
            "content_html": "<h1 id=\"volatile\"><a class=\"anchor\" href=\"#volatile\">#</a> Volatile</h1>\n<p>volatile 是轻量级的 synchronized，它在多处理器开发中保证了共享变量的 “可见性”。可见性的意思是当一个线程 修改一个共享变量时，另外一个线程能读到这个修改的值。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>instance <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Singleton</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//instance 是 volatile 变量</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 汇编代码</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">0x01a3de1d</span><span class=\"token operator\">:</span> movb $<span class=\"token number\">0</span>×<span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span>×<span class=\"token function\">1104800</span><span class=\"token punctuation\">(</span><span class=\"token operator\">%</span>esi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token number\">0x01a3de24</span><span class=\"token operator\">:</span> lock addl $<span class=\"token number\">0</span>×<span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token operator\">%</span>esp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol>\n<li>Lock 前缀的指令，将这个变量所在缓存行的数据 写回到系统内存。</li>\n<li>其他 CPU 里缓存了该内存地址的数据无效，对数据的访问需要从内存重新读取。（处理器通过嗅探在总线上传播的数据来检查自己缓存的值是不是过期了）</li>\n</ol>\n<h1 id=\"synchronized\"><a class=\"anchor\" href=\"#synchronized\">#</a> Synchronized</h1>\n<p>monitorenter 指令是在编译后插入到同步代码块的开始位置，而 monitorexit 是插入到方法结束处和异常处.</p>\n<p>synchronized 用的锁是存在 Java 对象头的 Mark Word</p>\n<h2 id=\"mark-word-结构\"><a class=\"anchor\" href=\"#mark-word-结构\">#</a> Mark Word 结构</h2>\n<p>TODO： 结构和状态值表</p>\n<table>\n<thead>\n<tr>\n<th>锁状态</th>\n<th>记录</th>\n<th>是否偏向锁</th>\n<th>锁标记位</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>轻量级锁</td>\n<td>指向栈中锁记录的指针</td>\n<td></td>\n<td>00</td>\n</tr>\n<tr>\n<td>重量级锁</td>\n<td>指向互斥量（重量级锁）的指针</td>\n<td></td>\n<td>10</td>\n</tr>\n<tr>\n<td>GC</td>\n<td></td>\n<td></td>\n<td>11</td>\n</tr>\n<tr>\n<td>偏向锁</td>\n<td>线程 ID</td>\n<td>1</td>\n<td>01</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"锁升级\"><a class=\"anchor\" href=\"#锁升级\">#</a> 锁升级</h2>\n<p>锁一共有 4 种状态，级别从低到高依次是：无锁状态、偏向锁状态、轻量级锁状 态和重量级锁状态，这几个状态会随着竞争情况逐渐升级。锁可以升级但不能降级，</p>\n<ol>\n<li>\n<p>单一线程频繁获得锁<br />\n当一个线程访问同步块并 获取锁时，会在对象头和栈帧中的锁记录里存储锁偏向的线程 ID，以后该线程在进入和退出 同步块时不需要进行 CAS 操作来加锁和解锁，只需简单地测试一下对象头的 Mark Word 里是否 存储着指向当前线程的偏向锁。如果测试成功，表示线程已经获得了锁。如果测试失败，则需 要再测试一下 Mark Word 中偏向锁的标识是否设置成 1 (表示当前是偏向锁): 如果没有设置，则 使用 CAS 竞争锁；如果设置了，则尝试使用 CAS 将对象头的偏向锁指向当前线程。</p>\n</li>\n<li>\n<p>轻量级锁<br />\n线程在执行同步块之前，JVM 会先在当前线程的栈桢中创建用于存储锁记录的空间，并 将对象头中的 Mark Word 复制到锁记录中，官方称为 Displaced Mark Word。然后线程尝试使用 CAS 将对象头中的 Mark Word 替换为指向锁记录的指针。如果成功，当前线程获得锁，如果失 败，表示其他线程竞争锁，当前线程便尝试使用 CAS 自旋来获取锁，失败则升级为重量级锁。</p>\n</li>\n<li>\n<p>重量级锁<br />\n轻量级锁的线程释放锁后，通知等待重量级锁的线程。</p>\n</li>\n</ol>\n<h1 id=\"原子性\"><a class=\"anchor\" href=\"#原子性\">#</a> 原子性</h1>\n<h2 id=\"cas\"><a class=\"anchor\" href=\"#cas\">#</a> CAS</h2>\n<p>存在问题：</p>\n<ol>\n<li>ABA 问题</li>\n<li>循环时间长开销大</li>\n<li>只能保证一个共享变量的原子操作</li>\n</ol>\n<h2 id=\"lock\"><a class=\"anchor\" href=\"#lock\">#</a> Lock</h2>\n<h1 id=\"jmm\"><a class=\"anchor\" href=\"#jmm\">#</a> JMM</h1>\n<p>Java 线程之间的通信由 Java 内存模型 (本文简称为 JMM) 控制，JMM 决定一个线程对共享 变量的写入何时对另一个线程可见 <em>可见性</em>。从抽象的角度来看，JMM 定义了线程和主内存之间的抽 象关系：线程之间的共享变量存储在主内存 (Main Memory) 中，每个线程都有一个私有的本地 内存 (Local Memory)，本地内存中存储了该线程以读 / 写共享变量的副本。本地内存是 JMM 的 一个抽象概念，并不真实存在。它涵盖了缓存、写缓冲区、寄存器以及其他的硬件和编译器优 化。</p>\n<h1 id=\"有序性\"><a class=\"anchor\" href=\"#有序性\">#</a> 有序性</h1>\n",
            "tags": []
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2024/01/01/Privacy-Policy/",
            "url": "https://limxtop1989.github.io/limxtop/2024/01/01/Privacy-Policy/",
            "title": "Privacy Policy",
            "date_published": "2024-01-01T13:55:00.000Z",
            "content_html": "<p>Last updated: January 01, 2024</p>\n<h1 id=\"declaration\"><a class=\"anchor\" href=\"#declaration\">#</a> Declaration</h1>\n<p>Flashcard app request access to the following data and only for the purposes stated in the following list:</p>\n<ul>\n<li>Device internal or external storage</li>\n</ul>\n<p>Required to download and move the dictionary files, which will be accessed by GoldenDict, in Downloads or user-specified folders. No other data is accessed. No content found on the device is ever transmitted over the network.</p>\n<ul>\n<li>User interaction &amp; Firebase installation ID</li>\n</ul>\n<p>Information about how a user interacts with Flashcard app. For example, the crash logs, the action of user clicking download button and the action result, which will be used to analyze whether the app works fine. The information is collected by Google Analysis SDK, which obeys General Data Protection Regulation (GDPR). Please refer to <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdXBwb3J0Lmdvb2dsZS5jb20vYW5hbHl0aWNzL2Fuc3dlci82MDA0MjQ1P2hsPWVuJmFtcDt2aXNpdF9pZD02MzgzOTUyMjUyODkxNTU5MjYtMjgxNTM4MzI0MSZhbXA7cmQ9MSN6aXBweT0lMkNvdXItcHJpdmFjeS1wb2xpY3klMkNkYXRhLWNvbGxlY3RlZC1ieS1nb29nbGUtYW5hbHl0aWNzJTJDZGF0YS1jb250cm9scy1mb3ItcmV0ZW50aW9uLWRlbGV0aW9uLWFuZC1wb3J0YWJpbGl0eQ==\">safeguarding your data</span> for further information.</p>\n<p>We use the data to provide and improve the service. By using the service, You agree to the collection and use of information in accordance with this Privacy Policy.</p>\n<h1 id=\"contact-us\"><a class=\"anchor\" href=\"#contact-us\">#</a> Contact Us</h1>\n<p>If you have any questions about this Privacy Policy, You can contact us:</p>\n<p>By email: <span class=\"exturl\" data-url=\"bWFpbHRvOmxpbXh0b3BAZ21haWwuY29t\">limxtop@gmail.com</span></p>\n",
            "tags": []
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/11/11/Google-Play-Store-In-App-Billing/",
            "url": "https://limxtop1989.github.io/limxtop/2023/11/11/Google-Play-Store-In-App-Billing/",
            "title": "Google Play Store In App Billing Issue",
            "date_published": "2023-11-11T12:22:52.000Z",
            "content_html": "<h1 id=\"found-null-or-empty-skudetails\"><a class=\"anchor\" href=\"#found-null-or-empty-skudetails\">#</a> Found null or empty SkuDetails.</h1>\n<blockquote>\n<p>TrivialDrive:BillingDataSource: onSkuDetailsResponse: Found null or empty SkuDetails. Check to see if the SKUs you requested are correctly published in the Google Play Console.</p>\n</blockquote>\n<p>Root cause: Some of following prerequisites are not satisfied.</p>\n<ol>\n<li>Upload the application to Closing Testing, no need to publish at this stage. (Internal Testing may be sufficient, but not verified).</li>\n<li>Create SKUs, note that the ID should match the ID of the application request.</li>\n<li>Add the tester's mailbox, which is the Google account login to the device to test the app SKU.</li>\n<li>Switch License Respond to LICENSED (Path: play console homepage -&gt; Setup -&gt; License testing).</li>\n</ol>\n<p>Notes:</p>\n<ul>\n<li>The Application ID for uploading Closing Testing needs to be the same as the Application ID for local debugging.</li>\n<li>Copy the link in the &quot;Testers&quot; tab, send it to testers to invite them join the test.</li>\n</ul>\n<h1 id=\"3-billing-unavailable\"><a class=\"anchor\" href=\"#3-billing-unavailable\">#</a> 3 Billing Unavailable</h1>\n<blockquote>\n<p>TrivialDrive:BillingDataSource: onSkuDetailsResponse: 3 Billing Unavailable</p>\n</blockquote>\n<p>Your &quot;Premium&quot; tab should show empty rather the paid applications list in your play store if you encounter this issue.<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2023/11/11/22c2efeaf37dabf6.jpeg\" style=\"zoom:25%;\" /><br />\nRoot cause: The current Play Store account of the test device does not support the Billing feature, for example, my reason is that the account is registered as China region.<br />\nSolution: Change it to US, and the address can use a US physical address, or fill in a random one.</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdXBwb3J0Lmdvb2dsZS5jb20vZ29vZ2xlcGxheS9hbnN3ZXIvNzQzMTY3NT9zamlkPTExMjAxNjA2MjQwMDQ4OTIwNTAwLUVV\">Change your Google Play country</span></p>\n<p><img data-src=\"https://storage.googleapis.com/support-kms-prod/nZJ8elMyFeFOLGEpXwigaB6zmHvq46xYOfd1\" alt=\"\" /></p>\n<ol>\n<li>On your Android device, open the Google Play Store app Google Play.</li>\n<li>At the top right, tap the profile icon.</li>\n<li>Tap Settings and then General and then Account and device preferences and then Country and profiles.</li>\n<li>Tap the country where you want to add an account.</li>\n<li>Follow the on-screen instructions to add a payment method for that country.<br />\nTips: Your profile can take up to 48 hours to update.</li>\n</ol>\n<h1 id=\"other-checkpoints-and-actions-to-try\"><a class=\"anchor\" href=\"#other-checkpoints-and-actions-to-try\">#</a> Other checkpoints and actions to try</h1>\n<ol>\n<li>Enable VPN and use American server.</li>\n<li>Register the test account in the settings and play store, remove other accounts.</li>\n<li>Clear the storage of &quot;Google Play services&quot; and &quot;Google Play Store&quot;.</li>\n</ol>\n",
            "tags": [
                "Essay",
                "Google Play Store, In App Billing, Found null or empty SkuDetails. Check to see if the SKUs you requested are correctly published in the Google Play Console, onSkuDetailsResponse 3 Billing Unavailable"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/11/08/how-to-learn-English/",
            "url": "https://limxtop1989.github.io/limxtop/2023/11/08/how-to-learn-English/",
            "title": "How to Learn English",
            "date_published": "2023-11-08T10:31:39.000Z",
            "content_html": "<h1 id=\"fundamentals-of-learning-english\"><a class=\"anchor\" href=\"#fundamentals-of-learning-english\">#</a> Fundamentals of Learning English</h1>\n<p>Mastering the English language involves adopting two fundamental approaches that work synergistically to enhance language proficiency.</p>\n<ol>\n<li>\n<p>Utilize an English-English Dictionary: Opt for an electronic English dictionary for convenience. When encountering an unfamiliar word, refer to this resource to access a plethora of explanations, contextual usage, and numerous examples. This tool provides comprehensive insights, facilitating a more profound understanding of the word.</p>\n</li>\n<li>\n<p>Consistent Practice in English: Immerse yourself in English consistently across all language domains—reading, writing, listening, speaking, and even thinking. Regular practice is paramount for language acquisition and retention.</p>\n</li>\n</ol>\n<h1 id=\"learning-english-through-translation-a-detrimental-approach\"><a class=\"anchor\" href=\"#learning-english-through-translation-a-detrimental-approach\">#</a> Learning English through Translation: A Detrimental Approach</h1>\n<p>Learning English by rote memorization of word translations is strongly discouraged. This method lacks the depth needed for a nuanced understanding of how words function within the context of communication. Language is an intricate network of interconnected words likewise a neural network forming meaningful phrases and sentences. To truly grasp English, one must learn how to seamlessly combine words to express ideas spontaneously. It is impractical to think and translate sentences directly from one's native language, such as Chinese, as the languages do not align perfectly word-for-word.</p>\n<h1 id=\"challenges-faced-by-adults-in-english-learning\"><a class=\"anchor\" href=\"#challenges-faced-by-adults-in-english-learning\">#</a> Challenges Faced by Adults in English Learning</h1>\n<p>While consistent practice is integral to language mastery, reading English articles, listening to English audios, writing essays in English, and engaging in English conversations are challenging for non-native adults. The struggle lies in the tendency to think and organize thoughts in one's native language rather than English. This challenge persists due to the lack of an English-speaking environment and the comfort of expressing oneself effortlessly in the native language. The difficulty arises when searching for the right English words, phrases, or sentences to articulate ideas, leading to frustration and a reluctance to think in English. However, effective language practice involves thinking in English and subsequently expressing thoughts through writing or speaking, demanding a concerted effort to bridge the gap between native and acquired language proficiency.</p>\n<h1 id=\"overcoming-challenges\"><a class=\"anchor\" href=\"#overcoming-challenges\">#</a> Overcoming Challenges</h1>\n<p>Don't be frustrated; there are two steps to overcome these challenges.</p>\n<ul>\n<li>\n<p>Practice Reading and Listening: Immerse yourself in English during your daily life, reading and listening as much as possible. This input-oriented approach feeds the language into your brain and can be done independently.</p>\n</li>\n<li>\n<p>Practice Writing and Speaking: These output-oriented activities follow training and are more challenging as they require you to think and combine words effectively. Start writing in English and engage in conversations once you've reached a new level during step 1.</p>\n</li>\n</ul>\n<h1 id=\"how-to-memorize-words-effectively\"><a class=\"anchor\" href=\"#how-to-memorize-words-effectively\">#</a> How to Memorize Words Effectively</h1>\n<p>To enhance your vocabulary retention, engage in repetition as a memorization technique and deepen your understanding by consulting English-English dictionaries, such as GoldenDict. Gradually reduce the frequency of review as your familiarity with the words increases.</p>\n<p>Additionally, I have developed an Android application called <span class=\"exturl\" data-url=\"aHR0cHM6Ly9iZXdhdGVycy5tZS9saW14dG9wLzIwMjMvMDUvMDcvd29yZC1jYXJkLXVzZXItbWFudWFsLw==\">&quot;Word Card&quot;</span> specifically designed to assist in memorizing English words. This app is scheduled for publication on the Play Store.</p>\n<h1 id=\"how-to-install-goldendict\"><a class=\"anchor\" href=\"#how-to-install-goldendict\">#</a> How to Install GoldenDict</h1>\n<p>Download GoldenDict software and the English relevant dictionaries from here:<br />\nlink: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMW9WNkF4UlVsWDFjN21wRTM1MmJ0OHc=\">https://pan.baidu.com/s/1oV6AxRUlX1c7mpE352bt8w</span> code: uxtw</p>\n<h2 id=\"windows-mac\"><a class=\"anchor\" href=\"#windows-mac\">#</a> Windows &amp; Mac</h2>\n<ol>\n<li>Download and install goldenDict for you computer system.</li>\n</ol>\n<ul>\n<li>Mac： GoldenDict-1.5.0-RC2-209-gfe9312e(Qt_563)</li>\n<li>Windows： GoldenDict-1.0.1-Portable</li>\n</ul>\n<ol start=\"2\">\n<li>Download the dictionary files and unzip them.</li>\n</ol>\n<ul>\n<li>En-En-Longman_Pronunciation3.zip</li>\n<li>En-En_OALD8.zip</li>\n<li>En-En_Merriam_Webster11</li>\n<li>En-zh_CN_OALD4</li>\n<li>En-En_Longman_DOCE5</li>\n</ul>\n<ol start=\"3\">\n<li>After the GoldenDict and the dictionaries have been prepared, go to settings of the dictionaries in GoldenDict as follows. (The path at Mac is: Edit -&gt; Dictionaries. I am not sure what it is at Window system, you should can find it by yourself). Add all unzip directories by clicking &quot;Add&quot; button and rescan them to create indexes.<br />\n<img data-src=\"https://s3.bmp.ovh/imgs/2021/08/305a1480dcfc9dbd.png\" alt=\"Add dictionaries to GoldenDict\" /><br />\nThere is a exception of the example sentences are hidden at Mac system as bellow.<br />\n<img data-src=\"https://s3.bmp.ovh/imgs/2021/08/bad36e68350614d4.png\" alt=\"\" /><br />\nTo resolve this problem, go to Preference and check &quot;Expand optional parts&quot; option in &quot;Advanced&quot; tab.<br />\n<img data-src=\"https://s3.bmp.ovh/imgs/2021/08/f3565b6d9c3abefc.png\" alt=\"\" /></li>\n</ol>\n<h2 id=\"android\"><a class=\"anchor\" href=\"#android\">#</a> Android</h2>\n",
            "tags": [
                "Essay",
                "How to Learn English, How to Learn a Foreign language, Golden Dict, English"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/09/15/generic-type/",
            "url": "https://limxtop1989.github.io/limxtop/2023/09/15/generic-type/",
            "title": "一文读懂Java范型",
            "date_published": "2023-09-15T13:00:07.000Z",
            "content_html": "<h1 id=\"terms\"><a class=\"anchor\" href=\"#terms\">#</a> Terms</h1>\n<table>\n<thead>\n<tr>\n<th>Term</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Parameterized type</td>\n<td>List&lt;String&gt;</td>\n</tr>\n<tr>\n<td>Actual type parameter</td>\n<td>String</td>\n</tr>\n<tr>\n<td>Generic type</td>\n<td>List&lt;E&gt;</td>\n</tr>\n<tr>\n<td>Formal type parameter</td>\n<td>E</td>\n</tr>\n<tr>\n<td>Unbonded wildcard type</td>\n<td>List&lt;?&gt;</td>\n</tr>\n<tr>\n<td>Raw type</td>\n<td>List</td>\n</tr>\n<tr>\n<td>Bounded type parameter</td>\n<td>&lt;E extends Number&gt;</td>\n</tr>\n<tr>\n<td>Recursive type bond</td>\n<td>&lt;T extends Comparable&lt;T&gt;&gt;</td>\n</tr>\n<tr>\n<td>Bounded widcard type</td>\n<td>List&lt;? extends Numbers&gt;</td>\n</tr>\n<tr>\n<td>Generic method</td>\n<td>static &lt;E&gt; List&lt;E&gt; asList(E[] a)</td>\n</tr>\n<tr>\n<td>Type token</td>\n<td>String.class</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"范型定义\"><a class=\"anchor\" href=\"#范型定义\">#</a> 范型定义</h1>\n<p>一个类或者接口，它的声明里，有 type parameter (T)，它就是范型类或者接口。</p>\n<p>假设我们要定义一个容器类，它可以存放任意类型的实力，我们先看<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlL3R1dG9yaWFsL2phdmEvZ2VuZXJpY3MvdHlwZXMuaHRtbA==\">非范型</span>的实现。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Box</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Object</span> object<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> object<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>object <span class=\"token operator\">=</span> object<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> object<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">Box</span> i <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Box</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        i<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token class-name\">String</span> s <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> i<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1. run time error.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这种实现有个缺陷，编译时无法验证 Box 存放的实例类型，编译正常通过，但在运行时，一部分代码使用 Box 存放 String， 理所当然地期望，取出来的也是 String，但如果有人意外地，在其他代码位置，放进一个 Integer，代码注释 1 处，便发生运行时异常。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Generic version of the Box class.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * @param &lt;T> the type of the value being boxed</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Box</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// T stands for \"Type\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">T</span> t<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>t <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">T</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> t<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token class-name\">Box</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> i <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Box</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1. generic type invocation.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        i<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2. compile error.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">String</span> s <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> i<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 3. run time error.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>范型优点：改造成范型类后，由于我们定义 Box 只能放 String 类型，注释 2 处编译不通过。错误的代码，在编译时被检测出来，而不是运行时。再者，运行时的错误，并非容易找到根源，导致错误的位置可能离发生错误的位置很远。</p>\n<h2 id=\"范型类调用-generic-type-invocation\"><a class=\"anchor\" href=\"#范型类调用-generic-type-invocation\">#</a> 范型类调用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlL3R1dG9yaWFsL2phdmEvZ2VuZXJpY3MvdHlwZXMuaHRtbA==\">generic type invocation</span></h2>\n<p>To reference the generic Box class from within your code, you must perform a generic type invocation, which replaces T with some concrete value, such as Integer:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Box</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> integerBox<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>You can think of a generic type invocation as being similar to an ordinary method invocation, but instead of passing an argument to a method, you are passing a type argument — Integer in this case — to the Box class itself.</p>\n<h2 id=\"范型方法\"><a class=\"anchor\" href=\"#范型方法\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlL3R1dG9yaWFsL2phdmEvZ2VuZXJpY3MvbWV0aG9kcy5odG1s\">范型方法</span></h2>\n<p>Generic methods are methods that introduce their own type parameters. This is similar to declaring a generic type, but the type parameter's scope is limited to the method where it is declared.</p>\n<p>The syntax for a generic method includes a list of type parameters, inside angle brackets, which appears before the method's return type. (public static <strong>&lt;K, V&gt;</strong> boolean compare)</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Util</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Pair</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> p1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Pair</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> p2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">return</span> p1<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>               p1<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>The complete syntax for invoking this method would be (Util. <strong>&lt;Integer, String&gt;</strong> compare(p1, p2)😉:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Pair</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> p1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Pair</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"apple\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Pair</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> p2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Pair</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pear\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">boolean</span> same <span class=\"token operator\">=</span> <span class=\"token class-name\">Util</span><span class=\"token punctuation\">.</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">,</span> p2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"范型与数组\"><a class=\"anchor\" href=\"#范型与数组\">#</a> 范型与数组</h1>\n<h2 id=\"范型和数组有重要的不同\"><a class=\"anchor\" href=\"#范型和数组有重要的不同\">#</a> 范型和数组有重要的不同</h2>\n<ol>\n<li>数组是协变，即如果 Sub 是 Super 的子类，那么 Sub [] 是 Super [] 的子类。相反，范型不是协变的，对于任意两个不同的类 Type1 &amp; Type2， List<Type1> 既不是 List<Type2> 的子类，也不是它的超类。 协变带来缺陷：</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Fails at runtime!</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> objectArray <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>objectArray<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"I don't fit in\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Throws ArrayStoreException</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// Won't compile!</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> ol <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Incompatible types.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ol<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"I don't fit in\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>数组是 reified， 意味着数组在运行时才知道和强制约束它的元素类型，但范型，与之相反，是通过范型擦除实现，意味着它在编译时强制类型约束，在运行时丢弃（擦除）范型信息。</li>\n</ol>\n<h2 id=\"范型数组\"><a class=\"anchor\" href=\"#范型数组\">#</a> 范型数组</h2>\n<p>由于以上的区别，创建范型数组是非法的。 new List<E>(), new List<String>[], new E [], 在编译时会报错。</p>\n<blockquote>\n<p>It is illegal to create an array of a generic type, a parameterized type, or a type parameter. <sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup></p>\n</blockquote>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Why generic array creation is illegal - won't compile!</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> stringLists <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">// 1. 假设 Line1 我们可以创建范型数组</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> intList <span class=\"token operator\">=</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 2.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> objects <span class=\"token operator\">=</span> stringLists<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 3. 合法，数组是协变的</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>objects<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> intList<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 4. 合法，运行时范型已经被擦除，List&lt;Integer> 成为 List，List&lt;String>[] 成为 List []，没有 ArrayStoreException</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">String</span> s <span class=\"token operator\">=</span> stringLists<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//  5. ClassCastException at runtime.</span></pre></td></tr></table></figure><h2 id=\"liste-优于-e\"><a class=\"anchor\" href=\"#liste-优于-e\">#</a> List<E> 优于 E []</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">E</span> <span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> list<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> f<span class=\"token punctuation\">,</span> <span class=\"token class-name\">E</span> initVal<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// compiler can't check the safety of the cast at runtime because it doesn't know what E is at runtime.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">E</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> snapshot <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">)</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">E</span> result <span class=\"token operator\">=</span> intVal<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">E</span> e <span class=\"token operator\">:</span> snapShot<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        result <span class=\"token operator\">=</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">E</span> <span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> list<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> f<span class=\"token punctuation\">,</span> <span class=\"token class-name\">E</span> initVal<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> snapshot<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        snapshot <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">E</span> result <span class=\"token operator\">=</span> intVal<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">E</span> e <span class=\"token operator\">:</span> snapShot<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        result <span class=\"token operator\">=</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"范型擦除-type-erasure\"><a class=\"anchor\" href=\"#范型擦除-type-erasure\">#</a> 范型擦除 Type Erasure</h2>\n<p>Generics were introduced to the Java language to provide tighter type checks at compile time and to support generic programming. To implement generics, the Java compiler applies type erasure to:</p>\n<ol>\n<li>Replace all type parameters in generic types with their bounds or Object if the type parameters are unbounded. The produced bytecode, therefore, contains only ordinary classes, interfaces, and methods.</li>\n<li>Insert type casts if necessary to preserve type safety.</li>\n<li>Generate bridge methods to preserve polymorphism in extended generic types.<br />\nType erasure ensures that no new classes are created for parameterized types; consequently, generics incur no runtime overhead.</li>\n</ol>\n<h3 id=\"erasure-of-generic-types\"><a class=\"anchor\" href=\"#erasure-of-generic-types\">#</a> Erasure of Generic Types</h3>\n<p>During the type erasure process, the Java compiler erases all type parameters and replaces each with its first bound if the type parameter is bounded, or Object if the type parameter is unbounded.</p>\n<p>Consider the following generic class that represents a node in a singly linked list:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">T</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> data<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">T</span> <span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Because the type parameter T is unbounded, the Java compiler replaces it with Object:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Object</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Node</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> data<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Node</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>In the following example, the generic Node class uses a bounded type parameter:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Comparable</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">T</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> data<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">T</span> <span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>The Java compiler replaces the bounded type parameter T with the first bound class, Comparable:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Comparable</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Node</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Comparable</span> data<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Node</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Comparable</span> <span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"extends-generic-type\"><a class=\"anchor\" href=\"#extends-generic-type\">#</a> Extends generic type</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNzcxMTcyNzYvaG93LXRvLWV4cGxhaW4tdGhlLXR5cGUtb2YtcmV0dXJuLXZhbHVlLWFuZC1wYXJhbWV0ZXItZGVmaW5pdGlvbi1hdC1zdWItY2xhc3MtaW4=\">override &amp; generic</span></p>\n<h3 id=\"effects-of-type-erasure-and-bridge-methods\"><a class=\"anchor\" href=\"#effects-of-type-erasure-and-bridge-methods\">#</a> Effects of Type Erasure and Bridge Methods</h3>\n<p>Sometimes type erasure causes a situation that you may not have anticipated. The following example shows how this can occur. The following example shows how a compiler sometimes creates a synthetic method, which is called a bridge method, as part of the type erasure process.</p>\n<p>Given the following two classes:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">T</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Node.setData\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyNode</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MyNode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MyNode.setData\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Consider the following code:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">MyNode</span> mn <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyNode</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Node</span> n <span class=\"token operator\">=</span> mn<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// A raw type - compiler throws an unchecked warning</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>n<span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// Causes a ClassCastException to be thrown.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">Integer</span> x <span class=\"token operator\">=</span> mn<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>After type erasure, this code becomes:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">MyNode</span> mn <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyNode</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Node</span> n <span class=\"token operator\">=</span> mn<span class=\"token punctuation\">;</span>            <span class=\"token comment\">// A raw type - compiler throws an unchecked warning</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                        <span class=\"token comment\">// Note: This statement could instead be the following:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                        <span class=\"token comment\">//     Node n = (Node)mn;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                        <span class=\"token comment\">// However, the compiler doesn't generate a cast because</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                        <span class=\"token comment\">// it isn't required.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>n<span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// Causes a ClassCastException to be thrown.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token class-name\">Integer</span> x <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">)</span>mn<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>The next section explains why a ClassCastException is thrown at the n.setData(&quot;Hello&quot;); statement.</p>\n<p>Bridge Methods<br />\nWhen compiling a class or interface that extends a parameterized class or implements a parameterized interface, the compiler may need to create a synthetic method, which is called a bridge method, as part of the type erasure process. You normally don't need to worry about bridge methods, but you might be puzzled if one appears in a stack trace.</p>\n<p>After type erasure, the Node and MyNode classes become:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Node.setData\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyNode</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MyNode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MyNode.setData\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>After type erasure, the method signatures do not match; the Node.setData(T) method becomes Node.setData(Object). As a result, the MyNode.setData(Integer) method does not override the Node.setData(Object) method.</p>\n<p>To solve this problem and preserve the polymorphism of generic types after type erasure, the Java compiler generates a bridge method to ensure that subtyping works as expected.</p>\n<p>For the MyNode class, the compiler generates the following bridge method for setData:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyNode</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// Bridge method generated by the compiler</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">)</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MyNode.setData\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>The bridge method MyNode.setData(object) delegates to the original MyNode.setData(Integer) method. As a result, the n.setData(&quot;Hello&quot;); statement calls the method MyNode.setData(Object), and a ClassCastException is thrown because &quot;Hello&quot; can't be cast to Integer.</p>\n<h1 id=\"bounded-type-parameters\"><a class=\"anchor\" href=\"#bounded-type-parameters\">#</a> Bounded Type Parameters</h1>\n<p>There may be times when you want to restrict the types that can be used as type arguments in a parameterized type. For example, a method that operates on numbers might only want to accept instances of Number or its subclasses. This is what <strong>bounded</strong> type parameters are for.</p>\n<p>To declare a bounded type parameter, list the type parameter's name, followed by the extends keyword, followed by its upper bound, which in this example is Number. Note that, in this context, extends is used in a general sense to mean either &quot;extends&quot; (as in classes) or &quot;implements&quot; (as in interfaces).</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Box</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">T</span> t<span class=\"token punctuation\">;</span>          </pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>t <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">T</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">return</span> t<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">U</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Number</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">void</span> <span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">U</span> u<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"T: \"</span> <span class=\"token operator\">+</span> t<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"U: \"</span> <span class=\"token operator\">+</span> u<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token class-name\">Box</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> integerBox <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Box</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        integerBox<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        integerBox<span class=\"token punctuation\">.</span><span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some text\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// error: this is still String!</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>By modifying our generic method to include this bounded type parameter, compilation will now fail, since our invocation of inspect still includes a String:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Box</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">21</span><span class=\"token operator\">:</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">U</span><span class=\"token punctuation\">></span></span><span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">U</span><span class=\"token punctuation\">)</span> in <span class=\"token class-name\">Box</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>Integer</span><span class=\"token punctuation\">></span></span> cannot</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  be applied <span class=\"token keyword\">to</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>String</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                        integerBox<span class=\"token punctuation\">.</span><span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"10\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                  <span class=\"token operator\">^</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">1</span> error</pre></td></tr></table></figure><p>In addition to limiting the types you can use to instantiate a generic type, <strong>bounded type parameters allow you to invoke methods defined in the bounds</strong> :</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Comparable</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">int</span> <span class=\"token function\">countGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> anArray<span class=\"token punctuation\">,</span> <span class=\"token class-name\">T</span> elem<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> e <span class=\"token operator\">:</span> anArray<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token operator\">++</span>count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>The countGreaterThan method invokes the compareTo method defined in the Comparable class through e.</p>\n<h1 id=\"bounded-wildcards\"><a class=\"anchor\" href=\"#bounded-wildcards\">#</a> Bounded wildcards</h1>\n<p>由于 parameterized types 不支持 协变 (invariant), 就是说，对于任意两个不同的类 Type1 &amp; Type2， List<Type1> 既不是 List<Type2> 的子类，也不是它的超类。  List<String> 不是 List<Object> 的子类，初看起来有点反直觉，但它确实有意义，我们可以放任意 object 到 List<Object>， 但我们只能放 string 到 List<String>. 但这样非协变的类型没有伸缩性 (flexibility)。 如下展开解释：</p>\n<h2 id=\"upper-bounded-wildcards\"><a class=\"anchor\" href=\"#upper-bounded-wildcards\">#</a> Upper Bounded Wildcards</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Stack</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Stack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">E</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">E</span> <span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>假设我们要增加一个方法，它输入一个可迭代序列，然后 push 他们到这个 Stack， 以下第一次尝试的代码：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// pushAll method without wildcard type -- works but is deficient!</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">pushAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Iterable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> src<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">E</span> e <span class=\"token operator\">:</span> src<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这代码能工作，但并不能满意。如果 src 的元素类型和 Stack 的完全匹配，它运行没问题。但假设我们有一个 Stack<Number> ， 然后调用 push (intVal), intVal 是一个 Integer 类型。这完全没问题，因为 Integer 是 Number 的子类，因此，逻辑上，以下代码也应该没问题：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Stack</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Number</span><span class=\"token punctuation\">></span></span> numberStack <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Stack</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Number</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Iterable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> integers <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>numberStack<span class=\"token punctuation\">.</span><span class=\"token function\">pushAll</span><span class=\"token punctuation\">(</span>integers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>但实际上，它编译时报错，因为 Iterable<Integer> 并非 Iterable<Number> 的子类，intergers 不能传参给 src。幸好，Java 提供 有边界通配符类型 (bounded wildcard type) 来解决这个场景。 pushAll <strong>的入参类型不应该是 &quot;Iterable of E&quot;, 由 Iterable<E>表示，而应该是 &quot;Iterable of some subtype of E&quot;，由 Iterable&lt;? extends E&gt;</strong> 表示。如下改写 Stack pushAll 方法声明后，上方的客户端代码就可以编译通过了，因为 Iterable<Integer> 是 Iterable&lt;? extends Number&gt; 的子类</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Wildcard type for marameter that serves as an E producer</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">pushAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Iterable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> src<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">E</span> e<span class=\"token operator\">:</span> src<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"lower-bounded-wildcards\"><a class=\"anchor\" href=\"#lower-bounded-wildcards\">#</a> Lower Bounded Wildcards</h2>\n<p>假设我们现在需要实现一个 popAll 的方法，和 pushAll 配套，这个方法 pop stack 里面的元素，并逐一加到给定集合参数，看下第一次尝试的代码：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// popAll method without wildcard type - deficient</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">popAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> dst<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        dst<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>假设我们有一个 Stack<Number> 和一个 Object 类型的变量，如果我们 pop 一个元素并把它存放在该变量，这完全没问题。所以，如下代码也应该没问题的，对么？</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Stack</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Number</span><span class=\"token punctuation\">></span></span> numberStack <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Stack</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Number</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> objects <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>numberStack<span class=\"token punctuation\">.</span><span class=\"token function\">popAll</span><span class=\"token punctuation\">(</span>objects<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>但很遗憾，这个代码编译不通过，因为 Collection<Object> 不是 Collection<Number> 的子类。 下边界通配符类型提供了解决方案， <strong>入参不应该是 &quot;Collection of E&quot; ，由 Collection<E>表示，而应该是 &quot;collection of some supertype of E&quot; ， 由 Collection&lt;? super E&gt;</strong> 表示。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Wildcard type for parameter that serves as an E consumer</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">popAll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> dst<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        dst<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>由上，教训是很清晰的，为了 API 最大伸缩性，在代表生产者和消费者的入参使用通配符类型。助记口诀：</p>\n<blockquote>\n<p>PECS strands for producer-extends, consumer-super</p>\n</blockquote>\n<p>The  <code>reduce</code>  method use  <code>list</code>  parameter as an  <code>E</code>  producer, so its declaration should use a wildcard type that extends  <code>E</code> . whereas, The parameter  <code>f</code>  represents a function that both consumes and produces  <code>E</code>  instances, so a wildcard type would be inappropriate for it.</p>\n<h2 id=\"重构reduce\"><a class=\"anchor\" href=\"#重构reduce\">#</a> 重构 Reduce</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">E</span> <span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> list<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> f<span class=\"token punctuation\">,</span> <span class=\"token class-name\">E</span> intVal<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>Would this change make any difference in practice? As it turns out, it wold. Suppose you have a  <code>List&lt;Integer&gt;</code> , and you want to reduce it with a  <code>Function&lt;Number&gt;</code> . This would not compile with the original declarationo previously, but it does once you add the bounded wildcard type.</p>\n<h2 id=\"recursive-type-bound\"><a class=\"anchor\" href=\"#recursive-type-bound\">#</a> Recursive type bound</h2>\n<p>Recursive type bound definition: A type parameter to be bounded by some expression involving that type parameter itself.</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Comparable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">int</span> <span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Comparable</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">T</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> i <span class=\"token operator\">=</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token class-name\">T</span> result <span class=\"token operator\">=</span> i<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token class-name\">T</span> t <span class=\"token operator\">=</span> i<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            result <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>The type bound  <code>&lt;T extends Comparable&lt;T&gt;&gt;</code>  may be read as &quot;for every type T that can be compared to itself&quot;.</p>\n<p>但我们不能调用  <code>max(List&lt;ScheduledFuture&lt;?&gt;&gt; scheduledFutures)</code> ，原因在于，ScheduledFuture 并不实现  <code>Comparable&lt;ScheduledFuture&gt;</code>  接口，相反，它不过是  <code>Delayed</code>  子接口，它继承的是  <code>Comparable&lt;Delayed&gt;</code> ，换句话说，  <code>ScheduledFuture</code>  实例并不仅仅和其他  <code>ScheduledFuture</code>  实例比较，它还可以和任意的  <code>Delayed</code>  实例进行比较。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ScheduledFuture</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Delayed</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Delayed</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Comparable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Delayed</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Comparable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">int</span> <span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Comparable</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">T</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> i <span class=\"token operator\">=</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token class-name\">T</span> result <span class=\"token operator\">=</span> i<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">T</span> t <span class=\"token operator\">=</span> i<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            result <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><blockquote>\n<p>You should always use Comparable&lt;? super T&gt; in preference to Comparable<T>. The same is true of comparators.</p>\n</blockquote>\n<h2 id=\"unbounded-wildcards\"><a class=\"anchor\" href=\"#unbounded-wildcards\">#</a> Unbounded Wildcards</h2>\n<p>The unbounded wildcard type is specified using the wildcard character (?), for example, List&lt;?&gt;. This is called a list of unknown type. There are two scenarios where an unbounded wildcard is a useful approach:</p>\n<ol>\n<li>If you are writing a method that can be implemented using functionality provided in the Object class.</li>\n<li>When the code is using methods in the generic class that don't depend on the type parameter. For example, List.size or List.clear. In fact, Class&lt;?&gt; is so often used because most of the methods in Class<T> do not depend on T.<br />\nConsider the following method, printList:</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> elem <span class=\"token operator\">:</span> list<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>elem <span class=\"token operator\">+</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>The goal of printList is to print a list of any type, but it fails to achieve that goal — it prints only a list of Object instances; it cannot print List<Integer>, List<String>, List<Double>, and so on, because they are not subtypes of List<Object>. To write a generic printList method, use List&lt;?&gt;:<br />\n 到这里，其实可以理解 List&lt;?&gt; 是 List&lt;? extends Object&gt; 的简写</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> elem<span class=\"token operator\">:</span> list<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>elem <span class=\"token operator\">+</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Because for any concrete type A, List<A> is a subtype of List&lt;?&gt;, you can use printList to print a list of any type:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> li <span class=\"token operator\">=</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span>  ls <span class=\"token operator\">=</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"one\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"two\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"three\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">printList</span><span class=\"token punctuation\">(</span>li<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">printList</span><span class=\"token punctuation\">(</span>ls<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>It's important to note that  <code>List&lt;Object&gt;</code>  and  <code>List&lt;?&gt;</code>  are not the same. You can insert an Object, or any subtype of Object, into a  <code>List&lt;Object&gt;</code> . But you can only insert null into a List<?>. (Because the type of element in the List<?> is not certain, the compiler can't check the inserting operation is type safe or not, unless you insert null value) The Guidelines for Wildcard Use section has more information on how to determine what kind of wildcard, if any, should be used in a given situation.</p>\n<h2 id=\"wildcards-and-subtyping\"><a class=\"anchor\" href=\"#wildcards-and-subtyping\">#</a> Wildcards and Subtyping</h2>\n<p>如果 Sub 是 Super 的子类，那么</p>\n<ol>\n<li>范型不支持协变  <code>List&lt;Sub&gt;</code>  &amp;  <code>List&lt;Super&gt;</code>  没有关系；</li>\n<li><code>List&lt;Sub&gt;</code>  是 List&lt;? extends Super&gt; 的子类；</li>\n<li><code>List&lt;Super&gt;</code>  是 List&lt;? super Sub&gt; 的子类；</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>Invariant</th>\n<th>Wildcard</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><img data-src=\"https://docs.oracle.com/javase/tutorial/figures/java/generics-subtypeRelationship.gif\" alt=\"\" /></td>\n<td><img data-src=\"https://docs.oracle.com/javase/tutorial/figures/java/generics-wildcardSubtyping.gif\" alt=\"\" /></td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"key-points\"><a class=\"anchor\" href=\"#key-points\">#</a> Key points</h1>\n<ol>\n<li>Don't use a wildcard as a return type, because it forces programmers to use wildcard types in client codes.</li>\n<li>If a input parameter is both producer and consumer, define it as exact type match, rather than wildcard types.</li>\n</ol>\n<hr class=\"footnotes-sep\" />\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p>Effect Java Item 25 <a href=\"#fnref1\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n</ol>\n</section>\n",
            "tags": [
                "Java",
                "范型"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/08/06/AndroidX-migrate/",
            "url": "https://limxtop1989.github.io/limxtop/2023/08/06/AndroidX-migrate/",
            "title": "穿山甲集成报错",
            "date_published": "2023-08-06T15:10:48.000Z",
            "content_html": "<h1 id=\"异常描述\"><a class=\"anchor\" href=\"#异常描述\">#</a> 异常描述</h1>\n<p>引入穿山甲 SDK 后，编译运行时异常，堆栈如下</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">2023</span><span class=\"token operator\">-</span><span class=\"token number\">08</span><span class=\"token operator\">-</span><span class=\"token number\">06</span> <span class=\"token number\">23</span><span class=\"token operator\">:</span><span class=\"token number\">08</span><span class=\"token operator\">:</span><span class=\"token number\">51.659</span> <span class=\"token number\">32243</span><span class=\"token operator\">-</span><span class=\"token number\">32243</span><span class=\"token operator\">/</span>com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>wordcard<span class=\"token punctuation\">.</span>debug <span class=\"token class-name\">E</span><span class=\"token operator\">/</span><span class=\"token class-name\">AndroidRuntime</span><span class=\"token operator\">:</span> FATAL EXCEPTION<span class=\"token operator\">:</span> main</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">Process</span><span class=\"token operator\">:</span> com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>wordcard<span class=\"token punctuation\">.</span>debug<span class=\"token punctuation\">,</span> PID<span class=\"token operator\">:</span> <span class=\"token number\">32243</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>RuntimeException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Unable</span> <span class=\"token keyword\">to</span> <span class=\"token namespace\">get</span> provider <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>bytedance<span class=\"token punctuation\">.</span>sdk<span class=\"token punctuation\">.</span>openadsdk<span class=\"token punctuation\">.</span></span>TTFileProvider</span><span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassNotFoundException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Didn</span>'t find <span class=\"token keyword\">class</span> <span class=\"token string\">\"com.bytedance.sdk.openadsdk.TTFileProvider\"</span> on path<span class=\"token operator\">:</span> <span class=\"token class-name\">DexPathList</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>zip file <span class=\"token string\">\"/data/app/~~8aOWO0BH2NR-PT5SN6_9Sw==/com.maxim.wordcard.debug-z4MN-3uI1JjNQYgIxbhNYQ==/base.apk\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>nativeLibraryDirectories<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>app<span class=\"token operator\">/</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token number\">8</span>aOWO0BH2NR<span class=\"token operator\">-</span><span class=\"token class-name\">PT5SN6_9Sw</span><span class=\"token operator\">==</span><span class=\"token operator\">/</span>com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>wordcard<span class=\"token punctuation\">.</span>debug<span class=\"token operator\">-</span>z4MN<span class=\"token operator\">-</span><span class=\"token number\">3</span>uI1JjNQYgIxbhNYQ<span class=\"token operator\">==</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>arm64<span class=\"token punctuation\">,</span> <span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>app<span class=\"token operator\">/</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token number\">8</span>aOWO0BH2NR<span class=\"token operator\">-</span><span class=\"token class-name\">PT5SN6_9Sw</span><span class=\"token operator\">==</span><span class=\"token operator\">/</span>com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>wordcard<span class=\"token punctuation\">.</span>debug<span class=\"token operator\">-</span>z4MN<span class=\"token operator\">-</span><span class=\"token number\">3</span>uI1JjNQYgIxbhNYQ<span class=\"token operator\">==</span><span class=\"token operator\">/</span>base<span class=\"token punctuation\">.</span>apk<span class=\"token operator\">!</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>arm64<span class=\"token operator\">-</span>v8a<span class=\"token punctuation\">,</span> <span class=\"token operator\">/</span>system<span class=\"token operator\">/</span>lib64<span class=\"token punctuation\">,</span> <span class=\"token operator\">/</span>system_ext<span class=\"token operator\">/</span>lib64<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span><span class=\"token punctuation\">.</span><span class=\"token function\">installProvider</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">7479</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span><span class=\"token punctuation\">.</span><span class=\"token function\">installContentProviders</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">6985</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleBindApplication</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">6756</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span><span class=\"token punctuation\">.</span>-$$<span class=\"token class-name\">Nest</span>$<span class=\"token function\">mhandleBindApplication</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Unknown</span> <span class=\"token class-name\">Source</span><span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span>$<span class=\"token class-name\">H</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">2129</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>Handler</span><span class=\"token punctuation\">.</span><span class=\"token function\">dispatchMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Handler</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">106</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">loopOnce</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">201</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">288</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span><span class=\"token punctuation\">.</span><span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">7884</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span>Method</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Native</span> <span class=\"token class-name\">Method</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>RuntimeInit</span>$<span class=\"token class-name\">MethodAndArgsCaller</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RuntimeInit</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">548</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>ZygoteInit</span><span class=\"token punctuation\">.</span><span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ZygoteInit</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">936</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>     <span class=\"token class-name\">Caused</span> by<span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassNotFoundException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Didn</span>'t find <span class=\"token keyword\">class</span> <span class=\"token string\">\"com.bytedance.sdk.openadsdk.TTFileProvider\"</span> on path<span class=\"token operator\">:</span> <span class=\"token class-name\">DexPathList</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>zip file <span class=\"token string\">\"/data/app/~~8aOWO0BH2NR-PT5SN6_9Sw==/com.maxim.wordcard.debug-z4MN-3uI1JjNQYgIxbhNYQ==/base.apk\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>nativeLibraryDirectories<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>app<span class=\"token operator\">/</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token number\">8</span>aOWO0BH2NR<span class=\"token operator\">-</span><span class=\"token class-name\">PT5SN6_9Sw</span><span class=\"token operator\">==</span><span class=\"token operator\">/</span>com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>wordcard<span class=\"token punctuation\">.</span>debug<span class=\"token operator\">-</span>z4MN<span class=\"token operator\">-</span><span class=\"token number\">3</span>uI1JjNQYgIxbhNYQ<span class=\"token operator\">==</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>arm64<span class=\"token punctuation\">,</span> <span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>app<span class=\"token operator\">/</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token number\">8</span>aOWO0BH2NR<span class=\"token operator\">-</span><span class=\"token class-name\">PT5SN6_9Sw</span><span class=\"token operator\">==</span><span class=\"token operator\">/</span>com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>wordcard<span class=\"token punctuation\">.</span>debug<span class=\"token operator\">-</span>z4MN<span class=\"token operator\">-</span><span class=\"token number\">3</span>uI1JjNQYgIxbhNYQ<span class=\"token operator\">==</span><span class=\"token operator\">/</span>base<span class=\"token punctuation\">.</span>apk<span class=\"token operator\">!</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>arm64<span class=\"token operator\">-</span>v8a<span class=\"token punctuation\">,</span> <span class=\"token operator\">/</span>system<span class=\"token operator\">/</span>lib64<span class=\"token punctuation\">,</span> <span class=\"token operator\">/</span>system_ext<span class=\"token operator\">/</span>lib64<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">dalvik<span class=\"token punctuation\">.</span>system<span class=\"token punctuation\">.</span></span>BaseDexClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">findClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BaseDexClassLoader</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">259</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassLoader</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">379</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassLoader</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">312</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>AppComponentFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">instantiateProvider</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AppComponentFactory</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">147</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>CoreComponentFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">instantiateProvider</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CoreComponentFactory</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">67</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span><span class=\"token punctuation\">.</span><span class=\"token function\">installProvider</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">7463</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span><span class=\"token punctuation\">.</span><span class=\"token function\">installContentProviders</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">6985</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleBindApplication</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">6756</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span><span class=\"token punctuation\">.</span>-$$<span class=\"token class-name\">Nest</span>$<span class=\"token function\">mhandleBindApplication</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Unknown</span> <span class=\"token class-name\">Source</span><span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span>$<span class=\"token class-name\">H</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">2129</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>Handler</span><span class=\"token punctuation\">.</span><span class=\"token function\">dispatchMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Handler</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">106</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">loopOnce</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">201</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">288</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span></span>ActivityThread</span><span class=\"token punctuation\">.</span><span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">7884</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span>Method</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Native</span> <span class=\"token class-name\">Method</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>RuntimeInit</span>$<span class=\"token class-name\">MethodAndArgsCaller</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RuntimeInit</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">548</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>ZygoteInit</span><span class=\"token punctuation\">.</span><span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ZygoteInit</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">936</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    \t<span class=\"token class-name\">Suppressed</span><span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>NoClassDefFoundError</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Failed</span> resolution of<span class=\"token operator\">:</span> <span class=\"token class-name\">Landroid</span><span class=\"token operator\">/</span>support<span class=\"token operator\">/</span>v4<span class=\"token operator\">/</span>content<span class=\"token operator\">/</span><span class=\"token class-name\">FileProvider</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>VMClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">findLoadedClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Native</span> <span class=\"token class-name\">Method</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">findLoadedClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassLoader</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">738</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassLoader</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">363</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        \t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token number\">15</span> more</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>     <span class=\"token class-name\">Caused</span> by<span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassNotFoundException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Didn</span>'t find <span class=\"token keyword\">class</span> <span class=\"token string\">\"android.support.v4.content.FileProvider\"</span> on path<span class=\"token operator\">:</span> <span class=\"token class-name\">DexPathList</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>zip file <span class=\"token string\">\"/data/app/~~8aOWO0BH2NR-PT5SN6_9Sw==/com.maxim.wordcard.debug-z4MN-3uI1JjNQYgIxbhNYQ==/base.apk\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>nativeLibraryDirectories<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>app<span class=\"token operator\">/</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token number\">8</span>aOWO0BH2NR<span class=\"token operator\">-</span><span class=\"token class-name\">PT5SN6_9Sw</span><span class=\"token operator\">==</span><span class=\"token operator\">/</span>com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>wordcard<span class=\"token punctuation\">.</span>debug<span class=\"token operator\">-</span>z4MN<span class=\"token operator\">-</span><span class=\"token number\">3</span>uI1JjNQYgIxbhNYQ<span class=\"token operator\">==</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>arm64<span class=\"token punctuation\">,</span> <span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>app<span class=\"token operator\">/</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token number\">8</span>aOWO0BH2NR<span class=\"token operator\">-</span><span class=\"token class-name\">PT5SN6_9Sw</span><span class=\"token operator\">==</span><span class=\"token operator\">/</span>com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>wordcard<span class=\"token punctuation\">.</span>debug<span class=\"token operator\">-</span>z4MN<span class=\"token operator\">-</span><span class=\"token number\">3</span>uI1JjNQYgIxbhNYQ<span class=\"token operator\">==</span><span class=\"token operator\">/</span>base<span class=\"token punctuation\">.</span>apk<span class=\"token operator\">!</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>arm64<span class=\"token operator\">-</span>v8a<span class=\"token punctuation\">,</span> <span class=\"token operator\">/</span>system<span class=\"token operator\">/</span>lib64<span class=\"token punctuation\">,</span> <span class=\"token operator\">/</span>system_ext<span class=\"token operator\">/</span>lib64<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">dalvik<span class=\"token punctuation\">.</span>system<span class=\"token punctuation\">.</span></span>BaseDexClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">findClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BaseDexClassLoader</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">259</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassLoader</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">379</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        at <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassLoader</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">312</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>app 目录下的 build.gradle 配置如下：</p>\n<pre><code class=\"language-gradle\">dependencies &#123;\n\n    implementation fileTree(dir: 'libs', include: ['*.jar'])\n    // Ad begin\n    implementation 'com.pangle.cn:ads-sdk-pro:5.4.1.6'\n    // Ad end\n    implementation 'com.github.PhilJay:MPAndroidChart:v3.1.0'\n\n    implementation  'com.umeng.umsdk:common:9.4.7'// required\n    implementation  'com.umeng.umsdk:asms:1.4.0'// required\n    implementation 'com.umeng.umsdk:apm:1.7.0' // crash and performance\n    implementation  'com.umeng.umsdk:abtest:1.0.0'// optional\n\n    implementation 'com.github.deano2390:MaterialShowcaseView:1.3.7'\n    // Navigation start\n    def nav_version = &quot;2.5.3&quot;\n    // Kotlin\n    implementation (&quot;androidx.navigation:navigation-fragment-ktx:$nav_version&quot;)\n    implementation (&quot;androidx.navigation:navigation-ui-ktx:$nav_version&quot;)\n    // Feature module Support\n    implementation &quot;androidx.navigation:navigation-dynamic-features-fragment:$nav_version&quot;\n    // Navigation end\n\n    implementation 'androidx.core:core-ktx:1.7.0'\n    implementation 'androidx.appcompat:appcompat:1.6.0'\n    implementation 'com.google.android.material:material:1.8.0'\n    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'\n    implementation 'androidx.lifecycle:lifecycle-livedata-ktx:2.5.1'\n    implementation 'androidx.lifecycle:lifecycle-viewmodel-ktx:2.5.1'\n    implementation &quot;androidx.activity:activity-ktx:1.7.1&quot;\n    implementation &quot;androidx.fragment:fragment-ktx:1.5.7&quot;\n\n    api &quot;io.reactivex.rxjava2:rxandroid:2.1.0&quot;\n    implementation 'androidx.lifecycle:lifecycle-livedata-core-ktx:2.5.1'\n    implementation 'androidx.legacy:legacy-support-v4:1.0.0'\n    // room start\n    def room_version = &quot;2.5.1&quot;\n    implementation(&quot;androidx.room:room-runtime:$room_version&quot;)\n    annotationProcessor(&quot;androidx.room:room-compiler:$room_version&quot;)\n    // To use Kotlin annotation processing tool (kapt)\n    kapt(&quot;androidx.room:room-compiler:$room_version&quot;)\n    // To use Kotlin Symbol Processing (KSP)\n//    ksp(&quot;androidx.room:room-compiler:$room_version&quot;)\n    // optional - Kotlin Extensions and Coroutines support for Room\n    implementation(&quot;androidx.room:room-ktx:$room_version&quot;)\n    // optional - RxJava2 support for Room\n    implementation(&quot;androidx.room:room-rxjava2:$room_version&quot;)\n    // optional - RxJava3 support for Room\n    implementation(&quot;androidx.room:room-rxjava3:$room_version&quot;)\n    // optional - Guava support for Room, including Optional and ListenableFuture\n    implementation(&quot;androidx.room:room-guava:$room_version&quot;)\n    // optional - Test helpers\n    testImplementation(&quot;androidx.room:room-testing:$room_version&quot;)\n    // optional - Paging 3 Integration\n    implementation(&quot;androidx.room:room-paging:$room_version&quot;)\n    // room end\n\n    testImplementation 'junit:junit:4.13.2'\n    androidTestImplementation 'androidx.test.ext:junit:1.1.5'\n    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'\n&#125;\n</code></pre>\n<h1 id=\"异常分析\"><a class=\"anchor\" href=\"#异常分析\">#</a> 异常分析</h1>\n<p>打开  <code>TTFileProvider</code> ， 它继承的是  <code>android.support.v4.content.FileProvider</code></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>bytedance<span class=\"token punctuation\">.</span>sdk<span class=\"token punctuation\">.</span>openadsdk</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">android<span class=\"token punctuation\">.</span>support<span class=\"token punctuation\">.</span>v4<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">FileProvider</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TTFileProvider</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">FileProvider</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">TTFileProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>如果添加包含  <code>android.support.v4.content.FileProvider</code>  的依赖， <code>implementation 'com.android.support:support-v4:26.1.0'</code>  则编译报出好几个类重复定义的异常。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Duplicate</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>support<span class=\"token punctuation\">.</span>v4<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>ResultReceiver</span> found in modules core<span class=\"token operator\">-</span><span class=\"token number\">1.9</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span>runtime <span class=\"token punctuation\">(</span>androidx<span class=\"token punctuation\">.</span>core<span class=\"token operator\">:</span>core<span class=\"token operator\">:</span><span class=\"token number\">1.9</span><span class=\"token number\">.0</span><span class=\"token punctuation\">)</span> and support<span class=\"token operator\">-</span>compat<span class=\"token operator\">-</span><span class=\"token number\">26.1</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span>runtime <span class=\"token punctuation\">(</span>com<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>support<span class=\"token operator\">:</span>support<span class=\"token operator\">-</span>compat<span class=\"token operator\">:</span><span class=\"token number\">26.1</span><span class=\"token number\">.0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Duplicate</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>support<span class=\"token punctuation\">.</span>v4<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>ResultReceiver</span>$<span class=\"token number\">1</span> found in modules core<span class=\"token operator\">-</span><span class=\"token number\">1.9</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span>runtime <span class=\"token punctuation\">(</span>androidx<span class=\"token punctuation\">.</span>core<span class=\"token operator\">:</span>core<span class=\"token operator\">:</span><span class=\"token number\">1.9</span><span class=\"token number\">.0</span><span class=\"token punctuation\">)</span> and support<span class=\"token operator\">-</span>compat<span class=\"token operator\">-</span><span class=\"token number\">26.1</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span>runtime <span class=\"token punctuation\">(</span>com<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>support<span class=\"token operator\">:</span>support<span class=\"token operator\">-</span>compat<span class=\"token operator\">:</span><span class=\"token number\">26.1</span><span class=\"token number\">.0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">Duplicate</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>support<span class=\"token punctuation\">.</span>v4<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>ResultReceiver</span>$<span class=\"token class-name\">MyResultReceiver</span> found in modules core<span class=\"token operator\">-</span><span class=\"token number\">1.9</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span>runtime <span class=\"token punctuation\">(</span>androidx<span class=\"token punctuation\">.</span>core<span class=\"token operator\">:</span>core<span class=\"token operator\">:</span><span class=\"token number\">1.9</span><span class=\"token number\">.0</span><span class=\"token punctuation\">)</span> and support<span class=\"token operator\">-</span>compat<span class=\"token operator\">-</span><span class=\"token number\">26.1</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span>runtime <span class=\"token punctuation\">(</span>com<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>support<span class=\"token operator\">:</span>support<span class=\"token operator\">-</span>compat<span class=\"token operator\">:</span><span class=\"token number\">26.1</span><span class=\"token number\">.0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">Duplicate</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\"><span class=\"token namespace\">android<span class=\"token punctuation\">.</span>support<span class=\"token punctuation\">.</span>v4<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span></span>ResultReceiver</span>$<span class=\"token class-name\">MyRunnable</span> found in modules core<span class=\"token operator\">-</span><span class=\"token number\">1.9</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span>runtime <span class=\"token punctuation\">(</span>androidx<span class=\"token punctuation\">.</span>core<span class=\"token operator\">:</span>core<span class=\"token operator\">:</span><span class=\"token number\">1.9</span><span class=\"token number\">.0</span><span class=\"token punctuation\">)</span> and support<span class=\"token operator\">-</span>compat<span class=\"token operator\">-</span><span class=\"token number\">26.1</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span>runtime <span class=\"token punctuation\">(</span>com<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>support<span class=\"token operator\">:</span>support<span class=\"token operator\">-</span>compat<span class=\"token operator\">:</span><span class=\"token number\">26.1</span><span class=\"token number\">.0</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>异常日志里有一段警告</p>\n<blockquote>\n<p>Your project has set  <code>android.useAndroidX=true</code> , but configuration  <code>:app:googleDebugRuntimeClasspath</code>  still contains legacy support libraries, which may cause runtime issues.<br />\nThis behavior will not be allowed in Android Gradle plugin 8.0.<br />\nPlease use only AndroidX dependencies or set  <code>android.enableJetifier=true</code>  in the  <code>gradle.properties</code>  file to migrate your project to AndroidX (see <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vamV0cGFjay9hbmRyb2lkeC9taWdyYXRl\">https://developer.android.com/jetpack/androidx/migrate</span> for more info).</p>\n</blockquote>\n<p>我原来的   <code>gradle.properties</code>  只有  <code>android.useAndroidX=true</code>  的配置，按照警告的建议，修改后如下：</p>\n<pre><code>android.useAndroidX=true\nandroid.enableJetifier=true\n</code></pre>\n<h1 id=\"migrate-an-existing-project-using-android-studio\"><a class=\"anchor\" href=\"#migrate-an-existing-project-using-android-studio\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5nb29nbGUuY24vamV0cGFjay9hbmRyb2lkeC9taWdyYXRlI21pZ3JhdGVfYW5fZXhpc3RpbmdfcHJvamVjdF91c2luZ19hbmRyb2lkX3N0dWRpbw==\">Migrate an existing project using Android Studio</span></h1>\n<p>With Android Studio 3.2 and higher, you can migrate an existing project to AndroidX by selecting Refactor &gt; Migrate to AndroidX from the menu bar.</p>\n<p>The refactor command makes use of two flags. By default, both of them are set to  <code>true</code>  in your  <code>gradle.properties</code>  file:</p>\n<p><code>android.useAndroidX=true</code> <br />\nThe Android plugin uses the appropriate AndroidX library instead of a Support Library.<br />\n <code>android.enableJetifier=true</code> <br />\nThe Android plugin automatically migrates existing third-party libraries to use AndroidX by rewriting their binaries.</p>\n<p>看这描述，开启  <code>android.enableJetifier=true</code>  后，编译时将重写二进制文件，将  <code>android.support.v4.content.FileProvider</code>  改为 AndroidX 对应的类  <code>androidx.core.content.FileProvider</code>  相当于将穿山甲库里引用的 support 的类，重写为 AndroiX 的，如下</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>bytedance<span class=\"token punctuation\">.</span>sdk<span class=\"token punctuation\">.</span>openadsdk</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">androidx<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">FileProvider</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TTFileProvider</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">FileProvider</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">TTFileProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>至此问题原因找到并解决，移植 AndroidX 不彻底，所致，把问题暴露出来。</p>\n",
            "tags": [
                "Android",
                "穿山甲, 集成报错，AndroidX migrate，FileProvider not found"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/07/30/RxJava-Schedule/",
            "url": "https://limxtop1989.github.io/limxtop/2023/07/30/RxJava-Schedule/",
            "title": "RxJava Schedule",
            "date_published": "2023-07-30T09:08:48.000Z",
            "content_html": "<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Observable</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Observable<span class=\"token punctuation\">.</span>OnSubscribe</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Subscriber</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> observer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>observer<span class=\"token punctuation\">.</span><span class=\"token function\">isUnsubscribed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    observer<span class=\"token punctuation\">.</span><span class=\"token function\">onNext</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                observer<span class=\"token punctuation\">.</span><span class=\"token function\">onCompleted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            observer<span class=\"token punctuation\">.</span><span class=\"token function\">onError</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Subscriber</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onNext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Next: \"</span> <span class=\"token operator\">+</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onError</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error: \"</span> <span class=\"token operator\">+</span> error<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCompleted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Sequence complete.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>Running result:</p>\n<pre><code>Next: 1\nNext: 2\nNext: 3\nNext: 4\nSequence complete.\n</code></pre>\n<p>一个 Observable 需要一个 OnSubscribe &amp; Subscriber 配套成组。 每组 Observable 构成上下游关系，operator 调用时，会创建该层级的 Observable 并持有上游的 Observable 对象。 当该层级 Observable 被 subscribe 时， onSubscribe 会实例化上游的 Observer，它持有下游的 Observer。  subscribe 上游的 Observable。 由此出发链式 subscribe 调用，直到最上游的 Observable，其 onSubscribe 发射数据<br />\n上游的 Observer 会调用下游的 Observer ，如此链式逐级调用 Observer 的 接口方法，如 onNext ，直到最下游 。</p>\n<pre><code>    /**\n     * Modifies an ObservableSource to perform its emissions and notifications on a specified &#123;@link Scheduler&#125;,\n     * asynchronously with an unbounded buffer of configurable &quot;island size&quot; and optionally delays onError notifications.\n     * &lt;p&gt;\n     * &lt;img width=&quot;640&quot; height=&quot;308&quot; src=&quot;https://raw.github.com/wiki/ReactiveX/RxJava/images/rx-operators/observeOn.png&quot; alt=&quot;&quot;&gt;\n     * &lt;dl&gt;\n     *  &lt;dt&gt;&lt;b&gt;Scheduler:&lt;/b&gt;&lt;/dt&gt;\n     *  &lt;dd&gt;You specify which &#123;@link Scheduler&#125; this operator will use.&lt;/dd&gt;\n     * &lt;/dl&gt;\n     * &lt;p&gt;&quot;Island size&quot; indicates how large chunks the unbounded buffer allocates to store the excess elements waiting to be consumed\n     * on the other side of the asynchronous boundary. Values below 16 are not recommended in performance sensitive scenarios.\n     *\n     * @param scheduler\n     *            the &#123;@link Scheduler&#125; to notify &#123;@link Observer&#125;s on\n     * @param delayError\n     *            indicates if the onError notification may not cut ahead of onNext notification on the other side of the\n     *            scheduling boundary. If true a sequence ending in onError will be replayed in the same order as was received\n     *            from upstream\n     * @param bufferSize the size of the buffer.\n     * @return the source ObservableSource modified so that its &#123;@link Observer&#125;s are notified on the specified\n     *         &#123;@link Scheduler&#125;\n     * @see &lt;a href=&quot;http://reactivex.io/documentation/operators/observeon.html&quot;&gt;ReactiveX operators documentation: ObserveOn&lt;/a&gt;\n     * @see &lt;a href=&quot;http://www.grahamlea.com/2014/07/rxjava-threading-examples/&quot;&gt;RxJava Threading Examples&lt;/a&gt;\n     * @see #subscribeOn\n     * @see #observeOn(Scheduler)\n     * @see #observeOn(Scheduler, boolean)\n     */\n    @CheckReturnValue\n    @SchedulerSupport(SchedulerSupport.CUSTOM)\n    public final Observable&lt;T&gt; observeOn(Scheduler scheduler, boolean delayError, int bufferSize) &#123;\n        ObjectHelper.requireNonNull(scheduler, &quot;scheduler is null&quot;);\n        ObjectHelper.verifyPositive(bufferSize, &quot;bufferSize&quot;);\n        return RxJavaPlugins.onAssembly(new ObservableObserveOn&lt;T&gt;(this, scheduler, delayError, bufferSize));\n    &#125;\n</code></pre>\n<pre><code>    /**\n     * Asynchronously subscribes Observers to this ObservableSource on the specified &#123;@link Scheduler&#125;.\n     * &lt;p&gt;\n     * &lt;img width=&quot;640&quot; height=&quot;305&quot; src=&quot;https://raw.github.com/wiki/ReactiveX/RxJava/images/rx-operators/subscribeOn.png&quot; alt=&quot;&quot;&gt;\n     * &lt;dl&gt;\n     *  &lt;dt&gt;&lt;b&gt;Scheduler:&lt;/b&gt;&lt;/dt&gt;\n     *  &lt;dd&gt;You specify which &#123;@link Scheduler&#125; this operator will use.&lt;/dd&gt;\n     * &lt;/dl&gt;\n     *\n     * @param scheduler\n     *            the &#123;@link Scheduler&#125; to perform subscription actions on\n     * @return the source ObservableSource modified so that its subscriptions happen on the\n     *         specified &#123;@link Scheduler&#125;\n     * @see &lt;a href=&quot;http://reactivex.io/documentation/operators/subscribeon.html&quot;&gt;ReactiveX operators documentation: SubscribeOn&lt;/a&gt;\n     * @see &lt;a href=&quot;http://www.grahamlea.com/2014/07/rxjava-threading-examples/&quot;&gt;RxJava Threading Examples&lt;/a&gt;\n     * @see #observeOn\n     */\n    @CheckReturnValue\n    @SchedulerSupport(SchedulerSupport.CUSTOM)\n    public final Observable&lt;T&gt; subscribeOn(Scheduler scheduler) &#123;\n        ObjectHelper.requireNonNull(scheduler, &quot;scheduler is null&quot;);\n        return RxJavaPlugins.onAssembly(new ObservableSubscribeOn&lt;T&gt;(this, scheduler));\n    &#125;\n</code></pre>\n<pre><code>Observable.create(OnSubscribe)\n.observeOn()\n.subscribeOn()\n// 1. subscribe\n.subscribe(Subscriber);\n</code></pre>\n<pre><code>\npublic final class ObservableSubscribeOn&lt;T&gt; extends AbstractObservableWithUpstream&lt;T, T&gt; &#123;\n    final Scheduler scheduler;\n\n    public ObservableSubscribeOn(ObservableSource&lt;T&gt; source, Scheduler scheduler) &#123;\n        super(source);\n        this.scheduler = scheduler;\n    &#125;\n\n    @Override\n    public void subscribeActual(final Observer&lt;? super T&gt; observer) &#123;\n        // 2. 实例话上游 Observer\n        final SubscribeOnObserver&lt;T&gt; parent = new SubscribeOnObserver&lt;T&gt;(observer);\n\n        observer.onSubscribe(parent);\n        // 3. 使用上游 Observer 订阅上游 Observable ，具体是在 SubscribeTask 内执行。\n        parent.setDisposable(scheduler.scheduleDirect(new SubscribeTask(parent)));\n    &#125;\n\n    static final class SubscribeOnObserver&lt;T&gt; extends AtomicReference&lt;Disposable&gt; implements Observer&lt;T&gt;, Disposable &#123;\n\n        private static final long serialVersionUID = 8094547886072529208L;\n        final Observer&lt;? super T&gt; downstream;\n\n        final AtomicReference&lt;Disposable&gt; upstream;\n\n        SubscribeOnObserver(Observer&lt;? super T&gt; downstream) &#123;\n            this.downstream = downstream;\n            this.upstream = new AtomicReference&lt;Disposable&gt;();\n        &#125;\n\n        @Override\n        public void onSubscribe(Disposable d) &#123;\n            DisposableHelper.setOnce(this.upstream, d);\n        &#125;\n\n        @Override\n        public void onNext(T t) &#123;\n            downstream.onNext(t);\n        &#125;\n\n        @Override\n        public void onError(Throwable t) &#123;\n            downstream.onError(t);\n        &#125;\n\n        @Override\n        public void onComplete() &#123;\n            downstream.onComplete();\n        &#125;\n\n        @Override\n        public void dispose() &#123;\n            DisposableHelper.dispose(upstream);\n            DisposableHelper.dispose(this);\n        &#125;\n\n        @Override\n        public boolean isDisposed() &#123;\n            return DisposableHelper.isDisposed(get());\n        &#125;\n\n        void setDisposable(Disposable d) &#123;\n            DisposableHelper.setOnce(this, d);\n        &#125;\n    &#125;\n\n    final class SubscribeTask implements Runnable &#123;\n        private final SubscribeOnObserver&lt;T&gt; parent;\n\n        SubscribeTask(SubscribeOnObserver&lt;T&gt; parent) &#123;\n            this.parent = parent;\n        &#125;\n\n        @Override\n        public void run() &#123;\n            // 4. 订阅上游 Observable ObservableObserveOn\n            source.subscribe(parent);\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n",
            "tags": [
                "RxJava, 线程切换"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/07/30/AbstractQueuedSynchronizer/",
            "url": "https://limxtop1989.github.io/limxtop/2023/07/30/AbstractQueuedSynchronizer/",
            "title": "Java 并发框架 AbstractQueuedSynchronizer",
            "date_published": "2023-07-30T00:58:02.000Z",
            "content_html": "<p><img data-src=\"https://s3.uuu.ovh/imgs/2023/07/30/84de061a940ab561.png\" alt=\"\" /><br />\n关于 AbstractQueuedSynchronizer 的源码分析，我以 ReentrantLock 为例，类图如上。</p>\n<blockquote>\n<p>A reentrant mutual exclusion Lock with the same basic behavior and semantics as the implicit monitor lock accessed using synchronized methods and statements, but with extended capabilities.</p>\n</blockquote>\n<blockquote>\n<p>A ReentrantLock is owned by the thread last successfully locking, but not yet unlocking it. A thread invoking lock will return, successfully acquiring the lock, when the lock is not owned by another thread. The method will return immediately if the current thread already owns the lock. This can be checked using methods isHeldByCurrentThread, and getHoldCount.</p>\n</blockquote>\n<p>Lock 接口定义了关于 Lock 的三个主要操作：</p>\n<ol>\n<li>lock();</li>\n<li>unLock();</li>\n<li>newCondition();</li>\n</ol>\n<p><code>ReentrantLock</code>  实现  <code>Lock</code>  接口，但实现的细节全都委派给内部类  <code>Sync</code>  的具体实例。其中值得注意的是，创建  <code>ReentrantLock</code>  实例时，可以传递  <code>fair</code>  参数，指明实现的是公平锁还是非公平锁，默认为非公平锁。</p>\n<p>总体流程如图<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2023/07/30/602b88085d477f84.png\" alt=\"\" /></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    * Creates an instance of &#123;@code ReentrantLock&#125;.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    * This is equivalent to using &#123;@code ReentrantLock(false)&#125;.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    sync <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NonfairSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    * Creates an instance of &#123;@code ReentrantLock&#125; with the</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    * given fairness policy.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    *</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    * @param fair &#123;@code true&#125; if this lock should use a fair ordering policy</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> fair<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    sync <span class=\"token operator\">=</span> fair <span class=\"token operator\">?</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FairSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NonfairSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>公平锁指线程  <code>lock</code>  时得按顺序排队，等待队列为空时才抢占锁，否则进入队列排队等待。</p>\n<h1 id=\"thread-b-加锁失败进入等待\"><a class=\"anchor\" href=\"#thread-b-加锁失败进入等待\">#</a> Thread B 加锁失败，进入等待</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.ReentrantLock.FairSync#lock</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">final</span> <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#acquire</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    * Acquires in exclusive mode, ignoring interrupts.  Implemented</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    * by invoking at least once &#123;@link #tryAcquire&#125;,</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    * returning on success.  Otherwise the thread is queued, possibly</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    * repeatedly blocking and unblocking, invoking &#123;@link</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    * #tryAcquire&#125; until success.  This method can be used</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    * to implement method &#123;@link Lock#lock&#125;.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    *</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    * @param arg the acquire argument.  This value is conveyed to</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    *        &#123;@link #tryAcquire&#125; but is otherwise uninterpreted and</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    *        can represent anything you like.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">void</span> <span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function\">acquireQueued</span><span class=\"token punctuation\">(</span><span class=\"token function\">addWaiter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span><span class=\"token punctuation\">.</span>EXCLUSIVE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token function\">selfInterrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>先 <code>tryAcquire</code>  尝试获得锁，尝试失败，则  <code>acquireQueued</code>  。在 AbstractQueuedSynchronizer  <code>tryAcquire</code>  是模版方法，强制子类实现</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.ReentrantLock.FairSync#tryAcquire</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    * Fair version of tryAcquire.  Don't grant access unless</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    * recursive call or no waiters or is first.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">protected</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> acquires<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">final</span> <span class=\"token class-name\">Thread</span> current <span class=\"token operator\">=</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> <span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">// 没有线程持有锁，(线程成功获得锁时，会将 state 递增 acquires)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">hasQueuedPredecessors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token function\">compareAndSetState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> acquires<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token function\">setExclusiveOwnerThread</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">==</span> <span class=\"token function\">getExclusiveOwnerThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// 已经有线程持有锁，判断该锁拥有者是不是当前线程，是则递增 acquires 直接返回 true 表示成功加锁。</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token comment\">// 线程加锁后，可以继续加锁，是故可重入锁</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">int</span> nextc <span class=\"token operator\">=</span> c <span class=\"token operator\">+</span> acquires<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextc <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Maximum lock count exceeded\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span>nextc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// 该锁被其他线程持有，返回 false， 加锁失败，执行 acquireQueued 进入等待队列。</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol>\n<li>获得锁的逻辑很清晰简单，获取状态，当 state == 0 时，意味着没有线程持有该锁，再判断队列没有前驱并且用 CAS 操作更新 state，使其大于 0，如果更新操作成功，当前线程获得锁，在 setExclusiveOwnerThread 方法里将 exclusiveOwnerThread 指向当前线程。(compare expectedValue with the state value in the memory, and set the state value only if they are equal, which is atomic operation. 由于 state &amp; exclusiveOwnerThread 是共享变量，此代码块是 critical section (临界区)，所以比较和更新必须是原子操作，防止线程 A 比较更新中间，线程 B 更新 state，导致线程 AB 同时获得锁)</li>\n<li>如果 state &gt; 0, 意味着已经有线程持有该锁，但不必灰心，代码进一步判断当前锁的持有者是否是当前线程，如果是，则累加锁数量。</li>\n<li>我们重点来看加锁失败，加入等待队列的情况。</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#addWaiter</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    * Creates and enqueues node for current thread and given mode.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    * @param mode Node.EXCLUSIVE for exclusive, Node.SHARED for shared</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    * @return the new node</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token class-name\">Node</span> <span class=\"token function\">addWaiter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span> mode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token class-name\">Node</span> node <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// Try the fast path of enq; backup to full enq on failure</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token class-name\">Node</span> pred <span class=\"token operator\">=</span> tail<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pred <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        node<span class=\"token punctuation\">.</span>prev <span class=\"token operator\">=</span> pred<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compareAndSetTail</span><span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            pred<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token function\">enq</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>将当前线程和锁模式  <code>exclusive</code>  封装在  <code>Node</code>  里，加入队列末尾。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#acquireQueued</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    * Acquires in exclusive uninterruptible mode for thread already in</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    * queue. Used by condition wait methods as well as acquire.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    * @param node the node</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    * @param arg the acquire argument</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    * @return &#123;@code true&#125; if interrupted while waiting</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">acquireQueued</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Node</span> node<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">boolean</span> failed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">boolean</span> interrupted <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">final</span> <span class=\"token class-name\">Node</span> p <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span><span class=\"token function\">predecessor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token comment\">// 等待队列有前驱等待节点，才进入此方法，但此时可能前驱节点已经移除，</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token comment\">// 是故这里判断等待队列为空，重新尝试获取锁</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">==</span> head <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token function\">setHead</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                p<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// help GC</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                failed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">return</span> interrupted<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token comment\">// 重点在这里</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">shouldParkAfterFailedAcquire</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token function\">parkAndCheckInterrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                interrupted <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>failed<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token function\">cancelAcquire</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>先简略理解下  <code>shouldParkAfterFailedAcquire</code> ，如果前驱节点</p>\n<ol>\n<li>是 Signal，则返回 true，执行 parkAndCheckInterrupt。</li>\n<li>是 Cancel，则移除 Cancel 的等待节点.</li>\n<li>将非 Cancel 的前驱节点，状态升级为 Signal，下次循环进来，就是 case 1.</li>\n</ol>\n<p>在这里，我们记住，当前等待线程的前驱节点，到最后是 Signal 状态。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#shouldParkAfterFailedAcquire</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    * Checks and updates status for a node that failed to acquire.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    * Returns true if thread should block. This is the main signal</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    * control in all acquire loops.  Requires that pred == node.prev.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    * @param pred node's predecessor holding status</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    * @param node the node</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    * @return &#123;@code true&#125; if thread should block</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">shouldParkAfterFailedAcquire</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span> pred<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Node</span> node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">int</span> ws <span class=\"token operator\">=</span> pred<span class=\"token punctuation\">.</span>waitStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ws <span class=\"token operator\">==</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">.</span>SIGNAL<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            * This node has already set status asking a release</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            * to signal it, so it can safely park.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ws <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            * Predecessor was cancelled. Skip over predecessors and</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            * indicate retry.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            */</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            node<span class=\"token punctuation\">.</span>prev <span class=\"token operator\">=</span> pred <span class=\"token operator\">=</span> pred<span class=\"token punctuation\">.</span>prev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">.</span>waitStatus <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        pred<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            * waitStatus must be 0 or PROPAGATE.  Indicate that we</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            * need a signal, but don't park yet.  Caller will need to</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            * retry to make sure it cannot acquire before parking.</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            */</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token function\">compareAndSetWaitStatus</span><span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> ws<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">.</span>SIGNAL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>接下来，我们看  <code>parkAndCheckInterrupt</code>  则当前线程休眠，开始进入等待态（没什么特别的，就设置一个状态标记，告诉线程调度算法不用拿此线程参与调度计算），并检查中断状态。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#parkAndCheckInterrupt</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    * Convenience method to park and then check if interrupted</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    * @return &#123;@code true&#125; if interrupted</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">parkAndCheckInterrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token class-name\">LockSupport</span><span class=\"token punctuation\">.</span><span class=\"token function\">park</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 这行代码执行完毕，线程进入休眠，等待其他线程调用 unpark 后，执行下一行的 retrun</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.LockSupport#park(java.lang.Object)</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Disables the current thread for thread scheduling purposes unless the</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * permit is available.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * &lt;p>If the permit is available then it is consumed and the call returns</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * immediately; otherwise</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * the current thread becomes disabled for thread scheduling</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * purposes and lies dormant until one of three things happens:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * &lt;ul></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> * &lt;li>Some other thread invokes &#123;@link #unpark unpark&#125; with the</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * current thread as the target; or</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> * &lt;li>Some other thread &#123;@linkplain Thread#interrupt interrupts&#125;</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> * the current thread; or</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * &lt;li>The call spuriously (that is, for no reason) returns.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * &lt;/ul></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> * &lt;p>This method does &lt;em>not&lt;/em> report which of these caused the</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> * method to return. Callers should re-check the conditions which caused</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> * the thread to park in the first place. Callers may also determine,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> * for example, the interrupt status of the thread upon return.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> * @param blocker the synchronization object responsible for this</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> *        thread parking</pre></td></tr><tr><td data-num=\"27\"></td><td><pre> * @since 1.6</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">park</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> blocker<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token class-name\">Thread</span> t <span class=\"token operator\">=</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token function\">setBlocker</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">,</span> blocker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    UNSAFE<span class=\"token punctuation\">.</span><span class=\"token function\">park</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">setBlocker</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>到这里，Thread B 线程加锁失败，进入等待队列，休眠，等待其他线程释放锁，通知唤醒等待队列的线程，重新竞争获得锁。我们开始看其他线程释放锁流程。</p>\n<h1 id=\"thread-b-释放锁\"><a class=\"anchor\" href=\"#thread-b-释放锁\">#</a> Thread B 释放锁</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.ReentrantLock#unlock</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Attempts to release this lock.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * &lt;p>If the current thread is the holder of this lock then the hold</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * count is decremented.  If the hold count is now zero then the lock</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * is released.  If the current thread is not the holder of this</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * lock then &#123;@link IllegalMonitorStateException&#125; is thrown.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * @throws IllegalMonitorStateException if the current thread does not</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *         hold this lock</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    sync<span class=\"token punctuation\">.</span><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#release</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Releases in exclusive mode.  Implemented by unblocking one or</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * more threads if &#123;@link #tryRelease&#125; returns true.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * This method can be used to implement method &#123;@link Lock#unlock&#125;.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param arg the release argument.  This value is conveyed to</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *        &#123;@link #tryRelease&#125; but is otherwise uninterpreted and</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *        can represent anything you like.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * @return the value returned from &#123;@link #tryRelease&#125;</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">tryRelease</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token class-name\">Node</span> h <span class=\"token operator\">=</span> head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> h<span class=\"token punctuation\">.</span>waitStatus <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token function\">unparkSuccessor</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>尝试释放锁，然后 unpark 锁等待队列的第一个线程，使其进入等待调度状态。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.ReentrantLock.Sync#tryRelease</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">protected</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryRelease</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> releases<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> <span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> releases<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token function\">getExclusiveOwnerThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalMonitorStateException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">boolean</span> free <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        free <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token function\">setExclusiveOwnerThread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> free<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.locks.AbstractQueuedSynchronizer#unparkSuccessor</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>* Wakes up node's successor, if one exists.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>*</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>* @param node the node</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">unparkSuccessor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span> node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    * If status is negative (i.e., possibly needing signal) try</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    * to clear in anticipation of signalling.  It is OK if this</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    * fails or if status is changed by waiting thread.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">int</span> ws <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>waitStatus<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ws <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">compareAndSetWaitStatus</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> ws<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    * Thread to unpark is held in successor, which is normally</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    * just the next node.  But if cancelled or apparently null,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    * traverse backwards from tail to find the actual</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    * non-cancelled successor.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token class-name\">Node</span> s <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> s<span class=\"token punctuation\">.</span>waitStatus <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        s <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span> t <span class=\"token operator\">=</span> tail<span class=\"token punctuation\">;</span> t <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> t <span class=\"token operator\">!=</span> node<span class=\"token punctuation\">;</span> t <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>prev<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span>waitStatus <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        s <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token class-name\">LockSupport</span><span class=\"token punctuation\">.</span><span class=\"token function\">unpark</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>传入 h 指向的是哨兵头节点，找到锁等待队列里第一个  <code>waitStatus &lt;= 0</code>  即 SIGNAL CONDITION PROPAGATE 三者之一的节点，并 unpark 唤醒节点里的线程。<br />\n当上文 Thread B 加锁失败，进入等待锁队列的节点</p>\n<ol>\n<li>是这个头节点，加锁线程被唤醒，thread schedule 分配它运行后，它从 park 中返回，并检测记录 interrupted，进入下一次循环，此时它的前驱就是 head 哨兵节点，再次执行  <code>tryAcquire</code>  流程。</li>\n<li>不是头节点，那么等待前面的节点都纷纷通过  <code>tryAcquire</code>  获得锁，然后释放锁后，文中上一个加锁的线程所在节点最终会成为头节点。</li>\n</ol>\n<p>获得锁成功后，返回 interrupted 中断状态，如果该线程是 interrupted 而进入等待态，则返回后重置还原 interrupted 状态。</p>\n<p>线程从休眠进入等待态有三种 cases 见  <code>java.util.concurrent.locks.LockSupport#park(java.lang.Object)</code> ：</p>\n<ol>\n<li>Some other thread invokes unpark with the current thread as the target; or</li>\n<li>Some other thread interrupts the current thread; or</li>\n<li>The call spuriously (that is, for no reason) returns.</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>a java.util.concurrent.locks.AbstractQueuedSynchronizer#acquireQueued</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Acquires in exclusive uninterruptible mode for thread already in</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * queue. Used by condition wait methods as well as acquire.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param node the node</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param arg the acquire argument</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * @return &#123;@code true&#125; if interrupted while waiting</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">acquireQueued</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Node</span> node<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">boolean</span> failed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">boolean</span> interrupted <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">final</span> <span class=\"token class-name\">Node</span> p <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span><span class=\"token function\">predecessor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p <span class=\"token operator\">==</span> head <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">tryAcquire</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token function\">setHead</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                p<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// help GC</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                failed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">return</span> interrupted<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">shouldParkAfterFailedAcquire</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token function\">parkAndCheckInterrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                interrupted <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>failed<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token function\">cancelAcquire</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "Java"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/07/29/semaphore/",
            "url": "https://limxtop1989.github.io/limxtop/2023/07/29/semaphore/",
            "title": "Semaphore",
            "date_published": "2023-07-29T09:03:58.000Z",
            "content_html": "<p>计数方式实现的旗语，一个旗语维护一组概念上的许可。每个线程 acquire 都会在必要时阻塞，直到有许可证可用，然后获取它，许可数量减一。每次释放都会增加一个许可，从而有可能释放阻塞在 acquire 的线程。不过， Semaphore 并不使用实际的许可对象；它只是对可用数量进行计数，并采取相应的行动。</p>\n<p>如此 Semaphores 通常用于限制可以访问某些（物理或逻辑）资源的线程数量。也就是说，当你希望只有 permits 个线程可以并发访问这些资源是，通过 Semaphore (int permits, boolean fair) 实例化 permits 个许可资源，线程 aquire 许可后，获取资源，完成后，release 释放许可回许可池。</p>\n<blockquote>\n<p>A counting semaphore. Conceptually, a semaphore maintains a set of permits. Each acquire blocks if necessary until a permit is available, and then takes it. Each release adds a permit, potentially releasing a blocking acquirer. However, no actual permit objects are used; the Semaphore just keeps a count of the number available and acts accordingly.<br />\nSemaphores are often used to restrict the number of threads than can access some (physical or logical) resource.</p>\n</blockquote>\n<p>在 aquire &amp; release 之前，没有同步锁被持有，</p>\n<blockquote>\n<p>Note that no synchronization lock is held when acquire is called as that would prevent an item from being returned to the pool. The semaphore encapsulates the synchronization needed to restrict access to the pool, separately from any synchronization needed to maintain the consistency of the pool itself.</p>\n</blockquote>\n<p>与 Lock 的实现不同， semaphore release permit 的线程，不需要以 aquire 该 permit 为前提。</p>\n<blockquote>\n<p>A semaphore initialized to one, and which is used such that it only has at most one permit available, can serve as a mutual exclusion lock. This is more commonly known as a binary semaphore, because it only has two states: one permit available, or zero permits available. When used in this way, the binary semaphore has the property (unlike many java.util.concurrent.locks.Lock implementations), that the &quot;lock&quot; can be released by a thread other than the owner (as semaphores have no notion of ownership). This can be useful in some specialized contexts, such as deadlock recovery.</p>\n</blockquote>\n",
            "tags": [
                "semaphore，java 并发，信号量"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/07/29/CountDownLatch/",
            "url": "https://limxtop1989.github.io/limxtop/2023/07/29/CountDownLatch/",
            "title": "CountDownLatch",
            "date_published": "2023-07-29T07:30:00.000Z",
            "content_html": "<h2 id=\"overview\"><a class=\"anchor\" href=\"#overview\">#</a> Overview</h2>\n<p>一种同步辅助工具，允许一个或多个线程等待其他线程正在执行的一组操作完成。</p>\n<blockquote>\n<p>A synchronization aid that allows one or more threads to wait until a set of operations being performed in other threads completes.</p>\n</blockquote>\n<p>CountDownLatch 以给定的计数初始化。await 方法会阻塞，直到当前计数因调用 CountDown 方法而归零，之后所有等待的线程都会被释放，并且 await 的任何后续调用都会立即返回。这是一种一次性现象 -- 计数无法重置。如果需要重置计数的版本，可以考虑使用 CyclicBarrier。</p>\n<blockquote>\n<p>A CountDownLatch is initialized with a given count. The await methods block until the current count reaches zero due to invocations of the countDown method, after which all waiting threads are released and any subsequent invocations of await return immediately. This is a one-shot phenomenon -- the count cannot be reset. If you need a version that resets the count, consider using a CyclicBarrier.<br />\nCountDownLatch 是一种多功能同步工具，可用于多种用途。初始化计数为 1 的 CountDownLatch 可用作简单的开 / 关锁存器或门：所有调用 await 的线程都在门上等待，直到调用 countDown 的线程打开它。初始化为 N 的 CountDownLatch 可用于让一个线程等待，直到 N 个线程完成某个操作，或某个操作完成 N 次。<br />\nA CountDownLatch is a versatile synchronization tool and can be used for a number of purposes. A CountDownLatch initialized with a count of one serves as a simple on/off latch, or gate: all threads invoking await wait at the gate until it is opened by a thread invoking countDown. A CountDownLatch initialized to N can be used to make one thread wait until N threads have completed some action, or some action has been completed N times.<br />\nCountDownLatch 的一个有用特性是，它并不要求调用 countDown 的线程在继续执行之前需要等待计数归零，也就是它调用 countDown 之后，可以继续一路高歌猛进，它只是阻止其他调用 await 的任何线程越过 await 继续执行，直到所有 await 的线程都能通过为止（即 countDown 为 0）。<br />\nA useful property of a CountDownLatch is that it doesn't require that threads calling countDown wait for the count to reach zero before proceeding, it simply prevents any thread from proceeding past an await until all threads could pass.</p>\n</blockquote>\n<p>Sample usage: Here is a pair of classes in which a group of worker threads use two countdown latches:<br />\nThe first is a start signal that prevents any worker from proceeding until the driver is ready for them to proceed;<br />\nThe second is a completion signal that allows the driver to wait until all workers have completed.</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>a</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Driver</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     <span class=\"token class-name\">CountDownLatch</span> startSignal <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CountDownLatch</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     <span class=\"token class-name\">CountDownLatch</span> doneSignal <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CountDownLatch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">N</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token class-name\">N</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token comment\">// create and start threads</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>       <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span>startSignal<span class=\"token punctuation\">,</span> doneSignal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     <span class=\"token function\">doSomethingElse1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>            <span class=\"token comment\">// don't let run yet</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     startSignal<span class=\"token punctuation\">.</span><span class=\"token function\">countDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// let all threads proceed</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     <span class=\"token function\">doSomethingElse2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     doneSignal<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>           <span class=\"token comment\">// wait for all to finish</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Worker</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CountDownLatch</span> startSignal<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CountDownLatch</span> doneSignal<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CountDownLatch</span> startSignal<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CountDownLatch</span> doneSignal<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>startSignal <span class=\"token operator\">=</span> startSignal<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>doneSignal <span class=\"token operator\">=</span> doneSignal<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>       startSignal<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>       <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>       doneSignal<span class=\"token punctuation\">.</span><span class=\"token function\">countDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">// return;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   <span class=\"token keyword\">void</span> <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://s3.uuu.ovh/imgs/2023/07/30/47ebfd56d12f728c.png\" alt=\"\" /><br />\nWorkerThread 初始化启动后， 在  <code>startSignal.await();</code>  集结等待，driver 在 doSomethingElse1 后， startSignal.countDown (); 释放门闩，所有等待线程从等待态，进入就绪态，纷纷执行 doWork () 与此同时， Driver 执行 doneSignal.await () 等所有 WorkerThread 完成工作，都执行 doneSignal.countDown ();<br />\n 待计数器归零，Driver 线程从 await 中返回，从等待态进入就绪态，</p>\n<blockquote>\n<p>Another typical usage would be to divide a problem into N parts, describe each part with a Runnable that executes that portion and counts down on the latch, and queue all the Runnables to an Executor. When all sub-parts are complete, the coordinating thread will be able to pass through await. (When threads must repeatedly count down in this way, instead use a CyclicBarrier.)</p>\n</blockquote>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>a</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Driver2</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     <span class=\"token class-name\">CountDownLatch</span> doneSignal <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CountDownLatch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">N</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     <span class=\"token class-name\">Executor</span> e <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token class-name\">N</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token comment\">// create and start threads</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>       e<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">WorkerRunnable</span><span class=\"token punctuation\">(</span>doneSignal<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     doneSignal<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>           <span class=\"token comment\">// wait for all to finish</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WorkerRunnable</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CountDownLatch</span> doneSignal<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token class-name\">WorkerRunnable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CountDownLatch</span> doneSignal<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>     <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>doneSignal <span class=\"token operator\">=</span> doneSignal<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>i <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>       <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>       doneSignal<span class=\"token punctuation\">.</span><span class=\"token function\">countDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">// return;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   <span class=\"token keyword\">void</span> <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><blockquote>\n<p>Memory consistency effects: Until the count reaches zero, actions in a thread prior to calling countDown() happen-before actions following a successful return from a corresponding await() in another thread.</p>\n</blockquote>\n",
            "tags": [
                "Java",
                "CountDownLatch, 并发，多线程"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/07/27/thread-pool/",
            "url": "https://limxtop1989.github.io/limxtop/2023/07/27/thread-pool/",
            "title": "线程池",
            "date_published": "2023-07-27T15:10:17.000Z",
            "content_html": "<p>本文的目的为掌握线程池的正确使用。如果英语水平不错，仅仅看类注释，半个小时就可以初步掌握如何正确使用了，但如果读懂源码相关的实现，则不仅可以辅助加深对注释描述的理解，也可以学习好的代码设计和实现。</p>\n<h1 id=\"overview\"><a class=\"anchor\" href=\"#overview\">#</a> Overview</h1>\n<p>An ExecutorService that executes each submitted task using one of possibly several pooled threads, normally configured using Executors factory methods.</p>\n<h2 id=\"core-and-maximum-pool-sizes\"><a class=\"anchor\" href=\"#core-and-maximum-pool-sizes\">#</a> Core and maximum pool sizes</h2>\n<ol>\n<li>在方法  <code>execute(Runnable)</code>  中提交新任务时，如果正在运行的线程少于  <code>corePoolSize</code> ，即使其他工作线程处于空闲状态，也会创建一个新线程来处理请求。</li>\n<li>线程数达到 <code>corePoolSize</code>  后，新来的任务进入队列，等待 core 线程处理。</li>\n<li>当队列满了以后，又有新任务提交，在 <code>corePoolSize</code>  外，继续创建新线程。</li>\n<li>当队列满 &amp; 线程数达到  <code>maximumPoolSize</code> ，提交的新任务走 Rejected tasks 流程。</li>\n</ol>\n<p>文字描述或许干枯难记，当阅读源码后，回来总结这些规则时，自己应该依据这些规则，就生产者线程（client）往线程池提交任务时，线程池如何分配任务给 core thread，任务队列，maximum thread，在脑海里构建一张动态序列图。这样可以更好的帮助理解和记忆。</p>\n<blockquote>\n<p>On-demand construction<br />\nBy default, even core threads are initially created and started only when new tasks arrive, but this can be overridden dynamically using method  <code>prestartCoreThread</code>  or  <code>prestartAllCoreThreads</code> . You probably want to prestart threads if you construct the pool with a non-empty queue.</p>\n</blockquote>\n<h2 id=\"keep-alive-times\"><a class=\"anchor\" href=\"#keep-alive-times\">#</a> Keep-alive times</h2>\n<p>超过 <code>corePoolSize</code>  的线程，当他们空闲时长超过  <code>getKeepAliveTime(TimeUnit)</code> ，会 terminate。通过 <code> allowCoreThreadTimeOut(boolean)</code>  可以设置这个超时策略适用于 core 线程。</p>\n<h2 id=\"queuing\"><a class=\"anchor\" href=\"#queuing\">#</a> Queuing</h2>\n<ol>\n<li>Direct handoffs：需要无边界的  <code>maximumPoolSizes</code> ，避免没有线程，导致新提交的任务被拒绝。</li>\n</ol>\n<blockquote>\n<p>Direct handoffs. A good default choice for a work queue is a SynchronousQueue that hands off tasks to threads without otherwise holding them. Here, an attempt to queue a task will fail if no threads are immediately available to run it, so a new thread will be constructed. This policy avoids lockups when handling sets of requests that might have internal dependencies. Direct handoffs generally require unbounded maximumPoolSizes to avoid rejection of new submitted tasks. This in turn admits the possibility of unbounded thread growth when commands continue to arrive on average faster than they can be processed.</p>\n</blockquote>\n<ol start=\"2\">\n<li>Unbounded queues:  <code>LinkedBlockingQueue</code>  没有容量限制， <code>maximumPoolSize</code>  不会生效，适用于任务彼此独立。</li>\n</ol>\n<blockquote>\n<p>Unbounded queues. Using an unbounded queue (for example a LinkedBlockingQueue without a predefined capacity) will cause new tasks to wait in the queue when all corePoolSize threads are busy. Thus, no more than corePoolSize threads will ever be created. (And the value of the maximumPoolSize therefore doesn't have any effect.) This may be appropriate when each task is completely independent of others, so tasks cannot affect each others execution; for example, in a web page server. While this style of queuing can be useful in smoothing out transient bursts of requests, it admits the possibility of unbounded work queue growth when commands continue to arrive on average faster than they can be processed.</p>\n</blockquote>\n<ol start=\"3\">\n<li>Bounded queues：  <code> ArrayBlockingQueue</code>   是前两种策略的折衷，队列大小和最大线程数大小彼此折衷。</li>\n</ol>\n<blockquote>\n<p>Queue sizes and maximum pool sizes may be traded off for each other: Using large queues and small pools minimizes CPU usage, OS resources, and context-switching overhead, but can lead to artificially low throughput. If tasks frequently block (for example if they are I/O bound), a system may be able to schedule time for more threads than you otherwise allow. Use of small queues generally requires larger pool sizes, which keeps CPUs busier but may encounter unacceptable scheduling overhead, which also decreases throughput.</p>\n</blockquote>\n<h1 id=\"source-code\"><a class=\"anchor\" href=\"#source-code\">#</a> Source code</h1>\n<ol>\n<li>不要通篇顺序阅读，需要分层，跳过干扰次要代码，重点阅读想要懂的逻辑部分。由于我们现在是要读懂线程池是如何管理线程和任务的，所以，线程池的状态等代码都不必深入理解。</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.ThreadPoolExecutor#execute</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> command<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>command <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     * Proceed in 3 steps:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     * 1. If fewer than corePoolSize threads are running, try to</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     * start a new thread with the given command as its first</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     * task.  The call to addWorker atomically checks runState and</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     * workerCount, and so prevents false alarms that would add</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     * threads when it shouldn't, by returning false.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     * 2. If a task can be successfully queued, then we still need</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     * to double-check whether we should have added a thread</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     * (because existing ones died since last checking) or that</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>     * the pool shut down since entry into this method. So we</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>     * recheck state and if necessary roll back the enqueuing if</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     * stopped, or start a new thread if there are none.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     * 3. If we cannot queue task, then we try to add a new</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     * thread.  If it fails, we know we are shut down or saturated</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>     * and so reject the task.</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">//case 1: 线程数少于 corePoolSize，新建 core 线程</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">workerCountOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> corePoolSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">addWorker</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        c <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">//case 2: 线程数已经到达 corePoolSize，加入队列处理</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isRunning</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">offer</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">int</span> recheck <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span> <span class=\"token function\">isRunning</span><span class=\"token punctuation\">(</span>recheck<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">workerCountOf</span><span class=\"token punctuation\">(</span>recheck<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token function\">addWorker</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">//case 3: 队列满了，加入新任务失败，新建 (core, maximum] 区间的线程来处理</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">addWorker</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"case-1-addworkercommand-true\"><a class=\"anchor\" href=\"#case-1-addworkercommand-true\">#</a> Case 1:  addWorker(command, true)</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.ThreadPoolExecutor#addWorker</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">addWorker</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> firstTask<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> core<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 状态判断，大概理解即可，并非重点 begin</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    retry<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">int</span> c <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">int</span> rs <span class=\"token operator\">=</span> <span class=\"token function\">runStateOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token comment\">// Check if queue empty only if necessary.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rs <span class=\"token operator\">>=</span> SHUTDOWN <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token operator\">!</span> <span class=\"token punctuation\">(</span>rs <span class=\"token operator\">==</span> SHUTDOWN <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                firstTask <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token operator\">!</span> workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">int</span> wc <span class=\"token operator\">=</span> <span class=\"token function\">workerCountOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wc <span class=\"token operator\">>=</span> CAPACITY <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                wc <span class=\"token operator\">>=</span> <span class=\"token punctuation\">(</span>core <span class=\"token operator\">?</span> corePoolSize <span class=\"token operator\">:</span> maximumPoolSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">compareAndIncrementWorkerCount</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">break</span> retry<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            c <span class=\"token operator\">=</span> ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Re-read ctl</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">runStateOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> rs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token keyword\">continue</span> retry<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token comment\">// else CAS failed due to workerCount change; retry inner loop</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// 状态判断，大概理解即可，并非重点 end</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">boolean</span> workerStarted <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">boolean</span> workerAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token class-name\">Worker</span> w <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token comment\">// 新建一个 worker thread，并将第一个 task 传入</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        w <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span>firstTask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Thread</span> t <span class=\"token operator\">=</span> w<span class=\"token punctuation\">.</span>thread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token keyword\">final</span> <span class=\"token class-name\">ReentrantLock</span> mainLock <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mainLock<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            mainLock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token comment\">// Recheck while holding lock.</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token comment\">// Back out on ThreadFactory failure or if</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token comment\">// shut down before lock acquired.</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token keyword\">int</span> rs <span class=\"token operator\">=</span> <span class=\"token function\">runStateOf</span><span class=\"token punctuation\">(</span>ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rs <span class=\"token operator\">&lt;</span> SHUTDOWN <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                    <span class=\"token punctuation\">(</span>rs <span class=\"token operator\">==</span> SHUTDOWN <span class=\"token operator\">&amp;&amp;</span> firstTask <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">isAlive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// precheck that t is startable</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalThreadStateException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token comment\">// 将 worker 加入 worker 列表，他们循环从任务队列取任务执行</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                    workers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    <span class=\"token keyword\">int</span> s <span class=\"token operator\">=</span> workers<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">></span> largestPoolSize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                        largestPoolSize <span class=\"token operator\">=</span> s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                    workerAdded <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                mainLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workerAdded<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token comment\">// 启动 worker thread，开始循环获取，执行任务</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                t<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                workerStarted <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span> workerStarted<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token function\">addWorkerFailed</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">return</span> workerStarted<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"new-worker\"><a class=\"anchor\" href=\"#new-worker\">#</a> new Worker</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>a java.util.concurrent.ThreadPoolExecutor.Worker#Worker</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    * Creates with given first task and thread from ThreadFactory.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    * @param firstTask the first task (null if none)</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> firstTask<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// inhibit interrupts until runWorker</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>firstTask <span class=\"token operator\">=</span> firstTask<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>thread <span class=\"token operator\">=</span> <span class=\"token function\">getThreadFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">newThread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>初始化 Worker 实例，其中实例化  <code>firstTask</code>  &amp;  <code>thread</code>  成员变量。Worker 实现  <code>Runnable</code>  interface，在初始化 thread 时，作为构造器参数传入，作为 Thread.target 的值。Worker 继承  <code>AbstractQueuedSynchronizer</code> ，这是 Java 并发包的核心类，使用 CAS 操作实现锁，将放在其他博文展开分析。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.ThreadPoolExecutor#ThreadPoolExecutor(int, int, long, TimeUnit, BlockingQueue<Runnable>)</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">ThreadPoolExecutor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> corePoolSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                            <span class=\"token keyword\">int</span> maximumPoolSize<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                            <span class=\"token keyword\">long</span> keepAliveTime<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                            <span class=\"token class-name\">TimeUnit</span> unit<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                            <span class=\"token class-name\">BlockingQueue</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">></span></span> workQueue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>corePoolSize<span class=\"token punctuation\">,</span> maximumPoolSize<span class=\"token punctuation\">,</span> keepAliveTime<span class=\"token punctuation\">,</span> unit<span class=\"token punctuation\">,</span> workQueue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">defaultThreadFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> defaultHandler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ThreadPool 默认的 ThreadFactory 是 Executors.defaultThreadFactory ()，看下其 newThread 代码，便知 worker 实例是 Thread 的 target 了。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.Executors.DefaultThreadFactory#DefaultThreadFactory</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Thread</span> <span class=\"token function\">newThread</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">Thread</span> t <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>group<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                            namePrefix <span class=\"token operator\">+</span> threadNumber<span class=\"token punctuation\">.</span><span class=\"token function\">getAndIncrement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                            <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">isDaemon</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        t<span class=\"token punctuation\">.</span><span class=\"token function\">setDaemon</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">getPriority</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span>NORM_PRIORITY<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        t<span class=\"token punctuation\">.</span><span class=\"token function\">setPriority</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span>NORM_PRIORITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">return</span> t<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>当 Thread start 后，Thread.run 会执行，target.run 也就是 Worker.run 会被调用。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.lang.Thread#Thread(java.lang.ThreadGroup, java.lang.Runnable, java.lang.String, long)</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ThreadGroup</span> g<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Runnable</span> target<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                    <span class=\"token keyword\">long</span> stackSize<span class=\"token punctuation\">,</span> <span class=\"token class-name\">AccessControlContext</span> acc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                    <span class=\"token keyword\">boolean</span> inheritThreadLocals<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// ignore irrelevant codes</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>target <span class=\"token operator\">=</span> target<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// ignore irrelevant codes</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>target <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        target<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"workersadd\"><a class=\"anchor\" href=\"#workersadd\">#</a> workers.add</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.ThreadPoolExecutor#workers</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * Set containing all worker threads in pool. Accessed only when</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * holding mainLock.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Worker</span><span class=\"token punctuation\">></span></span> workers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Worker</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"tstart\"><a class=\"anchor\" href=\"#tstart\">#</a> t.start</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.ThreadPoolExecutor.Worker#run</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/** Delegates main run loop to outer runWorker  */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">runWorker</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>java.util.concurrent.ThreadPoolExecutor#runWorker</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">final</span> <span class=\"token keyword\">void</span> <span class=\"token function\">runWorker</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Worker</span> w<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">Thread</span> wt <span class=\"token operator\">=</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Runnable</span> task <span class=\"token operator\">=</span> w<span class=\"token punctuation\">.</span>firstTask<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    w<span class=\"token punctuation\">.</span>firstTask <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    w<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// allow interrupts</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">boolean</span> completedAbruptly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token comment\">// 初始化时的第一个任务先执行，后续都从任务队列获取任务执行</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">=</span> <span class=\"token function\">getTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            w<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token comment\">// If pool is stopping, ensure thread is interrupted;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token comment\">// if not, ensure thread is not interrupted.  This</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token comment\">// requires a recheck in second case to deal with</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token comment\">// shutdownNow race while clearing interrupt</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">runStateAtLeast</span><span class=\"token punctuation\">(</span>ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> STOP<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                    <span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">interrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token function\">runStateAtLeast</span><span class=\"token punctuation\">(</span>ctl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> STOP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token operator\">!</span>wt<span class=\"token punctuation\">.</span><span class=\"token function\">isInterrupted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                wt<span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token function\">beforeExecute</span><span class=\"token punctuation\">(</span>wt<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token class-name\">Throwable</span> thrown <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    task<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RuntimeException</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    thrown <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span> <span class=\"token keyword\">throw</span> x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Error</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    thrown <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span> <span class=\"token keyword\">throw</span> x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                    thrown <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                    <span class=\"token function\">afterExecute</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">,</span> thrown<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                task <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                w<span class=\"token punctuation\">.</span>completedTasks<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                w<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        completedAbruptly <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token function\">processWorkerExit</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> completedAbruptly<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"case-2-workqueueoffercommand\"><a class=\"anchor\" href=\"#case-2-workqueueoffercommand\">#</a> Case 2: workQueue.offer(command)</h1>\n<p>将任务塞入队列，待线程池的线程轮询获取任务执行。队列有多种实现，主要区分 Array &amp; Link</p>\n<ol>\n<li>ArrayBlockingQueue 有固定边界，当任务加满后，workQueue.offer (command) 会返回 false，进入线程 (core, maximum] 扩张流程。</li>\n<li>LinkedBlockingQueue 默认没有边界，所以 workQueue.offer (command) 一般返回 true，即任务成功加入队列。除非初始化时，设置 capacity。</li>\n</ol>\n<h1 id=\"case-3-addworkercommand-false\"><a class=\"anchor\" href=\"#case-3-addworkercommand-false\">#</a> Case 3: addWorker(command, false)</h1>\n<p>与 addWorker (command, true) 类似，当线程数没到达 maximum 时，创建新线程，返回 true，否则不创建新线程，返回 false，当前任务交由  <code>RejectedExecutionHandler</code>  处理，进入 reject 流程。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>a java.util.concurrent.ThreadPoolExecutor#addWorker</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">addWorker</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> firstTask<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> core<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">int</span> wc <span class=\"token operator\">=</span> <span class=\"token function\">workerCountOf</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wc <span class=\"token operator\">>=</span> CAPACITY <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        wc <span class=\"token operator\">>=</span> <span class=\"token punctuation\">(</span>core <span class=\"token operator\">?</span> corePoolSize <span class=\"token operator\">:</span> maximumPoolSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "Java",
                "Thread Pool，线程池"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/07/08/Representing-and-Manipulating-Information/",
            "url": "https://limxtop1989.github.io/limxtop/2023/07/08/Representing-and-Manipulating-Information/",
            "title": "数字在计算机的表示和操作",
            "date_published": "2023-07-08T06:51:22.000Z",
            "content_html": "<h1 id=\"integer-representations\"><a class=\"anchor\" href=\"#integer-representations\">#</a> Integer Representations</h1>\n<p>在学校教科书告诉我们原码，反码，补码的规则来计算正负数在计算机的表示。</p>\n<blockquote>\n<p>原码：将一个整数，转换成二进制，就是其原码。<br />\n如单字节的 5 的原码为：0000 0101；-5 的原码为 1000 0101。<br />\n反码：正数的反码就是其原码；负数的反码是将原码中，除符号位以外，每一位取反。<br />\n如单字节的 5 的反码为：0000 0101；-5 的反码为 1111 1010。<br />\n补码：正数的补码就是其原码；负数的反码 + 1 就是补码。<br />\n如单字节的 5 的补码为：0000 0101；-5 的补码为 1111 1011。<br />\n在计算机中，正数是直接用原码表示的，如单字节 5，在计算机中就表示为：0000 0101。<br />\n负数用补码表示，如单字节 - 5，在计算机中表示为 1111 1011。</p>\n</blockquote>\n<p>规则不仅复杂抽象不说，也无助于我们理解无符号和有符号的转换，无符号与有符号的扩展。当我阅读 CSAPP Chapter 2 Representing and Manipulating Information，忽然如沐春风，豁然开朗。如下是部分笔记。</p>\n<h2 id=\"unsigned-and-twos-complement-encodings\"><a class=\"anchor\" href=\"#unsigned-and-twos-complement-encodings\">#</a> Unsigned and Two’s-Complement Encodings</h2>\n<p>Assume we have an integer data type of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ω</mi></mrow><annotation encoding=\"application/x-tex\">\\omega</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">ω</span></span></span></span> bits. We write a bit vector as either <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>x</mi><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{x}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.714em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.20772em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span>, to denote the entire vector, or as <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><msub><mi>x</mi><mrow><mi>w</mi><mo>−</mo><mn>1</mn></mrow></msub><mo separator=\"true\">,</mo><msub><mi>x</mi><mrow><mi>w</mi><mo>−</mo><mn>2</mn></mrow></msub><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[x_{w-1}, x_{w-2}, ..., x_0 ]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span></span> to denote the individual bits within the vector. Treating <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>x</mi><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{x}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.714em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.20772em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span>  as a number written in binary notation, we obtain the unsigned interpretation of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>x</mi><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{x}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.714em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.20772em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span>. We express this interpretation as a function <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi><mn>2</mn><msub><mi>U</mi><mi>w</mi></msub></mrow><annotation encoding=\"application/x-tex\">B2U_w</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord\">2</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> (for “binary to unsigned”, length <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ω</mi></mrow><annotation encoding=\"application/x-tex\">\\omega</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">ω</span></span></span></span>)</p>\n\\begin{equation}\nB2U_w(\\vec{x}) = \\sum_{i = 0}^{w-1} x_i 2^i\n\\end{equation}\n\n<p>We wish to represent negative values as well by two’s-complement form. This is defined by interpreting the most significant bit of the word to have negative weight. We express this interpretation as a function <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi><mn>2</mn><msub><mi>T</mi><mi>w</mi></msub></mrow><annotation encoding=\"application/x-tex\">B2T_w</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord\">2</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>(for “binary to two’s-complement” length <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ω</mi></mrow><annotation encoding=\"application/x-tex\">\\omega</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">ω</span></span></span></span> \t)</p>\n\\begin{equation}\nB2T_w(\\vec{x}) = -x_{w - 1} 2^{w-1} +  \\sum_{i = 0}^{w-2} x_i 2^i\n\\end{equation}\n\n<p>Problem: find the <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi><mn>2</mn><msub><mi>T</mi><mi>w</mi></msub><mo stretchy=\"false\">(</mo><mo>−</mo><mn>5</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">B2T_w(-5)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord\">2</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\">−</span><span class=\"mord\">5</span><span class=\"mclose\">)</span></span></span></span></p>\n\\begin{align}\n\\because {5 + -5 = 0} \\\\\n0000 \\space 0101 + 1\\space\\underbrace{\\vec{x_6, x_5, ..., x_0}}_\\text{x} = 0 \\\\\n\\underbrace{\\vec{x_6, x_5, ..., x_0}}_\\text{x} = 1000 \\space 000 - 0000 \\space 0101 \\\\\n\\underbrace{\\vec{x_6, x_5, ..., x_0}}_\\text{x} = 0111 \\space 1011\\\\\n\\therefore {B2T_w(-5) = 1111 \\space 1011}\n\\end{align}\n\n<h3 id=\"conversions-between-singed-and-unsigned\"><a class=\"anchor\" href=\"#conversions-between-singed-and-unsigned\">#</a> Conversions Between Singed and Unsigned</h3>\n\\begin{gather}\nU2B_w(x) = B2U_w^{-1}(x) \\\\\nT2B_w(x) = B2T_w^{-1}(x)\n\\end{gather}\n\n<p>These functions give the unsigned or two’s-complement bit patterns for a numeric value. Consider the function</p>\n\\begin{gather}\nU2T_w(x) = B2T_w(U2B_w(x))\n\\end{gather}\n\n<p>which takes a number between 0 and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>w</mi></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">2^w - 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.747722em;vertical-align:-0.08333em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> and yields a number between <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><mo>−</mo><msup><mn>2</mn><mrow><mi>w</mi><mo>−</mo><mn>1</mn></mrow></msup><mo separator=\"true\">,</mo><mtext> </mtext><msup><mn>2</mn><mrow><mi>w</mi><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[-2^{w - 1},\\space 2^{w - 1}]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">−</span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\"> </span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span></span>, where the two numbers have identical bit representations, except that the argument is unsigned, while the result has a two’s-complement representation. Conversely, the function</p>\n\\begin{gather}\nT2U_w(x) = B2U_w(T2B_w(x))\n\\end{gather}\n\n<p>yields the unsigned number having the same bit representation as the two’s-complement value of x.</p>\n<p>To get a better understanding of the relation between a signed number <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> and its unsigned counterpart <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi><mn>2</mn><msub><mi>U</mi><mi>w</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">T2U_w(x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord\">2</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span>, we can use the fact that they have identical bit representations to derive a numerical relationship.</p>\n\\begin{align}\nB2U_w(\\vec{x}) - B2T_w(\\vec{x}) = x_{w-1}(2^{w-1} - - 2^{w-1}) = x_{w-1}2^w \\\\\n\\end{align}\n\n<p>This gives a relationship <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mstyle mathcolor=\"red\"><mi>B</mi><mn>2</mn><msub><mi>U</mi><mi>w</mi></msub><mo stretchy=\"false\">(</mo><mover accent=\"true\"><mi>x</mi><mo>⃗</mo></mover><mo stretchy=\"false\">)</mo><mo>=</mo><msub><mi>x</mi><mrow><mi>w</mi><mo>−</mo><mn>1</mn></mrow></msub><msup><mn>2</mn><mi>w</mi></msup><mo>+</mo><mi>B</mi><mn>2</mn><msub><mi>T</mi><mi>w</mi></msub><mo stretchy=\"false\">(</mo><mover accent=\"true\"><mi>x</mi><mo>⃗</mo></mover><mo stretchy=\"false\">)</mo></mstyle></mrow><annotation encoding=\"application/x-tex\">\\textcolor{red}{B2U_w(\\vec{x}) = x_{w-1}2^w + B2T_w(\\vec{x})}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;color:red;\">B</span><span class=\"mord\" style=\"color:red;\">2</span><span class=\"mord\" style=\"color:red;\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;color:red;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\" style=\"color:red;\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;color:red;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\" style=\"color:red;\">(</span><span class=\"mord accent\" style=\"color:red;\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\" style=\"color:red;\"><span class=\"mord mathnormal\" style=\"color:red;\">x</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.20772em;\"><span class=\"overlay\" style=\"color:red;height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mclose\" style=\"color:red;\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\" style=\"color:red;\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8727229999999999em;vertical-align:-0.208331em;\"></span><span class=\"mord\" style=\"color:red;\"><span class=\"mord mathnormal\" style=\"color:red;\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\" style=\"color:red;\"><span class=\"mord mtight\" style=\"color:red;\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;color:red;\">w</span><span class=\"mbin mtight\" style=\"color:red;\">−</span><span class=\"mord mtight\" style=\"color:red;\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mord\" style=\"color:red;\"><span class=\"mord\" style=\"color:red;\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\" style=\"color:red;\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;color:red;\">w</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\" style=\"color:red;\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;color:red;\">B</span><span class=\"mord\" style=\"color:red;\">2</span><span class=\"mord\" style=\"color:red;\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;color:red;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\" style=\"color:red;\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;color:red;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\" style=\"color:red;\">(</span><span class=\"mord accent\" style=\"color:red;\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\" style=\"color:red;\"><span class=\"mord mathnormal\" style=\"color:red;\">x</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.20772em;\"><span class=\"overlay\" style=\"color:red;height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mclose\" style=\"color:red;\">)</span></span></span></span>. If we let <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo>=</mo><mi>B</mi><mn>2</mn><msub><mi>T</mi><mi>w</mi></msub><mo stretchy=\"false\">(</mo><mover accent=\"true\"><mi>x</mi><mo>⃗</mo></mover><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">x = B2T_w(\\vec{x})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord\">2</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.20772em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span>, we then have</p>\n\\begin{equation}\nB2U_w(T2B_w(x)) = T2U_w(x) = x_{w-1}2^w + x\n\\end{equation}\n\n<p>This relationship is useful for proving relationships between unsigned and two’s-complement arithmetic. In the two’s-complement representation of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span>, bit <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mrow><mi>w</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">x_{w-1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.638891em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span> determines whether or not <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> is negative, giving</p>\n\\begin{equation}\nT2U_w(x) = \n\\begin{cases}\nx + 2^w, & x \\lt 0\\\\\nx, & x \\ge 0\n\\end{cases}\n\\end{equation}\n\n<p><img data-src=\"https://pic.imgdb.cn/item/64a90fd21ddac507ccc20279.png\" alt=\"\" /><br />\nGoing in the other direction, we wish to derive the relationship between an unsigned number <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> and its signed counterpart <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>U</mi><mn>2</mn><msub><mi>T</mi><mi>w</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mi mathvariant=\"normal\">.</mi></mrow><annotation encoding=\"application/x-tex\">U2T_w(x).</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mord\">2</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mord\">.</span></span></span></span> If we let <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo>=</mo><mi>B</mi><mn>2</mn><msub><mi>U</mi><mi>x</mi></msub><mo stretchy=\"false\">(</mo><mover accent=\"true\"><mi>x</mi><mo>⃗</mo></mover><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">x = B2U_x(\\vec{x})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord\">2</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.20772em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> , then <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>x</mi><mo>⃗</mo></mover><mo>=</mo><mi>U</mi><mn>2</mn><mi>B</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\vec{x} = U2B(x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.714em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.20772em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span> we have</p>\n\\begin{equation}\nB2T_w(U2B_w(x)) = U2T_w(x) = -x_{w-1}2^w + x\n\\end{equation}\n\n<p>In the unsigned representation of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span>, bit <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mrow><mi>w</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">x_{w-1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.638891em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span> determines whether or not <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> is greater than or equal to <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mrow><mi>w</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding=\"application/x-tex\">2^{w-1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span></span></span></span>, giving</p>\n\\begin{equation}\nU2T_w(x) = \n\\begin{cases}\nx, & x \\lt 2^{w-1}\\\\\nx - 2^w, & x \\ge 2^{w-1}\n\\end{cases}\n\\end{equation}\n\n<p><img data-src=\"https://pic.imgdb.cn/item/64a90fd11ddac507ccc20139.png\" alt=\"\" /></p>\n<h2 id=\"225-expanding-the-bit-representation-of-a-number\"><a class=\"anchor\" href=\"#225-expanding-the-bit-representation-of-a-number\">#</a> 2.2.5 Expanding the Bit Representation of a Number</h2>\n<p>zero extension: To convert an unsigned number to a larger data type, we simply add leading 0s to the representation.</p>\n<p>sign extension: To convert an signed(two’s-complement) number to a larger data type, , add leading most significant bit to the representation.</p>\n\\begin{align}\nB2T_{w+1}([x_{w-1}, x_{w-1}, x_{w-2},...x_0]) &= -x_{w-1}2^w + [\\sum_0^{w-1}x_i2^i] \\\\\n&=  -x_{w-1}2^w + x_{w-1}2^{w-1}  +[\\sum_0^{w-2}x_i2^i] \\\\\n& = -x_{w-1}2^{w-1}  +[\\sum_0^{w-2}x_i2^i] \\\\\n& = B2T_w([x_{w-1},x_{w-2},...x_0]\n\\end{align}\n\n<h2 id=\"truncating-numbers\"><a class=\"anchor\" href=\"#truncating-numbers\">#</a> Truncating Numbers</h2>\n\\begin{align}\nB2U_w([x_{w-1}, x_{w-2},...x_0]) \\space mod \\space  2^k &= [\\sum_0^{w-1}x_i2^i]\\space mod\\space  2^k \\\\\n&= [\\sum_0^{k-1}x_i2^i] \\space mod \\space 2^k \\\\\n& = [\\sum_0^{k-1}x_i2^i] \\\\\n& = B2U_w([x_{k-1},x_{k-2},...x_0]\n\\end{align}\n\n<h3 id=\"241-fractional-binary-numbers\"><a class=\"anchor\" href=\"#241-fractional-binary-numbers\">#</a> 2.4.1 Fractional Binary Numbers</h3>\n<p>Fractional binary notation:</p>\n\\begin{equation}\nb = b_mb_{m-1}...b_1b_0.b_{-1}...b_{-n} = \\sum_{i=-n}^mi^i * b_i\n\\end{equation}\n\n<p>This notation is not efficient for representing <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>5</mn><mo>∗</mo><msup><mn>2</mn><mn>100</mn></msup></mrow><annotation encoding=\"application/x-tex\">5 * 2^{100}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span></span></span></span></span></span></span></span></span></span></span></span>, which would consist of the bit pattern 101 followed by 100 zeros. Instead, we would like to represent numbers in a form <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo>∗</mo><msup><mn>2</mn><mi>y</mi></msup></mrow><annotation encoding=\"application/x-tex\">x * 2^y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.46528em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.664392em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span></span></span></span></span></span></span></span> by giving the values of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span>.</p>\n<p>The IEEEE floating-point standard represents a number in a form <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi><mo>=</mo><mo stretchy=\"false\">(</mo><mo>−</mo><mn>1</mn><msup><mo stretchy=\"false\">)</mo><mi>s</mi></msup><mo>∗</mo><mi>M</mi><mo>∗</mo><msup><mn>2</mn><mi>E</mi></msup></mrow><annotation encoding=\"application/x-tex\">v = (-1)^s * M * 2^E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">−</span><span class=\"mord\">1</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8413309999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413309999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">E</span></span></span></span></span></span></span></span></span></span></span></p>\n<ul>\n<li>The sign s determines whether the number is negative ( s = 1) or positive (s = 0).</li>\n<li>The significant M is a fractional binary number that ranges either between 1 and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mo>−</mo><mi>ϵ</mi></mrow><annotation encoding=\"application/x-tex\">2 - \\epsilon</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">ϵ</span></span></span></span> or between 0 and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>−</mo><mi>ϵ</mi></mrow><annotation encoding=\"application/x-tex\">1 - \\epsilon</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">ϵ</span></span></span></span></li>\n<li>The exponent E weights the value by a (possibly negative ) power of 2.</li>\n</ul>\n<p>The bit representation of a floating-point number is divided into three fields to encode these values:</p>\n<ul>\n<li>The single sign bit s directly encodes the sign s.</li>\n<li>The k-bit exponent field <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mo>=</mo><msub><mn>3</mn><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><msub><mi>e</mi><mn>1</mn></msub><msub><mi>e</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">exp = 3_{k-1}...e_1e_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.852771em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord\">3</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> encodes the exponent E.</li>\n<li>The n-bit fraction field <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mo>=</mo><msub><mi>f</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><msub><mi>f</mi><mn>1</mn></msub><msub><mi>f</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">frac = f_{n - 1}...f_1f_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.902771em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> encodes the significant M.</li>\n</ul>\n<p>Normalized Values</p>\n<p>The bit pattern of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi><mi>x</mi><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">exp</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">p</span></span></span></span> is neither all 0s nor all 1s. The exponent value is <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi><mo>=</mo><mi>e</mi><mo>−</mo><mi>B</mi><mi>i</mi><mi>a</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">E = e - Bias</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span></span></span></span> where <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi></mrow><annotation encoding=\"application/x-tex\">e</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">e</span></span></span></span> is the unsigned number having bit representation <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi><mo>=</mo><msub><mi>e</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><msub><mi>e</mi><mn>1</mn></msub><msub><mi>e</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">e = e_{k-1}...e_1e_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.638891em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, and Bias is a bias value <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>b</mi><mi>i</mi><mi>a</mi><mi>s</mi><mo>=</mo><msup><mn>2</mn><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">bias = 2^{k - 1} - 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9324379999999999em;vertical-align:-0.08333em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8491079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>. <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>M</mi><mo>=</mo><mn>1</mn><mo>+</mo><mn>0.</mn><msub><mi>f</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><msub><mi>f</mi><mn>1</mn></msub><msub><mi>f</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">M = 1 + 0.f_{n-1}...f_1f_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.902771em;vertical-align:-0.208331em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></p>\n<p>Denormalized Values</p>\n<p>When the exponent field is all 0s.</p>\n<ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi><mo>=</mo><mn>1</mn><mo>−</mo><mi>B</mi><mi>i</mi><mi>a</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">E = 1 - Bias</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span></span></span></span></li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>M</mi><mo>=</mo><mi>f</mi></mrow><annotation encoding=\"application/x-tex\">M = f</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span></span></li>\n</ul>\n<p>Special Values</p>\n<ul>\n<li>Infinity: When the exponent field is all 1s and the fraction field is all 0s.</li>\n<li>NaN: When the exponent field is all 1s but the fraction field is nonzero.</li>\n</ul>\n<p>Problem 2.33: k = 2, n = 2,  <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>b</mi><mi>i</mi><mi>a</mi><mi>s</mi><mo>=</mo><msup><mn>2</mn><mrow><mn>2</mn><mo>−</mo><mn>1</mn></mrow></msup><mo>−</mo><mn>1</mn><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">bias = 2^{2 - 1} -1 = 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.897438em;vertical-align:-0.08333em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span></p>\n<table>\n<thead>\n<tr>\n<th>Bits</th>\n<th>e</th>\n<th>E</th>\n<th>f</th>\n<th>M</th>\n<th>V</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0 00 00</td>\n<td>0</td>\n<td>0 ( 1 - bias)</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>0 00 01</td>\n<td>0</td>\n<td>0 ( 1 - bias)</td>\n<td>1/4</td>\n<td>1/4</td>\n<td>1/4</td>\n</tr>\n<tr>\n<td>0 00 10</td>\n<td>0</td>\n<td>0 ( 1 - bias)</td>\n<td>2/4</td>\n<td>2/4</td>\n<td>2/4</td>\n</tr>\n<tr>\n<td>0 00 11</td>\n<td>0</td>\n<td>0 ( 1 - bias)</td>\n<td>3/4</td>\n<td>3/4</td>\n<td>3/4</td>\n</tr>\n<tr>\n<td>0 01 00</td>\n<td>1</td>\n<td>0 ( e - bias)</td>\n<td>0</td>\n<td>4/4</td>\n<td>4/4</td>\n</tr>\n<tr>\n<td>0 01 01</td>\n<td>1</td>\n<td>0</td>\n<td>1/4</td>\n<td>5/4</td>\n<td>5/4</td>\n</tr>\n<tr>\n<td>0 01 10</td>\n<td>1</td>\n<td>0</td>\n<td>2/4</td>\n<td>6/4</td>\n<td>6/4</td>\n</tr>\n<tr>\n<td>0 01 11</td>\n<td>1</td>\n<td>0</td>\n<td>3/4</td>\n<td>7/4</td>\n<td>7/4</td>\n</tr>\n<tr>\n<td>0 10 00</td>\n<td>2</td>\n<td>1</td>\n<td>0</td>\n<td>4/4</td>\n<td>8/4</td>\n</tr>\n<tr>\n<td>0 10 01</td>\n<td>2</td>\n<td>1</td>\n<td>1/4</td>\n<td>5/4</td>\n<td>10/4</td>\n</tr>\n<tr>\n<td>0 10 10</td>\n<td>2</td>\n<td>1</td>\n<td>2/4</td>\n<td>6/4</td>\n<td>12/4</td>\n</tr>\n<tr>\n<td>0 10 11</td>\n<td>2</td>\n<td>1</td>\n<td>3/4</td>\n<td>7/4</td>\n<td>14/4</td>\n</tr>\n<tr>\n<td>0 11 00</td>\n<td>-</td>\n<td>-</td>\n<td>-</td>\n<td>-</td>\n<td><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>+</mo><mi mathvariant=\"normal\">∞</mi></mrow><annotation encoding=\"application/x-tex\">+\\infty</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord\">+</span><span class=\"mord\">∞</span></span></span></span></td>\n</tr>\n<tr>\n<td>0 11 01</td>\n<td>-</td>\n<td>-</td>\n<td>-</td>\n<td>-</td>\n<td>NaN</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": []
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/05/07/word-card-user-manual/",
            "url": "https://limxtop1989.github.io/limxtop/2023/05/07/word-card-user-manual/",
            "title": "Android 单词卡片使用手册",
            "date_published": "2023-05-07T08:05:05.000Z",
            "content_html": "<h1 id=\"目录\"><a class=\"anchor\" href=\"#目录\">#</a> 目录</h1>\n<ol>\n<li>单词卡片效果图</li>\n<li>Android  单词卡片应用下载</li>\n<li>下载安装 GoldenDict 应用</li>\n<li>下载词库文件并放置在 GoldenDict 目录</li>\n</ol>\n<h1 id=\"单词卡片效果图\"><a class=\"anchor\" href=\"#单词卡片效果图\">#</a> 单词卡片效果图</h1>\n<p><img data-src=\"https://pic1.imgdb.cn/item/646de6540d2dde57771ab200.gif\" alt=\"\" /><br />\n使用艾宾浩斯遗忘曲线调度记忆任务。对于不懂的单词，可以点击搜索框，弹窗显示词典，目前提供朗文英英，牛津英汉等词典，丰富的释义，词源，例句和朗读例句，在丰富的链接下，让学习者掌握它的含义，用法和并训练听力，读～～写～～听说，雨露均沾。私以为，单纯记忆一个单词背后的汉语意思，只能知道它的含义，无法掌握它的用法，更不会听说。我们国人的哑巴英语就是这样学成的。关于我们很多国人没能掌握英语听说能力的根源及其有效学习掌握英语的方法，在<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iZXdhdGVycy5tZS9saW14dG9wLzIwMjEvMDgvMTgvRW5nbGlzaC1pbnRyb2R1Y3Rpb24v\">英语自学指南</span>详细解释叙述，欢迎阅读。</p>\n<h1 id=\"使用示例\"><a class=\"anchor\" href=\"#使用示例\">#</a> 使用示例</h1>\n<p>比方说，dish 是个初级词汇，我们很早就知道，它是盘子的意思，恐怕我们很多人也仅知道如此，但这对于我们语言表达还是词穷的。所以就算单词我们已经学过了，依然需要按照科学的方式重新学习。GoldenDict 一查，好家伙，居然还有这么多名词意思。（后面的汉字是为了表达清晰，具体学习，千万别去想中文含义，原则依然是用英语学习英语，看到 dish，不应该想到盘子，而是图画，或者英文释义或者例句，如果可以自己造句就更棒了）</p>\n<p>dish<br />\na flat container with low sides, for serving food from or cooking food in ⇨ bowl:<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2023/06/07/327fabf5e4a1a030.png\" alt=\"\" /></p>\n<ul>\n<li>a big dish of curry (量词，一盘菜）</li>\n<li>wash, dry put away, etc the dishes (泛指餐具，不仅是盘子了）</li>\n<li>a restaurant specializing in Indonesian dishes (风味）</li>\n<li>This soup is substantial enough to serve as a main dish (主菜）</li>\n<li>Mary's new boy-friend's quite a dish, isn't he? （帅气）</li>\n</ul>\n<p>还可以当动词用，想不到吧。</p>\n<ul>\n<li>The scandal dished his hope of being elected. (使破灭）</li>\n<li>Don't get into a fight with him: he can really dish it out. (attack sb fiercely with words or blows)</li>\n<li>There were students dishing out leaflets to passers-by.</li>\n<li>Could you dish up the fruits?</li>\n</ul>\n<p>看下相关的词汇。</p>\n<ul>\n<li>dishful: About as much as a dish will hold.</li>\n<li>dishy: physically attractive, or handsome.</li>\n<li>dishcloth: Cloth for washing dish.</li>\n<li>dishwasher: Machine or person that washes dishes.</li>\n<li>dish-water: Water used for washing dishes. (Her coffee tastes like dish-water)</li>\n</ul>\n<p>相似词</p>\n<ul>\n<li>food noun [uncountable and countable] things that people and animals eat: You can buy good fresh food in the market. | Do you like Japanese food?</li>\n<li>dish noun [countable] a type of food that is cooked in a particular way: a traditional English dish | They also offer vegetarian dishes.</li>\n<li>speciality British English, specialty American English noun [countable] a type of food that a restaurant or place is famous for: Fish dishes are a specialty of the region. | Home made pies are one of the hotel’s specialities.</li>\n<li>delicacy noun [countable] an unusual food which people in a particular place like to eat: The local delicacies include laverbread (boiled seaweed). | I was keen to try out the local delicacies.</li>\n<li>diet noun [countable] the type of food that someone usually eats: You shouldn’t have too much salt in your diet. | In the Andes, the main diet is beans, potatoes, and corn.</li>\n<li>cooking noun [uncountable] food made in a particular way, or by a particular person: Herbs are used a lot in French cooking. | I love my Mum’s home cooking.</li>\n<li>cuisine /kwɪˈziːn/ noun [countable] formal the food you can eat in a particular restaurant, country, or area: Italian cuisine | Trying the local cuisine is all part of the fun of travelling.</li>\n<li>nutrition noun [uncountable] food considered as something that is necessary for good health and growth: a book on nutrition | Many homeless people suffer from poor nutrition.</li>\n<li>nourishment /ˈnʌrɪʃmənt $ ˈnɜː-, ˈnʌ-/ noun [uncountable] goodness that you get from food, which helps your body to stay healthy: There's not much nourishment in fast food.</li>\n<li>fare noun [uncountable] formal the kind of food that is served in a place – used especially when saying how interesting it is: In China you can feast on bird’s nest soup and other exotic fare. | Dinner was pretty standard fare (=the usual kind of food).</li>\n</ul>\n<p>还有哦，再把情景下有关联的有用词汇照此学一遍。<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2023/06/03/86537a7659d0f73c.bmp\" alt=\"\" /></p>\n<p><img data-src=\"https://s3.uuu.ovh/imgs/2023/06/03/278784343549929c.bmp\" alt=\"\" /><br />\n天哪噜了。就一个小学词汇，把我一个大学毕业多年的人，一天学习词汇的时间额度给用光了，感觉收获满满呢。</p>\n<h1 id=\"单词卡片下载\"><a class=\"anchor\" href=\"#单词卡片下载\">#</a> 单词卡片下载</h1>\n<ol>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wbGF5Lmdvb2dsZS5jb20vc3RvcmUvYXBwcy9kZXRhaWxzP2lkPWNvbS5tYXhpbS53b3JkY2FyZC5mcmVl\">单词记忆闪卡</span> 点击链接安装，需要你手机有 Play Store。</li>\n</ol>\n<h1 id=\"下载安装-goldendict\"><a class=\"anchor\" href=\"#下载安装-goldendict\">#</a> 下载安装 GoldenDict</h1>\n<p>选择以下一个可用方案下载安装即可</p>\n<ol>\n<li>点击单词记忆闪卡右上角菜单 -&gt; 点击辞典 -&gt; 选择某个版本的 GoldenDict 安装，免费为宜。</li>\n<li><span class=\"exturl\" data-url=\"aHR0cDovL2dvbGRlbmRpY3QubW9iaS9kb3dubG9hZHMvYW5kcm9pZC9mcmVlLw==\">http://goldendict.mobi/downloads/android/free/</span> 选择某个版本下载安装即可。</li>\n<li>下载链接： <span class=\"exturl\" data-url=\"aHR0cDovL21hcmtldC5hbmRyb2lkLmNvbS9kZXRhaWxzP2lkPW1vYmkuZ29sZGVuZGljdC5hbmRyb2lkLmZyZWU=\">http://market.android.com/details?id=mobi.goldendict.android.free</span></li>\n<li>如果用浏览器无法下载安装 GoldenDict，自行打开 Android 手机自带的应用市场，搜素 GoldenDict，如果这里搜索的到，下载安装亦可。</li>\n</ol>\n<p>第一次启动会提示安装词库（如下图），并在 Android 手机存储器根目录创建 GoldenDict 目录（即文件夹）<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2023/05/07/41790adbafc47528.png\" width=\"30%\" height = \"30%\"></p>\n<h1 id=\"下载词库文件\"><a class=\"anchor\" href=\"#下载词库文件\">#</a> 下载词库文件</h1>\n<p>选择以下一个可用方案下载安装即可</p>\n<ol>\n<li>点击单词记忆闪卡右上角菜单 -&gt; 点击辞典 -&gt; 选择你需要的辞典下载即可，程序会帮你将文件放置在手机存储器根目录下的 GoldenDict 目录<br />\n下载链接: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMW9WNkF4UlVsWDFjN21wRTM1MmJ0OHc=\">https://pan.baidu.com/s/1oV6AxRUlX1c7mpE352bt8w</span> 提取码: uxtw</li>\n<li>Android 手机下载以下词库文件即可，下载完毕<strong>解压</strong>（注意⚠️，必须解压），并放到手机存储器的 GoldenDict 目录。具体操作步骤可参考下一节，或者自行 Google 百度。</li>\n</ol>\n<ul>\n<li>En-En_Longman_DOCE5</li>\n<li>En-En_Merriam_Webster11</li>\n<li>En-En_OALD8</li>\n<li>Oxford_Advanced_Learner_English-Chinese_Dictionary-4th.bgl</li>\n</ul>\n<p>作为参考和对照，这个是我 Android Pixel 手机 File 应用打开的 GoldenDict 目录截图<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2023/05/07/367486e3a757df2e.png\" width=\"30%\" height = \"30%\"></p>\n<p>重新启动 GoldenDict，开始索引词库。完毕后可以在搜索框输入单词查询。<br />\n<img data-src=\"https://s3.uuu.ovh/imgs/2023/05/07/969c769bb87bb2ba.png\" width=\"30%\" height = \"30%\"></p>\n<h2 id=\"电脑手机文件传输\"><a class=\"anchor\" href=\"#电脑手机文件传输\">#</a> 电脑手机文件传输</h2>\n<h3 id=\"windows-计算机\"><a class=\"anchor\" href=\"#windows-计算机\">#</a> Windows 计算机</h3>\n<ol>\n<li>解锁手机。</li>\n<li>使用 USB 数据线将手机连接到计算机。</li>\n<li>在手机上，点按 “正在通过 USB 为此设备充电” 通知。</li>\n<li>在 “USB 的用途” 下，选择文件传输。</li>\n<li>计算机上将打开一个文件传输窗口。请使用该窗口拖动文件。</li>\n<li>完成后，从 Windows 中弹出您的手机。</li>\n<li>拔下 USB 数据线。</li>\n</ol>\n<h3 id=\"mac-计算机\"><a class=\"anchor\" href=\"#mac-计算机\">#</a> Mac 计算机</h3>\n<ol>\n<li>在您的计算机上下载并安装 <span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5hbmRyb2lkLmNvbS9maWxldHJhbnNmZXIv\">Android 文件传输</span>。</li>\n<li>打开 Android 文件传输。在您下次连接手机时，该应用会自动打开。</li>\n<li>解锁手机。</li>\n<li>使用 USB 数据线将手机连接到计算机。</li>\n<li>在手机上，点按 “正在通过 USB 为此设备充电” 通知。</li>\n<li>在 “USB 的用途” 下，选择文件传输。</li>\n<li>计算机上将打开一个 Android 文件传输窗口。请使用该窗口拖动文件。</li>\n<li>完成后，拔下 USB 数据线。</li>\n</ol>\n<h1 id=\"最后\"><a class=\"anchor\" href=\"#最后\">#</a> 最后</h1>\n<p>应用图标由久未联系的足球队友余朝阳协助制作，在此特别鸣谢。设计理念由我匆忙提出，雪花和荧光元素寓意囊萤映雪，而 hello word 则与程序员学新语言写的第一个程序输出的传统文化一脉相承，希望大家可以坚持轻松愉悦学习，最后轻松驾驭英语。</p>\n<p>如果有遇到任何问题，特别是下载词库文件并放置在手机存储器指定目录这个步骤。欢迎留下评论或者给我邮件 <span class=\"exturl\" data-url=\"bWFpbHRvOmxpbXh0b3BAZ21haWwuY29t\">limxtop@gmail.com</span> ，我会尽力协助。</p>\n",
            "tags": [
                "单词卡片, word card"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/03/11/canvas-graphic-transform/",
            "url": "https://limxtop1989.github.io/limxtop/2023/03/11/canvas-graphic-transform/",
            "title": "Android 双指触控 位移 缩放 旋转",
            "date_published": "2023-03-11T13:13:48.000Z",
            "content_html": "<h1 id=\"效果\"><a class=\"anchor\" href=\"#效果\">#</a> 效果</h1>\n<p><img data-src=\"https://pic.imgdb.cn/item/6410989cebf10e5d53bddfb4.gif\" alt=\"demo\" /></p>\n<h1 id=\"代码实现\"><a class=\"anchor\" href=\"#代码实现\">#</a> 代码实现</h1>\n<figure class=\"highlight kotlin\"><figcaption data-lang=\"kotlin\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>opengl</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> android<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span>Context</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> android<span class=\"token punctuation\">.</span>graphics<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> android<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>MotionEvent</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> android<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">.</span>View</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>opengl<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>Constants</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>maxim<span class=\"token punctuation\">.</span>opengl<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>VLog</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> kotlin<span class=\"token punctuation\">.</span>math<span class=\"token punctuation\">.</span>acos</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> kotlin<span class=\"token punctuation\">.</span>math<span class=\"token punctuation\">.</span>asin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">import</span> kotlin<span class=\"token punctuation\">.</span>math<span class=\"token punctuation\">.</span>sqrt</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token function\">TouchEventView</span><span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">View</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> rect<span class=\"token operator\">:</span> RectF <span class=\"token operator\">=</span> <span class=\"token function\">RectF</span><span class=\"token punctuation\">(</span><span class=\"token number\">0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">400f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">400f</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> desRect <span class=\"token operator\">=</span> <span class=\"token function\">RectF</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> matrixST <span class=\"token operator\">=</span> <span class=\"token function\">Matrix</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> paint<span class=\"token operator\">:</span> Paint <span class=\"token operator\">=</span> <span class=\"token function\">Paint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">init</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        paint<span class=\"token punctuation\">.</span>color <span class=\"token operator\">=</span> Color<span class=\"token punctuation\">.</span>RED</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> downX<span class=\"token operator\">:</span> Float <span class=\"token operator\">=</span> <span class=\"token number\">0f</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> downY<span class=\"token operator\">:</span> Float <span class=\"token operator\">=</span> <span class=\"token number\">0f</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> downPointerX<span class=\"token operator\">:</span> Float <span class=\"token operator\">=</span> <span class=\"token number\">0f</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> downPointerY<span class=\"token operator\">:</span> Float <span class=\"token operator\">=</span> <span class=\"token number\">0f</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> dx<span class=\"token operator\">:</span> Float <span class=\"token operator\">=</span> <span class=\"token number\">0f</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> dy<span class=\"token operator\">:</span> Float <span class=\"token operator\">=</span> <span class=\"token number\">0f</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> scale<span class=\"token operator\">:</span> Float <span class=\"token operator\">=</span> <span class=\"token number\">1f</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> angle<span class=\"token operator\">:</span> Float <span class=\"token operator\">=</span> <span class=\"token number\">0f</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onTouchEvent</span><span class=\"token punctuation\">(</span>event<span class=\"token operator\">:</span> MotionEvent<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Boolean <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>actionMasked<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            MotionEvent<span class=\"token punctuation\">.</span>ACTION_DOWN <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                downX <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getX</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                downY <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getY</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            MotionEvent<span class=\"token punctuation\">.</span>ACTION_POINTER_DOWN <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                downX <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getX</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                downY <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getY</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                downPointerX <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getX</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                downPointerY <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getY</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            MotionEvent<span class=\"token punctuation\">.</span>ACTION_MOVE <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>pointerCount <span class=\"token operator\">&lt;=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    <span class=\"token function\">translate</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                    <span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                    <span class=\"token function\">zoom</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            MotionEvent<span class=\"token punctuation\">.</span>ACTION_POINTER_UP <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                <span class=\"token keyword\">val</span> remainIndex <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>actionIndex <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span> <span class=\"token keyword\">else</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                downX <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getX</span><span class=\"token punctuation\">(</span>remainIndex<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> dx</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                downY <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getY</span><span class=\"token punctuation\">(</span>remainIndex<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> dy</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            MotionEvent<span class=\"token punctuation\">.</span>ACTION_UP<span class=\"token punctuation\">,</span> MotionEvent<span class=\"token punctuation\">.</span>ACTION_CANCEL <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                <span class=\"token comment\">// NOP.</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            <span class=\"token keyword\">else</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                <span class=\"token comment\">// NOP.</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        <span class=\"token function\">invalidate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">translate</span><span class=\"token punctuation\">(</span>event<span class=\"token operator\">:</span> MotionEvent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        dx <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getX</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> downX</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        dy <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getY</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> downY</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">zoom</span><span class=\"token punctuation\">(</span>event<span class=\"token operator\">:</span> MotionEvent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token keyword\">val</span> prev <span class=\"token operator\">=</span> <span class=\"token function\">distance</span><span class=\"token punctuation\">(</span>downX<span class=\"token punctuation\">,</span> downY<span class=\"token punctuation\">,</span> downPointerX<span class=\"token punctuation\">,</span> downPointerY<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token keyword\">val</span> next <span class=\"token operator\">=</span> <span class=\"token function\">distance</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            event<span class=\"token punctuation\">.</span><span class=\"token function\">getX</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getY</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            event<span class=\"token punctuation\">.</span><span class=\"token function\">getX</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getY</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        scale <span class=\"token operator\">=</span> next <span class=\"token operator\">/</span> prev</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>event<span class=\"token operator\">:</span> MotionEvent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token keyword\">val</span> pointerX <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getX</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token keyword\">val</span> pointerY <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">getY</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token comment\">// multiply y component by -1 to make y-axis points up.</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        <span class=\"token comment\">// which maps view coordinate system to right-hand coordinate system.</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token keyword\">val</span> prevVector <span class=\"token operator\">=</span> <span class=\"token function\">Vector</span><span class=\"token punctuation\">(</span>downPointerX <span class=\"token operator\">-</span> downX<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token punctuation\">(</span>downPointerY <span class=\"token operator\">-</span> downY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0f</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token keyword\">val</span> nextVector <span class=\"token operator\">=</span> <span class=\"token function\">Vector</span><span class=\"token punctuation\">(</span>pointerX <span class=\"token operator\">-</span> event<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token punctuation\">(</span>pointerY <span class=\"token operator\">-</span> event<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0f</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token keyword\">val</span> cp<span class=\"token operator\">:</span> Vector <span class=\"token operator\">=</span> prevVector<span class=\"token punctuation\">.</span><span class=\"token function\">crossProduct</span><span class=\"token punctuation\">(</span>nextVector<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        <span class=\"token comment\">// direction is 1 if the angle the next vector rotates with clockwise direction by</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token comment\">// from previous vector locates at [0, PI], otherwise is -1 if locates at [PI , 2 PI]</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        <span class=\"token keyword\">val</span> direction <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cp<span class=\"token punctuation\">.</span>z <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> Rotate<span class=\"token punctuation\">.</span>CLOCKWISE<span class=\"token punctuation\">.</span>direction  <span class=\"token keyword\">else</span> Rotate<span class=\"token punctuation\">.</span>COUNTER_CLOCKWISE<span class=\"token punctuation\">.</span>direction</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token comment\">// radian represent the angle between the two vectors, whose value locates in [0, PI] always.</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token keyword\">val</span> radian <span class=\"token operator\">=</span> <span class=\"token function\">acos</span><span class=\"token punctuation\">(</span>prevVector<span class=\"token punctuation\">.</span><span class=\"token function\">dotProduct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>nextVector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>prevVector<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> nextVector<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        angle <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>radian <span class=\"token operator\">*</span> <span class=\"token number\">180</span> <span class=\"token operator\">/</span> Math<span class=\"token punctuation\">.</span>PI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFloat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> direction</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        VLog<span class=\"token punctuation\">.</span><span class=\"token function\">d</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token interpolation variable\">$cp</span>, <span class=\"token interpolation variable\">$radian</span>, <span class=\"token interpolation variable\">$angle</span>\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">distance</span><span class=\"token punctuation\">(</span>x1<span class=\"token operator\">:</span> Float<span class=\"token punctuation\">,</span> y1<span class=\"token operator\">:</span> Float<span class=\"token punctuation\">,</span> x2<span class=\"token operator\">:</span> Float<span class=\"token punctuation\">,</span> y2<span class=\"token operator\">:</span> Float<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Float <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        <span class=\"token keyword\">val</span> deltaX <span class=\"token operator\">=</span> x1 <span class=\"token operator\">-</span> x2</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token keyword\">val</span> deltaY <span class=\"token operator\">=</span> y1 <span class=\"token operator\">-</span> y2</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>deltaX <span class=\"token operator\">*</span> deltaX <span class=\"token operator\">+</span> deltaY <span class=\"token operator\">*</span> deltaY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toDouble</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFloat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onDraw</span><span class=\"token punctuation\">(</span>canvas<span class=\"token operator\">:</span> Canvas<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onDraw</span><span class=\"token punctuation\">(</span>canvas<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        matrixST<span class=\"token punctuation\">.</span><span class=\"token function\">reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        matrixST<span class=\"token punctuation\">.</span><span class=\"token function\">postScale</span><span class=\"token punctuation\">(</span>scale<span class=\"token punctuation\">,</span> scale<span class=\"token punctuation\">,</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">centerX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> rect<span class=\"token punctuation\">.</span><span class=\"token function\">centerY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        matrixST<span class=\"token punctuation\">.</span><span class=\"token function\">postTranslate</span><span class=\"token punctuation\">(</span>dx<span class=\"token punctuation\">,</span> dy<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        matrixST<span class=\"token punctuation\">.</span><span class=\"token function\">mapRect</span><span class=\"token punctuation\">(</span>desRect<span class=\"token punctuation\">,</span> rect<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        canvas<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        <span class=\"token comment\">// clockwise when degrees is positive.</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        canvas<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">rotate</span><span class=\"token punctuation\">(</span>angle<span class=\"token punctuation\">,</span> desRect<span class=\"token punctuation\">.</span><span class=\"token function\">centerX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> desRect<span class=\"token punctuation\">.</span><span class=\"token function\">centerY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        canvas<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">drawRect</span><span class=\"token punctuation\">(</span>desRect<span class=\"token punctuation\">,</span> paint<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        canvas<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">restore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token keyword\">enum</span> <span class=\"token keyword\">class</span> <span class=\"token function\">Rotate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> direction<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        <span class=\"token function\">CLOCKWISE</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        <span class=\"token function\">COUNTER_CLOCKWISE</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>    <span class=\"token keyword\">class</span> <span class=\"token function\">Vector</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> x<span class=\"token operator\">:</span> Float<span class=\"token punctuation\">,</span> <span class=\"token keyword\">val</span> y<span class=\"token operator\">:</span> Float<span class=\"token punctuation\">,</span> <span class=\"token keyword\">val</span> z<span class=\"token operator\">:</span> Float<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        <span class=\"token keyword\">fun</span> <span class=\"token function\">dotProduct</span><span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> Vector<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Float <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>            <span class=\"token keyword\">return</span> x <span class=\"token operator\">*</span> v<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> y <span class=\"token operator\">*</span> v<span class=\"token punctuation\">.</span>y <span class=\"token operator\">+</span> z <span class=\"token operator\">*</span> v<span class=\"token punctuation\">.</span>z</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        <span class=\"token keyword\">fun</span> <span class=\"token function\">crossProduct</span><span class=\"token punctuation\">(</span>v<span class=\"token operator\">:</span> Vector<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Vector <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">Vector</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                y <span class=\"token operator\">*</span> v<span class=\"token punctuation\">.</span>z <span class=\"token operator\">-</span> z <span class=\"token operator\">*</span> v<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>                <span class=\"token operator\">-</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> v<span class=\"token punctuation\">.</span>z <span class=\"token operator\">-</span> z <span class=\"token operator\">*</span> v<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>                x <span class=\"token operator\">*</span> v<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> y <span class=\"token operator\">*</span> v<span class=\"token punctuation\">.</span>x</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>            <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>        <span class=\"token keyword\">fun</span> <span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Double <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> x <span class=\"token operator\">+</span> y <span class=\"token operator\">*</span> y <span class=\"token operator\">+</span> z <span class=\"token operator\">*</span> z<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toDouble</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token string\">\"(<span class=\"token interpolation variable\">$x</span>, <span class=\"token interpolation variable\">$y</span>, <span class=\"token interpolation variable\">$z</span>)\"</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>        <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>            <span class=\"token keyword\">fun</span> <span class=\"token function\">crossProduct</span><span class=\"token punctuation\">(</span>v1<span class=\"token operator\">:</span> Vector<span class=\"token punctuation\">,</span> v2<span class=\"token operator\">:</span> Vector<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Float <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>                <span class=\"token keyword\">return</span> v1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*</span> v2<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> v1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*</span> v2<span class=\"token punctuation\">.</span>x</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>            <span class=\"token keyword\">fun</span> <span class=\"token function\">dotProduct</span><span class=\"token punctuation\">(</span>v1<span class=\"token operator\">:</span> Vector<span class=\"token punctuation\">,</span> v2<span class=\"token operator\">:</span> Vector<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Float <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>                <span class=\"token keyword\">return</span> v1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*</span> v2<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> v1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*</span> v2<span class=\"token punctuation\">.</span>y</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://s3.uuu.ovh/imgs/2023/03/15/3519b041b587e7e5.png\" alt=\"cross product and dot product\" /></p>\n<h1 id=\"向量点乘-dot-product\"><a class=\"anchor\" href=\"#向量点乘-dot-product\">#</a> 向量点乘 Dot Product</h1>\n\\begin{equation}\n\\vec{AB} \\cdot \\vec{AC} = \\parallel \\vec{AB} \\parallel * \\parallel \\vec{AC} \\parallel * \\cos\\theta  \\label{dotproduct} \\tag{1}\n\\end{equation}\n\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>B</mi></mrow><mo>⃗</mo></mover><mo>⋅</mo><mover accent=\"true\"><mrow><mi>A</mi><mi>D</mi></mrow><mo>⃗</mo></mover><mo>=</mo><mo>∥</mo><mover accent=\"true\"><mrow><mi>A</mi><mi>B</mi></mrow><mo>⃗</mo></mover><mo>∥</mo><mo>∗</mo><mo>∥</mo><mover accent=\"true\"><mrow><mi>A</mi><mi>D</mi></mrow><mo>⃗</mo></mover><mo>∥</mo><mo>∗</mo><mi>cos</mi><mo>⁡</mo><mi>θ</mi></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(2)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\vec{AB} \\cdot \\vec{AD} = \\parallel \\vec{AB} \\parallel * \\parallel \\vec{AD} \\parallel * \\cos\\theta \\tag{2}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mrel\">∥</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.21633em;vertical-align:-0.25em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∥</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∥</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.21633em;vertical-align:-0.25em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∥</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\">∗</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">cos</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span></span><span class=\"tag\"><span class=\"strut\" style=\"height:1.21633em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">2</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>θ</mi></mrow><annotation encoding=\"application/x-tex\">\\theta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span></span></span></span> 的取值范围为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mi>π</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[0, \\pi]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">π</span><span class=\"mclose\">]</span></span></span></span>，由于从<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>B</mi></mrow><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{AB}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span> 顺时针旋转到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>C</mi></mrow><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{AC}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span> 和从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>B</mi></mrow><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{AB}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span> 顺时针旋转到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>D</mi></mrow><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{AD}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span> 计算出来的<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>θ</mi></mrow><annotation encoding=\"application/x-tex\">\\theta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span></span></span></span> 是一样的，无法区分。而对于 <code>Canvas.rotate(degree)</code> ，当 <code>degree &gt; 0 </code> ，表示从向右方向顺时针旋转，当 <code>degree &lt; 0 </code> 时，表示向右方向逆时针旋转。所以，对于从<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>B</mi></mrow><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{AB}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span> 顺时针旋转 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>θ</mi><mo>+</mo><mn>2</mn><mo>∗</mo><mo stretchy=\"false\">(</mo><mi>π</mi><mo>−</mo><mi>θ</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mn>2</mn><mi>π</mi><mo>−</mo><mi>θ</mi></mrow><annotation encoding=\"application/x-tex\">\\theta + 2 * (\\pi - \\theta) =  2 \\pi - \\theta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">π</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">π</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span></span></span></span> 到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>D</mi></mrow><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{AD}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span>，相当于从<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>B</mi></mrow><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{AB}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span> 逆时针旋转 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>θ</mi></mrow><annotation encoding=\"application/x-tex\">\\theta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span></span></span></span> 到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>D</mi></mrow><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{AD}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span>。 也即公示\\ref{dotproduct} 所求 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>θ</mi><mo>∗</mo><mi>d</mi><mi>i</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">\\theta * direction</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">θ</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span></span></span></span> 即可。+1 表示顺时针， -1 表示逆时针，而 direction 的值可由叉乘计算得出。</p>\n<h1 id=\"向量叉乘-cross-product\"><a class=\"anchor\" href=\"#向量叉乘-cross-product\">#</a> 向量叉乘 Cross Product</h1>\n<p>如图左手坐标系，使用左手法则。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>B</mi></mrow><mo>⃗</mo></mover><mo>×</mo><mover accent=\"true\"><mrow><mi>A</mi><mi>C</mi></mrow><mo>⃗</mo></mover><mo>=</mo><mover accent=\"true\"><msub><mi>N</mi><mi>c</mi></msub><mo>⃗</mo></mover></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(3)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\vec{AB} \\times \\vec{AC} = \\vec{N_c} \\tag{3}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0496599999999998em;vertical-align:-0.08333em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1163299999999998em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"tag\"><span class=\"strut\" style=\"height:1.21633em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">3</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mi>N</mi><mi>c</mi></msub><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{N_c}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.1163299999999998em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 指向 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>−</mo><mi>z</mi><mo separator=\"true\">,</mo><mi>d</mi><mi>i</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">-z, direction = +1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">−</span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">+</span><span class=\"mord\">1</span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mover accent=\"true\"><mrow><mi>A</mi><mi>B</mi></mrow><mo>⃗</mo></mover><mo>×</mo><mover accent=\"true\"><mrow><mi>A</mi><mi>D</mi></mrow><mo>⃗</mo></mover><mo>=</mo><mover accent=\"true\"><msub><mi>N</mi><mi>d</mi></msub><mo>⃗</mo></mover></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(4)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\vec{AB} \\times \\vec{AD} = \\vec{N_d} \\tag{4}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0496599999999998em;vertical-align:-0.08333em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9663299999999999em;vertical-align:0em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1163299999999998em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">d</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"tag\"><span class=\"strut\" style=\"height:1.21633em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">4</span></span><span class=\"mord\">)</span></span></span></span></span></span></p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><msub><mi>N</mi><mi>d</mi></msub><mo>⃗</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\vec{N_d}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.1163299999999998em;vertical-align:-0.15em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663299999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">d</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span> 指向 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>+</mo><mi>z</mi><mo separator=\"true\">,</mo><mi>d</mi><mi>i</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">+z, direction = -1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">+</span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">−</span><span class=\"mord\">1</span></span></span></span></p>\n<h1 id=\"参考\"><a class=\"anchor\" href=\"#参考\">#</a> 参考</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8yNjgyNDkyMS8=\">Introduction to Linear Algebra</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vZGV2ZWxvcC91aS92aWV3cy90b3VjaC1hbmQtaW5wdXQvZ2VzdHVyZXMvbXVsdGk=\">Android multiple touch event</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82ODQ0OTA0MTYyNzQ0ODYwNjg1\">使用斜率计算旋转角度</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82ODQ0OTA0MTY2NzAwMDg5MzUx\">使用向量计算旋转角度</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82NDcwNzI1OQ==\">三维叉乘 &amp; 坐标系</span></li>\n</ul>\n",
            "tags": [
                "Android",
                "Android Translate Scale Rotate, multiple touch event, Android 双指触控，位移，缩放，旋转"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/02/25/notice-time/",
            "url": "https://limxtop1989.github.io/limxtop/2023/02/25/notice-time/",
            "title": "看见时间",
            "date_published": "2023-02-25T03:53:23.000Z",
            "content_html": "<p>因缘巧合，在毕业两年多后的一趟公交车外，我看见了时间，明白了它到底是何物。</p>\n<p>那个上班等车的清晨，姗姗来迟的公交车未来得及靠站，一群候车的上班族便蜂拥而上，我没有参与，从容闲适地徘徊在候车亭等待下一班车的到来。心急火燎的人群几经努力尝试终有些人挤不上车，放弃撤退回来。不过，车子启动扬起的尘埃还未落定，下一班车就空荡荡地尾随而来，遗憾留下来的人愁眉渐次舒展开来。</p>\n<p>我知道，有些公司会规定迟到要扣钱，但即使没有这样的规矩，我依然能够理解他们挤着上车的举动。当前门空间被拥挤的人群塞得满满当当，司机总是奉劝还在门外挣扎的人，等下一班，很快就来。这是他们这个职业所能留给乘客一丝无奈的善意。</p>\n<p>我们有序上车，由于并非满载行驶，车子极其轻快，一下子就超车了。当我到站走下车回头一望时，上一趟公交车还在远处姗姗来迟。如果我刚才也随波逐流在人群中推搡上车，那我只能在此时此刻之后的几分钟的未来才能到达此地。也就是一个性格使然看似不经意间的选择，我提前到达了未来（本来应该是  <code>t2</code> ，结果是 <code>t1</code>  到达）。</p>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2023/02/25/14b5f2ba338fbc0d.png\" alt=\"figure timeline\" /></p>\n<p>那一刻，我仿佛看见了时间，滴答滴答，在自己生命场合里，刻下的尺度。我们的人生只有一次，没有彩排，没办法走到某一刻，有个旋钮可以把我们倒拨回过去，重新作出选择，对比看孰好孰坏。但只要自己不要碌碌无为，虚度光阴，贪图玩乐，像个母亲细心地呵护呱呱坠地的婴孩一样爱护自己的时间，这样自己就可以提前到达未来。在人生有限的生命里，自己可以走的更远，这样也许自己不惑之年所驻足的地方，却是曾经懵懂的自己或者他人活到耄耋之年才能到达。</p>\n<p>人有了点学识，方知自己过去的无知，也许因为意识到这点，便孜孜不倦地求知。学海无涯，回头不是岸，努力游到对岸才是。</p>\n<blockquote>\n<p>“人永远都无法知道自己该要什么，因为人只能活一次，既不能拿它跟前世相比，也不能在来生加以修正。没有任何方法可以检验哪种抉择是好的，因为不存在任何比较。一切都是马上经历，仅此一次，不能准备。—— 米兰・昆德拉”</p>\n</blockquote>\n<p>很不幸，和大多数大道理都懂，小情绪却总是喷薄而出的小孩脾气一样。知道时间珍贵，应该珍惜时间，那些人生至关重要的清规戒律时常淹没在日常琐碎繁杂的洪流里，知行合一是如此之难。</p>\n<p>但其实也没有必要对此太过于介怀。有道是人生苦短，及时行乐。没有必要一直如同苦行僧，偶尔需要些许闲暇的时光，让自己走出家门坐在双层巴士上发呆，看着街边的房屋，树叶如白驹过隙般从车窗前一晃而过。和朋友踩在松软的沙滩或者硬实的木栈道，任凭裹挟着咸味的海风涌入鼻腔，或者坐在自己宽大的书桌前摊开百读不厌，看似百无一用的课外书籍。接受偶尔不那么功利目的，虚度光阴的自己。</p>\n",
            "tags": [
                "时间, time"
            ]
        },
        {
            "id": "https://limxtop1989.github.io/limxtop/2023/02/04/android-message-loop/",
            "url": "https://limxtop1989.github.io/limxtop/2023/02/04/android-message-loop/",
            "title": "Android消息循环",
            "date_published": "2023-02-04T07:59:56.000Z",
            "content_html": "<h1 id=\"题记\"><a class=\"anchor\" href=\"#题记\">#</a> 题记</h1>\n<p>本文又几年前给同事们培训准备的资料整理而来，只是凭借印象，粗略记录框架原理和要点，需要新人花不少功夫自学探索。待闲暇时，待我重新阅读源码，再详细展开。读懂消息循环，需要具备英语阅读能力，如果尚缺，可以阅读<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iZXdhdGVycy5tZS9saW14dG9wLzIwMjEvMDgvMTgvRW5nbGlzaC1pbnRyb2R1Y3Rpb24v\">英语自学指南</span>。</p>\n<h1 id=\"用法\"><a class=\"anchor\" href=\"#用法\">#</a> 用法</h1>\n<p>线程是不具备消息循环的，需要调用 <code>Looper.prepare()</code>  &amp;  <code>Looper.loop()</code>  才开启消息循环。系统已经在 <code>ActivityThread</code>  帮忙主线程开启了消息循环，代码如下。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">prepareMainLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token class-name\">ActivityThread</span> thread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ActivityThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sMainThreadHandler <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            sMainThreadHandler <span class=\"token operator\">=</span> thread<span class=\"token punctuation\">.</span><span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Main thread loop unexpectedly exited\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>所以，主线程是不可以调用 <code>looper.quit()</code> ，不然抛出 <code>new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;)</code> ，而 WorkerThread 如果开启消息循环，不再需要时，得调用 <code>looper.quit()</code> ，否则内存泄漏。</p>\n<h1 id=\"类图\"><a class=\"anchor\" href=\"#类图\">#</a> 类图</h1>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2023/02/04/e2a2de9b66a113c6.png\" alt=\"\" /><br />\n每个线程都有自己的消息循环机制和队列，实现的关键是将 Looper 对象保存在当前 <code>Thread</code>  的 <code>ThreadLocalMap</code> ，&lt;key, value&gt; = &lt;Looper.sThreadLocal, Looper&gt;.</p>\n<p>android.os.Looper#prepare(boolean)</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> quitAllowed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sThreadLocal<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Only one Looper may be created per thread\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        sThreadLocal<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">(</span>quitAllowed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>java.lang.ThreadLocal#set</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>     * Sets the current thread's copy of this thread-local variable</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     * to the specified value.  Most subclasses will have no need to</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     * override this method, relying solely on the &#123;@link #initialValue&#125;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     * method to set the values of thread-locals.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     * @param value the value to be stored in the current thread's copy of</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     *        this thread-local.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token class-name\">Thread</span> t <span class=\"token operator\">=</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token class-name\">ThreadLocalMap</span> map <span class=\"token operator\">=</span> <span class=\"token function\">getMap</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>map <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            map<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token function\">createMap</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"overview\"><a class=\"anchor\" href=\"#overview\">#</a> Overview</h1>\n<p>消息队列的消息有指定执行时间，消息循环机制是如何做到准时处理消息的？</p>\n<ol>\n<li>消息循环机制初始化时，在 native 层，监听 `mWakeEventFd。</li>\n<li>消息循环开始时，从消息队列里取消息，自然取不到，就在 native 等待 <code>mWakeEventFd</code>  事件</li>\n<li>handler 发送消息，并进入消息队列，native 层 在 mWakeEventFd 写入数据，唤醒第二步的等待事件。</li>\n<li>第二步从等待中唤醒，读取消息队列的消息，如果消息执行时间是现在，则处理消息。否则计算执行时间和当前的时间差 <code>nextPollTimeoutMillis</code> ，重新插入消息队列，并在 native 层等待，等待超时参数是 <code>nextPollTimeoutMillis</code></li>\n</ol>\n<h1 id=\"nextpolltimeoutmillis\"><a class=\"anchor\" href=\"#nextpolltimeoutmillis\">#</a> nextPollTimeoutMillis</h1>\n<p><code>nextPollTimeoutMillis</code>  看似不起眼，其实是很重要的变量，它有三种类型的值，分别代表不同的含义。</p>\n<ol>\n<li>-1：消息队列没消息，native 使用 <code>wait()</code></li>\n<li>0：（TODO： ）</li>\n<li>自然数：消息队列最早执行的消息（队列头部的消息）在未来，当前没有消息处理，可以歇息。native 使用  <code>wait(int timeout)</code>  ，超时后自动从等待中返回，无需 write 事件唤醒。</li>\n</ol>\n<p>android.os.MessageQueue#next</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> nextPollTimeoutMillis <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token function\">nativePollOnce</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">,</span> nextPollTimeoutMillis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token comment\">// Try to retrieve the next message.  Return if found.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>msg <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>now <span class=\"token operator\">&lt;</span> msg<span class=\"token punctuation\">.</span>when<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    <span class=\"token comment\">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    nextPollTimeoutMillis <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>when <span class=\"token operator\">-</span> now<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span>MAX_VALUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token keyword\">return</span> msg<span class=\"token punctuation\">;</span><span class=\"token comment\">// Got a message.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    nextPollTimeoutMillis <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// No more messages.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token comment\">// A new message could have been delivered, so go back and look again for a pending message without waiting.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            nextPollTimeoutMillis <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"prepare\"><a class=\"anchor\" href=\"#prepare\">#</a> Prepare</h1>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2023/02/04/4b24b7075c896855.png\" alt=\"\" /><br />\n使用 Epoll API，在 mWakeEventFd 注册监听</p>\n<h1 id=\"loop-and-handle-message\"><a class=\"anchor\" href=\"#loop-and-handle-message\">#</a> Loop And Handle Message</h1>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2023/02/04/c8230250364e5395.png\" alt=\"\" /><br />\n此时消息队列还没有消息，在 <code>epoll_wait</code>  等待</p>\n<h1 id=\"insert-message\"><a class=\"anchor\" href=\"#insert-message\">#</a> Insert Message</h1>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2023/02/04/4b347d81a5ccef35.png\" alt=\"\" /><br />\n往消息队列插入消息后，往 <code>mWakeEventFd</code>  写入一个整数，唤醒 <code>poll_wait</code> ，从而 loop 循环中取出消息，接着处理 Message。</p>\n<h1 id=\"线程间通信\"><a class=\"anchor\" href=\"#线程间通信\">#</a> 线程间通信</h1>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2023/02/04/ef7b63e078f95c70.png\" alt=\"\" /><br />\n通信线程双方，持有对方的 handler 实例的引用，通过 handler.sendMessage 往对方线程的消息队列发送消息，如此两个线程就可以彼此发送消息，实现通信。</p>\n<h1 id=\"消息作用域\"><a class=\"anchor\" href=\"#消息作用域\">#</a> 消息作用域</h1>\n<p><img data-src=\"https://s3.bmp.ovh/imgs/2023/02/07/be19a511e4b0ac2b.png\" alt=\"\" /><br />\n哪个 Handler 发送的消息，最后出消息队列，仍由该 Handler 处理，所以不同的 Handler 实例，可以有相同的 What，而不会相互干扰。具体实现是 <code>handler.sendMessage(message)</code>  时， <code>handler</code>  对象保存在 <code>message.target</code>  字段。</p>\n<h1 id=\"threadlocal\"><a class=\"anchor\" href=\"#threadlocal\">#</a> ThreadLocal</h1>\n<h1 id=\"雷区\"><a class=\"anchor\" href=\"#雷区\">#</a> 雷区</h1>\n<h1 id=\"reference\"><a class=\"anchor\" href=\"#reference\">#</a> Reference</h1>\n<p>[1] <span class=\"exturl\" data-url=\"aHR0cHM6Ly9tZWRpdW0uY29tL0Bjb3B5Y29uc3RydWN0L3RoZS1tZXRob2QtdG8tZXBvbGxzLW1hZG5lc3MtZDlkMmQ2Mzc4NjQy\">https://medium.com/@copyconstruct/the-method-to-epolls-madness-d9d2d6378642</span><br />\n[2 ] <span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYW43Lm9yZy9saW51eC9tYW4tcGFnZXMvbWFuNy9lcG9sbC43Lmh0bWw=\">https://man7.org/linux/man-pages/man7/epoll.7.html</span><br />\n[3] The Design of the UNIX Operating System<br />\n[4] /base/core/java/android/os/MessageQueue.java<br />\n[5] /frameworks/base/core/jni/android_os_MessageQueue.cpp<br />\n[6] /system/core/libutils/Looper.cpp</p>\n",
            "tags": [
                "Android",
                "Android, message loop, 消息循环"
            ]
        }
    ]
}