<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>FragmentManager源码剖析二 | 若批评不自由，则赞美无意义</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="remove &amp; detach Fragment差别1234567891011121314public void removeFragment(Fragment fragment) &amp;#123;    if (DEBUG) Log.v(TAG, &quot;remove: &quot; + fragment + &quot; nesting&#x3D;&quot; + fragment.mBackS">
<meta property="og:type" content="article">
<meta property="og:title" content="FragmentManager源码剖析二">
<meta property="og:url" content="https://limxtop1989.github.io/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/index.html">
<meta property="og:site_name" content="若批评不自由，则赞美无意义">
<meta property="og:description" content="remove &amp; detach Fragment差别1234567891011121314public void removeFragment(Fragment fragment) &amp;#123;    if (DEBUG) Log.v(TAG, &quot;remove: &quot; + fragment + &quot; nesting&#x3D;&quot; + fragment.mBackS">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-10-18T13:27:09.000Z">
<meta property="article:modified_time" content="2022-07-23T10:38:56.390Z">
<meta property="article:author" content="文理兼修电脑首席">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/limxtop/atom.xml" title="若批评不自由，则赞美无意义" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/limxtop/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/limxtop/" id="logo">若批评不自由，则赞美无意义</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/limxtop/">Home</a>
        
          <a class="main-nav-link" href="/limxtop/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/limxtop/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://limxtop1989.github.io/limxtop"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-FragmentManager源码剖析2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/" class="article-date">
  <time datetime="2021-10-18T13:27:09.000Z" itemprop="datePublished">2021-10-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      FragmentManager源码剖析二
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="remove-amp-detach-Fragment差别"><a href="#remove-amp-detach-Fragment差别" class="headerlink" title="remove &amp; detach Fragment差别"></a>remove &amp; detach Fragment差别</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeFragment</span><span class="params">(Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;remove: &quot;</span> + fragment + <span class="string">&quot; nesting=&quot;</span> + fragment.mBackStackNesting);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> inactive = !fragment.isInBackStack();</span><br><span class="line">    <span class="keyword">if</span> (!fragment.mDetached || inactive) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mAdded) &#123;</span><br><span class="line">            mAdded.remove(fragment);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isMenuAvailable(fragment)) &#123;</span><br><span class="line">            mNeedMenuInvalidate = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fragment.mAdded = <span class="keyword">false</span>;</span><br><span class="line">        fragment.mRemoving = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detachFragment</span><span class="params">(Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;detach: &quot;</span> + fragment);</span><br><span class="line">    <span class="keyword">if</span> (!fragment.mDetached) &#123;</span><br><span class="line">        fragment.mDetached = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (fragment.mAdded) &#123;</span><br><span class="line">            <span class="comment">// We are not already in back stack, so need to remove the fragment.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;remove from detach: &quot;</span> + fragment);</span><br><span class="line">            <span class="keyword">synchronized</span> (mAdded) &#123;</span><br><span class="line">                mAdded.remove(fragment);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isMenuAvailable(fragment)) &#123;</span><br><span class="line">                mNeedMenuInvalidate = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            fragment.mAdded = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>都是移出mAdded集合，并将mAdded置为false，区别在更新的标记不同mRemoving &amp; mDetached。在FragmentManager同步状态调用时，有对remove &amp; detach的状态同步。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Changes the state of the fragment manager to &#123;<span class="doctag">@code</span> newState&#125;. If the fragment manager</span></span><br><span class="line"><span class="comment"> * changes state or &#123;<span class="doctag">@code</span> always&#125; is &#123;<span class="doctag">@code</span> true&#125;, any fragments within it have their</span></span><br><span class="line"><span class="comment"> * states updated as well.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newState The new state for the fragment manager</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> always If &#123;<span class="doctag">@code</span> true&#125;, all fragments update their state, even</span></span><br><span class="line"><span class="comment"> *               if &#123;<span class="doctag">@code</span> newState&#125; matches the current fragment manager&#x27;s state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(<span class="keyword">int</span> newState, <span class="keyword">boolean</span> always)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mHost == <span class="keyword">null</span> &amp;&amp; newState != Fragment.INITIALIZING) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No activity&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!always &amp;&amp; newState == mCurState) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mCurState = newState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mActive != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Must add them in the proper order. mActive fragments may be out of order</span></span><br><span class="line">				<span class="comment">// Fragment add &amp; attach 后的状态同步</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> numAdded = mAdded.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numAdded; i++) &#123;</span><br><span class="line">            Fragment f = mAdded.get(i);</span><br><span class="line">            moveFragmentToExpectedState(f);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now iterate through all active fragments. These will include those that are removed</span></span><br><span class="line">        <span class="comment">// and detached.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> numActive = mActive.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numActive; i++) &#123;</span><br><span class="line">            Fragment f = mActive.valueAt(i);</span><br><span class="line">						<span class="comment">// Fragment 激活后执行remove 或者 detach，同步状态。</span></span><br><span class="line">            <span class="keyword">if</span> (f != <span class="keyword">null</span> &amp;&amp; (f.mRemoving || f.mDetached) &amp;&amp; !f.mIsNewlyAdded) &#123;</span><br><span class="line">                moveFragmentToExpectedState(f);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        startPendingDeferredFragments();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mNeedMenuInvalidate &amp;&amp; mHost != <span class="keyword">null</span> &amp;&amp; mCurState == Fragment.RESUMED) &#123;</span><br><span class="line">            mHost.onSupportInvalidateOptionsMenu();</span><br><span class="line">            mNeedMenuInvalidate = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Moves a fragment to its expected final state or the fragment manager&#x27;s state, depending</span></span><br><span class="line"><span class="comment"> * on whether the fragment manager&#x27;s state is raised properly.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> f The fragment to change.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveFragmentToExpectedState</span><span class="params">(Fragment f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (f == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mActive.containsKey(f.mWho)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">&quot;Ignoring moving &quot;</span> + f + <span class="string">&quot; to state &quot;</span> + mCurState</span><br><span class="line">                    + <span class="string">&quot;since it is not added to &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> nextState = mCurState;</span><br><span class="line">    <span class="keyword">if</span> (f.mRemoving) &#123;</span><br><span class="line">        <span class="keyword">if</span> (f.isInBackStack()) &#123;</span><br><span class="line">            nextState = Math.min(nextState, Fragment.CREATED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nextState = Math.min(nextState, Fragment.INITIALIZING);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    moveToState(f, nextState, f.getNextTransition(), f.getNextTransitionStyle(), <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于Remove如果nextState 是CREATED，Fragment只会<code>f.performDestroyView()</code>，但如果是INITIALIZING，分两种情况：</p>
<ol>
<li>不在回退栈，执行<code>f.performDestroy()</code>;</li>
<li>在回退栈，执行<code>f.performDetach()</code>;并<code>makeInactive(f);</code></li>
</ol>
<p>对于detach，nextState是CREATED，也即只执行<code>f.performDestroyView()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;ReferenceEquality&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(Fragment f, <span class="keyword">int</span> newState, <span class="keyword">int</span> transit, <span class="keyword">int</span> transitionStyle,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">boolean</span> keepActive)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Fragments that are not currently added will sit in the onCreate() state.</span></span><br><span class="line">    <span class="keyword">if</span> ((!f.mAdded || f.mDetached) &amp;&amp; newState &gt; Fragment.CREATED) &#123;</span><br><span class="line">        newState = Fragment.CREATED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="add-amp-attach-Fragment区别"><a href="#add-amp-attach-Fragment区别" class="headerlink" title="add &amp; attach Fragment区别"></a>add &amp; attach Fragment区别</h1><p>由于addFragment 有activate调用，fragment 已经在mActive映射里，允许状态同步，但attach没有activate 调用，于是状态不同步。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Moves a fragment to its expected final state or the fragment manager&#x27;s state, depending</span></span><br><span class="line"><span class="comment"> * on whether the fragment manager&#x27;s state is raised properly.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> f The fragment to change.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveFragmentToExpectedState</span><span class="params">(Fragment f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (f == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mActive.containsKey(f.mWho)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">&quot;Ignoring moving &quot;</span> + f + <span class="string">&quot; to state &quot;</span> + mCurState</span><br><span class="line">                    + <span class="string">&quot;since it is not added to &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> nextState = mCurState;</span><br><span class="line">    <span class="keyword">if</span> (f.mRemoving) &#123;</span><br><span class="line">        <span class="keyword">if</span> (f.isInBackStack()) &#123;</span><br><span class="line">            nextState = Math.min(nextState, Fragment.CREATED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nextState = Math.min(nextState, Fragment.INITIALIZING);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    moveToState(f, nextState, f.getNextTransition(), f.getNextTransitionStyle(), <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFragment</span><span class="params">(Fragment fragment, <span class="keyword">boolean</span> moveToStateNow)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;add: &quot;</span> + fragment);</span><br><span class="line">    **makeActive(fragment);<span class="comment">// 这是主要区别**</span></span><br><span class="line">    <span class="keyword">if</span> (!fragment.mDetached) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAdded.contains(fragment)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Fragment already added: &quot;</span> + fragment);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (mAdded) &#123;</span><br><span class="line">            mAdded.add(fragment);</span><br><span class="line">        &#125;</span><br><span class="line">        fragment.mAdded = <span class="keyword">true</span>;</span><br><span class="line">        fragment.mRemoving = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (fragment.mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            fragment.mHiddenChanged = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isMenuAvailable(fragment)) &#123;</span><br><span class="line">            mNeedMenuInvalidate = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (moveToStateNow) &#123;</span><br><span class="line">            moveToState(fragment);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attachFragment</span><span class="params">(Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;attach: &quot;</span> + fragment);</span><br><span class="line">    <span class="keyword">if</span> (fragment.mDetached) &#123;</span><br><span class="line">        fragment.mDetached = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!fragment.mAdded) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAdded.contains(fragment)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Fragment already added: &quot;</span> + fragment);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;add from attach: &quot;</span> + fragment);</span><br><span class="line">            <span class="keyword">synchronized</span> (mAdded) &#123;</span><br><span class="line">                mAdded.add(fragment);</span><br><span class="line">            &#125;</span><br><span class="line">            fragment.mAdded = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (isMenuAvailable(fragment)) &#123;</span><br><span class="line">                mNeedMenuInvalidate = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Show和hide-Fragment区别"><a href="#Show和hide-Fragment区别" class="headerlink" title="Show和hide Fragment区别"></a>Show和hide Fragment区别</h1><p>首先，更新mHidden标记。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Marks a fragment as hidden to be later animated in with</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #completeShowHideFragment(Fragment)&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fragment The fragment to be shown.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideFragment</span><span class="params">(Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;hide: &quot;</span> + fragment);</span><br><span class="line">    <span class="keyword">if</span> (!fragment.mHidden) &#123;</span><br><span class="line">        fragment.mHidden = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></span><br><span class="line">        <span class="comment">// it doesn&#x27;t go through the animation.</span></span><br><span class="line">        fragment.mHiddenChanged = !fragment.mHiddenChanged;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Marks a fragment as shown to be later animated in with</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #completeShowHideFragment(Fragment)&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fragment The fragment to be shown.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showFragment</span><span class="params">(Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;show: &quot;</span> + fragment);</span><br><span class="line">    <span class="keyword">if</span> (fragment.mHidden) &#123;</span><br><span class="line">        fragment.mHidden = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></span><br><span class="line">        <span class="comment">// it doesn&#x27;t go through the animation.</span></span><br><span class="line">        fragment.mHiddenChanged = !fragment.mHiddenChanged;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>故事并没有就此结束，看下这个标记如何使用。</p>
<p>首先，hidden后，Fragment下的View为Gone，不贡献视图。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentStateManager#<span class="function">moveToExpectedState</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">(FragmentManager.USE_STATE_MANAGER &amp;&amp; mFragment.mHiddenChanged)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mFragment.mView != <span class="keyword">null</span> &amp;&amp; mFragment.mContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Get the controller and enqueue the show/hide</span></span><br><span class="line">        SpecialEffectsController controller = SpecialEffectsController</span><br><span class="line">                .getOrCreateController(mFragment.mContainer,</span><br><span class="line">                        mFragment.getParentFragmentManager());</span><br><span class="line">        <span class="keyword">if</span> (mFragment.mHidden) &#123;</span><br><span class="line">            controller.enqueueHide(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            controller.enqueueShow(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mFragment.mFragmentManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mFragment.mFragmentManager.invalidateMenuForFragment(mFragment);</span><br><span class="line">    &#125;</span><br><span class="line">    mFragment.mHiddenChanged = <span class="keyword">false</span>;</span><br><span class="line">    mFragment.onHiddenChanged(mFragment.mHidden);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其次，hidden后，Fragment不再贡献菜单项</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#<span class="function">dispatchPrepareOptionsMenu</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">dispatchPrepareOptionsMenu</span><span class="params">(<span class="meta">@NonNull</span> Menu menu)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mCurState &lt; Fragment.CREATED) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> show = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (Fragment f : mFragmentStore.getFragments()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isParentMenuVisible(f) &amp;&amp; f.performPrepareOptionsMenu(menu)) &#123;</span><br><span class="line">                show = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> show;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">androidx.fragment.app.Fragment#<span class="function">performPrepareOptionsMenu</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">performPrepareOptionsMenu</span><span class="params">(<span class="meta">@NonNull</span> Menu menu)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> show = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mHidden) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mHasMenu &amp;&amp; mMenuVisible) &#123;</span><br><span class="line">            show = <span class="keyword">true</span>;</span><br><span class="line">            onPrepareOptionsMenu(menu);</span><br><span class="line">        &#125;</span><br><span class="line">        show |= mChildFragmentManager.dispatchPrepareOptionsMenu(menu);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> show;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显隐切换完成后，androidx.fragment.app.Fragment#onHiddenChanged会得到通知调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#completeShowHideFragment</span><br><span class="line">androidx.fragment.app.FragmentStateManager#moveToExpectedState</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="FragmentManager-派发生命周期方法"><a href="#FragmentManager-派发生命周期方法" class="headerlink" title="FragmentManager 派发生命周期方法"></a>FragmentManager 派发生命周期方法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentActivity</span> <span class="keyword">extends</span> <span class="title">ComponentActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> FragmentController mFragments = FragmentController.createController(</span><br><span class="line">					<span class="keyword">new</span> HostCallbacks());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mFragments 负责Activity 生命周期方法，派发给FragmentManager，再遍历逐个派发给旗下的Fragment。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Perform initialization of all fragments.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    mFragments.attachHost(<span class="keyword">null</span> <span class="comment">/*parent*/</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (savedInstanceState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Parcelable p = savedInstanceState.getParcelable(FRAGMENTS_TAG);</span><br><span class="line">        mFragments.restoreSaveState(p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">    mFragmentLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    mFragments.dispatchCreate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Moves all Fragments managed by the controller&#x27;s FragmentManager</span></span><br><span class="line"><span class="comment"> * into the create state.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Call when Fragments should be created.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Fragment#onCreate(Bundle)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mHost.mFragmentManager.dispatchCreate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dispatchCreate 终导致FragmentManagerImpl的当前状态<code>mCurState</code> 变更。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#<span class="function">dispatchCreate</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mStateSaved = <span class="keyword">false</span>;</span><br><span class="line">    mStopped = <span class="keyword">false</span>;</span><br><span class="line">    mNonConfig.setIsStateSaved(<span class="keyword">false</span>);</span><br><span class="line">    dispatchStateChange(Fragment.CREATED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">androidx.fragment.app.FragmentManager#<span class="function">dispatchStateChange</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchStateChange</span><span class="params">(<span class="keyword">int</span> nextState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mExecutingActions = <span class="keyword">true</span>;</span><br><span class="line">        mFragmentStore.dispatchStateChange(nextState);</span><br><span class="line">        moveToState(nextState, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (USE_STATE_MANAGER) &#123;</span><br><span class="line">            Set&lt;SpecialEffectsController&gt; controllers = collectAllSpecialEffectsController();</span><br><span class="line">            <span class="keyword">for</span> (SpecialEffectsController controller : controllers) &#123;</span><br><span class="line">                controller.forceCompleteAllOperations();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mExecutingActions = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    execPendingActions(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步生命周期状态给mActive内fragment集合</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchStateChange</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (FragmentStateManager fragmentStateManager : mActive.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fragmentStateManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fragmentStateManager.setFragmentManagerState(state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#moveToState(<span class="keyword">int</span>, <span class="keyword">boolean</span>)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Changes the state of the fragment manager to &#123;<span class="doctag">@code</span> newState&#125;. If the fragment manager</span></span><br><span class="line"><span class="comment"> * changes state or &#123;<span class="doctag">@code</span> always&#125; is &#123;<span class="doctag">@code</span> true&#125;, any fragments within it have their</span></span><br><span class="line"><span class="comment"> * states updated as well.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newState The new state for the fragment manager</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> always If &#123;<span class="doctag">@code</span> true&#125;, all fragments update their state, even</span></span><br><span class="line"><span class="comment"> *               if &#123;<span class="doctag">@code</span> newState&#125; matches the current fragment manager&#x27;s state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(<span class="keyword">int</span> newState, <span class="keyword">boolean</span> always)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mHost == <span class="keyword">null</span> &amp;&amp; newState != Fragment.INITIALIZING) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No activity&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!always &amp;&amp; newState == mCurState) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mCurState = newState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (USE_STATE_MANAGER) &#123;</span><br><span class="line">        mFragmentStore.moveToExpectedState();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Must add them in the proper order. mActive fragments may be out of order</span></span><br><span class="line">        <span class="keyword">for</span> (Fragment f : mFragmentStore.getFragments()) &#123;</span><br><span class="line">            moveFragmentToExpectedState(f);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now iterate through all active fragments. These will include those that are removed</span></span><br><span class="line">        <span class="comment">// and detached.</span></span><br><span class="line">        <span class="keyword">for</span> (FragmentStateManager fragmentStateManager :</span><br><span class="line">                mFragmentStore.getActiveFragmentStateManagers()) &#123;</span><br><span class="line">            Fragment f = fragmentStateManager.getFragment();</span><br><span class="line">            <span class="keyword">if</span> (!f.mIsNewlyAdded) &#123;</span><br><span class="line">                moveFragmentToExpectedState(f);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> beingRemoved = f.mRemoving &amp;&amp; !f.isInBackStack();</span><br><span class="line">            <span class="keyword">if</span> (beingRemoved) &#123;</span><br><span class="line">                mFragmentStore.makeInactive(fragmentStateManager);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    startPendingDeferredFragments();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mNeedMenuInvalidate &amp;&amp; mHost != <span class="keyword">null</span> &amp;&amp; mCurState == Fragment.RESUMED) &#123;</span><br><span class="line">        mHost.onSupportInvalidateOptionsMenu();</span><br><span class="line">        mNeedMenuInvalidate = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#<span class="function">moveFragmentToExpectedState</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveToExpectedState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Must add them in the proper order. mActive fragments may be out of order</span></span><br><span class="line">    <span class="keyword">for</span> (Fragment f : mAdded) &#123;</span><br><span class="line">        FragmentStateManager fragmentStateManager = mActive.get(f.mWho);</span><br><span class="line">        <span class="keyword">if</span> (fragmentStateManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fragmentStateManager.moveToExpectedState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now iterate through all active fragments. These will include those that are removed</span></span><br><span class="line">    <span class="comment">// and detached.</span></span><br><span class="line">    <span class="keyword">for</span> (FragmentStateManager fragmentStateManager : mActive.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fragmentStateManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fragmentStateManager.moveToExpectedState();</span><br><span class="line"></span><br><span class="line">            Fragment f = fragmentStateManager.getFragment();</span><br><span class="line">            <span class="keyword">boolean</span> beingRemoved = f.mRemoving &amp;&amp; !f.isInBackStack();</span><br><span class="line">            <span class="keyword">if</span> (beingRemoved) &#123;</span><br><span class="line">                makeInactive(fragmentStateManager);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意只有在mActive集合的Fragment才可以<code>moveToExpectedState</code> ，attach阶段的Fragment 并未进入此集合，add之后才进入，此后Fragment接收生命周期方法派发。</p>
<h1 id="BackStack"><a href="#BackStack" class="headerlink" title="BackStack"></a>BackStack</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implementation of &#123;<span class="doctag">@link</span> FragmentManagerImpl.OpGenerator&#125;.</span></span><br><span class="line"><span class="comment"> * This operation is added to the list of pending actions during &#123;<span class="doctag">@link</span> #commit()&#125;, and</span></span><br><span class="line"><span class="comment"> * will be executed on the UI thread to run this FragmentTransaction.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> records Modified to add this BackStackRecord</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isRecordPop Modified to add a false (this isn&#x27;t a pop)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true always because the records and isRecordPop will always be changed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">generateOps</span><span class="params">(ArrayList&lt;BackStackRecord&gt; records, ArrayList&lt;Boolean&gt; isRecordPop)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (FragmentManagerImpl.DEBUG) &#123;</span><br><span class="line">        Log.v(TAG, <span class="string">&quot;Run: &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    records.add(<span class="keyword">this</span>);</span><br><span class="line">    isRecordPop.add(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (mAddToBackStack) &#123;</span><br><span class="line">        mManager.addBackStackState(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addBackStackState</span><span class="params">(BackStackRecord state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBackStack == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mBackStack = <span class="keyword">new</span> ArrayList&lt;BackStackRecord&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    mBackStack.add(state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把当前backStackRecord 即事务加入mBackStack 集合。此处可以猜想：当接收back事件时，activity先派发back事件给FragmentManager，如果mBackStack存在元素，则将列表末尾的事务revert，并移出集合，指针向左偏移一位，并直接返回。如果FragmentManager不回应back event，那么由Activity继续回应。我们看下具体实现是否这样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">androidx.activity.ComponentActivity#onBackPressed</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called when the activity has detected the user&#x27;s press of the back</span></span><br><span class="line"><span class="comment"> * key. The &#123;<span class="doctag">@link</span> #getOnBackPressedDispatcher() OnBackPressedDispatcher&#125; will be given a</span></span><br><span class="line"><span class="comment"> * chance to handle the back button before the default behavior of</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> android.app.Activity#onBackPressed()&#125; is invoked.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getOnBackPressedDispatcher()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mOnBackPressedDispatcher.onBackPressed();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OnBackPressedDispatcher mOnBackPressedDispatcher =</span><br><span class="line">      <span class="keyword">new</span> OnBackPressedDispatcher(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              ComponentActivity.<span class="keyword">super</span>.onBackPressed();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">androidx.activity.OnBackPressedDispatcher#onBackPressed</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Trigger a call to the currently added &#123;<span class="doctag">@link</span> OnBackPressedCallback callbacks&#125; in reverse</span></span><br><span class="line"><span class="comment"> * order in which they were added. Only if the most recently added callback is not</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> OnBackPressedCallback#isEnabled() enabled&#125;</span></span><br><span class="line"><span class="comment"> * will any previously added callback be called.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * It is strongly recommended to call &#123;<span class="doctag">@link</span> #hasEnabledCallbacks()&#125; prior to calling</span></span><br><span class="line"><span class="comment"> * this method to determine if there are any enabled callbacks that will be triggered</span></span><br><span class="line"><span class="comment"> * by this method as calling this method.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Iterator&lt;OnBackPressedCallback&gt; iterator =</span><br><span class="line">            mOnBackPressedCallbacks.descendingIterator();</span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">        OnBackPressedCallback callback = iterator.next();</span><br><span class="line">        <span class="keyword">if</span> (callback.isEnabled()) &#123;</span><br><span class="line">						<span class="comment">// 如果回调回应back事件，则返回</span></span><br><span class="line">            callback.handleOnBackPressed();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// FragmentManager 没回应，则继续走这里</span></span><br><span class="line">    <span class="keyword">if</span> (mFallbackOnBackPressed != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// 为OnBackPressedDispatcher初始化时，传入的回调方法，其实现是</span></span><br><span class="line">				<span class="comment">// 调用Activity的onBackPressed()</span></span><br><span class="line">        mFallbackOnBackPressed.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>FragmentManager如何注册callback</p>
<p>→androidx.fragment.app.FragmentActivity#init</p>
<p>→androidx.fragment.app.FragmentController#attachHost</p>
<p>→androidx.fragment.app.FragmentManager#attachController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line"><span class="meta">@SuppressLint(&quot;SyntheticAccessor&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachController</span><span class="params">(<span class="meta">@NonNull</span> FragmentHostCallback&lt;?&gt; host,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> FragmentContainer container, <span class="meta">@Nullable</span> <span class="keyword">final</span> Fragment parent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mHost != <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Already attached&quot;</span>);</span><br><span class="line">    mHost = host;</span><br><span class="line">    mContainer = container;</span><br><span class="line">    mParent = parent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add a FragmentOnAttachListener to the parent fragment / host to support</span></span><br><span class="line">    <span class="comment">// backward compatibility with the deprecated onAttachFragment() APIs</span></span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        addFragmentOnAttachListener(<span class="keyword">new</span> FragmentOnAttachListener() &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttachFragment</span><span class="params">(<span class="meta">@NonNull</span> FragmentManager fragmentManager,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">                parent.onAttachFragment(fragment);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (host <span class="keyword">instanceof</span> FragmentOnAttachListener) &#123;</span><br><span class="line">        addFragmentOnAttachListener((FragmentOnAttachListener) host);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Since the callback depends on us being the primary navigation fragment,</span></span><br><span class="line">        <span class="comment">// update our callback now that we have a parent so that we have the correct</span></span><br><span class="line">        <span class="comment">// state by default</span></span><br><span class="line">        updateOnBackPressedCallbackEnabled();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Set up the OnBackPressedCallback</span></span><br><span class="line">    <span class="keyword">if</span> (host <span class="keyword">instanceof</span> OnBackPressedDispatcherOwner) &#123;</span><br><span class="line">        OnBackPressedDispatcherOwner dispatcherOwner = ((OnBackPressedDispatcherOwner) host);</span><br><span class="line">        mOnBackPressedDispatcher = dispatcherOwner.getOnBackPressedDispatcher();</span><br><span class="line">        LifecycleOwner owner = parent != <span class="keyword">null</span> ? parent : dispatcherOwner;</span><br><span class="line">        mOnBackPressedDispatcher.addCallback(owner, mOnBackPressedCallback);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 代码省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OnBackPressedCallback mOnBackPressedCallback =</span><br><span class="line">    <span class="keyword">new</span> OnBackPressedCallback(<span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleOnBackPressed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            FragmentManager.<span class="keyword">this</span>.handleOnBackPressed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#handleOnBackPressed</span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span> <span class="comment">/* synthetic access */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleOnBackPressed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// First, execute any pending actions to make sure we&#x27;re in an</span></span><br><span class="line">    <span class="comment">// up to date view of the world just in case anyone is queuing</span></span><br><span class="line">    <span class="comment">// up transactions that change the back stack then immediately</span></span><br><span class="line">    <span class="comment">// calling onBackPressed()</span></span><br><span class="line">    execPendingActions(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (mOnBackPressedCallback.isEnabled()) &#123;</span><br><span class="line">        <span class="comment">// We still have a back stack, so we can pop</span></span><br><span class="line">        popBackStackImmediate();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Sigh. Due to FragmentManager&#x27;s asynchronicity, we can</span></span><br><span class="line">        <span class="comment">// get into cases where we *think* we can handle the back</span></span><br><span class="line">        <span class="comment">// button but because of frame perfect dispatch, we fell</span></span><br><span class="line">        <span class="comment">// on our face. Since our callback is disabled, we can</span></span><br><span class="line">        <span class="comment">// re-trigger the onBackPressed() to dispatch to the next</span></span><br><span class="line">        <span class="comment">// enabled callback</span></span><br><span class="line">        mOnBackPressedDispatcher.onBackPressed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看fragmentManager.popBackStackImmediate()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">popBackStackImmediate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    checkStateLoss();</span><br><span class="line">    <span class="keyword">return</span> popBackStackImmediate(<span class="keyword">null</span>, -<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Used by all public popBackStackImmediate methods, this executes pending transactions and</span></span><br><span class="line"><span class="comment"> * returns true if the pop action did anything, regardless of what other pending</span></span><br><span class="line"><span class="comment"> * transactions did.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if the pop operation did anything or false otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">popBackStackImmediate</span><span class="params">(String name, <span class="keyword">int</span> id, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    execPendingActions();</span><br><span class="line">    ensureExecReady(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPrimaryNav != <span class="keyword">null</span> <span class="comment">// We have a primary nav fragment</span></span><br><span class="line">            &amp;&amp; id &lt; <span class="number">0</span> <span class="comment">// No valid id (since they&#x27;re local)</span></span><br><span class="line">            &amp;&amp; name == <span class="keyword">null</span>) &#123; <span class="comment">// no name to pop to (since they&#x27;re local)</span></span><br><span class="line">        <span class="keyword">final</span> FragmentManager childManager = mPrimaryNav.getChildFragmentManager();</span><br><span class="line">        <span class="keyword">if</span> (childManager.popBackStackImmediate()) &#123;</span><br><span class="line">            <span class="comment">// We did something, just not to this specific FragmentManager. Return true.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> executePop = popBackStackState(mTmpRecords, mTmpIsPop, name, id, flags);</span><br><span class="line">    <span class="keyword">if</span> (executePop) &#123;</span><br><span class="line">        mExecutingActions = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            removeRedundantOperationsAndExecute(mTmpRecords, mTmpIsPop);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            cleanupExec();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    updateOnBackPressedCallbackEnabled();</span><br><span class="line">    doPendingDeferredStart();</span><br><span class="line">    burpActive();</span><br><span class="line">    <span class="keyword">return</span> executePop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>popBackStackState获取回退事务集合，交由removeRedundantOperationsAndExecute执行事务回退。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">popBackStackState</span><span class="params">(ArrayList&lt;BackStackRecord&gt; records, ArrayList&lt;Boolean&gt; isRecordPop,</span></span></span><br><span class="line"><span class="params"><span class="function">                              String name, <span class="keyword">int</span> id, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBackStack == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 无参数回退，只回退一个事务</span></span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span> &amp;&amp; id &lt; <span class="number">0</span> &amp;&amp; (flags &amp; POP_BACK_STACK_INCLUSIVE) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> last = mBackStack.size() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (last &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        records.add(mBackStack.remove(last));</span><br><span class="line">        isRecordPop.add(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// 指定id或者backStack name回退，可以一次回退多个事务。</span></span><br><span class="line">        <span class="keyword">int</span> index = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="keyword">null</span> || id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// If a name or ID is specified, look for that place in</span></span><br><span class="line">            <span class="comment">// the stack.</span></span><br><span class="line">            index = mBackStack.size()-<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                BackStackRecord bss = mBackStack.get(index);</span><br><span class="line">                <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; name.equals(bss.getName())) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (id &gt;= <span class="number">0</span> &amp;&amp; id == bss.mIndex) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                index--;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((flags&amp;POP_BACK_STACK_INCLUSIVE) != <span class="number">0</span>) &#123;</span><br><span class="line">                index--;</span><br><span class="line">                <span class="comment">// Consume all following entries that match.</span></span><br><span class="line">                <span class="keyword">while</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    BackStackRecord bss = mBackStack.get(index);</span><br><span class="line">                    <span class="keyword">if</span> ((name != <span class="keyword">null</span> &amp;&amp; name.equals(bss.getName()))</span><br><span class="line">                            || (id &gt;= <span class="number">0</span> &amp;&amp; id == bss.mIndex)) &#123;</span><br><span class="line">                        index--;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (index == mBackStack.size()-<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = mBackStack.size() - <span class="number">1</span>; i &gt; index; i--) &#123;</span><br><span class="line">            records.add(mBackStack.remove(i));</span><br><span class="line">            isRecordPop.add(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>事务从mBackStack回退栈管理集合移出，并加入records用于执行事务，对应的isRecordPop元素设置为true，标记位回退事务，最后执行逆向操作，实现回退。</p>
<p>→androidx.fragment.app.FragmentManagerImpl#removeRedundantOperationsAndExecute</p>
<p>→androidx.fragment.app.FragmentManagerImpl#executeOpsTogether</p>
<p>→androidx.fragment.app.FragmentManager#executeOps</p>
<p>→androidx.fragment.app.BackStackRecord#executePopOps</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#executeOps</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run the operations in the BackStackRecords, either to push or pop.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> records The list of records whose operations should be run.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isRecordPop The direction that these records are being run.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startIndex The index of the first entry in records to run.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endIndex One past the index of the final entry in records to run.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">executeOps</span><span class="params">(<span class="meta">@NonNull</span> ArrayList&lt;BackStackRecord&gt; records,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> ArrayList&lt;Boolean&gt; isRecordPop, <span class="keyword">int</span> startIndex, <span class="keyword">int</span> endIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; endIndex; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> BackStackRecord record = records.get(i);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPop = isRecordPop.get(i);</span><br><span class="line">        <span class="keyword">if</span> (isPop) &#123;</span><br><span class="line">            record.bumpBackStackNesting(-<span class="number">1</span>);</span><br><span class="line">            <span class="comment">// Only execute the add operations at the end of</span></span><br><span class="line">            <span class="comment">// all transactions.</span></span><br><span class="line">            <span class="keyword">boolean</span> moveToState = i == (endIndex - <span class="number">1</span>);</span><br><span class="line">            record.executePopOps(moveToState);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            record.bumpBackStackNesting(<span class="number">1</span>);</span><br><span class="line">            record.executeOps();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">androidx.fragment.app.BackStackRecord#executePopOps</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reverses the execution of the operations within this transaction. The Fragment states will</span></span><br><span class="line"><span class="comment"> * only be modified if reordering is not allowed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> moveToState &#123;<span class="doctag">@code</span> true&#125; if added fragments should be moved to their final state</span></span><br><span class="line"><span class="comment"> *                    in ordered transactions</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">executePopOps</span><span class="params">(<span class="keyword">boolean</span> moveToState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> opNum = mOps.size() - <span class="number">1</span>; opNum &gt;= <span class="number">0</span>; opNum--) &#123;</span><br><span class="line">        <span class="keyword">final</span> Op op = mOps.get(opNum);</span><br><span class="line">        Fragment f = op.mFragment;</span><br><span class="line">        <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">            f.setPopDirection(<span class="keyword">true</span>);</span><br><span class="line">            f.setAnimations(op.mEnterAnim, op.mExitAnim, op.mPopEnterAnim, op.mPopExitAnim);</span><br><span class="line">            f.setNextTransition(FragmentManager.reverseTransit(mTransition));</span><br><span class="line">            <span class="comment">// Reverse the target and source names for pop operations</span></span><br><span class="line">            f.setSharedElementNames(mSharedElementTargetNames, mSharedElementSourceNames);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (op.mCmd) &#123;</span><br><span class="line">            <span class="keyword">case</span> OP_ADD:</span><br><span class="line">                mManager.setExitAnimationOrder(f, <span class="keyword">true</span>);</span><br><span class="line">                mManager.removeFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_REMOVE:</span><br><span class="line">                mManager.addFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_HIDE:</span><br><span class="line">                mManager.showFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_SHOW:</span><br><span class="line">                mManager.setExitAnimationOrder(f, <span class="keyword">true</span>);</span><br><span class="line">                mManager.hideFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_DETACH:</span><br><span class="line">                mManager.attachFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_ATTACH:</span><br><span class="line">                mManager.setExitAnimationOrder(f, <span class="keyword">true</span>);</span><br><span class="line">                mManager.detachFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_SET_PRIMARY_NAV:</span><br><span class="line">                mManager.setPrimaryNavigationFragment(<span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_UNSET_PRIMARY_NAV:</span><br><span class="line">                mManager.setPrimaryNavigationFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_SET_MAX_LIFECYCLE:</span><br><span class="line">                mManager.setMaxLifecycle(f, op.mOldMaxState);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unknown cmd: &quot;</span> + op.mCmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!mReorderingAllowed &amp;&amp; op.mCmd != OP_REMOVE &amp;&amp; f != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!FragmentManager.USE_STATE_MANAGER) &#123;</span><br><span class="line">                mManager.moveFragmentToExpectedState(f);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mReorderingAllowed &amp;&amp; moveToState &amp;&amp; !FragmentManager.USE_STATE_MANAGER) &#123;</span><br><span class="line">        mManager.moveToState(mManager.mCurState, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="BackPressedCallback注册和反注册"><a href="#BackPressedCallback注册和反注册" class="headerlink" title="BackPressedCallback注册和反注册"></a>BackPressedCallback注册和反注册</h1><p>注册和反注册有些值得揣摩，它和以往的模式略有不同。一般而言，注册和反注册都是提供一对API，add &amp; remove 或者 register &amp; unregister。但这里mOnBackPressedDispatcher只提供addCallback，反注册是mOnBackPressedCallback自己调用cancel 方法实现。</p>
<h2 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#attachController</span><br><span class="line"><span class="meta">@SuppressLint(&quot;SyntheticAccessor&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachController</span><span class="params">(<span class="meta">@NonNull</span> FragmentHostCallback&lt;?&gt; host,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> FragmentContainer container, <span class="meta">@Nullable</span> <span class="keyword">final</span> Fragment parent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mHost != <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Already attached&quot;</span>);</span><br><span class="line">    mHost = host;</span><br><span class="line">    mContainer = container;</span><br><span class="line">    mParent = parent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set up the OnBackPressedCallback</span></span><br><span class="line">    <span class="keyword">if</span> (host <span class="keyword">instanceof</span> OnBackPressedDispatcherOwner) &#123;</span><br><span class="line">        OnBackPressedDispatcherOwner dispatcherOwner = ((OnBackPressedDispatcherOwner) host);</span><br><span class="line">        mOnBackPressedDispatcher = dispatcherOwner.getOnBackPressedDispatcher();</span><br><span class="line">        LifecycleOwner owner = parent != <span class="keyword">null</span> ? parent : dispatcherOwner;</span><br><span class="line">				<span class="comment">// 注册</span></span><br><span class="line">        mOnBackPressedDispatcher.addCallback(owner, mOnBackPressedCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="反注册"><a href="#反注册" class="headerlink" title="反注册"></a>反注册</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mDestroyed = <span class="keyword">true</span>;</span><br><span class="line">    execPendingActions(<span class="keyword">true</span>);</span><br><span class="line">    endAnimatingAwayFragments();</span><br><span class="line">    dispatchStateChange(Fragment.INITIALIZING);</span><br><span class="line">    mHost = <span class="keyword">null</span>;</span><br><span class="line">    mContainer = <span class="keyword">null</span>;</span><br><span class="line">    mParent = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mOnBackPressedDispatcher != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// mOnBackPressedDispatcher can hold a reference to the host</span></span><br><span class="line">        <span class="comment">// so we need to null it out to prevent memory leaks</span></span><br><span class="line">				<span class="comment">// 反注册</span></span><br><span class="line">        mOnBackPressedCallback.remove();</span><br><span class="line">        mOnBackPressedDispatcher = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">androidx.activity.OnBackPressedDispatcher#addCallback(androidx.lifecycle.LifecycleOwner, androidx.activity.OnBackPressedCallback)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Receive callbacks to a new &#123;<span class="doctag">@link</span> OnBackPressedCallback&#125; when the given</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> LifecycleOwner&#125; is at least &#123;<span class="doctag">@link</span> Lifecycle.State#STARTED started&#125;.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * This will automatically call &#123;<span class="doctag">@link</span> #addCallback(OnBackPressedCallback)&#125; and</span></span><br><span class="line"><span class="comment"> * remove the callback as the lifecycle state changes.</span></span><br><span class="line"><span class="comment"> * As a corollary, if your lifecycle is already at least</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Lifecycle.State#STARTED started&#125;, calling this method will result in an immediate</span></span><br><span class="line"><span class="comment"> * call to &#123;<span class="doctag">@link</span> #addCallback(OnBackPressedCallback)&#125;.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * When the &#123;<span class="doctag">@link</span> LifecycleOwner&#125; is &#123;<span class="doctag">@link</span> Lifecycle.State#DESTROYED destroyed&#125;, it will</span></span><br><span class="line"><span class="comment"> * automatically be removed from the list of callbacks. The only time you would need to</span></span><br><span class="line"><span class="comment"> * manually call &#123;<span class="doctag">@link</span> OnBackPressedCallback#remove()&#125; is if</span></span><br><span class="line"><span class="comment"> * you&#x27;d like to remove the callback prior to destruction of the associated lifecycle.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * If the Lifecycle is already &#123;<span class="doctag">@link</span> Lifecycle.State#DESTROYED destroyed&#125;</span></span><br><span class="line"><span class="comment"> * when this method is called, the callback will not be added.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> owner The LifecycleOwner which controls when the callback should be invoked</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> onBackPressedCallback The callback to add</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #onBackPressed()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressLint(&quot;LambdaLast&quot;)</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCallback</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner owner,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> OnBackPressedCallback onBackPressedCallback)</span> </span>&#123;</span><br><span class="line">    Lifecycle lifecycle = owner.getLifecycle();</span><br><span class="line">    <span class="keyword">if</span> (lifecycle.getCurrentState() == Lifecycle.State.DESTROYED) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 注册 action2</span></span><br><span class="line">    onBackPressedCallback.addCancellable(</span><br><span class="line">            <span class="keyword">new</span> LifecycleOnBackPressedCancellable(lifecycle, onBackPressedCallback));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>onBackPressedCallback的注册委托给LifecycleOnBackPressedCancellable，同时，持有LifecycleOnBackPressedCancellable的实例引用，但反注册时，onBackPressedCallback调用cancel方法，通知LifecycleOnBackPressedCancellable实例反注册。也就是A 向C注册，其实是委托给B实现注册，反注册通过A持有B的引用，也由B负责完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleOnBackPressedCancellable</span> <span class="keyword">implements</span> <span class="title">LifecycleEventObserver</span>,</span></span><br><span class="line"><span class="class">        <span class="title">Cancellable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lifecycle mLifecycle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OnBackPressedCallback mOnBackPressedCallback;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Cancellable mCurrentCancellable;</span><br><span class="line"></span><br><span class="line">    LifecycleOnBackPressedCancellable(<span class="meta">@NonNull</span> Lifecycle lifecycle,</span><br><span class="line">            <span class="meta">@NonNull</span> OnBackPressedCallback onBackPressedCallback) &#123;</span><br><span class="line">        mLifecycle = lifecycle;</span><br><span class="line">        mOnBackPressedCallback = onBackPressedCallback;</span><br><span class="line">				<span class="comment">// 注册 action1</span></span><br><span class="line">        lifecycle.addObserver(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event == Lifecycle.Event.ON_START) &#123;</span><br><span class="line">						<span class="comment">// 实际注册</span></span><br><span class="line">            mCurrentCancellable = addCancellableCallback(mOnBackPressedCallback);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event == Lifecycle.Event.ON_STOP) &#123;</span><br><span class="line">            <span class="comment">// Should always be non-null</span></span><br><span class="line">            <span class="keyword">if</span> (mCurrentCancellable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mCurrentCancellable.cancel();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event == Lifecycle.Event.ON_DESTROY) &#123;</span><br><span class="line">            cancel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="comment">// 反注册 action1</span></span><br><span class="line">        mLifecycle.removeObserver(<span class="keyword">this</span>);</span><br><span class="line">				<span class="comment">// 反注册 action2</span></span><br><span class="line">        mOnBackPressedCallback.removeCancellable(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (mCurrentCancellable != <span class="keyword">null</span>) &#123;</span><br><span class="line">						<span class="comment">// 实际反注册</span></span><br><span class="line">            mCurrentCancellable.cancel();</span><br><span class="line">            mCurrentCancellable = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">androidx.activity.OnBackPressedDispatcher#addCancellableCallback</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Internal implementation of &#123;<span class="doctag">@link</span> #addCallback(OnBackPressedCallback)&#125; that gives</span></span><br><span class="line"><span class="comment"> * access to the &#123;<span class="doctag">@link</span> Cancellable&#125; that specifically removes this callback from</span></span><br><span class="line"><span class="comment"> * the dispatcher without relying on &#123;<span class="doctag">@link</span> OnBackPressedCallback#remove()&#125; which</span></span><br><span class="line"><span class="comment"> * is what external developers should be using.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> onBackPressedCallback The callback to add</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> Cancellable&#125; which can be used to &#123;<span class="doctag">@link</span> Cancellable#cancel() cancel&#125;</span></span><br><span class="line"><span class="comment"> * the callback and remove it from the set of OnBackPressedCallbacks.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span> <span class="comment">/* synthetic access */</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function">Cancellable <span class="title">addCancellableCallback</span><span class="params">(<span class="meta">@NonNull</span> OnBackPressedCallback onBackPressedCallback)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// start后，实际注册进callback列表</span></span><br><span class="line">		mOnBackPressedCallbacks.add(onBackPressedCallback);</span><br><span class="line">		<span class="comment">// 建立OnBackPressedCancellable实例 与onBackPressedCallback的双向引用并返回</span></span><br><span class="line">    OnBackPressedCancellable cancellable = <span class="keyword">new</span> OnBackPressedCancellable(onBackPressedCallback);</span><br><span class="line">    onBackPressedCallback.addCancellable(cancellable);</span><br><span class="line">    <span class="keyword">return</span> cancellable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">OnBackPressedCancellable</span> <span class="keyword">implements</span> <span class="title">Cancellable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OnBackPressedCallback mOnBackPressedCallback;</span><br><span class="line">    OnBackPressedCancellable(OnBackPressedCallback onBackPressedCallback) &#123;</span><br><span class="line">        mOnBackPressedCallback = onBackPressedCallback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="comment">// stop后，实际反注册</span></span><br><span class="line">        mOnBackPressedCallbacks.remove(mOnBackPressedCallback);</span><br><span class="line">				<span class="comment">// 断开引用</span></span><br><span class="line">        mOnBackPressedCallback.removeCancellable(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://limxtop1989.github.io/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/" data-id="cl5xromkj00053s133ofra321" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/limxtop/2022/02/14/LifeCycle-LiveData%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          LifeCycle &amp; LiveData源码剖析
        
      </div>
    </a>
  
  
    <a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">FragmentManager源码剖析一</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/Android-view-coordinate-canvas-coordinate-%E5%9D%90%E6%A0%87%E7%B3%BB/" rel="tag">Android, view coordinate, canvas coordinate, 坐标系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/LifeCycle-LiveData/" rel="tag">LifeCycle, LiveData</a></li><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-Android-ViewModel/" rel="tag">ViewModel源码剖析, Android, ViewModel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/%E8%8B%B1%E8%AF%AD-%E8%87%AA%E5%AD%A6-%E5%85%A5%E9%97%A8-%E6%8C%87%E5%8D%97-%E6%96%B9%E6%B3%95%E8%AE%BA-%E8%AF%8D%E5%85%B8/" rel="tag">英语,自学,入门,指南,方法论,词典</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/limxtop/tags/Android-view-coordinate-canvas-coordinate-%E5%9D%90%E6%A0%87%E7%B3%BB/" style="font-size: 10px;">Android, view coordinate, canvas coordinate, 坐标系</a> <a href="/limxtop/tags/LifeCycle-LiveData/" style="font-size: 10px;">LifeCycle, LiveData</a> <a href="/limxtop/tags/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-Android-ViewModel/" style="font-size: 10px;">ViewModel源码剖析, Android, ViewModel</a> <a href="/limxtop/tags/%E8%8B%B1%E8%AF%AD-%E8%87%AA%E5%AD%A6-%E5%85%A5%E9%97%A8-%E6%8C%87%E5%8D%97-%E6%96%B9%E6%B3%95%E8%AE%BA-%E8%AF%8D%E5%85%B8/" style="font-size: 10px;">英语,自学,入门,指南,方法论,词典</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/07/">July 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/limxtop/2022/02/24/Android-view-canvas-%E5%9D%90%E6%A0%87%E7%B3%BB/">Android view &amp; canvas 坐标系</a>
          </li>
        
          <li>
            <a href="/limxtop/2022/02/14/LifeCycle-LiveData%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">LifeCycle &amp; LiveData源码剖析</a>
          </li>
        
          <li>
            <a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/">FragmentManager源码剖析二</a>
          </li>
        
          <li>
            <a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/">FragmentManager源码剖析一</a>
          </li>
        
          <li>
            <a href="/limxtop/2021/09/19/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">ViewModel源码剖析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 文理兼修电脑首席<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/limxtop/" class="mobile-nav-link">Home</a>
  
    <a href="/limxtop/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/limxtop/fancybox/jquery.fancybox.css">

  
<script src="/limxtop/fancybox/jquery.fancybox.pack.js"></script>




<script src="/limxtop/js/script.js"></script>




  </div>
</body>
</html>