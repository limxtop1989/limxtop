<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>FragmentManager源码剖析一 | 若批评不自由，则赞美无意义</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="总结 使用Fragment的Activity需要继承FragmentActivity 这里有派发生命周期方法给FragmentManager，再派发给旗下Fragment。 加入Fragment时，需要判断savedInstanceState &#x3D;&#x3D; null ，避免重复创建实例。 add Fragment，初始时，其Fragment生命周期方法会被升级到onStart 状态，随后与Fragment">
<meta property="og:type" content="article">
<meta property="og:title" content="FragmentManager源码剖析一">
<meta property="og:url" content="https://limxtop1989.github.io/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/index.html">
<meta property="og:site_name" content="若批评不自由，则赞美无意义">
<meta property="og:description" content="总结 使用Fragment的Activity需要继承FragmentActivity 这里有派发生命周期方法给FragmentManager，再派发给旗下Fragment。 加入Fragment时，需要判断savedInstanceState &#x3D;&#x3D; null ，避免重复创建实例。 add Fragment，初始时，其Fragment生命周期方法会被升级到onStart 状态，随后与Fragment">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://developer.android.com/images/guide/fragments/fragment-view-lifecycle.png">
<meta property="article:published_time" content="2021-10-18T13:23:33.000Z">
<meta property="article:modified_time" content="2022-07-23T10:38:56.389Z">
<meta property="article:author" content="文理兼修电脑首席">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://developer.android.com/images/guide/fragments/fragment-view-lifecycle.png">
  
    <link rel="alternate" href="/limxtop/atom.xml" title="若批评不自由，则赞美无意义" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/limxtop/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/limxtop/" id="logo">若批评不自由，则赞美无意义</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/limxtop/">Home</a>
        
          <a class="main-nav-link" href="/limxtop/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/limxtop/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://limxtop1989.github.io/limxtop"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-FragmentManager源码剖析1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/" class="article-date">
  <time datetime="2021-10-18T13:23:33.000Z" itemprop="datePublished">2021-10-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      FragmentManager源码剖析一
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>使用Fragment的Activity需要继承<code>FragmentActivity</code> 这里有派发生命周期方法给FragmentManager，再派发给旗下Fragment。</li>
<li>加入Fragment时，需要判断<code>savedInstanceState == null</code> ，避免重复创建实例。</li>
<li>add Fragment，初始时，其Fragment生命周期方法会被升级到onStart 状态，随后与FragmentManager的状态同步，如果宿主Activity是Resume状态，则同步至onResume状态。</li>
<li>detach fragment，其生命周期方法会被降级到onDestroyView。</li>
<li>remove fragment，其生命周期方法会被降级到onDestroyView 或者onDestroy。</li>
<li>show or hide fragment，生命周期方法不会回调，只是切换fragment 根view的可见性。</li>
</ol>
<h1 id="Sample-codes"><a href="#Sample-codes" class="headerlink" title="Sample codes"></a>Sample codes</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(R.layout.example_activity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="keyword">if</span> (savedInstanceState == <span class="keyword">null</span>) &#123;</span><br><span class="line">            getSupportFragmentManager().beginTransaction()</span><br><span class="line">                .setReorderingAllowed(<span class="keyword">true</span>)</span><br><span class="line">                .add(R.id.fragment_container_view, ExampleFragment.class)</span><br><span class="line">								<span class="comment">// name can be null</span></span><br><span class="line">								.addToBackStack(<span class="string">&quot;name&quot;</span>) </span><br><span class="line">                .commit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note: the fragment transaction is only created when savedInstanceState is null. This is to ensure that the fragment is added only once, when the activity is first created. When a configuration change occurs and the activity is recreated, savedInstanceState is no longer null, and the fragment does not need to be added a second time, as the fragment is automatically restored from the savedInstanceState.</p>
<p>Note: You should always use setReorderingAllowed(true) when performing a FragmentTransaction. For more information on reordered transactions, see Fragment transactions.</p>
<h2 id="beginTransaction"><a href="#beginTransaction" class="headerlink" title="beginTransaction"></a>beginTransaction</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FragmentTransaction <span class="title">beginTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BackStackRecord(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="setReorderingAllowed"><a href="#setReorderingAllowed" class="headerlink" title="setReorderingAllowed"></a>setReorderingAllowed</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets whether or not to allow optimizing operations within and across</span></span><br><span class="line"><span class="comment"> * transactions. This will remove redundant operations, eliminating</span></span><br><span class="line"><span class="comment"> * operations that cancel. For example, if two transactions are executed</span></span><br><span class="line"><span class="comment"> * together, one that adds a fragment A and the next replaces it with fragment B,</span></span><br><span class="line"><span class="comment"> * the operations will cancel and only fragment B will be added. That means that</span></span><br><span class="line"><span class="comment"> * fragment A may not go through the creation/destruction lifecycle.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The side effect of removing redundant operations is that fragments may have state changes</span></span><br><span class="line"><span class="comment"> * out of the expected order. For example, one transaction adds fragment A,</span></span><br><span class="line"><span class="comment"> * a second adds fragment B, then a third removes fragment A. Without removing the redundant</span></span><br><span class="line"><span class="comment"> * operations, fragment B could expect that while it is being created, fragment A will also</span></span><br><span class="line"><span class="comment"> * exist because fragment A will be removed after fragment B was added.</span></span><br><span class="line"><span class="comment"> * With removing redundant operations, fragment B cannot expect fragment A to exist when</span></span><br><span class="line"><span class="comment"> * it has been created because fragment A&#x27;s add/remove will be optimized out.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * It can also reorder the state changes of Fragments to allow for better Transitions.</span></span><br><span class="line"><span class="comment"> * Added Fragments may have &#123;<span class="doctag">@link</span> Fragment#onCreate(Bundle)&#125; called before replaced</span></span><br><span class="line"><span class="comment"> * Fragments have &#123;<span class="doctag">@link</span> Fragment#onDestroy()&#125; called.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Fragment#postponeEnterTransition()&#125; requires &#123;<span class="doctag">@code</span> setReorderingAllowed(true)&#125;.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The default is &#123;<span class="doctag">@code</span> false&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> reorderingAllowed &#123;<span class="doctag">@code</span> true&#125; to enable optimizing out redundant operations</span></span><br><span class="line"><span class="comment"> *                          or &#123;<span class="doctag">@code</span> false&#125; to disable optimizing out redundant</span></span><br><span class="line"><span class="comment"> *                          operations on this transaction.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FragmentTransaction <span class="title">setReorderingAllowed</span><span class="params">(<span class="keyword">boolean</span> reorderingAllowed)</span> </span>&#123;</span><br><span class="line">    mReorderingAllowed = reorderingAllowed;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="add"><a href="#add" class="headerlink" title="add"></a>add</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Calls &#123;<span class="doctag">@link</span> #add(int, Fragment, String)&#125; with a 0 containerViewId.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FragmentTransaction <span class="title">add</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment, <span class="meta">@Nullable</span> String tag)</span>  </span>&#123;</span><br><span class="line">    doAddOp(<span class="number">0</span>, fragment, tag, OP_ADD);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doAddOp</span><span class="params">(<span class="keyword">int</span> containerViewId, Fragment fragment, <span class="meta">@Nullable</span> String tag, <span class="keyword">int</span> opcmd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; fragmentClass = fragment.getClass();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> modifiers = fragmentClass.getModifiers();</span><br><span class="line">    <span class="keyword">if</span> (fragmentClass.isAnonymousClass() || !Modifier.isPublic(modifiers)</span><br><span class="line">            || (fragmentClass.isMemberClass() &amp;&amp; !Modifier.isStatic(modifiers))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Fragment &quot;</span> + fragmentClass.getCanonicalName()</span><br><span class="line">                + <span class="string">&quot; must be a public static class to be  properly recreated from&quot;</span></span><br><span class="line">                + <span class="string">&quot; instance state.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tag != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fragment.mTag != <span class="keyword">null</span> &amp;&amp; !tag.equals(fragment.mTag)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Can&#x27;t change tag of fragment &quot;</span></span><br><span class="line">                    + fragment + <span class="string">&quot;: was &quot;</span> + fragment.mTag</span><br><span class="line">                    + <span class="string">&quot; now &quot;</span> + tag);</span><br><span class="line">        &#125;</span><br><span class="line">        fragment.mTag = tag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (containerViewId != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (containerViewId == View.NO_ID) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Can&#x27;t add fragment &quot;</span></span><br><span class="line">                    + fragment + <span class="string">&quot; with tag &quot;</span> + tag + <span class="string">&quot; to container view with no id&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fragment.mFragmentId != <span class="number">0</span> &amp;&amp; fragment.mFragmentId != containerViewId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Can&#x27;t change container ID of fragment &quot;</span></span><br><span class="line">                    + fragment + <span class="string">&quot;: was &quot;</span> + fragment.mFragmentId</span><br><span class="line">                    + <span class="string">&quot; now &quot;</span> + containerViewId);</span><br><span class="line">        &#125;</span><br><span class="line">        fragment.mContainerId = fragment.mFragmentId = containerViewId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addOp(<span class="keyword">new</span> Op(opcmd, fragment));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addOp</span><span class="params">(Op op)</span> </span>&#123;</span><br><span class="line">    mOps.add(op);</span><br><span class="line">    op.mEnterAnim = mEnterAnim;</span><br><span class="line">    op.mExitAnim = mExitAnim;</span><br><span class="line">    op.mPopEnterAnim = mPopEnterAnim;</span><br><span class="line">    op.mPopExitAnim = mPopExitAnim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传入fragment实例，将对fragment的增删换，显示隐藏等操作封装成op，并加入op列表集合，作为一个操作事物。</p>
<h2 id="addToBackStack"><a href="#addToBackStack" class="headerlink" title="addToBackStack"></a>addToBackStack</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add this transaction to the back stack.  This means that the transaction</span></span><br><span class="line"><span class="comment"> * will be remembered after it is committed, and will reverse its operation</span></span><br><span class="line"><span class="comment"> * when later popped off the stack.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #setReorderingAllowed(boolean)&#125; must be set to &lt;code&gt;true&lt;/code&gt;</span></span><br><span class="line"><span class="comment"> * in the same transaction as addToBackStack() to allow the pop of that</span></span><br><span class="line"><span class="comment"> * transaction to be reordered.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name An optional name for this back stack state, or null.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FragmentTransaction <span class="title">addToBackStack</span><span class="params">(<span class="meta">@Nullable</span> String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mAllowAddToBackStack) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                <span class="string">&quot;This FragmentTransaction is not allowed to be added to the back stack.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mAddToBackStack = <span class="keyword">true</span>;</span><br><span class="line">    mName = name;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>addToBackStack更新mAddToBackStack标记位，并保存backStack名字，作为未来回退到此backStack的标示。</p>
<h2 id="commit"><a href="#commit" class="headerlink" title="commit"></a>commit</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.BackStackRecord#<span class="function">commitInternal</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">commitInternal</span><span class="params">(<span class="keyword">boolean</span> allowStateLoss)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mCommitted) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;commit already called&quot;</span>);</span><br><span class="line">    mCommitted = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (mAddToBackStack) &#123;</span><br><span class="line">        mIndex = mManager.allocBackStackIndex(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mIndex = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mManager.enqueueAction(<span class="keyword">this</span>, allowStateLoss);</span><br><span class="line">    <span class="keyword">return</span> mIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果加入backStack，则分配一个在backStack的索引，然后将此事务加入提交队列，等待主线程调度提交。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#enqueueAction</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds an action to the queue of pending actions.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> action the action to add</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> allowStateLoss whether to allow loss of state information</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalStateException if the activity has been destroyed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueAction</span><span class="params">(OpGenerator action, <span class="keyword">boolean</span> allowStateLoss)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!allowStateLoss) &#123;</span><br><span class="line">        checkStateLoss();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDestroyed || mHost == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (allowStateLoss) &#123;</span><br><span class="line">                <span class="comment">// This FragmentManager isn&#x27;t attached, so drop the entire transaction.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Activity has been destroyed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mPendingActions == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPendingActions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        mPendingActions.add(action);</span><br><span class="line">        scheduleCommit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="OpGenerator"><a href="#OpGenerator" class="headerlink" title="OpGenerator"></a>OpGenerator</h2><p>BackStackRecord实现OpGenerator接口，先看下方法实现内容：将本次事务加入事务集合。并且判断如果要支持回退栈，则加入回退栈集合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.BackStackRecord#generateOps</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implementation of &#123;<span class="doctag">@link</span> FragmentManagerImpl.OpGenerator&#125;.</span></span><br><span class="line"><span class="comment"> * This operation is added to the list of pending actions during &#123;<span class="doctag">@link</span> #commit()&#125;, and</span></span><br><span class="line"><span class="comment"> * will be executed on the UI thread to run this FragmentTransaction.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> records Modified to add this BackStackRecord</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isRecordPop Modified to add a false (this isn&#x27;t a pop)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true always because the records and isRecordPop will always be changed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">generateOps</span><span class="params">(ArrayList&lt;BackStackRecord&gt; records, ArrayList&lt;Boolean&gt; isRecordPop)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (FragmentManagerImpl.DEBUG) &#123;</span><br><span class="line">        Log.v(TAG, <span class="string">&quot;Run: &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    records.add(<span class="keyword">this</span>);</span><br><span class="line">    isRecordPop.add(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (mAddToBackStack) &#123;</span><br><span class="line">        mManager.addBackStackState(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#<span class="function">addBackStackState</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addBackStackState</span><span class="params">(BackStackRecord state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBackStack == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mBackStack = <span class="keyword">new</span> ArrayList&lt;BackStackRecord&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    mBackStack.add(state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="scheduleCommit"><a href="#scheduleCommit" class="headerlink" title="scheduleCommit"></a>scheduleCommit</h1><h2 id="ensureExecReady"><a href="#ensureExecReady" class="headerlink" title="ensureExecReady"></a>ensureExecReady</h2><p>条件检查，并实例化mTmpRecords &amp; mTmpIsPop。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#execPendingActions</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Only call from main thread!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execPendingActions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ensureExecReady(<span class="keyword">true</span>);<span class="comment">// 1. Init mTmpRecords &amp; mTmpIsPop</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 2. Copy BackStackRecord  in mPendingActions into mTmpRecords， so does mTmpIsPop </span></span><br><span class="line">    <span class="keyword">while</span> (generateOpsForPendingActions(mTmpRecords, mTmpIsPop)) &#123;</span><br><span class="line">        mExecutingActions = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="comment">// 3. </span></span><br><span class="line">            removeRedundantOperationsAndExecute(mTmpRecords, mTmpIsPop);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            cleanupExec();</span><br><span class="line">        &#125;</span><br><span class="line">        didSomething = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    updateOnBackPressedCallbackEnabled();</span><br><span class="line">    doPendingDeferredStart();</span><br><span class="line">    burpActive();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="generateOpsForPendingActions"><a href="#generateOpsForPendingActions" class="headerlink" title="generateOpsForPendingActions"></a>generateOpsForPendingActions</h2><p>将mPendingActions的BackStackRecord，即我们提交的事务集合，复制到records（即成员变量mTmpRecords，mTmpIsPop同理）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#generateOpsForPendingActions</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds all records in the pending actions to records and whether they are add or pop</span></span><br><span class="line"><span class="comment"> * operations to isPop. After executing, the pending actions will be empty.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> records All pending actions will generate BackStackRecords added to this.</span></span><br><span class="line"><span class="comment"> *                This contains the transactions, in order, to execute.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isPop All pending actions will generate booleans to add to this. This contains</span></span><br><span class="line"><span class="comment"> *              an entry for each entry in records to indicate whether or not it is a</span></span><br><span class="line"><span class="comment"> *              pop action.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">generateOpsForPendingActions</span><span class="params">(ArrayList&lt;BackStackRecord&gt; records,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             ArrayList&lt;Boolean&gt; isPop)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPendingActions == <span class="keyword">null</span> || mPendingActions.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> numActions = mPendingActions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numActions; i++) &#123;</span><br><span class="line">            didSomething |= mPendingActions.get(i).generateOps(records, isPop);</span><br><span class="line">        &#125;</span><br><span class="line">        mPendingActions.clear();</span><br><span class="line">        mHost.getHandler().removeCallbacks(mExecCommit);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="removeRedundantOperationsAndExecute"><a href="#removeRedundantOperationsAndExecute" class="headerlink" title="removeRedundantOperationsAndExecute"></a>removeRedundantOperationsAndExecute</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#removeRedundantOperationsAndExecute</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Remove redundant BackStackRecord operations and executes them. This method merges operations</span></span><br><span class="line"><span class="comment"> * of proximate records that allow reordering. See</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> FragmentTransaction#setReorderingAllowed(boolean)&#125;.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * For example, a transaction that adds to the back stack and then another that pops that</span></span><br><span class="line"><span class="comment"> * back stack record will be optimized to remove the unnecessary operation.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Likewise, two transactions committed that are executed at the same time will be optimized</span></span><br><span class="line"><span class="comment"> * to remove the redundant operations as well as two pop operations executed together.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> records The records pending execution</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isRecordPop The direction that these records are being run.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeRedundantOperationsAndExecute</span><span class="params">(ArrayList&lt;BackStackRecord&gt; records,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                 ArrayList&lt;Boolean&gt; isRecordPop)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (records == <span class="keyword">null</span> || records.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isRecordPop == <span class="keyword">null</span> || records.size() != isRecordPop.size()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Internal error with the back stack records&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Force start of any postponed transactions that interact with scheduled transactions:</span></span><br><span class="line">    executePostponedTransaction(records, isRecordPop);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> numRecords = records.size();</span><br><span class="line">    <span class="keyword">int</span> startIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> recordNum = <span class="number">0</span>; recordNum &lt; numRecords; recordNum++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> canReorder = records.get(recordNum).mReorderingAllowed;</span><br><span class="line">        <span class="keyword">if</span> (!canReorder) &#123;</span><br><span class="line">            <span class="comment">// execute all previous transactions</span></span><br><span class="line">            <span class="keyword">if</span> (startIndex != recordNum) &#123;</span><br><span class="line">                executeOpsTogether(records, isRecordPop, startIndex, recordNum);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// execute all pop operations that don&#x27;t allow reordering together or</span></span><br><span class="line">            <span class="comment">// one add operation</span></span><br><span class="line">            <span class="keyword">int</span> reorderingEnd = recordNum + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (isRecordPop.get(recordNum)) &#123;</span><br><span class="line">                <span class="keyword">while</span> (reorderingEnd &lt; numRecords</span><br><span class="line">                        &amp;&amp; isRecordPop.get(reorderingEnd)</span><br><span class="line">                        &amp;&amp; !records.get(reorderingEnd).mReorderingAllowed) &#123;</span><br><span class="line">                    reorderingEnd++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            executeOpsTogether(records, isRecordPop, recordNum, reorderingEnd);</span><br><span class="line">            startIndex = reorderingEnd;</span><br><span class="line">            recordNum = reorderingEnd - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// Reorder is true as example code. Pay attention here.</span></span><br><span class="line">    <span class="keyword">if</span> (startIndex != numRecords) &#123;</span><br><span class="line">				<span class="comment">// startIndex 为0， numRecords为批处理的事务个数。</span></span><br><span class="line">        executeOpsTogether(records, isRecordPop, startIndex, numRecords);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="executeOpsTogether"><a href="#executeOpsTogether" class="headerlink" title="executeOpsTogether"></a>executeOpsTogether</h2><p>一般推荐允许重排序，看最后一行方法调用executeOpsTogether。从API描述看，它执行事务集合的子集，子集里事务要么是允许重排序，要么不允许。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#executeOpsTogether</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Executes a subset of a list of BackStackRecords, all of which either allow reordering or</span></span><br><span class="line"><span class="comment"> * do not allow ordering.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> records A list of BackStackRecords that are to be executed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isRecordPop The direction that these records are being run.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startIndex The index of the first record in &lt;code&gt;records&lt;/code&gt; to be executed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endIndex One more than the final record index in &lt;code&gt;records&lt;/code&gt; to executed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeOpsTogether</span><span class="params">(<span class="meta">@NonNull</span> ArrayList&lt;BackStackRecord&gt; records,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> ArrayList&lt;Boolean&gt; isRecordPop, <span class="keyword">int</span> startIndex, <span class="keyword">int</span> endIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> allowReordering = records.get(startIndex).mReorderingAllowed;</span><br><span class="line">    <span class="keyword">boolean</span> addToBackStack = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mTmpAddedFragments == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mTmpAddedFragments = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mTmpAddedFragments.clear();</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 执行transaction.add(fragment)，事务完成后，fragment会加入mAdded集合内，</span></span><br><span class="line">		<span class="comment">// activity生命周期方法派发给FragmentManager，继而派发给mAdded集合内的Fragment</span></span><br><span class="line">		<span class="comment">// 此处复制已添加Fragment集合到临时变量，</span></span><br><span class="line">    mTmpAddedFragments.addAll(mFragmentStore.getFragments());</span><br><span class="line">    Fragment oldPrimaryNav = getPrimaryNavigationFragment();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> recordNum = startIndex; recordNum &lt; endIndex; recordNum++) &#123;</span><br><span class="line">        <span class="keyword">final</span> BackStackRecord record = records.get(recordNum);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPop = isRecordPop.get(recordNum);</span><br><span class="line">        <span class="keyword">if</span> (!isPop) &#123;</span><br><span class="line">						<span class="comment">// 这里将op替换为更原子的操作，如replace拆解为remove &amp; add，并将ops内的fragment</span></span><br><span class="line">						<span class="comment">// 依照op的cmd命令，从mTmpAddedFragments add 或 remove op里的fragment，</span></span><br><span class="line">            oldPrimaryNav = record.expandOps(mTmpAddedFragments, oldPrimaryNav);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            oldPrimaryNav = record.trackAddedFragmentsInPop(mTmpAddedFragments, oldPrimaryNav);</span><br><span class="line">        &#125;</span><br><span class="line">        addToBackStack = addToBackStack || record.mAddToBackStack;</span><br><span class="line">    &#125;</span><br><span class="line">    mTmpAddedFragments.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!allowReordering &amp;&amp; mCurState &gt;= Fragment.CREATED) &#123;</span><br><span class="line">        <span class="comment">// 一般推荐重排序，此处代码省略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1. 遍历BackStackRecord集合，逐个执行事务：将Fragment发送给FragmentManager管理，并更新Fragment标记。</span></span><br><span class="line">    executeOps(records, isRecordPop, startIndex, endIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (USE_STATE_MANAGER) &#123;</span><br><span class="line">        <span class="comment">// The last operation determines the overall direction, this ensures that operations</span></span><br><span class="line">        <span class="comment">// such as push, push, pop, push are correctly considered a push</span></span><br><span class="line">        <span class="keyword">boolean</span> isPop = isRecordPop.get(endIndex - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// Ensure that Fragments directly affected by operations</span></span><br><span class="line">        <span class="comment">// are moved to their expected state in operation order</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = startIndex; index &lt; endIndex; index++) &#123;</span><br><span class="line">            BackStackRecord record = records.get(index);</span><br><span class="line">            <span class="keyword">if</span> (isPop) &#123;</span><br><span class="line">                <span class="comment">// Pop operations get applied in reverse order</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> opIndex = record.mOps.size() - <span class="number">1</span>; opIndex &gt;= <span class="number">0</span>; opIndex--) &#123;</span><br><span class="line">                    FragmentTransaction.Op op = record.mOps.get(opIndex);</span><br><span class="line">                    Fragment fragment = op.mFragment;</span><br><span class="line">                    <span class="keyword">if</span> (fragment != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        FragmentStateManager fragmentStateManager =</span><br><span class="line">                                createOrGetFragmentStateManager(fragment);</span><br><span class="line">                        fragmentStateManager.moveToExpectedState();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (FragmentTransaction.Op op : record.mOps) &#123;</span><br><span class="line">                    Fragment fragment = op.mFragment;</span><br><span class="line">                    <span class="keyword">if</span> (fragment != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        FragmentStateManager fragmentStateManager =</span><br><span class="line">                                createOrGetFragmentStateManager(fragment);</span><br><span class="line">												<span class="comment">// 2. 事务内的Fragment推送至默认状态</span></span><br><span class="line">                        fragmentStateManager.moveToExpectedState();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// And only then do we move all other fragments to the current state</span></span><br><span class="line">				<span class="comment">// 3. 将Fragment全部推送到当前FragmentManager的状态。</span></span><br><span class="line">        moveToState(mCurState, <span class="keyword">true</span>);</span><br><span class="line">        Set&lt;SpecialEffectsController&gt; changedControllers = collectChangedControllers(</span><br><span class="line">                records, startIndex, endIndex);</span><br><span class="line">        <span class="keyword">for</span> (SpecialEffectsController controller : changedControllers) &#123;</span><br><span class="line">            controller.updateOperationDirection(isPop);</span><br><span class="line">            controller.markPostponedState();</span><br><span class="line">            controller.executePendingOperations();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// USE_STATE_MANAGER 默认为true，此处代码省略</span></span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 调用每个事务的提交监听回掉</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> recordNum = startIndex; recordNum &lt; endIndex; recordNum++) &#123;</span><br><span class="line">        <span class="keyword">final</span> BackStackRecord record = records.get(recordNum);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPop = isRecordPop.get(recordNum);</span><br><span class="line">        <span class="keyword">if</span> (isPop &amp;&amp; record.mIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            record.mIndex = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        record.runOnCommitRunnables();</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// // 通知backStack变更的监听回掉</span></span><br><span class="line">    <span class="keyword">if</span> (addToBackStack) &#123;</span><br><span class="line">        reportBackStackChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="executeOps"><a href="#executeOps" class="headerlink" title="executeOps"></a>executeOps</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#executeOps</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run the operations in the BackStackRecords, either to push or pop.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> records The list of records whose operations should be run.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isRecordPop The direction that these records are being run.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startIndex The index of the first entry in records to run.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endIndex One past the index of the final entry in records to run.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">executeOps</span><span class="params">(ArrayList&lt;BackStackRecord&gt; records,</span></span></span><br><span class="line"><span class="params"><span class="function">                               ArrayList&lt;Boolean&gt; isRecordPop, <span class="keyword">int</span> startIndex, <span class="keyword">int</span> endIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; endIndex; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> BackStackRecord record = records.get(i);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPop = isRecordPop.get(i);</span><br><span class="line">        <span class="keyword">if</span> (isPop) &#123;</span><br><span class="line">            record.bumpBackStackNesting(-<span class="number">1</span>);</span><br><span class="line">            <span class="comment">// Only execute the add operations at the end of</span></span><br><span class="line">            <span class="comment">// all transactions.</span></span><br><span class="line">            <span class="keyword">boolean</span> moveToState = i == (endIndex - <span class="number">1</span>);</span><br><span class="line">            record.executePopOps(moveToState);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            record.bumpBackStackNesting(<span class="number">1</span>);</span><br><span class="line">            record.executeOps();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历事务Op集合，逐个执行事务里的Op</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.BackStackRecord#executeOps</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Executes the operations contained within this transaction. The Fragment states will only</span></span><br><span class="line"><span class="comment"> * be modified if optimizations are not allowed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">executeOps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> numOps = mOps.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> opNum = <span class="number">0</span>; opNum &lt; numOps; opNum++) &#123;</span><br><span class="line">        <span class="keyword">final</span> Op op = mOps.get(opNum);</span><br><span class="line">        <span class="keyword">final</span> Fragment f = op.mFragment;</span><br><span class="line">        <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">            f.setPopDirection(<span class="keyword">false</span>);</span><br><span class="line">            f.setAnimations(op.mEnterAnim, op.mExitAnim, op.mPopEnterAnim, op.mPopExitAnim);</span><br><span class="line">            f.setNextTransition(mTransition);</span><br><span class="line">            f.setSharedElementNames(mSharedElementSourceNames, mSharedElementTargetNames);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (op.mCmd) &#123;</span><br><span class="line">            <span class="keyword">case</span> OP_ADD:</span><br><span class="line">                mManager.setExitAnimationOrder(f, <span class="keyword">false</span>);</span><br><span class="line">                mManager.addFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_REMOVE:</span><br><span class="line">                mManager.removeFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_HIDE:</span><br><span class="line">                mManager.hideFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_SHOW:</span><br><span class="line">                mManager.setExitAnimationOrder(f, <span class="keyword">false</span>);</span><br><span class="line">                mManager.showFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_DETACH:</span><br><span class="line">                mManager.detachFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_ATTACH:</span><br><span class="line">                mManager.setExitAnimationOrder(f, <span class="keyword">false</span>);</span><br><span class="line">                mManager.attachFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_SET_PRIMARY_NAV:</span><br><span class="line">                mManager.setPrimaryNavigationFragment(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_UNSET_PRIMARY_NAV:</span><br><span class="line">                mManager.setPrimaryNavigationFragment(<span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OP_SET_MAX_LIFECYCLE:</span><br><span class="line">                mManager.setMaxLifecycle(f, op.mCurrentMaxState);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unknown cmd: &quot;</span> + op.mCmd);</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// 允许排序，以下代码不执行</span></span><br><span class="line">        <span class="keyword">if</span> (!mReorderingAllowed &amp;&amp; op.mCmd != OP_ADD &amp;&amp; f != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!FragmentManager.USE_STATE_MANAGER) &#123;</span><br><span class="line">                mManager.moveFragmentToExpectedState(f);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mReorderingAllowed &amp;&amp; !FragmentManager.USE_STATE_MANAGER) &#123;</span><br><span class="line">        <span class="comment">// Added fragments are added at the end to comply with prior behavior.</span></span><br><span class="line">        mManager.moveToState(mManager.mCurState, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>addFragment &amp; removeFragment 主要是操作mAdded fragment集合并更新fragment.mRemoving &amp; fragment.mAdded 标记</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#<span class="function">removeFragment</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeFragment</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isLoggingEnabled(Log.VERBOSE)) &#123;</span><br><span class="line">        Log.v(TAG, <span class="string">&quot;remove: &quot;</span> + fragment + <span class="string">&quot; nesting=&quot;</span> + fragment.mBackStackNesting);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> inactive = !fragment.isInBackStack();</span><br><span class="line">    <span class="keyword">if</span> (!fragment.mDetached || inactive) &#123;</span><br><span class="line">        mFragmentStore.removeFragment(fragment);</span><br><span class="line">        <span class="keyword">if</span> (isMenuAvailable(fragment)) &#123;</span><br><span class="line">            mNeedMenuInvalidate = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fragment.mRemoving = <span class="keyword">true</span>;</span><br><span class="line">        setVisibleRemovingFragment(fragment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">androidx.fragment.app.FragmentManager#<span class="function">addFragment</span></span><br><span class="line"><span class="function">FragmentStateManager <span class="title">addFragment</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isLoggingEnabled(Log.VERBOSE)) Log.v(TAG, <span class="string">&quot;add: &quot;</span> + fragment);</span><br><span class="line">    FragmentStateManager fragmentStateManager = createOrGetFragmentStateManager(fragment);</span><br><span class="line">    fragment.mFragmentManager = <span class="keyword">this</span>;</span><br><span class="line">    mFragmentStore.makeActive(fragmentStateManager);</span><br><span class="line">    <span class="keyword">if</span> (!fragment.mDetached) &#123;</span><br><span class="line">        mFragmentStore.addFragment(fragment);</span><br><span class="line">        fragment.mRemoving = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (fragment.mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            fragment.mHiddenChanged = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isMenuAvailable(fragment)) &#123;</span><br><span class="line">            mNeedMenuInvalidate = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fragmentStateManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>attachFragment 与addFragment的差异： </p>
<ol>
<li>无makeActive(fragment)，这个差异导致两者的Fragment默认升级到started状态后，只有add fragment会继续与FragmentManager状态同步，接收FragmentManager生命周期方法的派发，attach fragment则到此戛然而止。也没有moveToState(fragment)操作（addFragment下，此方法不调用，传入moveToStateNow参数值为false）</li>
<li>只有之前detach操作过，attach才有效果。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#<span class="function">attachFragment</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachFragment</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isLoggingEnabled(Log.VERBOSE)) Log.v(TAG, <span class="string">&quot;attach: &quot;</span> + fragment);</span><br><span class="line">    <span class="keyword">if</span> (fragment.mDetached) &#123;</span><br><span class="line">				<span class="comment">// 初始化时，mDetached为false，只有detachFragment才置为true。</span></span><br><span class="line">        fragment.mDetached = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!fragment.mAdded) &#123;</span><br><span class="line">            mFragmentStore.addFragment(fragment);</span><br><span class="line">            <span class="keyword">if</span> (isLoggingEnabled(Log.VERBOSE)) Log.v(TAG, <span class="string">&quot;add from attach: &quot;</span> + fragment);</span><br><span class="line">            <span class="keyword">if</span> (isMenuAvailable(fragment)) &#123;</span><br><span class="line">                mNeedMenuInvalidate = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">androidx.fragment.app.FragmentStore#<span class="function">addFragment</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addFragment</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mAdded.contains(fragment)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Fragment already added: &quot;</span> + fragment);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mAdded) &#123;</span><br><span class="line">        mAdded.add(fragment);</span><br><span class="line">    &#125;</span><br><span class="line">    fragment.mAdded = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>remove &amp; detachFragment都将fragment从mAdded集合移除fragment，不同的是分别标记mRemoving &amp; mDetached 为true。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeFragment</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isLoggingEnabled(Log.VERBOSE)) &#123;</span><br><span class="line">        Log.v(TAG, <span class="string">&quot;remove: &quot;</span> + fragment + <span class="string">&quot; nesting=&quot;</span> + fragment.mBackStackNesting);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> inactive = !fragment.isInBackStack();</span><br><span class="line">    <span class="keyword">if</span> (!fragment.mDetached || inactive) &#123;</span><br><span class="line">        mFragmentStore.removeFragment(fragment);</span><br><span class="line">        <span class="keyword">if</span> (isMenuAvailable(fragment)) &#123;</span><br><span class="line">            mNeedMenuInvalidate = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fragment.mRemoving = <span class="keyword">true</span>;</span><br><span class="line">        setVisibleRemovingFragment(fragment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeFragment</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mAdded) &#123;</span><br><span class="line">        mAdded.remove(fragment);</span><br><span class="line">    &#125;</span><br><span class="line">    fragment.mAdded = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">detachFragment</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isLoggingEnabled(Log.VERBOSE)) Log.v(TAG, <span class="string">&quot;detach: &quot;</span> + fragment);</span><br><span class="line">    <span class="keyword">if</span> (!fragment.mDetached) &#123;</span><br><span class="line">        fragment.mDetached = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (fragment.mAdded) &#123;</span><br><span class="line">            <span class="comment">// We are not already in back stack, so need to remove the fragment.</span></span><br><span class="line">            <span class="keyword">if</span> (isLoggingEnabled(Log.VERBOSE)) Log.v(TAG, <span class="string">&quot;remove from detach: &quot;</span> + fragment);</span><br><span class="line">            mFragmentStore.removeFragment(fragment);</span><br><span class="line">            <span class="keyword">if</span> (isMenuAvailable(fragment)) &#123;</span><br><span class="line">                mNeedMenuInvalidate = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            setVisibleRemovingFragment(fragment);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>showFrament &amp; hideFragment 主要更新mHidden标记</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Marks a fragment as hidden to be later animated in with</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #completeShowHideFragment(Fragment)&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fragment The fragment to be shown.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hideFragment</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isLoggingEnabled(Log.VERBOSE)) Log.v(TAG, <span class="string">&quot;hide: &quot;</span> + fragment);</span><br><span class="line">    <span class="keyword">if</span> (!fragment.mHidden) &#123;</span><br><span class="line">        fragment.mHidden = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></span><br><span class="line">        <span class="comment">// it doesn&#x27;t go through the animation.</span></span><br><span class="line">        fragment.mHiddenChanged = !fragment.mHiddenChanged;</span><br><span class="line">        setVisibleRemovingFragment(fragment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Marks a fragment as shown to be later animated in with</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #completeShowHideFragment(Fragment)&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fragment The fragment to be shown.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showFragment</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isLoggingEnabled(Log.VERBOSE)) Log.v(TAG, <span class="string">&quot;show: &quot;</span> + fragment);</span><br><span class="line">    <span class="keyword">if</span> (fragment.mHidden) &#123;</span><br><span class="line">        fragment.mHidden = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// Toggle hidden changed so that if a fragment goes through show/hide/show</span></span><br><span class="line">        <span class="comment">// it doesn&#x27;t go through the animation.</span></span><br><span class="line">        fragment.mHiddenChanged = !fragment.mHiddenChanged;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Fragment 主要标记</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// True if the fragment is in the list of added fragments.</span></span><br><span class="line"><span class="keyword">boolean</span> mAdded;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If set this fragment is being removed from its activity.</span></span><br><span class="line"><span class="keyword">boolean</span> mRemoving;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set to true when the app has requested that this fragment be hidden</span></span><br><span class="line"><span class="comment">// from the user.</span></span><br><span class="line"><span class="keyword">boolean</span> mHidden;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set to true when the app has requested that this fragment be deactivated.</span></span><br><span class="line"><span class="keyword">boolean</span> mDetached;</span><br></pre></td></tr></table></figure>

<h3 id="moveToExpectedState"><a href="#moveToExpectedState" class="headerlink" title="moveToExpectedState"></a>moveToExpectedState</h3><p>遍历事务集合，将事务内每个op 对应的Fragment推送到合适的状态，具体状态值在computeExpectedState计算。默认是当前FragmentManager的状态。但会根据Fragment标记重算。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assume the Fragment can go as high as the FragmentManager&#x27;s state</span></span><br><span class="line"><span class="keyword">int</span> maxState = mFragmentManagerState;</span><br><span class="line"><span class="comment">// Fragments that are not currently added will sit in the CREATED state.</span></span><br><span class="line"><span class="comment">// detach &amp; remove 操作的fragment，目标状态是CREATED</span></span><br><span class="line"><span class="keyword">if</span> (!mFragment.mAdded) &#123;</span><br><span class="line">    maxState = Math.min(maxState, Fragment.CREATED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mFragment.mRemoving) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mFragment.isInBackStack()) &#123;</span><br><span class="line">        <span class="comment">// Fragments on the back stack shouldn&#x27;t go higher than CREATED</span></span><br><span class="line">        maxState = Math.min(maxState, Fragment.CREATED);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// While removing a fragment, we always move to INITIALIZING</span></span><br><span class="line">				<span class="comment">// remove 操作的Fragment，如果不在回退栈，目标状态是INITIALIZING</span></span><br><span class="line">        maxState = Math.min(maxState, Fragment.INITIALIZING);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveToExpectedState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mMovingToState) &#123;</span><br><span class="line">            <span class="keyword">if</span> (FragmentManager.isLoggingEnabled(Log.VERBOSE)) &#123;</span><br><span class="line">                Log.v(FragmentManager.TAG, <span class="string">&quot;Ignoring re-entrant call to &quot;</span></span><br><span class="line">                        + <span class="string">&quot;moveToExpectedState() for &quot;</span> + getFragment());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mMovingToState = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> newState;</span><br><span class="line">            <span class="keyword">while</span> ((newState = computeExpectedState()) != mFragment.mState) &#123;</span><br><span class="line">                <span class="keyword">if</span> (newState &gt; mFragment.mState) &#123;</span><br><span class="line">                    <span class="comment">// Moving upward</span></span><br><span class="line">                    <span class="keyword">int</span> nextStep = mFragment.mState + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">switch</span> (nextStep) &#123;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.ATTACHED:</span><br><span class="line">                            attach();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.CREATED:</span><br><span class="line">                            create();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.VIEW_CREATED:</span><br><span class="line">                            ensureInflatedView();</span><br><span class="line">                            createView();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.AWAITING_EXIT_EFFECTS:</span><br><span class="line">                            activityCreated();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.ACTIVITY_CREATED:</span><br><span class="line">                            <span class="keyword">if</span> (mFragment.mView != <span class="keyword">null</span> &amp;&amp; mFragment.mContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                SpecialEffectsController controller = SpecialEffectsController</span><br><span class="line">                                        .getOrCreateController(mFragment.mContainer,</span><br><span class="line">                                                mFragment.getParentFragmentManager());</span><br><span class="line">                                <span class="keyword">int</span> visibility = mFragment.mView.getVisibility();</span><br><span class="line">                                SpecialEffectsController.Operation.State finalState =</span><br><span class="line">                                        SpecialEffectsController.Operation.State.from(visibility);</span><br><span class="line">                                controller.enqueueAdd(finalState, <span class="keyword">this</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            mFragment.mState = Fragment.ACTIVITY_CREATED;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.STARTED:</span><br><span class="line">                            start();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.AWAITING_ENTER_EFFECTS:</span><br><span class="line">                            mFragment.mState = Fragment.AWAITING_ENTER_EFFECTS;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.RESUMED:</span><br><span class="line">                            resume();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Moving downward</span></span><br><span class="line">                    <span class="keyword">int</span> nextStep = mFragment.mState - <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">switch</span> (nextStep) &#123;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.AWAITING_ENTER_EFFECTS:</span><br><span class="line">                            pause();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.STARTED:</span><br><span class="line">                            mFragment.mState = Fragment.STARTED;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.ACTIVITY_CREATED:</span><br><span class="line">                            stop();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.AWAITING_EXIT_EFFECTS:</span><br><span class="line">                            <span class="keyword">if</span> (FragmentManager.isLoggingEnabled(Log.DEBUG)) &#123;</span><br><span class="line">                                Log.d(TAG, <span class="string">&quot;movefrom ACTIVITY_CREATED: &quot;</span> + mFragment);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (mFragment.mView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// Need to save the current view state if not done already</span></span><br><span class="line">                                <span class="comment">// by saveInstanceState()</span></span><br><span class="line">                                <span class="keyword">if</span> (mFragment.mSavedViewState == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    saveViewState();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (mFragment.mView != <span class="keyword">null</span> &amp;&amp; mFragment.mContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                SpecialEffectsController controller = SpecialEffectsController</span><br><span class="line">                                        .getOrCreateController(mFragment.mContainer,</span><br><span class="line">                                                mFragment.getParentFragmentManager());</span><br><span class="line">                                controller.enqueueRemove(<span class="keyword">this</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            mFragment.mState = Fragment.AWAITING_EXIT_EFFECTS;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.VIEW_CREATED:</span><br><span class="line">                            mFragment.mInLayout = <span class="keyword">false</span>;</span><br><span class="line">                            mFragment.mState = Fragment.VIEW_CREATED;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.CREATED:</span><br><span class="line">                            destroyFragmentView();</span><br><span class="line">                            mFragment.mState = Fragment.CREATED;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.ATTACHED:</span><br><span class="line">                            destroy();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> Fragment.INITIALIZING:</span><br><span class="line">                            detach();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (FragmentManager.USE_STATE_MANAGER &amp;&amp; mFragment.mHiddenChanged) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mFragment.mView != <span class="keyword">null</span> &amp;&amp; mFragment.mContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Get the controller and enqueue the show/hide</span></span><br><span class="line">                    SpecialEffectsController controller = SpecialEffectsController</span><br><span class="line">                            .getOrCreateController(mFragment.mContainer,</span><br><span class="line">                                    mFragment.getParentFragmentManager());</span><br><span class="line">                    <span class="keyword">if</span> (mFragment.mHidden) &#123;</span><br><span class="line">                        controller.enqueueHide(<span class="keyword">this</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        controller.enqueueShow(<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mFragment.mFragmentManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mFragment.mFragmentManager.invalidateMenuForFragment(mFragment);</span><br><span class="line">                &#125;</span><br><span class="line">                mFragment.mHiddenChanged = <span class="keyword">false</span>;</span><br><span class="line">                mFragment.onHiddenChanged(mFragment.mHidden);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mMovingToState = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentManager#moveToState(<span class="keyword">int</span>, <span class="keyword">boolean</span>)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Changes the state of the fragment manager to &#123;<span class="doctag">@code</span> newState&#125;. If the fragment manager</span></span><br><span class="line"><span class="comment"> * changes state or &#123;<span class="doctag">@code</span> always&#125; is &#123;<span class="doctag">@code</span> true&#125;, any fragments within it have their</span></span><br><span class="line"><span class="comment"> * states updated as well.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newState The new state for the fragment manager</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> always If &#123;<span class="doctag">@code</span> true&#125;, all fragments update their state, even</span></span><br><span class="line"><span class="comment"> *               if &#123;<span class="doctag">@code</span> newState&#125; matches the current fragment manager&#x27;s state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(<span class="keyword">int</span> newState, <span class="keyword">boolean</span> always)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mHost == <span class="keyword">null</span> &amp;&amp; newState != Fragment.INITIALIZING) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No activity&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!always &amp;&amp; newState == mCurState) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mCurState = newState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (USE_STATE_MANAGER) &#123;</span><br><span class="line">        mFragmentStore.moveToExpectedState();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Must add them in the proper order. mActive fragments may be out of order</span></span><br><span class="line">        <span class="keyword">for</span> (Fragment f : mFragmentStore.getFragments()) &#123;</span><br><span class="line">            moveFragmentToExpectedState(f);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now iterate through all active fragments. These will include those that are removed</span></span><br><span class="line">        <span class="comment">// and detached.</span></span><br><span class="line">        <span class="keyword">for</span> (FragmentStateManager fragmentStateManager :</span><br><span class="line">                mFragmentStore.getActiveFragmentStateManagers()) &#123;</span><br><span class="line">            Fragment f = fragmentStateManager.getFragment();</span><br><span class="line">            <span class="keyword">if</span> (!f.mIsNewlyAdded) &#123;</span><br><span class="line">                moveFragmentToExpectedState(f);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> beingRemoved = f.mRemoving &amp;&amp; !f.isInBackStack();</span><br><span class="line">            <span class="keyword">if</span> (beingRemoved) &#123;</span><br><span class="line">                mFragmentStore.makeInactive(fragmentStateManager);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    startPendingDeferredFragments();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mNeedMenuInvalidate &amp;&amp; mHost != <span class="keyword">null</span> &amp;&amp; mCurState == Fragment.RESUMED) &#123;</span><br><span class="line">        mHost.onSupportInvalidateOptionsMenu();</span><br><span class="line">        mNeedMenuInvalidate = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同步FragmentManager的状态到mActive集合里的Fragments，mAdded集合的不同步。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">androidx.fragment.app.FragmentStore#<span class="function">moveToExpectedState</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveToExpectedState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Must add them in the proper order. mActive fragments may be out of order</span></span><br><span class="line">    <span class="keyword">for</span> (Fragment f : mAdded) &#123;</span><br><span class="line">        FragmentStateManager fragmentStateManager = mActive.get(f.mWho);</span><br><span class="line">        <span class="keyword">if</span> (fragmentStateManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fragmentStateManager.moveToExpectedState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now iterate through all active fragments. These will include those that are removed</span></span><br><span class="line">    <span class="comment">// and detached.</span></span><br><span class="line">    <span class="keyword">for</span> (FragmentStateManager fragmentStateManager : mActive.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fragmentStateManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fragmentStateManager.moveToExpectedState();</span><br><span class="line"></span><br><span class="line">            Fragment f = fragmentStateManager.getFragment();</span><br><span class="line">            <span class="keyword">boolean</span> beingRemoved = f.mRemoving &amp;&amp; !f.isInBackStack();</span><br><span class="line">            <span class="keyword">if</span> (beingRemoved) &#123;</span><br><span class="line">                makeInactive(fragmentStateManager);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将当前Fragment的状态沿着下方箭头方向升级（curState &lt; newState），或降级(curState &gt; newState)至newState，（想象状态值是一个等腰三角形，resumed在上方顶点，created &amp; destroyed位于下方两端。从左顶点到上顶点是升级，上顶点到右顶点是降级）状态值如下，RESUMED状态值最大。当前newState参数值为STARTED。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INITIALIZING = <span class="number">0</span>;     <span class="comment">// Not yet created.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CREATED = <span class="number">1</span>;          <span class="comment">// Created.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ACTIVITY_CREATED = <span class="number">2</span>; <span class="comment">// Fully created, not started.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STARTED = <span class="number">3</span>;          <span class="comment">// Created and started, not resumed.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESUMED = <span class="number">4</span>;          <span class="comment">// Created started and resumed.</span></span><br></pre></td></tr></table></figure>

<p><img src="https://developer.android.com/images/guide/fragments/fragment-view-lifecycle.png" alt="https://developer.android.com/images/guide/fragments/fragment-view-lifecycle.png"></p>
<p>由上可见，Fragment 添加后，首先推送升级到STARTED状态。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://limxtop1989.github.io/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/" data-id="cl5xromkm00093s135in68vvp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          FragmentManager源码剖析二
        
      </div>
    </a>
  
  
    <a href="/limxtop/2021/09/19/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ViewModel源码剖析</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/Android-view-coordinate-canvas-coordinate-%E5%9D%90%E6%A0%87%E7%B3%BB/" rel="tag">Android, view coordinate, canvas coordinate, 坐标系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/LifeCycle-LiveData/" rel="tag">LifeCycle, LiveData</a></li><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-Android-ViewModel/" rel="tag">ViewModel源码剖析, Android, ViewModel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/limxtop/tags/%E8%8B%B1%E8%AF%AD-%E8%87%AA%E5%AD%A6-%E5%85%A5%E9%97%A8-%E6%8C%87%E5%8D%97-%E6%96%B9%E6%B3%95%E8%AE%BA-%E8%AF%8D%E5%85%B8/" rel="tag">英语,自学,入门,指南,方法论,词典</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/limxtop/tags/Android-view-coordinate-canvas-coordinate-%E5%9D%90%E6%A0%87%E7%B3%BB/" style="font-size: 10px;">Android, view coordinate, canvas coordinate, 坐标系</a> <a href="/limxtop/tags/LifeCycle-LiveData/" style="font-size: 10px;">LifeCycle, LiveData</a> <a href="/limxtop/tags/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-Android-ViewModel/" style="font-size: 10px;">ViewModel源码剖析, Android, ViewModel</a> <a href="/limxtop/tags/%E8%8B%B1%E8%AF%AD-%E8%87%AA%E5%AD%A6-%E5%85%A5%E9%97%A8-%E6%8C%87%E5%8D%97-%E6%96%B9%E6%B3%95%E8%AE%BA-%E8%AF%8D%E5%85%B8/" style="font-size: 10px;">英语,自学,入门,指南,方法论,词典</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/limxtop/archives/2021/07/">July 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/limxtop/2022/02/24/Android-view-canvas-%E5%9D%90%E6%A0%87%E7%B3%BB/">Android view &amp; canvas 坐标系</a>
          </li>
        
          <li>
            <a href="/limxtop/2022/02/14/LifeCycle-LiveData%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">LifeCycle &amp; LiveData源码剖析</a>
          </li>
        
          <li>
            <a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%902/">FragmentManager源码剖析二</a>
          </li>
        
          <li>
            <a href="/limxtop/2021/10/18/FragmentManager%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%901/">FragmentManager源码剖析一</a>
          </li>
        
          <li>
            <a href="/limxtop/2021/09/19/ViewModel%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">ViewModel源码剖析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 文理兼修电脑首席<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/limxtop/" class="mobile-nav-link">Home</a>
  
    <a href="/limxtop/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/limxtop/fancybox/jquery.fancybox.css">

  
<script src="/limxtop/fancybox/jquery.fancybox.pack.js"></script>




<script src="/limxtop/js/script.js"></script>




  </div>
</body>
</html>